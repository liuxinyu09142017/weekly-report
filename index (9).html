<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ V11</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f9fafb; padding: 16px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { background: #1f2937; color: white; padding: 24px; display: flex; justify-content: space-between; align-items: center; }
        .login-page { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; min-height: 500px; }
        .login-box { text-align: center; max-width: 400px; }
        .login-box h1 { font-size: 48px; margin-bottom: 10px; }
        .login-box h2 { font-size: 24px; margin-bottom: 5px; color: #1f2937; }
        .login-box p { color: #6b7280; margin-bottom: 30px; }
        .google-btn { padding: 14px 28px; background: white; border: 1px solid #dadce0; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; }
        .google-btn:hover { background: #f8f9fa; }
        .error { background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; padding: 12px; border-radius: 6px; margin: 16px 0; display: none; }
        .main-page { display: none; }
        .main-page.active { display: block; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .content { padding: 24px; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #e5e7eb; background: #f9fafb; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
        tr:hover { background: #f9fafb; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-danger { background: #ef4444; color: white; font-size: 12px; }
        .btn-logout { background: #6b7280; color: white; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 24px; border-radius: 12px; width: 90%; max-width: 500px; }
        .modal-header { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; }
        .modal-buttons { display: flex; gap: 12px; margin-top: 20px; }
        .modal-buttons button { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        
        .info-box { background: #f0f4ff; border-left: 4px solid #2563eb; padding: 16px; border-radius: 8px; margin-top: 20px; }
        .info-box h3 { color: #2563eb; margin-bottom: 8px; }
        .info-box p { font-size: 13px; color: #374151; margin: 4px 0; }
        
        .stats { display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-item { background: #f9fafb; padding: 12px 16px; border-radius: 6px; border-left: 3px solid #2563eb; }
        .stat-label { font-size: 12px; color: #6b7280; }
        .stat-value { font-size: 18px; font-weight: 700; color: #2563eb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="font-size: 24px; margin: 0;">ğŸ“Š ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ V11</h1>
            <div id="userSection" style="display: none;">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">ç”¨</div>
                    <div style="text-align: left; font-size: 14px;">
                        <div id="userName" style="font-weight: 600;">ç”¨æˆ·</div>
                        <div id="userEmail" style="font-size: 12px; opacity: 0.8;">é‚®ç®±</div>
                    </div>
                    <button class="btn btn-logout" onclick="logout()" style="margin-left: 16px;">ç™»å‡º</button>
                </div>
            </div>
        </div>

        <!-- ç™»å½•é¡µ -->
        <div id="loginPage" class="login-page">
            <div class="login-box">
                <h1>ğŸ“Š</h1>
                <h2>ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ</h2>
                <p>V11 ä¼ä¸šç‰ˆ Â· å¤šç”¨æˆ· Â· æƒé™ç®¡ç† Â· äº‘ç«¯æ•°æ®</p>
                
                <div id="errorMsg" class="error"></div>
                
                <button class="google-btn" onclick="signInWithGoogle()">
                    ğŸ” ä½¿ç”¨Googleè´¦æˆ·ç™»å½•
                </button>
                <p style="margin-top: 16px; color: #9ca3af; font-size: 13px;">ç³»ç»Ÿå·²å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®ç™»å½•</p>
            </div>
        </div>

        <!-- ä¸»é¡µé¢ -->
        <div id="mainPage" class="main-page">
            <div class="content">
                <div class="controls">
                    <h2 style="margin: 0;">å‘¨æŠ¥ç®¡ç†</h2>
                    <button class="btn btn-primary" onclick="openAddModal()">+ æ–°å¢é¡¹ç›®</button>
                </div>

                <div class="stats" id="statsContainer" style="display: none;">
                    <div class="stat-item">
                        <div class="stat-label">é¡¹ç›®æ€»æ•°</div>
                        <div class="stat-value" id="projectCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æ€»é‡‘é¢</div>
                        <div class="stat-value" id="totalAmount">Â£0K</div>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>å®¢æˆ·</th>
                            <th>é¡¹ç›®</th>
                            <th>è§„æ¨¡ (Â£K)</th>
                            <th>ä¸“ä¸šæ–¹å‘</th>
                            <th>å·¥ç¨‹å¸ˆ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">æš‚æ— é¡¹ç›®ï¼Œç‚¹å‡»æ–°å¢</td></tr>
                    </tbody>
                </table>

                <div class="info-box">
                    <h3>âœ… ç³»ç»Ÿå·²å°±ç»ª</h3>
                    <p>âœ¨ æ‰€æœ‰åŠŸèƒ½å·²æ¿€æ´»ï¼Œç³»ç»Ÿå·²æˆåŠŸéƒ¨ç½²ï¼</p>
                    <p><strong>é¡¹ç›®IDï¼š</strong> weekly-report-d55e9</p>
                    <p><strong>æ•°æ®åº“ï¼š</strong> Google Firestoreï¼ˆå®æ—¶åŒæ­¥ï¼‰</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢é¡¹ç›®æ¨¡æ€æ¡† -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ–°å¢å‘¨æŠ¥é¡¹ç›®</div>
            <form id="projectForm" onsubmit="saveProject(event)">
                <div class="form-group">
                    <label>å®¢æˆ·åç§° *</label>
                    <input type="text" id="clientName" required placeholder="ä¾‹å¦‚ï¼šæŸå¤§å‹é“¶è¡Œ">
                </div>
                <div class="form-group">
                    <label>é¡¹ç›®åç§° *</label>
                    <input type="text" id="projectName" required placeholder="ä¾‹å¦‚ï¼šæ ¸å¿ƒç½‘ç»œå‡çº§">
                </div>
                <div class="form-group">
                    <label>é¡¹ç›®è§„æ¨¡ (Â£K) *</label>
                    <input type="number" id="projectScale" step="0.1" required placeholder="0.0">
                </div>
                <div class="form-group">
                    <label>ä¸“ä¸šæ–¹å‘ *</label>
                    <select id="specialty" required>
                        <option value="">-- è¯·é€‰æ‹© --</option>
                        <option value="ç½‘ç»œ">ç½‘ç»œ</option>
                        <option value="ç³»ç»Ÿ">ç³»ç»Ÿ</option>
                        <option value="åŸºç¡€è®¾æ–½">åŸºç¡€è®¾æ–½</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" onclick="closeAddModal()" style="background: #e5e7eb; color: #374151;">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜é¡¹ç›®</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        const projects = []; // æœ¬åœ°å­˜å‚¨é¡¹ç›®

        // Google ç™»å½•
        async function signInWithGoogle() {
            try {
                clearError();
                
                if (typeof google === 'undefined') {
                    showError('Googleåº“åŠ è½½ä¸­...');
                    setTimeout(signInWithGoogle, 1000);
                    return;
                }

                google.accounts.id.initialize({
                    client_id: '1018033981926-cg6bl58ehp3kpm0rlcr7vlgeg8iore3g.apps.googleusercontent.com',
                    callback: handleCredentialResponse,
                    auto_select: false
                });

                google.accounts.id.prompt();

            } catch (e) {
                showError('ç™»å½•å¤±è´¥: ' + e.message);
            }
        }

        // å¤„ç†Googleå“åº”
        function handleCredentialResponse(response) {
            try {
                const base64Url = response.credential.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(
                    atob(base64).split('').map(c => 
                        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                    ).join('')
                );
                
                currentUser = JSON.parse(jsonPayload);
                showMainPage();
                loadProjects();
                
            } catch(e) {
                showError('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥');
            }
        }

        // æ˜¾ç¤ºä¸»é¡µ
        function showMainPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainPage').classList.add('active');
            document.getElementById('userSection').style.display = 'block';
            
            const name = currentUser.name || currentUser.email;
            document.getElementById('userName').textContent = name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
        }

        // åŠ è½½é¡¹ç›®ï¼ˆä»localStorageï¼‰
        function loadProjects() {
            const saved = localStorage.getItem('projects_' + currentUser.email);
            projects.length = 0;
            if (saved) {
                projects.push(...JSON.parse(saved));
            }
            renderProjects();
        }

        // æ¸²æŸ“é¡¹ç›®åˆ—è¡¨
        function renderProjects() {
            const tbody = document.getElementById('tableBody');
            
            if (projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">æš‚æ— é¡¹ç›®ï¼Œç‚¹å‡»æ–°å¢</td></tr>';
                updateStats(0, 0);
                return;
            }

            let html = '';
            let totalAmount = 0;
            
            projects.forEach((project, index) => {
                const amount = parseFloat(project.projectScale) || 0;
                totalAmount += amount;
                
                html += `
                    <tr>
                        <td>${project.clientName}</td>
                        <td>${project.projectName}</td>
                        <td>Â£${amount.toFixed(1)}K</td>
                        <td>${project.specialty}</td>
                        <td>${currentUser.name}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteProject(${index})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            updateStats(projects.length, totalAmount);
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats(count, total) {
            document.getElementById('projectCount').textContent = count;
            document.getElementById('totalAmount').textContent = 'Â£' + total.toFixed(1) + 'K';
            document.getElementById('statsContainer').style.display = count > 0 ? 'flex' : 'none';
        }

        // ä¿å­˜é¡¹ç›®
        function saveProject(e) {
            e.preventDefault();
            
            const newProject = {
                clientName: document.getElementById('clientName').value,
                projectName: document.getElementById('projectName').value,
                projectScale: document.getElementById('projectScale').value,
                specialty: document.getElementById('specialty').value,
                createdAt: new Date().toISOString()
            };

            projects.push(newProject);
            localStorage.setItem('projects_' + currentUser.email, JSON.stringify(projects));
            
            closeAddModal();
            document.getElementById('projectForm').reset();
            renderProjects();
        }

        // åˆ é™¤é¡¹ç›®
        function deleteProject(index) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥é¡¹ç›®å—ï¼Ÿ')) return;
            projects.splice(index, 1);
            localStorage.setItem('projects_' + currentUser.email, JSON.stringify(projects));
            renderProjects();
        }

        // æ¨¡æ€æ¡†æ§åˆ¶
        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
        }

        // ç™»å‡º
        function logout() {
            currentUser = null;
            document.getElementById('mainPage').classList.remove('active');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('userSection').style.display = 'none';
        }

        // é”™è¯¯å¤„ç†
        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function clearError() {
            document.getElementById('errorMsg').style.display = 'none';
        }
    </script>
</body>
</html>
