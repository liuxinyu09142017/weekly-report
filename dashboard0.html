<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å·¥æ—¶ç³»ç»Ÿ">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no,email=no,address=no">
    <link rel="stylesheet" href="css/mobile-responsive.css">
    <title>Dashboard - å·¥ç¨‹å¸ˆå·¥æ—¶ç³»ç»Ÿ</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebaseåˆå§‹åŒ–æ¨¡å— -->
    <script src="js/firebase-init.js"></script>
    
    <!-- è´§å¸è½¬æ¢æ¨¡å— -->
    <script src="js/currency-converter.js"></script>
    
    <!-- é‡‘é¢æ ¼å¼åŒ–æ¨¡å— -->
    <script src="js/amount-formatter.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f5f7fa; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { font-size: 32px; }
        .logo-text h1 { font-size: 20px; margin-bottom: 3px; }
        .logo-text p { font-size: 12px; opacity: 0.9; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; border: 3px solid white; object-fit: cover; }
        .user-avatar-placeholder { width: 45px; height: 45px; border-radius: 50%; background: white; color: #667eea; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; border: 3px solid white; }
        .user-details { text-align: right; }
        .user-name { font-weight: 600; margin-bottom: 3px; }
        .user-role { font-size: 12px; opacity: 0.9; }
        .role-badge { display: inline-block; padding: 3px 10px; background: rgba(255,255,255,0.2); border-radius: 12px; font-size: 11px; margin-left: 8px; }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 8px 20px; border-radius: 20px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 600; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        
        /* æé†’é€šçŸ¥ */
        .alert-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.3s; }
        .alert-box:hover { transform: translateX(5px); box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3); }
        .alert-icon { font-size: 24px; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: 600; color: #856404; margin-bottom: 3px; }
        .alert-text { font-size: 13px; color: #856404; }
        
        /* æ¬¢è¿å¡ç‰‡ */
        .welcome-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .welcome-card h2 { color: #333; font-size: 24px; margin-bottom: 8px; }
        .welcome-card p { color: #666; font-size: 14px; }
        .week-info { display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; margin-top: 12px; }
        
        /* ç»Ÿè®¡å¡ç‰‡ - ä¼˜åŒ–ç‰ˆ 4å¡ç‰‡å¸ƒå±€ */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.3s; overflow: hidden; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .stat-card-header { padding: 20px 20px 15px; display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid #f0f0f0; }
        .stat-main { display: flex; align-items: center; gap: 15px; }
        .stat-icon { font-size: 36px; }
        .stat-value { font-size: 32px; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; font-size: 13px; margin-top: 2px; }
        .stat-badge { background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        
        /* å¡ç‰‡è¯¦æƒ…åŒºåŸŸ */
        .stat-details { padding: 15px 20px 20px; }
        .detail-title { font-size: 12px; color: #999; margin-bottom: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* æ¨ªå‘æ¡å½¢å›¾æ ·å¼ */
        .bar-chart { display: flex; flex-direction: column; gap: 10px; }
        .bar-item { display: flex; align-items: center; gap: 10px; }
        .bar-label { width: 120px; font-size: 12px; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-shrink: 0; }
        .bar-container { flex: 1; height: 20px; background: #f3f4f6; border-radius: 10px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; border-radius: 10px; transition: width 0.8s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; min-width: 40px; }
        .bar-fill.purple { background: linear-gradient(90deg, #667eea, #764ba2); }
        .bar-fill.green { background: linear-gradient(90deg, #10b981, #34d399); }
        .bar-fill.orange { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .bar-fill.blue { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .bar-fill.pink { background: linear-gradient(90deg, #ec4899, #f472b6); }
        .bar-value { font-size: 11px; color: white; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        
        /* ç¯å½¢å›¾æ ·å¼ */
        .donut-chart-container { display: flex; align-items: center; gap: 20px; }
        .donut-chart { position: relative; width: 120px; height: 120px; flex-shrink: 0; }
        .donut-chart svg { transform: rotate(-90deg); }
        .donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .donut-center-value { font-size: 24px; font-weight: bold; color: #333; }
        .donut-center-label { font-size: 11px; color: #666; }
        .donut-legend { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
        .legend-text { flex: 1; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .legend-value { color: #667eea; font-weight: 600; white-space: nowrap; }
        
        /* å®¢æˆ·æ ‡ç­¾äº‘ */
        .customer-cloud { display: flex; flex-wrap: wrap; gap: 8px; max-height: 180px; overflow-y: auto; }
        .customer-tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 12px; transition: all 0.2s; }
        .customer-tag:nth-child(6n+1) { background: linear-gradient(135deg, #ede9fe, #ddd6fe); color: #6d28d9; }
        .customer-tag:nth-child(6n+2) { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1d4ed8; }
        .customer-tag:nth-child(6n+3) { background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #047857; }
        .customer-tag:nth-child(6n+4) { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #b45309; }
        .customer-tag:nth-child(6n+5) { background: linear-gradient(135deg, #fce7f3, #fbcfe8); color: #be185d; }
        .customer-tag:nth-child(6n+6) { background: linear-gradient(135deg, #e0e7ff, #c7d2fe); color: #4338ca; }
        .customer-tag:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .customer-tag .tag-hours { font-weight: 700; }
        
        /* ç©ºçŠ¶æ€ */
        .empty-detail { text-align: center; padding: 30px 0; color: #999; font-size: 13px; }
        .empty-detail .empty-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }
        
        /* å¿«é€Ÿæ“ä½œ */
        .actions-section { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .actions-section h3 { color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .action-btn { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 12px; text-align: left; }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        .action-btn.secondary { background: linear-gradient(135deg, #f5f7fa 0%, #e7eaf0 100%); color: #667eea; border: 2px solid #667eea; }
        .action-btn.secondary:hover { background: linear-gradient(135deg, #e7eaf0 0%, #d8dce5 100%); }
        .action-icon { font-size: 24px; }
        .action-content { flex: 1; }
        .action-title { font-size: 16px; margin-bottom: 3px; }
        .action-desc { font-size: 12px; opacity: 0.9; }
        
        /* å›¢é˜Ÿæˆå‘˜ */
        .team-section { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .team-section h3 { color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .team-member { background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center; transition: all 0.3s; cursor: pointer; }
        .team-member:hover { background: #e7eaf0; transform: translateY(-3px); }
        .member-avatar { width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 12px; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px; }
        .member-name { font-weight: 600; color: #333; margin-bottom: 5px; font-size: 14px; }
        .member-team { font-size: 12px; color: #666; }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading { text-align: center; padding: 100px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .detail-list::-webkit-scrollbar { width: 4px; }
        .detail-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 2px; }
        .detail-list::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 2px; }
        .detail-list::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 15px; text-align: center; }
            .user-info { flex-direction: column; }
            .user-details { text-align: center; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">ğŸ•</div>
                <div class="logo-text">
                    <h1>å·¥ç¨‹å¸ˆå·¥æ—¶ç³»ç»Ÿ</h1>
                    <p>China Telecom (Europe) ICTéƒ¨é—¨</p>
                </div>
            </div>
            <div class="user-info">
                <div id="user-avatar-container"></div>
                <div class="user-details">
                    <div class="user-name">
                        <span id="user-name">åŠ è½½ä¸­...</span>
                        <span class="role-badge" id="user-role-badge">-</span>
                    </div>
                    <div class="user-role" id="user-team">-</div>
                </div>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½ä¸­ -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>æ­£åœ¨åŠ è½½...</div>
    </div>
    
    <!-- ä¸»å†…å®¹ -->
    <div id="main-content" class="container" style="display: none;">
        <!-- ç®¡ç†å‘˜æé†’ -->
        <div id="admin-alert" style="display: none;"></div>
        
        <!-- æ¬¢è¿å¡ç‰‡ -->
        <div class="welcome-card">
            <h2 id="welcome-title">æ¬¢è¿å›æ¥ï¼</h2>
            <p id="welcome-subtitle">-</p>
            <div class="week-info" id="week-info">ğŸ“… æœ¬å‘¨æ•°æ®åŠ è½½ä¸­...</div>
        </div>
        
        <!-- ç»Ÿè®¡æ•°æ® -->
        <div class="stats-grid" id="stats-grid">
            <!-- åŠ¨æ€åŠ è½½ç»Ÿè®¡å¡ç‰‡ -->
        </div>
        
        <!-- å›¢é˜Ÿæˆå‘˜ -->
        <div id="team-section" class="team-section" style="display: none;">
            <h3>ğŸ‘¥ å›¢é˜Ÿæˆå‘˜</h3>
            <div class="team-grid" id="team-grid"></div>
        </div>
        
        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="actions-section">
            <h3>âš¡ å¿«é€Ÿæ“ä½œ</h3>
            <div class="actions-grid" id="actions-grid"></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let userData = null;

        // è·å–æœ¬å‘¨çš„èµ·æ­¢æ—¥æœŸ
        function getWeekRange() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const monday = new Date(now);
            monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            monday.setHours(0, 0, 0, 0);
            
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            sunday.setHours(23, 59, 59, 999);
            
            return { start: monday, end: sunday };
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
        function formatDateRange(start, end) {
            const formatDate = (d) => `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
            return `${formatDate(start)} - ${formatDate(end)}`;
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
            } else {
                window.location.href = 'index.html';
            }
        });

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (!userDoc.exists) {
                    alert('ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = 'index.html';
                    return;
                }
                
                userData = userDoc.data();
                
                if (userData.status !== 'approved') {
                    if (userData.status === 'pending') {
                        window.location.href = 'pending-approval.html';
                    } else {
                        alert('è´¦å·çŠ¶æ€å¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
                        await auth.signOut();
                        window.location.href = 'index.html';
                    }
                    return;
                }
                
                displayUserInfo();
                await loadDashboardByRole();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function displayUserInfo() {
            const userName = userData.fullName || userData.displayName || 'ç”¨æˆ·';
            const userTeam = userData.technicalTeam ? `${userData.technicalTeam}å›¢é˜Ÿ` : 'ICTéƒ¨é—¨';
            
            document.getElementById('user-name').textContent = userName;
            document.getElementById('user-team').textContent = userTeam;
            
            const roleMap = { 'admin': 'ç®¡ç†å‘˜', 'team_lead': 'éƒ¨é—¨é¢†å¯¼', 'engineer': 'å·¥ç¨‹å¸ˆ' };
            document.getElementById('user-role-badge').textContent = roleMap[userData.role] || 'ç”¨æˆ·';
            
            const avatarContainer = document.getElementById('user-avatar-container');
            if (userData.photoURL || currentUser.photoURL) {
                avatarContainer.innerHTML = `<img src="${userData.photoURL || currentUser.photoURL}" class="user-avatar" alt="Avatar">`;
            } else {
                avatarContainer.innerHTML = `<div class="user-avatar-placeholder">${userName.charAt(0)}</div>`;
            }
            
            // æ˜¾ç¤ºæœ¬å‘¨æ—¥æœŸèŒƒå›´
            const weekRange = getWeekRange();
            document.getElementById('week-info').textContent = `ğŸ“… æœ¬å‘¨: ${formatDateRange(weekRange.start, weekRange.end)}`;
        }

        // æ ¹æ®è§’è‰²åŠ è½½Dashboard
        async function loadDashboardByRole() {
            const role = userData.role;
            if (role === 'admin') {
                await loadAdminDashboard();
            } else if (role === 'team_lead') {
                await loadTeamLeadDashboard();
            } else {
                await loadEngineerDashboard();
            }
        }

        // ç®¡ç†å‘˜Dashboard
        async function loadAdminDashboard() {
            document.getElementById('welcome-title').textContent = `æ¬¢è¿ï¼Œ${userData.fullName || 'ç®¡ç†å‘˜'}ï¼`;
            document.getElementById('welcome-subtitle').textContent = 'ç³»ç»Ÿç®¡ç†å‘˜ - å®Œæ•´æƒé™';
            await checkPendingUsers();
            await loadAdminStats();
            await loadAllMembers();
            displayAdminActions();
        }

        // éƒ¨é—¨é¢†å¯¼Dashboard
        async function loadTeamLeadDashboard() {
            document.getElementById('welcome-title').textContent = `ä½ å¥½ï¼Œ${userData.fullName || 'é¢†å¯¼'}ï¼`;
            document.getElementById('welcome-subtitle').textContent = `${userData.technicalTeam || 'ICT'}å›¢é˜Ÿè´Ÿè´£äºº`;
            await loadTeamLeadStats();
            await loadAllMembers();
            displayTeamLeadActions();
        }

        // å·¥ç¨‹å¸ˆDashboard
        async function loadEngineerDashboard() {
            document.getElementById('welcome-title').textContent = `ä½ å¥½ï¼Œ${userData.fullName || userData.displayName}ï¼`;
            document.getElementById('welcome-subtitle').textContent = `${userData.technicalTeam || 'ICT'}å›¢é˜Ÿå·¥ç¨‹å¸ˆ`;
            await loadPersonalStats();
            displayEngineerActions();
        }

        // æ£€æŸ¥å¾…å®¡æ‰¹ç”¨æˆ·
        async function checkPendingUsers() {
            try {
                const pendingSnapshot = await db.collection('users').where('status', '==', 'pending').get();
                if (pendingSnapshot.size > 0) {
                    document.getElementById('admin-alert').style.display = 'block';
                    document.getElementById('admin-alert').innerHTML = `
                        <div class="alert-box" onclick="window.location.href='user-management.html'">
                            <div class="alert-icon">âš ï¸</div>
                            <div class="alert-content">
                                <div class="alert-title">æœ‰ ${pendingSnapshot.size} ä¸ªç”¨æˆ·ç­‰å¾…å®¡æ‰¹</div>
                                <div class="alert-text">ç‚¹å‡»æŸ¥çœ‹å¹¶å¤„ç†å¾…å®¡æ‰¹ç”¨æˆ·</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('æ£€æŸ¥å¾…å®¡æ‰¹ç”¨æˆ·å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç®¡ç†å‘˜ç»Ÿè®¡
        async function loadAdminStats() {
            try {
                // è·å–æ‰€æœ‰å·¥ä½œè®°å½•ï¼Œåœ¨å®¢æˆ·ç«¯è¿‡æ»¤æœ¬å‘¨
                const recordsSnapshot = await db.collection('workRecords').get();
                
                // ç»Ÿè®¡æ•°æ®
                let totalHours = 0;
                let normalHours = 0;
                let overtimeHours = 0;
                const customerHours = {};
                const projectHours = {};
                const projectNormalHours = {};
                const projectOvertimeHours = {};
                let weekRecordCount = 0;
                
                recordsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨æœ¬å‘¨å†…
                    if (!isInCurrentWeek(data)) return;
                    
                    weekRecordCount++;
                    const hours = data.totalWorkingHours || data.workHours || 0;
                    const normal = data.normalWorkingHours || 0;
                    const overtime = data.overtimeHours || 0;
                    
                    totalHours += hours;
                    normalHours += normal;
                    overtimeHours += overtime;
                    
                    // æŒ‰å®¢æˆ·ç»Ÿè®¡
                    const customer = data.customerName || 'æœªçŸ¥å®¢æˆ·';
                    customerHours[customer] = (customerHours[customer] || 0) + hours;
                    
                    // æŒ‰é¡¹ç›®ç»Ÿè®¡
                    const project = data.projectName || 'æœªçŸ¥é¡¹ç›®';
                    projectHours[project] = (projectHours[project] || 0) + hours;
                    projectNormalHours[project] = (projectNormalHours[project] || 0) + normal;
                    projectOvertimeHours[project] = (projectOvertimeHours[project] || 0) + overtime;
                });
                
                // æ’åº
                const sortedCustomers = Object.entries(customerHours).sort((a, b) => b[1] - a[1]);
                const sortedProjects = Object.entries(projectHours).sort((a, b) => b[1] - a[1]);
                const sortedNormalProjects = Object.entries(projectNormalHours).filter(([,h]) => h > 0).sort((a, b) => b[1] - a[1]);
                const sortedOvertimeProjects = Object.entries(projectOvertimeHours).filter(([,h]) => h > 0).sort((a, b) => b[1] - a[1]);
                
                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = `
                    ${createRecordsCard(weekRecordCount, sortedProjects, totalHours)}
                    ${createCustomerCard(sortedCustomers, totalHours)}
                    ${createHoursDonutCard('â˜€ï¸', normalHours.toFixed(1), 'æ­£å¸¸å·¥æ—¶', sortedNormalProjects, normalHours, 'normal')}
                    ${createHoursDonutCard('ğŸŒ™', overtimeHours.toFixed(1), 'åŠ ç­å·¥æ—¶', sortedOvertimeProjects, overtimeHours, 'overtime')}
                `;
            } catch (error) {
                console.error('åŠ è½½ç®¡ç†å‘˜ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // åŠ è½½éƒ¨é—¨é¢†å¯¼ç»Ÿè®¡
        async function loadTeamLeadStats() {
            try {
                // è·å–å›¢é˜Ÿæˆå‘˜
                const teamMembers = await db.collection('users')
                    .where('status', '==', 'approved')
                    .where('department', '==', 'ICTéƒ¨é—¨')
                    .get();
                
                const memberIds = teamMembers.docs.map(doc => doc.id);
                
                // è·å–å›¢é˜Ÿå·¥ä½œè®°å½•ï¼Œåœ¨å®¢æˆ·ç«¯è¿‡æ»¤æœ¬å‘¨
                let allRecords = [];
                for (const memberId of memberIds) {
                    const records = await db.collection('workRecords')
                        .where('userId', '==', memberId)
                        .get();
                    allRecords = allRecords.concat(records.docs);
                }
                
                let totalHours = 0;
                let normalHours = 0;
                let overtimeHours = 0;
                const customerHours = {};
                const projectHours = {};
                const projectNormalHours = {};
                const projectOvertimeHours = {};
                let weekRecordCount = 0;
                
                allRecords.forEach(doc => {
                    const data = doc.data();
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨æœ¬å‘¨å†…
                    if (!isInCurrentWeek(data)) return;
                    
                    weekRecordCount++;
                    const hours = data.totalWorkingHours || data.workHours || 0;
                    const normal = data.normalWorkingHours || 0;
                    const overtime = data.overtimeHours || 0;
                    
                    totalHours += hours;
                    normalHours += normal;
                    overtimeHours += overtime;
                    
                    const customer = data.customerName || 'æœªçŸ¥å®¢æˆ·';
                    customerHours[customer] = (customerHours[customer] || 0) + hours;
                    
                    const project = data.projectName || 'æœªçŸ¥é¡¹ç›®';
                    projectHours[project] = (projectHours[project] || 0) + hours;
                    projectNormalHours[project] = (projectNormalHours[project] || 0) + normal;
                    projectOvertimeHours[project] = (projectOvertimeHours[project] || 0) + overtime;
                });
                
                const sortedCustomers = Object.entries(customerHours).sort((a, b) => b[1] - a[1]);
                const sortedProjects = Object.entries(projectHours).sort((a, b) => b[1] - a[1]);
                const sortedNormalProjects = Object.entries(projectNormalHours).filter(([,h]) => h > 0).sort((a, b) => b[1] - a[1]);
                const sortedOvertimeProjects = Object.entries(projectOvertimeHours).filter(([,h]) => h > 0).sort((a, b) => b[1] - a[1]);
                
                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = `
                    ${createRecordsCard(weekRecordCount, sortedProjects, totalHours)}
                    ${createCustomerCard(sortedCustomers, totalHours)}
                    ${createHoursDonutCard('â˜€ï¸', normalHours.toFixed(1), 'æ­£å¸¸å·¥æ—¶', sortedNormalProjects, normalHours, 'normal')}
                    ${createHoursDonutCard('ğŸŒ™', overtimeHours.toFixed(1), 'åŠ ç­å·¥æ—¶', sortedOvertimeProjects, overtimeHours, 'overtime')}
                `;
            } catch (error) {
                console.error('åŠ è½½å›¢é˜Ÿç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // åˆ¤æ–­è®°å½•æ˜¯å¦åœ¨æœ¬å‘¨å†…
        function isInCurrentWeek(record) {
            const weekRange = getWeekRange();
            let recordDate = null;
            
            // å°è¯•å¤šç§æ—¥æœŸå­—æ®µå’Œæ ¼å¼
            const dateFields = ['startDateTime', 'workDate', 'date', 'createdAt'];
            for (const field of dateFields) {
                if (record[field]) {
                    if (record[field].toDate) {
                        // Firestore Timestamp
                        recordDate = record[field].toDate();
                    } else if (typeof record[field] === 'string') {
                        // ISOå­—ç¬¦ä¸²æˆ–æ—¥æœŸå­—ç¬¦ä¸²
                        recordDate = new Date(record[field]);
                    } else if (record[field] instanceof Date) {
                        recordDate = record[field];
                    }
                    if (recordDate && !isNaN(recordDate.getTime())) break;
                }
            }
            
            if (!recordDate || isNaN(recordDate.getTime())) return false;
            return recordDate >= weekRange.start && recordDate <= weekRange.end;
        }

        // åŠ è½½ä¸ªäººç»Ÿè®¡ï¼ˆå·¥ç¨‹å¸ˆï¼‰- æœ¬å‘¨æ•°æ®
        async function loadPersonalStats() {
            try {
                // è·å–æ‰€æœ‰ä¸ªäººå·¥ä½œè®°å½•ï¼Œç„¶ååœ¨å®¢æˆ·ç«¯è¿‡æ»¤æœ¬å‘¨
                const recordsSnapshot = await db.collection('workRecords')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                let totalHours = 0;
                let normalHours = 0;
                let overtimeHours = 0;
                const customerHours = {};
                const projectHours = {};
                const projectNormalHours = {};
                const projectOvertimeHours = {};
                let weekRecordCount = 0;
                
                recordsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨æœ¬å‘¨å†…
                    if (!isInCurrentWeek(data)) return;
                    
                    weekRecordCount++;
                    const hours = data.totalWorkingHours || data.workHours || 0;
                    const normal = data.normalWorkingHours || 0;
                    const overtime = data.overtimeHours || 0;
                    
                    totalHours += hours;
                    normalHours += normal;
                    overtimeHours += overtime;
                    
                    const customer = data.customerName || 'æœªçŸ¥å®¢æˆ·';
                    customerHours[customer] = (customerHours[customer] || 0) + hours;
                    
                    const project = data.projectName || 'æœªçŸ¥é¡¹ç›®';
                    projectHours[project] = (projectHours[project] || 0) + hours;
                    projectNormalHours[project] = (projectNormalHours[project] || 0) + normal;
                    projectOvertimeHours[project] = (projectOvertimeHours[project] || 0) + overtime;
                });
                
                const sortedCustomers = Object.entries(customerHours).sort((a, b) => b[1] - a[1]);
                const sortedProjects = Object.entries(projectHours).sort((a, b) => b[1] - a[1]);
                const sortedNormalProjects = Object.entries(projectNormalHours).filter(([,h]) => h > 0).sort((a, b) => b[1] - a[1]);
                const sortedOvertimeProjects = Object.entries(projectOvertimeHours).filter(([,h]) => h > 0).sort((a, b) => b[1] - a[1]);
                
                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = `
                    ${createRecordsCard(weekRecordCount, sortedProjects, totalHours)}
                    ${createCustomerCard(sortedCustomers, totalHours)}
                    ${createHoursDonutCard('â˜€ï¸', normalHours.toFixed(1), 'æ­£å¸¸å·¥æ—¶', sortedNormalProjects, normalHours, 'normal')}
                    ${createHoursDonutCard('ğŸŒ™', overtimeHours.toFixed(1), 'åŠ ç­å·¥æ—¶', sortedOvertimeProjects, overtimeHours, 'overtime')}
                `;
            } catch (error) {
                console.error('åŠ è½½ä¸ªäººç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // åˆ›å»ºå·¥ä½œè®°å½•å¡ç‰‡ï¼ˆå¸¦æ¨ªå‘æ¡å½¢å›¾ï¼‰
        function createRecordsCard(count, projects, total) {
            let chartHtml = '';
            if (projects.length > 0 && total > 0) {
                const items = projects.slice(0, 5).map(([name, hours], idx) => {
                    const percent = ((hours / total) * 100).toFixed(0);
                    const colors = ['purple', 'blue', 'green', 'orange', 'pink'];
                    return `
                        <div class="bar-item">
                            <span class="bar-label" title="${name}">${name}</span>
                            <div class="bar-container">
                                <div class="bar-fill ${colors[idx % 5]}" style="width: ${Math.max(percent, 15)}%">
                                    <span class="bar-value">${hours.toFixed(1)}h</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                chartHtml = `<div class="bar-chart">${items}</div>`;
            } else {
                chartHtml = '<div class="empty-detail"><div class="empty-icon">ğŸ“‹</div>æœ¬å‘¨æš‚æ— å·¥ä½œè®°å½•</div>';
            }
            
            return `
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-main">
                            <div class="stat-icon">ğŸ“‹</div>
                            <div>
                                <div class="stat-value">${count}</div>
                                <div class="stat-label">æœ¬å‘¨å·¥ä½œè®°å½•</div>
                            </div>
                        </div>
                        <span class="stat-badge">æœ¬å‘¨</span>
                    </div>
                    <div class="stat-details">
                        <div class="detail-title">é¡¹ç›®å·¥æ—¶åˆ†å¸ƒ</div>
                        ${chartHtml}
                    </div>
                </div>
            `;
        }

        // åˆ›å»ºå®¢æˆ·å¡ç‰‡ï¼ˆæ ‡ç­¾äº‘ï¼‰
        function createCustomerCard(customers, totalHours) {
            let content = '';
            if (customers.length === 0) {
                content = '<div class="empty-detail"><div class="empty-icon">ğŸ¢</div>æœ¬å‘¨æš‚æ— å®¢æˆ·è®°å½•</div>';
            } else {
                const tags = customers.map(([name, hours]) => {
                    const percent = totalHours > 0 ? ((hours / totalHours) * 100).toFixed(0) : 0;
                    return `<span class="customer-tag">${name} <span class="tag-hours">${hours.toFixed(1)}h (${percent}%)</span></span>`;
                }).join('');
                content = `<div class="customer-cloud">${tags}</div>`;
            }
            
            return `
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-main">
                            <div class="stat-icon">ğŸ¢</div>
                            <div>
                                <div class="stat-value">${customers.length}</div>
                                <div class="stat-label">æœ¬å‘¨æ”¯æŒå®¢æˆ·</div>
                            </div>
                        </div>
                        <span class="stat-badge">æœ¬å‘¨</span>
                    </div>
                    <div class="stat-details">
                        <div class="detail-title">å®¢æˆ·åŠå·¥æ—¶æ˜ç»†</div>
                        ${content}
                    </div>
                </div>
            `;
        }

        // åˆ›å»ºå·¥æ—¶ç¯å½¢å›¾å¡ç‰‡ï¼ˆæ­£å¸¸/åŠ ç­å·¥æ—¶ï¼‰
        function createHoursDonutCard(icon, value, label, projects, total, colorType) {
            const colors = colorType === 'normal' 
                ? ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5']
                : ['#f59e0b', '#fbbf24', '#fcd34d', '#fde68a', '#fef3c7'];
            
            let chartHtml = '';
            if (projects.length > 0 && total > 0) {
                // ç”Ÿæˆç¯å½¢å›¾SVG
                const radius = 45;
                const circumference = 2 * Math.PI * radius;
                let currentOffset = 0;
                
                const segments = projects.slice(0, 5).map(([name, hours], idx) => {
                    const percent = (hours / total) * 100;
                    const dashLength = (percent / 100) * circumference;
                    const dashOffset = currentOffset;
                    currentOffset += dashLength;
                    
                    return `<circle cx="60" cy="60" r="${radius}" fill="none" stroke="${colors[idx]}" 
                            stroke-width="12" stroke-dasharray="${dashLength} ${circumference}" 
                            stroke-dashoffset="-${dashOffset}" />`;
                }).join('');
                
                const legendItems = projects.slice(0, 5).map(([name, hours], idx) => {
                    const percent = ((hours / total) * 100).toFixed(0);
                    return `
                        <div class="legend-item">
                            <span class="legend-color" style="background: ${colors[idx]}"></span>
                            <span class="legend-text" title="${name}">${name}</span>
                            <span class="legend-value">${hours.toFixed(1)}h</span>
                        </div>
                    `;
                }).join('');
                
                chartHtml = `
                    <div class="donut-chart-container">
                        <div class="donut-chart">
                            <svg width="120" height="120" viewBox="0 0 120 120">
                                <circle cx="60" cy="60" r="${radius}" fill="none" stroke="#f3f4f6" stroke-width="12" />
                                ${segments}
                            </svg>
                            <div class="donut-center">
                                <div class="donut-center-value">${value}</div>
                                <div class="donut-center-label">å°æ—¶</div>
                            </div>
                        </div>
                        <div class="donut-legend">${legendItems}</div>
                    </div>
                `;
            } else {
                chartHtml = `<div class="empty-detail"><div class="empty-icon">${icon}</div>æœ¬å‘¨æš‚æ— ${label}è®°å½•</div>`;
            }
            
            return `
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-main">
                            <div class="stat-icon">${icon}</div>
                            <div>
                                <div class="stat-value">${value}</div>
                                <div class="stat-label">${label}</div>
                            </div>
                        </div>
                    </div>
                    <div class="stat-details">
                        <div class="detail-title">é¡¹ç›®${label}åˆ†å¸ƒ</div>
                        ${chartHtml}
                    </div>
                </div>
            `;
        }

        // åŠ è½½æ‰€æœ‰æˆå‘˜
        async function loadAllMembers() {
            try {
                const usersSnapshot = await db.collection('users')
                    .where('status', '==', 'approved')
                    .where('department', '==', 'ICTéƒ¨é—¨')
                    .get();
                
                const teamGrid = document.getElementById('team-grid');
                const teamSection = document.getElementById('team-section');
                
                if (usersSnapshot.size === 0) {
                    teamSection.style.display = 'none';
                    return;
                }
                
                teamSection.style.display = 'block';
                teamGrid.innerHTML = usersSnapshot.docs.map(doc => {
                    const member = doc.data();
                    const initial = (member.fullName || member.displayName || 'U').charAt(0);
                    return `
                        <div class="team-member">
                            <div class="member-avatar">${initial}</div>
                            <div class="member-name">${member.fullName || member.displayName}</div>
                            <div class="member-team">${member.technicalTeam || '-'}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½å›¢é˜Ÿæˆå‘˜å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºç®¡ç†å‘˜æ“ä½œæŒ‰é’®
        function displayAdminActions() {
            document.getElementById('actions-grid').innerHTML = `
                <button class="action-btn" onclick="window.location.href='user-management.html'">
                    <div class="action-icon">ğŸ‘¥</div>
                    <div class="action-content"><div class="action-title">ç”¨æˆ·ç®¡ç†</div><div class="action-desc">å®¡æ‰¹ç”¨æˆ·ã€åˆ†é…è§’è‰²</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='project-management.html'">
                    <div class="action-icon">ğŸ“</div>
                    <div class="action-content"><div class="action-title">é¡¹ç›®ç®¡ç†</div><div class="action-desc">æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰é¡¹ç›®</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='performance-stats.html'">
                    <div class="action-icon">ğŸ’°</div>
                    <div class="action-content"><div class="action-title">ä¸šç»©ç»Ÿè®¡</div><div class="action-desc">å”®å‰å”®åä¸šç»©åˆ†æ</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='create-work-record.html'">
                    <div class="action-icon">âœï¸</div>
                    <div class="action-content"><div class="action-title">åˆ›å»ºå·¥ä½œè®°å½•</div><div class="action-desc">è®°å½•ä»Šå¤©çš„å·¥ä½œ</div></div>
                </button>
                <button class="action-btn secondary" onclick="window.location.href='work-records-list.html'">
                    <div class="action-icon">ğŸ“‹</div>
                    <div class="action-content"><div class="action-title">æŸ¥çœ‹å·¥ä½œè®°å½•</div><div class="action-desc">æµè§ˆæ‰€æœ‰è®°å½•</div></div>
                </button>
                <button class="action-btn secondary" onclick="window.location.href='weekly-report-generator.html'">
                    <div class="action-icon">ğŸ“§</div>
                    <div class="action-content"><div class="action-title">ç”Ÿæˆå‘¨æŠ¥ç®€æŠ¥</div><div class="action-desc">ä¸€é”®ç”Ÿæˆå‘¨æŠ¥</div></div>
                </button>
            `;
        }

        // æ˜¾ç¤ºéƒ¨é—¨é¢†å¯¼æ“ä½œæŒ‰é’®
        function displayTeamLeadActions() {
            document.getElementById('actions-grid').innerHTML = `
                <button class="action-btn" onclick="window.location.href='project-management.html'">
                    <div class="action-icon">ğŸ“</div>
                    <div class="action-content"><div class="action-title">é¡¹ç›®ç®¡ç†</div><div class="action-desc">æŸ¥çœ‹æ‰€æœ‰é¡¹ç›®</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='performance-stats.html'">
                    <div class="action-icon">ğŸ’°</div>
                    <div class="action-content"><div class="action-title">ä¸šç»©ç»Ÿè®¡</div><div class="action-desc">å”®å‰å”®åä¸šç»©åˆ†æ</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='data-analytics.html'">
                    <div class="action-icon">ğŸ“Š</div>
                    <div class="action-content"><div class="action-title">æ•°æ®åˆ†æ</div><div class="action-desc">å¤šç»´åº¦æŠ¥è¡¨åˆ†æ</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='create-work-record.html'">
                    <div class="action-icon">âœï¸</div>
                    <div class="action-content"><div class="action-title">åˆ›å»ºå·¥ä½œè®°å½•</div><div class="action-desc">è®°å½•å·¥ä½œå†…å®¹</div></div>
                </button>
                <button class="action-btn secondary" onclick="window.location.href='work-records-list.html'">
                    <div class="action-icon">ğŸ“‹</div>
                    <div class="action-content"><div class="action-title">æŸ¥çœ‹å›¢é˜Ÿè®°å½•</div><div class="action-desc">æŸ¥çœ‹æ‰€æœ‰æˆå‘˜æ•°æ®</div></div>
                </button>
                <button class="action-btn secondary" onclick="window.location.href='weekly-report-generator.html'">
                    <div class="action-icon">ğŸ“§</div>
                    <div class="action-content"><div class="action-title">ç”Ÿæˆå‘¨æŠ¥ç®€æŠ¥</div><div class="action-desc">ä¸€é”®ç”Ÿæˆå‘¨æŠ¥</div></div>
                </button>
            `;
        }

        // æ˜¾ç¤ºå·¥ç¨‹å¸ˆæ“ä½œæŒ‰é’®
        function displayEngineerActions() {
            document.getElementById('actions-grid').innerHTML = `
                <button class="action-btn" onclick="window.location.href='project-management.html'">
                    <div class="action-icon">ğŸ“</div>
                    <div class="action-content"><div class="action-title">æˆ‘çš„é¡¹ç›®</div><div class="action-desc">æŸ¥çœ‹å‚ä¸çš„é¡¹ç›®</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='performance-stats.html'">
                    <div class="action-icon">ğŸ’°</div>
                    <div class="action-content"><div class="action-title">æˆ‘çš„ä¸šç»©</div><div class="action-desc">ä¸ªäººä¸šç»©ç»Ÿè®¡</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='data-analytics.html'">
                    <div class="action-icon">ğŸ“Š</div>
                    <div class="action-content"><div class="action-title">æˆ‘çš„æ•°æ®</div><div class="action-desc">å·¥æ—¶ç»Ÿè®¡åˆ†æ</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='create-work-record.html'">
                    <div class="action-icon">âœï¸</div>
                    <div class="action-content"><div class="action-title">åˆ›å»ºå·¥ä½œè®°å½•</div><div class="action-desc">è®°å½•ä»Šå¤©çš„å·¥ä½œ</div></div>
                </button>
                <button class="action-btn secondary" onclick="window.location.href='work-records-list.html'">
                    <div class="action-icon">ğŸ“‹</div>
                    <div class="action-content"><div class="action-title">æˆ‘çš„å·¥ä½œè®°å½•</div><div class="action-desc">æŸ¥çœ‹å†å²è®°å½•</div></div>
                </button>
                <button class="action-btn secondary" onclick="window.location.href='weekly-report-generator.html'">
                    <div class="action-icon">ğŸ“§</div>
                    <div class="action-content"><div class="action-title">ç”Ÿæˆå‘¨æŠ¥ç®€æŠ¥</div><div class="action-desc">ä¸€é”®ç”Ÿæˆå‘¨æŠ¥</div></div>
                </button>
            `;
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                try {
                    await auth.signOut();
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                    alert('é€€å‡ºå¤±è´¥: ' + error.message);
                }
            }
        }
    </script>
</body>
</html>
