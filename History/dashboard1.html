<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - å·¥ç¨‹å¸ˆå·¥æ—¶ç³»ç»Ÿ</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebaseåˆå§‹åŒ–æ¨¡å— -->
    <script src="js/firebase-init.js"></script>
    
    <!-- è´§å¸è½¬æ¢æ¨¡å— -->
    <script src="js/currency-converter.js"></script>
    
    <!-- é‡‘é¢æ ¼å¼åŒ–æ¨¡å— -->
    <script src="js/amount-formatter.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f5f7fa; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { font-size: 32px; }
        .logo-text h1 { font-size: 20px; margin-bottom: 3px; }
        .logo-text p { font-size: 12px; opacity: 0.9; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; border: 3px solid white; object-fit: cover; }
        .user-avatar-placeholder { width: 45px; height: 45px; border-radius: 50%; background: white; color: #667eea; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; border: 3px solid white; }
        .user-details { text-align: right; }
        .user-name { font-weight: 600; margin-bottom: 3px; }
        .user-role { font-size: 12px; opacity: 0.9; }
        .role-badge { display: inline-block; padding: 3px 10px; background: rgba(255,255,255,0.2); border-radius: 12px; font-size: 11px; margin-left: 8px; }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 8px 20px; border-radius: 20px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 600; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        
        /* æé†’é€šçŸ¥ */
        .alert-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.3s; }
        .alert-box:hover { transform: translateX(5px); box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3); }
        .alert-icon { font-size: 24px; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: 600; color: #856404; margin-bottom: 3px; }
        .alert-text { font-size: 13px; color: #856404; }
        
        /* æ¬¢è¿å¡ç‰‡ */
        .welcome-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .welcome-card h2 { color: #333; font-size: 24px; margin-bottom: 8px; }
        .welcome-card p { color: #666; font-size: 14px; }
        .week-info { display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; margin-top: 12px; }
        
        /* ç»Ÿè®¡å¡ç‰‡ - ä¼˜åŒ–ç‰ˆ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.3s; overflow: hidden; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .stat-card-header { padding: 20px 20px 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .stat-main { display: flex; align-items: center; gap: 15px; }
        .stat-icon { font-size: 36px; }
        .stat-value { font-size: 32px; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; font-size: 13px; margin-top: 2px; }
        .stat-badge { background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        
        /* å¡ç‰‡è¯¦æƒ…åŒºåŸŸ */
        .stat-details { padding: 0 20px 20px; }
        .detail-title { font-size: 12px; color: #999; margin-bottom: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .detail-list { max-height: 150px; overflow-y: auto; }
        .detail-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .detail-item:last-child { border-bottom: none; }
        .detail-name { font-size: 13px; color: #333; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 10px; }
        .detail-value { font-size: 13px; font-weight: 600; color: #667eea; white-space: nowrap; }
        .detail-bar { flex: 0 0 80px; height: 6px; background: #e5e7eb; border-radius: 3px; margin-left: 10px; overflow: hidden; }
        .detail-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .detail-bar-fill.purple { background: linear-gradient(90deg, #667eea, #764ba2); }
        .detail-bar-fill.green { background: linear-gradient(90deg, #10b981, #059669); }
        .detail-bar-fill.orange { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .detail-bar-fill.blue { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        
        /* ç©ºçŠ¶æ€ */
        .empty-detail { text-align: center; padding: 20px 0; color: #999; font-size: 13px; }
        
        /* å®¢æˆ·åˆ—è¡¨ç‰¹æ®Šæ ·å¼ */
        .customer-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .customer-tag { background: #f3f4f6; color: #374151; padding: 5px 12px; border-radius: 15px; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .customer-tag .hours { color: #667eea; font-weight: 600; }
        
        /* å¿«é€Ÿæ“ä½œ */
        .actions-section { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .actions-section h3 { color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .action-btn { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 12px; text-align: left; }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        .action-btn.secondary { background: linear-gradient(135deg, #f5f7fa 0%, #e7eaf0 100%); color: #667eea; border: 2px solid #667eea; }
        .action-btn.secondary:hover { background: linear-gradient(135deg, #e7eaf0 0%, #d8dce5 100%); }
        .action-icon { font-size: 24px; }
        .action-content { flex: 1; }
        .action-title { font-size: 16px; margin-bottom: 3px; }
        .action-desc { font-size: 12px; opacity: 0.9; }
        
        /* å›¢é˜Ÿæˆå‘˜ */
        .team-section { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .team-section h3 { color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .team-member { background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center; transition: all 0.3s; cursor: pointer; }
        .team-member:hover { background: #e7eaf0; transform: translateY(-3px); }
        .member-avatar { width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 12px; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px; }
        .member-name { font-weight: 600; color: #333; margin-bottom: 5px; font-size: 14px; }
        .member-team { font-size: 12px; color: #666; }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading { text-align: center; padding: 100px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .detail-list::-webkit-scrollbar { width: 4px; }
        .detail-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 2px; }
        .detail-list::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 2px; }
        .detail-list::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 15px; text-align: center; }
            .user-info { flex-direction: column; }
            .user-details { text-align: center; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">ğŸ•</div>
                <div class="logo-text">
                    <h1>å·¥ç¨‹å¸ˆå·¥æ—¶ç³»ç»Ÿ</h1>
                    <p>China Telecom (Europe) ICTéƒ¨é—¨</p>
                </div>
            </div>
            <div class="user-info">
                <div id="user-avatar-container"></div>
                <div class="user-details">
                    <div class="user-name">
                        <span id="user-name">åŠ è½½ä¸­...</span>
                        <span class="role-badge" id="user-role-badge">-</span>
                    </div>
                    <div class="user-role" id="user-team">-</div>
                </div>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½ä¸­ -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>æ­£åœ¨åŠ è½½...</div>
    </div>
    
    <!-- ä¸»å†…å®¹ -->
    <div id="main-content" class="container" style="display: none;">
        <!-- ç®¡ç†å‘˜æé†’ -->
        <div id="admin-alert" style="display: none;"></div>
        
        <!-- æ¬¢è¿å¡ç‰‡ -->
        <div class="welcome-card">
            <h2 id="welcome-title">æ¬¢è¿å›æ¥ï¼</h2>
            <p id="welcome-subtitle">-</p>
            <div class="week-info" id="week-info">ğŸ“… æœ¬å‘¨æ•°æ®åŠ è½½ä¸­...</div>
        </div>
        
        <!-- ç»Ÿè®¡æ•°æ® -->
        <div class="stats-grid" id="stats-grid">
            <!-- åŠ¨æ€åŠ è½½ç»Ÿè®¡å¡ç‰‡ -->
        </div>
        
        <!-- å›¢é˜Ÿæˆå‘˜ -->
        <div id="team-section" class="team-section" style="display: none;">
            <h3>ğŸ‘¥ å›¢é˜Ÿæˆå‘˜</h3>
            <div class="team-grid" id="team-grid"></div>
        </div>
        
        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="actions-section">
            <h3>âš¡ å¿«é€Ÿæ“ä½œ</h3>
            <div class="actions-grid" id="actions-grid"></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let userData = null;

        // è·å–æœ¬å‘¨çš„èµ·æ­¢æ—¥æœŸ
        function getWeekRange() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const monday = new Date(now);
            monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            monday.setHours(0, 0, 0, 0);
            
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            sunday.setHours(23, 59, 59, 999);
            
            return { start: monday, end: sunday };
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
        function formatDateRange(start, end) {
            const formatDate = (d) => `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
            return `${formatDate(start)} - ${formatDate(end)}`;
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
            } else {
                window.location.href = 'index.html';
            }
        });

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (!userDoc.exists) {
                    alert('ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = 'index.html';
                    return;
                }
                
                userData = userDoc.data();
                
                if (userData.status !== 'approved') {
                    if (userData.status === 'pending') {
                        window.location.href = 'pending-approval.html';
                    } else {
                        alert('è´¦å·çŠ¶æ€å¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
                        await auth.signOut();
                        window.location.href = 'index.html';
                    }
                    return;
                }
                
                displayUserInfo();
                await loadDashboardByRole();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function displayUserInfo() {
            const userName = userData.fullName || userData.displayName || 'ç”¨æˆ·';
            const userTeam = userData.technicalTeam ? `${userData.technicalTeam}å›¢é˜Ÿ` : 'ICTéƒ¨é—¨';
            
            document.getElementById('user-name').textContent = userName;
            document.getElementById('user-team').textContent = userTeam;
            
            const roleMap = { 'admin': 'ç®¡ç†å‘˜', 'team_lead': 'éƒ¨é—¨é¢†å¯¼', 'engineer': 'å·¥ç¨‹å¸ˆ' };
            document.getElementById('user-role-badge').textContent = roleMap[userData.role] || 'ç”¨æˆ·';
            
            const avatarContainer = document.getElementById('user-avatar-container');
            if (userData.photoURL || currentUser.photoURL) {
                avatarContainer.innerHTML = `<img src="${userData.photoURL || currentUser.photoURL}" class="user-avatar" alt="Avatar">`;
            } else {
                avatarContainer.innerHTML = `<div class="user-avatar-placeholder">${userName.charAt(0)}</div>`;
            }
            
            // æ˜¾ç¤ºæœ¬å‘¨æ—¥æœŸèŒƒå›´
            const weekRange = getWeekRange();
            document.getElementById('week-info').textContent = `ğŸ“… æœ¬å‘¨: ${formatDateRange(weekRange.start, weekRange.end)}`;
        }

        // æ ¹æ®è§’è‰²åŠ è½½Dashboard
        async function loadDashboardByRole() {
            const role = userData.role;
            if (role === 'admin') {
                await loadAdminDashboard();
            } else if (role === 'team_lead') {
                await loadTeamLeadDashboard();
            } else {
                await loadEngineerDashboard();
            }
        }

        // ç®¡ç†å‘˜Dashboard
        async function loadAdminDashboard() {
            document.getElementById('welcome-title').textContent = `æ¬¢è¿ï¼Œ${userData.fullName || 'ç®¡ç†å‘˜'}ï¼`;
            document.getElementById('welcome-subtitle').textContent = 'ç³»ç»Ÿç®¡ç†å‘˜ - å®Œæ•´æƒé™';
            await checkPendingUsers();
            await loadAdminStats();
            await loadAllMembers();
            displayAdminActions();
        }

        // éƒ¨é—¨é¢†å¯¼Dashboard
        async function loadTeamLeadDashboard() {
            document.getElementById('welcome-title').textContent = `ä½ å¥½ï¼Œ${userData.fullName || 'é¢†å¯¼'}ï¼`;
            document.getElementById('welcome-subtitle').textContent = `${userData.technicalTeam || 'ICT'}å›¢é˜Ÿè´Ÿè´£äºº`;
            await loadTeamLeadStats();
            await loadAllMembers();
            displayTeamLeadActions();
        }

        // å·¥ç¨‹å¸ˆDashboard
        async function loadEngineerDashboard() {
            document.getElementById('welcome-title').textContent = `ä½ å¥½ï¼Œ${userData.fullName || userData.displayName}ï¼`;
            document.getElementById('welcome-subtitle').textContent = `${userData.technicalTeam || 'ICT'}å›¢é˜Ÿå·¥ç¨‹å¸ˆ`;
            await loadPersonalStats();
            displayEngineerActions();
        }

        // æ£€æŸ¥å¾…å®¡æ‰¹ç”¨æˆ·
        async function checkPendingUsers() {
            try {
                const pendingSnapshot = await db.collection('users').where('status', '==', 'pending').get();
                if (pendingSnapshot.size > 0) {
                    document.getElementById('admin-alert').style.display = 'block';
                    document.getElementById('admin-alert').innerHTML = `
                        <div class="alert-box" onclick="window.location.href='user-management.html'">
                            <div class="alert-icon">âš ï¸</div>
                            <div class="alert-content">
                                <div class="alert-title">æœ‰ ${pendingSnapshot.size} ä¸ªç”¨æˆ·ç­‰å¾…å®¡æ‰¹</div>
                                <div class="alert-text">ç‚¹å‡»æŸ¥çœ‹å¹¶å¤„ç†å¾…å®¡æ‰¹ç”¨æˆ·</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('æ£€æŸ¥å¾…å®¡æ‰¹ç”¨æˆ·å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç®¡ç†å‘˜ç»Ÿè®¡
        async function loadAdminStats() {
            try {
                const weekRange = getWeekRange();
                
                // è·å–æœ¬å‘¨å·¥ä½œè®°å½•
                const recordsSnapshot = await db.collection('workRecords')
                    .where('startDateTime', '>=', weekRange.start.toISOString())
                    .where('startDateTime', '<=', weekRange.end.toISOString())
                    .get();
                
                // ç»Ÿè®¡æ•°æ®
                let totalHours = 0;
                let normalHours = 0;
                let overtimeHours = 0;
                const customerHours = {};
                const projectHours = {};
                const engineerHours = {};
                
                recordsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const hours = data.totalWorkingHours || 0;
                    totalHours += hours;
                    normalHours += data.normalWorkingHours || 0;
                    overtimeHours += data.overtimeHours || 0;
                    
                    // æŒ‰å®¢æˆ·ç»Ÿè®¡
                    const customer = data.customerName || 'æœªçŸ¥å®¢æˆ·';
                    customerHours[customer] = (customerHours[customer] || 0) + hours;
                    
                    // æŒ‰é¡¹ç›®ç»Ÿè®¡
                    const project = data.projectName || 'æœªçŸ¥é¡¹ç›®';
                    projectHours[project] = (projectHours[project] || 0) + hours;
                    
                    // æŒ‰å·¥ç¨‹å¸ˆç»Ÿè®¡
                    const engineer = data.userName || 'æœªçŸ¥';
                    engineerHours[engineer] = (engineerHours[engineer] || 0) + hours;
                });
                
                // æ’åºå¹¶å–å‰5
                const sortedCustomers = Object.entries(customerHours).sort((a, b) => b[1] - a[1]);
                const sortedProjects = Object.entries(projectHours).sort((a, b) => b[1] - a[1]);
                const sortedEngineers = Object.entries(engineerHours).sort((a, b) => b[1] - a[1]);
                
                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = `
                    ${createStatCard('ğŸ“‹', recordsSnapshot.size, 'æœ¬å‘¨å·¥ä½œè®°å½•', 'purple', sortedProjects, totalHours, 'é¡¹ç›®å·¥æ—¶åˆ†å¸ƒ')}
                    ${createStatCard('â°', totalHours.toFixed(1), 'æœ¬å‘¨æ€»å·¥æ—¶', 'blue', sortedEngineers, totalHours, 'å·¥ç¨‹å¸ˆå·¥æ—¶æ’å')}
                    ${createStatCard('â˜€ï¸', normalHours.toFixed(1), 'æ­£å¸¸å·¥æ—¶', 'green', null, null, null)}
                    ${createStatCard('ğŸŒ™', overtimeHours.toFixed(1), 'åŠ ç­å·¥æ—¶', 'orange', null, null, null)}
                    ${createCustomerCard(sortedCustomers, totalHours)}
                `;
            } catch (error) {
                console.error('åŠ è½½ç®¡ç†å‘˜ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // åŠ è½½éƒ¨é—¨é¢†å¯¼ç»Ÿè®¡
        async function loadTeamLeadStats() {
            try {
                const weekRange = getWeekRange();
                
                // è·å–å›¢é˜Ÿæˆå‘˜
                const teamMembers = await db.collection('users')
                    .where('status', '==', 'approved')
                    .where('department', '==', 'ICTéƒ¨é—¨')
                    .get();
                
                const memberIds = teamMembers.docs.map(doc => doc.id);
                
                // è·å–æœ¬å‘¨å›¢é˜Ÿå·¥ä½œè®°å½•
                let allRecords = [];
                for (const memberId of memberIds) {
                    const records = await db.collection('workRecords')
                        .where('userId', '==', memberId)
                        .where('startDateTime', '>=', weekRange.start.toISOString())
                        .where('startDateTime', '<=', weekRange.end.toISOString())
                        .get();
                    allRecords = allRecords.concat(records.docs);
                }
                
                let totalHours = 0;
                let normalHours = 0;
                let overtimeHours = 0;
                const customerHours = {};
                const projectHours = {};
                
                allRecords.forEach(doc => {
                    const data = doc.data();
                    const hours = data.totalWorkingHours || 0;
                    totalHours += hours;
                    normalHours += data.normalWorkingHours || 0;
                    overtimeHours += data.overtimeHours || 0;
                    
                    const customer = data.customerName || 'æœªçŸ¥å®¢æˆ·';
                    customerHours[customer] = (customerHours[customer] || 0) + hours;
                    
                    const project = data.projectName || 'æœªçŸ¥é¡¹ç›®';
                    projectHours[project] = (projectHours[project] || 0) + hours;
                });
                
                const sortedCustomers = Object.entries(customerHours).sort((a, b) => b[1] - a[1]);
                const sortedProjects = Object.entries(projectHours).sort((a, b) => b[1] - a[1]);
                
                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = `
                    ${createStatCard('ğŸ‘¥', teamMembers.size, 'å›¢é˜Ÿæˆå‘˜', 'purple', null, null, null)}
                    ${createStatCard('ğŸ“‹', allRecords.length, 'æœ¬å‘¨å·¥ä½œè®°å½•', 'blue', sortedProjects, totalHours, 'é¡¹ç›®å·¥æ—¶åˆ†å¸ƒ')}
                    ${createStatCard('â°', totalHours.toFixed(1), 'å›¢é˜Ÿæ€»å·¥æ—¶', 'green', null, null, null)}
                    ${createCustomerCard(sortedCustomers, totalHours)}
                `;
            } catch (error) {
                console.error('åŠ è½½å›¢é˜Ÿç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // åŠ è½½ä¸ªäººç»Ÿè®¡ï¼ˆå·¥ç¨‹å¸ˆï¼‰- æœ¬å‘¨æ•°æ®
        async function loadPersonalStats() {
            try {
                const weekRange = getWeekRange();
                
                // è·å–æœ¬å‘¨ä¸ªäººå·¥ä½œè®°å½•
                const recordsSnapshot = await db.collection('workRecords')
                    .where('userId', '==', currentUser.uid)
                    .where('startDateTime', '>=', weekRange.start.toISOString())
                    .where('startDateTime', '<=', weekRange.end.toISOString())
                    .get();
                
                let totalHours = 0;
                let normalHours = 0;
                let overtimeHours = 0;
                const customerHours = {};
                const projectHours = {};
                
                recordsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const hours = data.totalWorkingHours || 0;
                    totalHours += hours;
                    normalHours += data.normalWorkingHours || 0;
                    overtimeHours += data.overtimeHours || 0;
                    
                    const customer = data.customerName || 'æœªçŸ¥å®¢æˆ·';
                    customerHours[customer] = (customerHours[customer] || 0) + hours;
                    
                    const project = data.projectName || 'æœªçŸ¥é¡¹ç›®';
                    projectHours[project] = (projectHours[project] || 0) + hours;
                });
                
                const sortedCustomers = Object.entries(customerHours).sort((a, b) => b[1] - a[1]);
                const sortedProjects = Object.entries(projectHours).sort((a, b) => b[1] - a[1]);
                
                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = `
                    ${createStatCard('ğŸ“‹', recordsSnapshot.size, 'æœ¬å‘¨å·¥ä½œè®°å½•', 'purple', sortedProjects, totalHours, 'é¡¹ç›®å·¥æ—¶åˆ†å¸ƒ')}
                    ${createStatCard('â°', totalHours.toFixed(1), 'æœ¬å‘¨æ€»å·¥æ—¶', 'blue', null, null, null)}
                    ${createStatCard('â˜€ï¸', normalHours.toFixed(1), 'æ­£å¸¸å·¥æ—¶', 'green', null, null, null)}
                    ${createStatCard('ğŸŒ™', overtimeHours.toFixed(1), 'åŠ ç­å·¥æ—¶', 'orange', null, null, null)}
                    ${createCustomerCard(sortedCustomers, totalHours)}
                `;
            } catch (error) {
                console.error('åŠ è½½ä¸ªäººç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // åˆ›å»ºç»Ÿè®¡å¡ç‰‡ï¼ˆå¸¦è¯¦æƒ…ï¼‰
        function createStatCard(icon, value, label, color, details, total, detailTitle) {
            let detailsHtml = '';
            if (details && details.length > 0 && total > 0) {
                const items = details.slice(0, 5).map(([name, hours]) => {
                    const percent = ((hours / total) * 100).toFixed(0);
                    return `
                        <div class="detail-item">
                            <span class="detail-name" title="${name}">${name}</span>
                            <span class="detail-value">${hours.toFixed(1)}h</span>
                            <div class="detail-bar">
                                <div class="detail-bar-fill ${color}" style="width: ${percent}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                detailsHtml = `
                    <div class="stat-details">
                        <div class="detail-title">${detailTitle}</div>
                        <div class="detail-list">${items}</div>
                    </div>
                `;
            }
            
            return `
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-main">
                            <div class="stat-icon">${icon}</div>
                            <div>
                                <div class="stat-value">${value}</div>
                                <div class="stat-label">${label}</div>
                            </div>
                        </div>
                        ${details ? `<span class="stat-badge">æœ¬å‘¨</span>` : ''}
                    </div>
                    ${detailsHtml}
                </div>
            `;
        }

        // åˆ›å»ºå®¢æˆ·å¡ç‰‡ï¼ˆç‰¹æ®Šæ ·å¼ï¼‰
        function createCustomerCard(customers, totalHours) {
            let content = '';
            if (customers.length === 0) {
                content = '<div class="empty-detail">æœ¬å‘¨æš‚æ— å·¥ä½œè®°å½•</div>';
            } else {
                const tags = customers.map(([name, hours]) => {
                    const percent = totalHours > 0 ? ((hours / totalHours) * 100).toFixed(0) : 0;
                    return `<span class="customer-tag">${name} <span class="hours">${hours.toFixed(1)}h (${percent}%)</span></span>`;
                }).join('');
                content = `<div class="customer-list">${tags}</div>`;
            }
            
            return `
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-main">
                            <div class="stat-icon">ğŸ¢</div>
                            <div>
                                <div class="stat-value">${customers.length}</div>
                                <div class="stat-label">æœ¬å‘¨æ”¯æŒå®¢æˆ·</div>
                            </div>
                        </div>
                        <span class="stat-badge">æœ¬å‘¨</span>
                    </div>
                    <div class="stat-details">
                        <div class="detail-title">å®¢æˆ·åŠå·¥æ—¶æ˜ç»†</div>
                        ${content}
                    </div>
                </div>
            `;
        }

        // åŠ è½½æ‰€æœ‰æˆå‘˜
        async function loadAllMembers() {
            try {
                const usersSnapshot = await db.collection('users')
                    .where('status', '==', 'approved')
                    .where('department', '==', 'ICTéƒ¨é—¨')
                    .get();
                
                const teamGrid = document.getElementById('team-grid');
                const teamSection = document.getElementById('team-section');
                
                if (usersSnapshot.size === 0) {
                    teamSection.style.display = 'none';
                    return;
                }
                
                teamSection.style.display = 'block';
                teamGrid.innerHTML = usersSnapshot.docs.map(doc => {
                    const member = doc.data();
                    const initial = (member.fullName || member.displayName || 'U').charAt(0);
                    return `
                        <div class="team-member">
                            <div class="member-avatar">${initial}</div>
                            <div class="member-name">${member.fullName || member.displayName}</div>
                            <div class="member-team">${member.technicalTeam || '-'}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½å›¢é˜Ÿæˆå‘˜å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºç®¡ç†å‘˜æ“ä½œæŒ‰é’®
        function displayAdminActions() {
            document.getElementById('actions-grid').innerHTML = `
                <button class="action-btn" onclick="window.location.href='user-management.html'">
                    <div class="action-icon">ğŸ‘¥</div>
                    <div class="action-content"><div class="action-title">ç”¨æˆ·ç®¡ç†</div><div class="action-desc">å®¡æ‰¹ç”¨æˆ·ã€åˆ†é…è§’è‰²</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='project-management.html'">
                    <div class="action-icon">ğŸ“</div>
                    <div class="action-content"><div class="action-title">é¡¹ç›®ç®¡ç†</div><div class="action-desc">æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰é¡¹ç›®</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='performance-stats.html'">
                    <div class="action-icon">ğŸ’°</div>
                    <div class="action-content"><div class="action-title">ä¸šç»©ç»Ÿè®¡</div><div class="action-desc">å”®å‰å”®åä¸šç»©åˆ†æ</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='create-work-record.html'">
                    <div class="action-icon">âœï¸</div>
                    <div class="action-content"><div class="action-title">åˆ›å»ºå·¥ä½œè®°å½•</div><div class="action-desc">è®°å½•ä»Šå¤©çš„å·¥ä½œ</div></div>
                </button>
                <button class="action-btn secondary" onclick="window.location.href='work-records-list.html'">
                    <div class="action-icon">ğŸ“‹</div>
                    <div class="action-content"><div class="action-title">æŸ¥çœ‹å·¥ä½œè®°å½•</div><div class="action-desc">æµè§ˆæ‰€æœ‰è®°å½•</div></div>
                </button>
                <button class="action-btn secondary" onclick="window.location.href='weekly-report-generator.html'">
                    <div class="action-icon">ğŸ“§</div>
                    <div class="action-content"><div class="action-title">ç”Ÿæˆå‘¨æŠ¥ç®€æŠ¥</div><div class="action-desc">ä¸€é”®ç”Ÿæˆå‘¨æŠ¥</div></div>
                </button>
            `;
        }

        // æ˜¾ç¤ºéƒ¨é—¨é¢†å¯¼æ“ä½œæŒ‰é’®
        function displayTeamLeadActions() {
            document.getElementById('actions-grid').innerHTML = `
                <button class="action-btn" onclick="window.location.href='project-management.html'">
                    <div class="action-icon">ğŸ“</div>
                    <div class="action-content"><div class="action-title">é¡¹ç›®ç®¡ç†</div><div class="action-desc">æŸ¥çœ‹æ‰€æœ‰é¡¹ç›®</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='performance-stats.html'">
                    <div class="action-icon">ğŸ’°</div>
                    <div class="action-content"><div class="action-title">ä¸šç»©ç»Ÿè®¡</div><div class="action-desc">å”®å‰å”®åä¸šç»©åˆ†æ</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='data-analytics.html'">
                    <div class="action-icon">ğŸ“Š</div>
                    <div class="action-content"><div class="action-title">æ•°æ®åˆ†æ</div><div class="action-desc">å¤šç»´åº¦æŠ¥è¡¨åˆ†æ</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='create-work-record.html'">
                    <div class="action-icon">âœï¸</div>
                    <div class="action-content"><div class="action-title">åˆ›å»ºå·¥ä½œè®°å½•</div><div class="action-desc">è®°å½•å·¥ä½œå†…å®¹</div></div>
                </button>
                <button class="action-btn secondary" onclick="window.location.href='work-records-list.html'">
                    <div class="action-icon">ğŸ“‹</div>
                    <div class="action-content"><div class="action-title">æŸ¥çœ‹å›¢é˜Ÿè®°å½•</div><div class="action-desc">æŸ¥çœ‹æ‰€æœ‰æˆå‘˜æ•°æ®</div></div>
                </button>
                <button class="action-btn secondary" onclick="window.location.href='weekly-report-generator.html'">
                    <div class="action-icon">ğŸ“§</div>
                    <div class="action-content"><div class="action-title">ç”Ÿæˆå‘¨æŠ¥ç®€æŠ¥</div><div class="action-desc">ä¸€é”®ç”Ÿæˆå‘¨æŠ¥</div></div>
                </button>
            `;
        }

        // æ˜¾ç¤ºå·¥ç¨‹å¸ˆæ“ä½œæŒ‰é’®
        function displayEngineerActions() {
            document.getElementById('actions-grid').innerHTML = `
                <button class="action-btn" onclick="window.location.href='project-management.html'">
                    <div class="action-icon">ğŸ“</div>
                    <div class="action-content"><div class="action-title">æˆ‘çš„é¡¹ç›®</div><div class="action-desc">æŸ¥çœ‹å‚ä¸çš„é¡¹ç›®</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='performance-stats.html'">
                    <div class="action-icon">ğŸ’°</div>
                    <div class="action-content"><div class="action-title">æˆ‘çš„ä¸šç»©</div><div class="action-desc">ä¸ªäººä¸šç»©ç»Ÿè®¡</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='data-analytics.html'">
                    <div class="action-icon">ğŸ“Š</div>
                    <div class="action-content"><div class="action-title">æˆ‘çš„æ•°æ®</div><div class="action-desc">å·¥æ—¶ç»Ÿè®¡åˆ†æ</div></div>
                </button>
                <button class="action-btn" onclick="window.location.href='create-work-record.html'">
                    <div class="action-icon">âœï¸</div>
                    <div class="action-content"><div class="action-title">åˆ›å»ºå·¥ä½œè®°å½•</div><div class="action-desc">è®°å½•ä»Šå¤©çš„å·¥ä½œ</div></div>
                </button>
                <button class="action-btn secondary" onclick="window.location.href='work-records-list.html'">
                    <div class="action-icon">ğŸ“‹</div>
                    <div class="action-content"><div class="action-title">æˆ‘çš„å·¥ä½œè®°å½•</div><div class="action-desc">æŸ¥çœ‹å†å²è®°å½•</div></div>
                </button>
                <button class="action-btn secondary" onclick="window.location.href='weekly-report-generator.html'">
                    <div class="action-icon">ğŸ“§</div>
                    <div class="action-content"><div class="action-title">ç”Ÿæˆå‘¨æŠ¥ç®€æŠ¥</div><div class="action-desc">ä¸€é”®ç”Ÿæˆå‘¨æŠ¥</div></div>
                </button>
            `;
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                try {
                    await auth.signOut();
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                    alert('é€€å‡ºå¤±è´¥: ' + error.message);
                }
            }
        }
    </script>
</body>
</html>
