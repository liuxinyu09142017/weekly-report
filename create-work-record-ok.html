<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºå·¥ä½œè®°å½• - å·¥ç¨‹å¸ˆå·¥æ—¶ç³»ç»Ÿ</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- å›½å®¶åˆ—è¡¨æ¨¡å— -->
    <script src="js/countries-list.js"></script>
    <script src="js/project-stages.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            padding-bottom: 50px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        /* é¡¹ç›®é€‰æ‹©æç¤ºæ¡† */
        .project-notice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .project-notice h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .project-notice p {
            opacity: 0.9;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* é¡¹ç›®åŒ¹é…æç¤º */
        .project-match-alert {
            display: none;
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            animation: slideIn 0.3s ease;
        }
        
        .project-match-alert.show {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .match-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .match-icon {
            font-size: 32px;
        }
        
        .match-title {
            font-size: 18px;
            font-weight: bold;
            color: #856404;
        }
        
        .match-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .match-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .match-item:last-child {
            border-bottom: none;
        }
        
        .match-label {
            color: #666;
            font-weight: 600;
        }
        
        .match-value {
            color: #333;
        }
        
        .match-actions {
            display: flex;
            gap: 12px;
        }
        
        .match-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-use-project {
            background: #28a745;
            color: white;
        }
        
        .btn-use-project:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .btn-create-new {
            background: white;
            color: #856404;
            border: 2px solid #ffc107;
        }
        
        .btn-create-new:hover {
            background: #fff8e1;
        }
        
        .form-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .form-card h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .form-subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .form-section {
            margin-bottom: 35px;
            border-left: 4px solid #667eea;
            padding-left: 20px;
        }
        
        .form-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row.single {
            grid-template-columns: 1fr;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-label {
            color: #333;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .required {
            color: #f48771;
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-input:disabled,
        .form-select:disabled {
            background: #f5f7fa;
            cursor: not-allowed;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .checkbox-input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-label {
            cursor: pointer;
            user-select: none;
        }
        
        .hours-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .hours-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .hour-item {
            text-align: center;
        }
        
        .hour-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .hour-label {
            font-size: 12px;
            color: #666;
        }
        
        .submit-section {
            display: flex;
            gap: 15px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e1e8ed;
        }
        
        .submit-btn {
            flex: 1;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .cancel-btn {
            padding: 18px 40px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .cancel-btn:hover {
            background: #f5f7fa;
        }
    
        /* é¡¹ç›®é˜¶æ®µåˆ†ç±»é€‰æ‹©å™¨ */
        .stage-category-selector {
            display: none;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .category-btn {
            padding: 10px 18px;
            border: 2px solid #E5E7EB;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
        }
        
        .category-btn:hover {
            border-color: #667eea;
            background: #F9FAFB;
            transform: translateY(-1px);
        }
        
        .category-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* ========== æ™ºèƒ½é¡¹ç›®æœç´¢æ ·å¼ ========== */
        .autocomplete-wrapper {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 350px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: none;
        }

        .search-results.show {
            display: block;
        }

        .results-header {
            padding: 12px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-size: 13px;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }

        .result-item:hover {
            background: #f8f9ff;
        }

        .result-item:last-child {
            border-bottom: none;
            border-radius: 0 0 10px 10px;
        }

        .result-main {
            flex: 1;
            min-width: 0;
        }

        .result-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .result-name mark {
            background: #fff3cd;
            padding: 1px 3px;
            border-radius: 3px;
            color: #333;
        }

        .result-details {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .result-customer {
            color: #667eea;
            font-weight: 500;
        }

        .result-amount {
            color: #48bb78;
            font-weight: 600;
        }

        .result-type {
            background: #e0e7ff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            color: #667eea;
        }

        .result-records {
            color: #999;
        }

        .result-check {
            color: #667eea;
            font-size: 18px;
            opacity: 0;
            transition: opacity 0.2s;
            margin-left: 10px;
        }

        .result-item:hover .result-check {
            opacity: 1;
        }

        .result-item.create-new {
            background: #f8f9ff;
            border-top: 2px solid #e0e7ff;
        }

        .result-item.create-new .result-name {
            color: #667eea;
        }

        .no-results {
            padding: 30px 20px;
            text-align: center;
        }

        .no-results-icon {
            font-size: 40px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .no-results-text {
            color: #999;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .create-new-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .create-new-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* å·²é€‰æ‹©é¡¹ç›®æç¤º */
        .selected-project-badge {
            display: none;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            align-items: center;
            justify-content: space-between;
        }

        .selected-project-badge.show {
            display: flex;
        }

        .selected-project-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .change-project-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .change-project-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* æœç´¢åŠ è½½åŠ¨ç”» */
        .search-loading {
            padding: 20px;
            text-align: center;
            color: #999;
        }

        .search-loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ç¦ç”¨å­—æ®µæ ·å¼ */
        .form-input:disabled,
        .form-select:disabled {
            background-color: #f0f0f0 !important;
            cursor: not-allowed;
            color: #666;
        }

    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="header">
        <div class="header-content">
            <h2>âœï¸ åˆ›å»ºå·¥ä½œè®°å½•</h2>
            <a href="dashboard.html" class="back-btn">â† è¿”å›ä¸»é¡µ</a>
        </div>
    </div>
    
    <div class="container">
        <!-- é¡¹ç›®é€‰æ‹©æç¤º -->
        <div class="project-notice">
            <h3>ğŸ’¡ æ™ºèƒ½é¡¹ç›®æœç´¢</h3>
            <p>è¾“å…¥é¡¹ç›®åç§°æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æœç´¢å·²æœ‰é¡¹ç›®ã€‚é€‰æ‹©å·²æœ‰é¡¹ç›®å¯ä»¥å¿«é€Ÿå¡«å……ä¿¡æ¯ï¼Œé¿å…åˆ›å»ºé‡å¤é¡¹ç›®ã€‚å¦‚æœæ˜¯æ–°é¡¹ç›®ï¼Œç›´æ¥ç‚¹å‡»"åˆ›å»ºæ–°é¡¹ç›®"ã€‚</p>
        </div>
        
        <!-- é¡¹ç›®åŒ¹é…æç¤ºæ¡† -->
        <div class="project-match-alert" id="project-match-alert">
            <div class="match-header">
                <span class="match-icon">ğŸ¯</span>
                <div>
                    <div class="match-title">æ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®ï¼</div>
                    <div style="font-size: 13px; color: #856404; margin-top: 5px;">
                        ç³»ç»Ÿæ£€æµ‹åˆ°è¯¥é¡¹ç›®å·²å­˜åœ¨ï¼Œæ‚¨å¯ä»¥é€‰æ‹©ï¼š
                    </div>
                </div>
            </div>
            
            <div class="match-content" id="match-content">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
            
            <div class="match-actions">
                <button class="match-btn btn-use-project" onclick="useExistingProject()">
                    âœ… å…³è”åˆ°æ­¤é¡¹ç›®
                </button>
                <button class="match-btn btn-create-new" onclick="createNewProject()">
                    â• åˆ›å»ºæ–°é¡¹ç›®
                </button>
            </div>
        </div>
        
        <!-- ä¸»è¡¨å• -->
        <div class="form-card">
            <h1>ğŸ“ è®°å½•ä»Šæ—¥å·¥ä½œ</h1>
            <p class="form-subtitle">å¡«å†™å·¥ä½œå†…å®¹ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®—å·¥æ—¶</p>
            
            <form id="work-record-form">
                <!-- å®¢æˆ·ä¿¡æ¯ -->
                <div class="form-section">
                    <h3>ğŸ‘¤ å®¢æˆ·ä¿¡æ¯</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                å®¢æˆ·åç§° <span class="required">*</span>
                            </label>
                            <input type="text" id="customer-name" class="form-input" 
                                   required placeholder="ä¾‹å¦‚: æ‹›å•†é“¶è¡Œ"
                                   onblur="checkExistingProject()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å®¢æˆ·è¡Œä¸š</label>
                            <select id="customer-industry" class="form-select">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="é“¶è¡Œ">é“¶è¡Œ</option>
                                <option value="ä¿é™©">ä¿é™©</option>
                                <option value="è¯åˆ¸">è¯åˆ¸</option>
                                <option value="åŸºé‡‘">åŸºé‡‘</option>
                                <option value="ä¿¡æ‰˜">ä¿¡æ‰˜</option>
                                <option value="åˆ¶é€ ä¸š">åˆ¶é€ ä¸š</option>
                                <option value="èƒ½æº">èƒ½æº</option>
                                <option value="é›¶å”®">é›¶å”®</option>
                                <option value="ç‰©æµ">ç‰©æµ</option>
                                <option value="ç”µä¿¡">ç”µä¿¡</option>
                                <option value="äº’è”ç½‘">äº’è”ç½‘</option>
                                <option value="æ•™è‚²">æ•™è‚²</option>
                                <option value="åŒ»ç–—">åŒ»ç–—</option>
                                <option value="æ”¿åºœ">æ”¿åºœ</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">å›½å®¶/åœ°åŒº</label>
                            <select id="customer-country" class="form-select">
    <!-- é€šè¿‡ countries-list.js è‡ªåŠ¨å¡«å…… -->
                           </select>
                        </div>
                    </div>
                </div>
                
                <!-- é¡¹ç›®ä¿¡æ¯ -->
                <div class="form-section">
                    <h3>ğŸ“Š é¡¹ç›®ä¿¡æ¯</h3>
                    
                    <!-- å·²é€‰æ‹©é¡¹ç›®æç¤º -->
                    <div class="selected-project-badge" id="selected-project-badge">
                        <div class="selected-project-info">
                            <span>âœ… å·²å…³è”é¡¹ç›®ï¼š</span>
                            <strong id="selected-project-name"></strong>
                            <span style="opacity: 0.8;">-</span>
                            <span id="selected-project-customer" style="opacity: 0.8;"></span>
                        </div>
                        <button type="button" class="change-project-btn" onclick="clearSelectedProject()">
                            ğŸ”„ æ›´æ¢é¡¹ç›®
                        </button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                é¡¹ç›®åç§° <span class="required">*</span>
                            </label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="project-name" class="form-input" 
                                       required placeholder="è¾“å…¥é¡¹ç›®åç§°ï¼Œç³»ç»Ÿè‡ªåŠ¨æœç´¢..."
                                       oninput="smartSearchProjects()"
                                       onfocus="onProjectNameFocus()"
                                       autocomplete="off">
                                <div class="search-results" id="search-results">
                                    <!-- åŠ¨æ€å¡«å……æœç´¢ç»“æœ -->
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                é¡¹ç›®ç±»å‹ <span class="required">*</span>
                            </label>
                            <select id="project-type" class="form-select" required 
                                    onchange="updateProjectStages()">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="å”®å‰é¡¹ç›®">å”®å‰é¡¹ç›®</option>
                                <option value="å”®åé¡¹ç›®">å”®åé¡¹ç›®</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                é¡¹ç›®é˜¶æ®µ <span class="required">*</span>
                            </label>
                            
                            <!-- é˜¶æ®µåˆ†ç±»é€‰æ‹©å™¨ï¼ˆå”®åé¡¹ç›®æ˜¾ç¤ºï¼‰ -->
                            <div class="stage-category-selector" id="stage-category-selector">
                                <button type="button" class="category-btn active" data-category="general" onclick="selectCategory('general')">
                                    ğŸ“¦ é€šç”¨é˜¶æ®µ
                                </button>
                                <button type="button" class="category-btn" data-category="network" onclick="selectCategory('network')">
                                    ğŸŒ ç½‘ç»œé¡¹ç›®
                                </button>
                                <button type="button" class="category-btn" data-category="system" onclick="selectCategory('system')">
                                    ğŸ–¥ï¸ ç³»ç»Ÿé¡¹ç›®
                                </button>
                                <button type="button" class="category-btn" data-category="infrastructure" onclick="selectCategory('infrastructure')">
                                    ğŸ¢ èƒ½åŸºé¡¹ç›®
                                </button>
                                <button type="button" class="category-btn" data-category="emergency" onclick="selectCategory('emergency')">
                                    ğŸš¨ åº”æ€¥é¡¹ç›®
                                </button>
                                <button type="button" class="category-btn" data-category="expansion" onclick="selectCategory('expansion')">
                                    ğŸ“ˆ æ‰©å®¹é¡¹ç›®
                                </button>
                                <button type="button" class="category-btn" data-category="optimization" onclick="selectCategory('optimization')">
                                    âš¡ ä¼˜åŒ–é¡¹ç›®
                                </button>
                            </div>
                            
                            <select id="project-stage" class="form-select" required>
                                <option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®ç±»å‹</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                æ”¯æŒç±»å‹ <span class="required">*</span>
                            </label>
                            <select id="support-type" class="form-select" required>
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="ç°åœºæ”¯æŒ">ç°åœºæ”¯æŒ</option>
                                <option value="è¿œç¨‹æ”¯æŒ">è¿œç¨‹æ”¯æŒ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é”€å”®äººå‘˜</label>
                            <input type="text" id="sales-person" class="form-input" 
                                   placeholder="è´Ÿè´£çš„é”€å”®äººå‘˜">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®é‡‘é¢ï¼ˆå¯é€‰ï¼‰</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="project-amount" class="form-input" 
                                       placeholder="é‡‘é¢ï¼ˆKï¼‰" style="flex: 2;">
                                <select id="project-currency" class="form-select" style="flex: 1;">
                                    <option value="GBP">GBP</option>
                                    <option value="EUR">EUR</option>
                                    <option value="USD">USD</option>
                                    <option value="CNY">CNY</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ—¶é—´ä¿¡æ¯ -->
                <div class="form-section">
                    <h3>â° æ—¶é—´ä¿¡æ¯</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                å¼€å§‹æ—¥æœŸ <span class="required">*</span>
                            </label>
                            <input type="date" id="start-date" class="form-input" required onchange="calculateHours()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                å¼€å§‹æ—¶é—´ <span class="required">*</span>
                            </label>
                            <input type="time" id="start-time" class="form-input" 
                                   required onchange="calculateHours()">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                ç»“æŸæ—¥æœŸ <span class="required">*</span>
                            </label>
                            <input type="date" id="end-date" class="form-input" required onchange="calculateHours()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                ç»“æŸæ—¶é—´ <span class="required">*</span>
                            </label>
                            <input type="time" id="end-time" class="form-input" 
                                   required onchange="calculateHours()">
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="is-holiday" class="checkbox-input" onchange="toggleHolidayType()">
                        <label for="is-holiday" class="checkbox-label">è¿™æ˜¯èŠ‚å‡æ—¥å·¥ä½œ</label>
                        <select id="holiday-type" class="form-select" style="margin-left: 20px; width: 200px; display: none;" onchange="calculateHours()">
                            <option value="">é€‰æ‹©èŠ‚å‡æ—¥ç±»å‹</option>
                            <option value="Bank Holiday">Bank Holiday</option>
                            <option value="Christmas">Christmas</option>
                            <option value="Easter">Easter</option>
                            <option value="New Year">New Year</option>
                            <option value="Custom">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <!-- å·¥æ—¶æ˜¾ç¤º -->
                    <div class="hours-display" id="hours-display" style="display: none;">
                        <div class="hours-grid">
                            <div class="hour-item">
                                <div class="hour-value" id="normal-hours">0.0</div>
                                <div class="hour-label">æ­£å¸¸å·¥æ—¶</div>
                            </div>
                            <div class="hour-item">
                                <div class="hour-value" id="overtime-hours">0.0</div>
                                <div class="hour-label">åŠ ç­å·¥æ—¶</div>
                            </div>
                            <div class="hour-item">
                                <div class="hour-value" id="total-hours">0.0</div>
                                <div class="hour-label">æ€»å·¥æ—¶</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å·¥ä½œå†…å®¹ -->
                <div class="form-section">
                    <h3>ğŸ“‹ å·¥ä½œå†…å®¹</h3>
                    <div class="form-row single">
                        <div class="form-group">
                            <label class="form-label">
                                å·¥ä½œæè¿° <span class="required">*</span>
                            </label>
                            <textarea id="work-description" class="form-textarea" 
                                      required placeholder="è¯¦ç»†æè¿°ä»Šå¤©å®Œæˆçš„å·¥ä½œå†…å®¹..."></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row single">
                        <div class="form-group">
                            <label class="form-label">ä¸‹å‘¨å·¥ä½œè®¡åˆ’</label>
                            <textarea id="next-week-plan" class="form-textarea" 
                                      placeholder="ä¸‹ä¸€æ­¥çš„å·¥ä½œè®¡åˆ’..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- æäº¤æŒ‰é’® -->
                <div class="submit-section">
                    <button type="submit" class="submit-btn" id="submit-btn">
                        âœ… ä¿å­˜å·¥ä½œè®°å½•
                    </button>
                    <button type="button" class="cancel-btn" 
                            onclick="window.location.href='dashboard.html'">
                        å–æ¶ˆ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å›½å®¶åˆ—è¡¨
    document.addEventListener('DOMContentLoaded', () => {
        populateCountrySelect('customer-country');
    });
    
    // Firebaseé…ç½®
    const firebaseConfig = {
            apiKey: "AIzaSyBzcAr_OJFdIMnaYXRCE7TJs2qlK_TAy9U",
            authDomain: "weekly-report-d55e9.firebaseapp.com",
            projectId: "weekly-report-d55e9",
            storageBucket: "weekly-report-d55e9.appspot.com",
            messagingSenderId: "315332641675",
            appId: "1:315332641675:web:e1b52c3d4c5fcc7b8c0de7"
        };

        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUser = null;
        let userData = null;
        let matchedProject = null;
        
        // ========== æ™ºèƒ½é¡¹ç›®æœç´¢ç›¸å…³å˜é‡ ==========
        let allUserProjects = [];  // ç¼“å­˜ç”¨æˆ·çš„æ‰€æœ‰é¡¹ç›®
        let searchTimeout = null;   // æœç´¢é˜²æŠ–å®šæ—¶å™¨
        let selectedProject = null; // å½“å‰é€‰æ‹©çš„é¡¹ç›®

        // é¡¹ç›®é˜¶æ®µå®šä¹‰å·²ç§»è‡³ js/project-stages.js

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                initForm();
            } else {
                window.location.href = 'index.html';
            }
        });

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–è¡¨å•
        async function initForm() {
            // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('work-date').value = today;
            
            // â­ åŠ è½½ç”¨æˆ·çš„æ‰€æœ‰é¡¹ç›®ï¼ˆç”¨äºæ™ºèƒ½æœç´¢ï¼‰
            await loadAllUserProjects();
            
            // æ£€æŸ¥URLå‚æ•°ï¼ˆä»é¡¹ç›®è¯¦æƒ…é¡µè·³è½¬è¿‡æ¥ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('projectId');
            
            if (projectId) {
                loadProjectData(projectId);
            }
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æœç´¢ç»“æœ
            document.addEventListener('click', (e) => {
                const wrapper = document.querySelector('.autocomplete-wrapper');
                const resultsDiv = document.getElementById('search-results');
                if (wrapper && !wrapper.contains(e.target)) {
                    resultsDiv.classList.remove('show');
                }
            });
        }
        
        // ========== æ™ºèƒ½é¡¹ç›®æœç´¢åŠŸèƒ½ ==========
        
        // åŠ è½½ç”¨æˆ·æ‰€æœ‰é¡¹ç›®
        async function loadAllUserProjects() {
            try {
                console.log('å¼€å§‹åŠ è½½ç”¨æˆ·é¡¹ç›®åˆ—è¡¨...');
                const snapshot = await db.collection('projects')
                    .where('createdBy', '==', currentUser.uid)
                    .orderBy('updatedAt', 'desc')
                    .get();
                
                allUserProjects = [];
                snapshot.forEach(doc => {
                    allUserProjects.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log('å·²åŠ è½½', allUserProjects.length, 'ä¸ªé¡¹ç›®');
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥:', error);
                // å¦‚æœç´¢å¼•é—®é¢˜ï¼Œå°è¯•ä¸æ’åº
                try {
                    const snapshot = await db.collection('projects')
                        .where('createdBy', '==', currentUser.uid)
                        .get();
                    
                    allUserProjects = [];
                    snapshot.forEach(doc => {
                        allUserProjects.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    console.log('(æ— æ’åº)å·²åŠ è½½', allUserProjects.length, 'ä¸ªé¡¹ç›®');
                } catch (e) {
                    console.error('å¤‡ç”¨åŠ è½½ä¹Ÿå¤±è´¥:', e);
                }
            }
        }
        
        // æ–‡æœ¬æ ‡å‡†åŒ–ï¼ˆç”¨äºæ¨¡ç³ŠåŒ¹é…ï¼‰
        function normalizeText(text) {
            if (!text) return '';
            return text
                .toLowerCase()
                .replace(/[,ï¼Œ.ã€‚;ï¼›:ï¼š!ï¼?ï¼Ÿã€\s\-_ï¼ˆï¼‰()ã€ã€‘\[\]]/g, '')
                .trim();
        }
        
        // é«˜äº®åŒ¹é…æ–‡æœ¬
        function highlightMatch(text, query) {
            if (!text || !query) return text || '';
            const regex = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }
        
        // æ™ºèƒ½æœç´¢é¡¹ç›®ï¼ˆå®æ—¶ï¼‰
        function smartSearchProjects() {
            const input = document.getElementById('project-name').value.trim();
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            clearTimeout(searchTimeout);
            
            // å¦‚æœå·²ç»é€‰æ‹©äº†é¡¹ç›®ï¼Œä¸æœç´¢
            if (selectedProject) return;
            
            // å¦‚æœè¾“å…¥å¤ªçŸ­ï¼Œéšè—ç»“æœ
            if (input.length < 1) {
                hideSearchResults();
                return;
            }
            
            // é˜²æŠ–ï¼š200msåæ‰§è¡Œæœç´¢
            searchTimeout = setTimeout(() => {
                performProjectSearch(input);
            }, 200);
        }
        
        // æ‰§è¡Œé¡¹ç›®æœç´¢
        function performProjectSearch(query) {
            const normalizedQuery = normalizeText(query);
            const resultsDiv = document.getElementById('search-results');
            
            // æ˜¾ç¤ºåŠ è½½ä¸­
            resultsDiv.innerHTML = '<div class="search-loading">æœç´¢ä¸­...</div>';
            resultsDiv.classList.add('show');
            
            // æ¨¡ç³ŠåŒ¹é…
            const results = allUserProjects.filter(project => {
                const normalizedName = normalizeText(project.projectName);
                const normalizedCustomer = normalizeText(project.customerName);
                
                return normalizedName.includes(normalizedQuery) || 
                       normalizedCustomer.includes(normalizedQuery) ||
                       (project.projectName && project.projectName.toLowerCase().includes(query.toLowerCase())) ||
                       (project.customerName && project.customerName.toLowerCase().includes(query.toLowerCase()));
            });
            
            // æŒ‰æœ€è¿‘æ›´æ–°æ’åºï¼Œé™åˆ¶ç»“æœæ•°é‡
            const topResults = results
                .sort((a, b) => {
                    const timeA = a.updatedAt?.toDate?.() || new Date(0);
                    const timeB = b.updatedAt?.toDate?.() || new Date(0);
                    return timeB - timeA;
                })
                .slice(0, 6);
            
            displaySearchResults(topResults, query);
        }
        
        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(results, query) {
            const resultsDiv = document.getElementById('search-results');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">ğŸ”</div>
                        <div class="no-results-text">æœªæ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®</div>
                        <button type="button" class="create-new-btn" onclick="confirmCreateNew()">
                            + åˆ›å»ºæ–°é¡¹ç›®
                        </button>
                    </div>
                `;
            } else {
                let html = `<div class="results-header">ğŸ” æ‰¾åˆ° ${results.length} ä¸ªåŒ¹é…é¡¹ç›®ï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰</div>`;
                
                results.forEach(project => {
                    const amount = project.projectAmount ? 
                        `<span class="result-amount">${(project.projectAmount/1000).toFixed(0)}K ${project.projectCurrency || 'GBP'}</span>` : '';
                    const records = project.totalSessions ? 
                        `<span class="result-records">${project.totalSessions}æ¡è®°å½•</span>` : '';
                    
                    html += `
                        <div class="result-item" onclick="selectSearchResult('${project.id}')">
                            <div class="result-main">
                                <div class="result-name">${highlightMatch(project.projectName, query)}</div>
                                <div class="result-details">
                                    <span class="result-customer">${project.customerName || 'æ— å®¢æˆ·'}</span>
                                    ${amount}
                                    <span class="result-type">${project.projectType || ''}</span>
                                    ${records}
                                </div>
                            </div>
                            <div class="result-check">âœ“</div>
                        </div>
                    `;
                });
                
                html += `
                    <div class="result-item create-new" onclick="confirmCreateNew()">
                        <div class="result-main">
                            <div class="result-name">+ åˆ›å»ºæ–°é¡¹ç›®</div>
                            <div class="result-details">è¾“å…¥æ–°çš„é¡¹ç›®ä¿¡æ¯</div>
                        </div>
                    </div>
                `;
                
                resultsDiv.innerHTML = html;
            }
            
            resultsDiv.classList.add('show');
        }
        
        // éšè—æœç´¢ç»“æœ
        function hideSearchResults() {
            document.getElementById('search-results').classList.remove('show');
        }
        
        // é¡¹ç›®åç§°è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹
        function onProjectNameFocus() {
            // å¦‚æœå·²ç»é€‰æ‹©äº†é¡¹ç›®ï¼Œä¸æ˜¾ç¤ºæœç´¢
            if (selectedProject) return;
            
            const input = document.getElementById('project-name').value.trim();
            if (input.length >= 1) {
                performProjectSearch(input);
            } else if (allUserProjects.length > 0) {
                // æ˜¾ç¤ºæœ€è¿‘çš„é¡¹ç›®
                displaySearchResults(allUserProjects.slice(0, 5), '');
            }
        }
        
        // é€‰æ‹©æœç´¢ç»“æœä¸­çš„é¡¹ç›®
        function selectSearchResult(projectId) {
            const project = allUserProjects.find(p => p.id === projectId);
            if (!project) {
                console.error('æ‰¾ä¸åˆ°é¡¹ç›®:', projectId);
                return;
            }
            
            selectedProject = project;
            matchedProject = project;  // å…¼å®¹åŸæœ‰é€»è¾‘
            
            // éšè—æœç´¢ç»“æœ
            hideSearchResults();
            
            // æ˜¾ç¤ºå·²é€‰æ‹©é¡¹ç›®æç¤º
            document.getElementById('selected-project-badge').classList.add('show');
            document.getElementById('selected-project-name').textContent = project.projectName;
            document.getElementById('selected-project-customer').textContent = project.customerName || '';
            
            // å¡«å……è¡¨å•
            document.getElementById('project-name').value = project.projectName;
            document.getElementById('customer-name').value = project.customerName || '';
            document.getElementById('customer-industry').value = project.customerIndustry || '';
            document.getElementById('customer-country').value = project.customerCountry || '';
            document.getElementById('project-type').value = project.projectType || '';
            
            // æ›´æ–°é¡¹ç›®é˜¶æ®µ
            updateProjectStages();
            setTimeout(() => {
                document.getElementById('project-stage').value = project.projectStage || '';
            }, 100);
            
            document.getElementById('sales-person').value = project.salesPerson || '';
            document.getElementById('project-amount').value = project.projectAmount || '';
            document.getElementById('project-currency').value = project.projectCurrency || 'GBP';
            
            // ç¦ç”¨é¡¹ç›®ç›¸å…³å­—æ®µ
            disableProjectFields();
            
            console.log('å·²é€‰æ‹©é¡¹ç›®:', project.projectName, '- ID:', project.id);
        }
        
        // ç¦ç”¨é¡¹ç›®å­—æ®µ
        function disableProjectFields() {
            const fields = [
                'customer-name', 'customer-industry', 'customer-country',
                'project-name', 'project-type', 'project-stage',
                'sales-person', 'project-amount', 'project-currency'
            ];
            
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = true;
            });
        }
        
        // å¯ç”¨é¡¹ç›®å­—æ®µ
        function enableProjectFields() {
            const fields = [
                'customer-name', 'customer-industry', 'customer-country',
                'project-name', 'project-type', 'project-stage',
                'sales-person', 'project-amount', 'project-currency'
            ];
            
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = false;
            });
        }
        
        // æ¸…é™¤å·²é€‰æ‹©çš„é¡¹ç›®
        function clearSelectedProject() {
            selectedProject = null;
            matchedProject = null;
            
            // éšè—å·²é€‰æ‹©æç¤º
            document.getElementById('selected-project-badge').classList.remove('show');
            
            // å¯ç”¨å­—æ®µ
            enableProjectFields();
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('project-name').value = '';
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-industry').value = '';
            document.getElementById('customer-country').value = '';
            document.getElementById('project-type').value = '';
            document.getElementById('project-stage').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®ç±»å‹</option>';
            document.getElementById('sales-person').value = '';
            document.getElementById('project-amount').value = '';
            document.getElementById('project-currency').value = 'GBP';
            
            // éšè—åˆ†ç±»é€‰æ‹©å™¨
            document.getElementById('stage-category-selector').style.display = 'none';
            
            // èšç„¦åˆ°é¡¹ç›®åç§°è¾“å…¥æ¡†
            document.getElementById('project-name').focus();
        }
        
        // ç¡®è®¤åˆ›å»ºæ–°é¡¹ç›®
        function confirmCreateNew() {
            hideSearchResults();
            selectedProject = null;
            matchedProject = null;
            
            // ç¡®ä¿å­—æ®µå¯ç¼–è¾‘
            enableProjectFields();
            
            // éšè—å·²é€‰æ‹©æç¤º
            document.getElementById('selected-project-badge').classList.remove('show');
        }
        
        // æŸ¥æ‰¾ç›¸ä¼¼é¡¹ç›®ï¼ˆç”¨äºä¿å­˜å‰æ£€æµ‹ï¼‰
        function findSimilarProject(projectName, customerName) {
            const normalizedName = normalizeText(projectName);
            const normalizedCustomer = normalizeText(customerName);
            
            for (const project of allUserProjects) {
                const pName = normalizeText(project.projectName);
                const pCustomer = normalizeText(project.customerName);
                
                // é¡¹ç›®åç§°å®Œå…¨åŒ¹é…ï¼ˆæ ‡å‡†åŒ–åï¼‰
                if (pName === normalizedName) {
                    // å®¢æˆ·åç§°ä¹ŸåŒ¹é…æˆ–å…¶ä¸­ä¸€ä¸ªä¸ºç©º
                    if (pCustomer === normalizedCustomer || 
                        (!pCustomer && !normalizedCustomer) ||
                        (pCustomer && normalizedCustomer && pCustomer === normalizedCustomer)) {
                        return project;
                    }
                }
                
                // é¡¹ç›®åç§°é«˜åº¦ç›¸ä¼¼ï¼ˆåŒ…å«å…³ç³»ï¼‰
                if (normalizedName.length > 5 && pName.length > 5) {
                    if (pName.includes(normalizedName) || normalizedName.includes(pName)) {
                        if (pCustomer === normalizedCustomer) {
                            return project;
                        }
                    }
                }
            }
            
            return null;
        }

        // åŠ è½½é¡¹ç›®æ•°æ®ï¼ˆä»é¡¹ç›®è¯¦æƒ…é¡µè·³è½¬è¿‡æ¥ï¼‰
        async function loadProjectData(projectId) {
            try {
                const projectDoc = await db.collection('projects').doc(projectId).get();
                if (projectDoc.exists) {
                    matchedProject = { id: projectDoc.id, ...projectDoc.data() };
                    useExistingProject();
                }
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°é¡¹ç›®é˜¶æ®µï¼ˆä½¿ç”¨åˆ†ç±»ï¼‰
        function updateProjectStages() {
            const projectType = document.getElementById('project-type').value;
            const stageSelect = document.getElementById('project-stage');
            const categorySelector = document.getElementById('stage-category-selector');
            
            if (!projectType) {
                stageSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®ç±»å‹</option>';
                categorySelector.style.display = 'none';
                return;
            }
            
            if (projectType === 'å”®å‰é¡¹ç›®') {
                // å”®å‰é¡¹ç›®ï¼šéšè—åˆ†ç±»ï¼Œæ˜¾ç¤ºæ‰€æœ‰å”®å‰é˜¶æ®µ
                categorySelector.style.display = 'none';
                stageSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>' + 
                    presalesStages.map(stage => `<option value="${stage}">${stage}</option>`).join('');
            } else {
                // å”®åé¡¹ç›®ï¼šæ˜¾ç¤ºåˆ†ç±»æŒ‰é’®ï¼Œé»˜è®¤æ˜¾ç¤ºé€šç”¨é˜¶æ®µ
                categorySelector.style.display = 'flex';
                selectCategory('general');
            }
        }
        
        // é€‰æ‹©åˆ†ç±»
        function selectCategory(category) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.category-btn').forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // è·å–è¯¥åˆ†ç±»çš„é˜¶æ®µ
            const categoryData = postsalesStageCategories[category];
            if (!categoryData) {
                console.error('åˆ†ç±»ä¸å­˜åœ¨:', category);
                return;
            }
            
            // æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨
            const stageSelect = document.getElementById('project-stage');
            stageSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>' + 
                categoryData.stages.map(stage => `<option value="${stage}">${stage}</option>`).join('');
        }

        // æ£€æŸ¥å·²æœ‰é¡¹ç›®
        async function checkExistingProject() {
            const customerName = document.getElementById('customer-name').value.trim();
            const projectName = document.getElementById('project-name').value.trim();
            
            if (!customerName || !projectName) {
                return;
            }
            
            try {
                // æŸ¥è¯¢åŒ¹é…çš„é¡¹ç›®
                const projectsSnapshot = await db.collection('projects')
                    .where('customerName', '==', customerName)
                    .where('projectName', '==', projectName)
                    .limit(1)
                    .get();
                
                if (!projectsSnapshot.empty) {
                    // æ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®
                    matchedProject = {
                        id: projectsSnapshot.docs[0].id,
                        ...projectsSnapshot.docs[0].data()
                    };
                    
                    showProjectMatch();
                } else {
                    // æ²¡æ‰¾åˆ°ï¼Œéšè—æç¤º
                    hideProjectMatch();
                    matchedProject = null;
                }
            } catch (error) {
                console.error('æŸ¥è¯¢é¡¹ç›®å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºé¡¹ç›®åŒ¹é…æç¤º
        function showProjectMatch() {
            const alert = document.getElementById('project-match-alert');
            const content = document.getElementById('match-content');
            
            content.innerHTML = `
                <div class="match-item">
                    <span class="match-label">é¡¹ç›®åç§°</span>
                    <span class="match-value">${matchedProject.projectName}</span>
                </div>
                <div class="match-item">
                    <span class="match-label">å®¢æˆ·åç§°</span>
                    <span class="match-value">${matchedProject.customerName}</span>
                </div>
                <div class="match-item">
                    <span class="match-label">é¡¹ç›®ç±»å‹</span>
                    <span class="match-value">${matchedProject.projectType}</span>
                </div>
                <div class="match-item">
                    <span class="match-label">å½“å‰é˜¶æ®µ</span>
                    <span class="match-value">${matchedProject.projectStage}</span>
                </div>
                <div class="match-item">
                    <span class="match-label">é¡¹ç›®çŠ¶æ€</span>
                    <span class="match-value">${matchedProject.status}</span>
                </div>
                <div class="match-item">
                    <span class="match-label">å·²æœ‰å·¥ä½œè®°å½•</span>
                    <span class="match-value">${matchedProject.totalSessions || 0} æ¡</span>
                </div>
                <div class="match-item">
                    <span class="match-label">ç´¯è®¡å·¥æ—¶</span>
                    <span class="match-value">${(matchedProject.totalWorkHours || 0).toFixed(1)} å°æ—¶</span>
                </div>
            `;
            
            alert.classList.add('show');
        }

        // éšè—é¡¹ç›®åŒ¹é…æç¤º
        function hideProjectMatch() {
            document.getElementById('project-match-alert').classList.remove('show');
        }

        // ä½¿ç”¨ç°æœ‰é¡¹ç›®
        function useExistingProject() {
            if (!matchedProject) return;
            
            // è‡ªåŠ¨å¡«å……é¡¹ç›®ä¿¡æ¯
            document.getElementById('customer-name').value = matchedProject.customerName;
            document.getElementById('customer-industry').value = matchedProject.customerIndustry || '';
            document.getElementById('customer-country').value = matchedProject.customerCountry || '';
            document.getElementById('project-name').value = matchedProject.projectName;
            document.getElementById('project-type').value = matchedProject.projectType;
            
            // æ›´æ–°é˜¶æ®µåˆ—è¡¨
            updateProjectStages();
            document.getElementById('project-stage').value = matchedProject.projectStage;
            
            document.getElementById('sales-person').value = matchedProject.salesPerson || '';
            document.getElementById('project-amount').value = matchedProject.projectAmount || '';
            document.getElementById('project-currency').value = matchedProject.projectCurrency || 'GBP';
            
            // ç¦ç”¨é¡¹ç›®ä¿¡æ¯å­—æ®µï¼ˆå·²å…³è”åˆ°é¡¹ç›®ï¼‰
            document.getElementById('customer-name').disabled = true;
            document.getElementById('customer-industry').disabled = true;
            document.getElementById('customer-country').disabled = true;
            document.getElementById('project-name').disabled = true;
            document.getElementById('project-type').disabled = true;
            document.getElementById('project-stage').disabled = true;
            document.getElementById('sales-person').disabled = true;
            document.getElementById('project-amount').disabled = true;
            document.getElementById('project-currency').disabled = true;
            
            hideProjectMatch();
            
            alert('âœ… å·²å…³è”åˆ°ç°æœ‰é¡¹ç›®ï¼é¡¹ç›®ä¿¡æ¯å·²è‡ªåŠ¨å¡«å……ã€‚');
        }

        // åˆ›å»ºæ–°é¡¹ç›®
        function createNewProject() {
            matchedProject = null;
            
            // å¯ç”¨æ‰€æœ‰å­—æ®µ
            document.getElementById('customer-name').disabled = false;
            document.getElementById('customer-industry').disabled = false;
            document.getElementById('customer-country').disabled = false;
            document.getElementById('project-name').disabled = false;
            document.getElementById('project-type').disabled = false;
            document.getElementById('project-stage').disabled = false;
            document.getElementById('sales-person').disabled = false;
            document.getElementById('project-amount').disabled = false;
            document.getElementById('project-currency').disabled = false;
            
            hideProjectMatch();
            
            alert('âœ… å°†åˆ›å»ºæ–°é¡¹ç›®ï¼è¯·å®Œæ•´å¡«å†™é¡¹ç›®ä¿¡æ¯ã€‚');
        }

        // è®¡ç®—å·¥æ—¶
        function calculateHours() {
            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;
            const isHoliday = document.getElementById('is-holiday').checked;
            
            if (!startDate || !startTime || !endDate || !endTime) {
                return;
            }
            
            // è®¡ç®—æ€»å·¥æ—¶ï¼ˆæ”¯æŒè·¨å¤©ï¼‰
            const start = new Date(`${startDate}T${startTime}`);
            const end = new Date(`${endDate}T${endTime}`);
            const totalHours = (end - start) / (1000 * 60 * 60);
            
            if (totalHours <= 0) {
                alert('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´ï¼');
                return;
            }
            
            let normalHours = 0;
            let overtimeHours = 0;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å‘¨æœ«ï¼ˆå¼€å§‹æ—¥æœŸï¼‰
            const dayOfWeek = start.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            
            if (isHoliday || isWeekend) {
                // èŠ‚å‡æ—¥æˆ–å‘¨æœ«ï¼Œå…¨éƒ¨ç®—åŠ ç­
                overtimeHours = totalHours;
            } else {
                // å·¥ä½œæ—¥ï¼Œè®¡ç®—æ­£å¸¸å’ŒåŠ ç­å·¥æ—¶
                const workStart = 9;  // 9:00
                const workEnd = 17.5; // 17:30
                
                // å¦‚æœè·¨å¤©ï¼Œéœ€è¦æ›´å¤æ‚çš„è®¡ç®—
                if (startDate === endDate) {
                    // åŒä¸€å¤©
                    const startHour = start.getHours() + start.getMinutes() / 60;
                    const endHour = end.getHours() + end.getMinutes() / 60;
                    
                    const normalStart = Math.max(startHour, workStart);
                    const normalEnd = Math.min(endHour, workEnd);
                    normalHours = Math.max(0, normalEnd - normalStart);
                } else {
                    // è·¨å¤©ï¼šç¬¬ä¸€å¤©çš„æ­£å¸¸å·¥æ—¶
                    const startHour = start.getHours() + start.getMinutes() / 60;
                    if (startHour < workEnd) {
                        const normalStart = Math.max(startHour, workStart);
                        normalHours = Math.max(0, workEnd - normalStart);
                    }
                    
                    // ç¬¬äºŒå¤©åŠä»¥åçš„æ­£å¸¸å·¥æ—¶
                    const daysDiff = Math.floor((end - start) / (1000 * 60 * 60 * 24));
                    if (daysDiff >= 1) {
                        // å®Œæ•´å·¥ä½œæ—¥çš„å·¥æ—¶ï¼ˆæ¯å¤©8.5å°æ—¶ï¼‰
                        normalHours += (daysDiff - 1) * 8.5;
                        
                        // æœ€åä¸€å¤©çš„æ­£å¸¸å·¥æ—¶
                        const endHour = end.getHours() + end.getMinutes() / 60;
                        if (endHour > workStart) {
                            const normalEnd = Math.min(endHour, workEnd);
                            normalHours += Math.max(0, normalEnd - workStart);
                        }
                    }
                }
                
                // åŠ ç­å·¥æ—¶ = æ€»å·¥æ—¶ - æ­£å¸¸å·¥æ—¶
                overtimeHours = totalHours - normalHours;
            }
            
            // æ˜¾ç¤ºå·¥æ—¶
            document.getElementById('normal-hours').textContent = normalHours.toFixed(1);
            document.getElementById('overtime-hours').textContent = overtimeHours.toFixed(1);
            document.getElementById('total-hours').textContent = totalHours.toFixed(1);
            document.getElementById('hours-display').style.display = 'block';
        }
        
        // åˆ‡æ¢èŠ‚å‡æ—¥ç±»å‹é€‰æ‹©
        function toggleHolidayType() {
            const isHoliday = document.getElementById('is-holiday').checked;
            const holidayTypeSelect = document.getElementById('holiday-type');
            
            if (isHoliday) {
                holidayTypeSelect.style.display = 'inline-block';
            } else {
                holidayTypeSelect.style.display = 'none';
                holidayTypeSelect.value = '';
            }
            
            calculateHours();
        }

        // æäº¤è¡¨å•
        document.getElementById('work-record-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ä¿å­˜ä¸­...';
            
            try {
                // â­ ä¼˜å…ˆä½¿ç”¨é€‰æ‹©çš„é¡¹ç›®
                let projectId = selectedProject ? selectedProject.id : (matchedProject ? matchedProject.id : null);
                
                // å¦‚æœæ²¡æœ‰é€‰æ‹©é¡¹ç›®ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç›¸ä¼¼é¡¹ç›®
                if (!projectId) {
                    const projectName = document.getElementById('project-name').value.trim();
                    const customerName = document.getElementById('customer-name').value.trim();
                    
                    // æœç´¢ç›¸ä¼¼é¡¹ç›®
                    const similarProject = findSimilarProject(projectName, customerName);
                    
                    if (similarProject) {
                        // å‘ç°ç›¸ä¼¼é¡¹ç›®ï¼Œè¯¢é—®ç”¨æˆ·
                        const useExisting = confirm(
                            'âš ï¸ å‘ç°å¯èƒ½é‡å¤çš„é¡¹ç›®ï¼\n\n' +
                            'å·²æœ‰é¡¹ç›®ï¼š' + similarProject.projectName + '\n' +
                            'å®¢æˆ·åç§°ï¼š' + similarProject.customerName + '\n' +
                            'é¡¹ç›®é‡‘é¢ï¼š' + (similarProject.projectAmount ? 
                                (similarProject.projectAmount/1000).toFixed(0) + 'K ' + (similarProject.projectCurrency || 'GBP') 
                                : 'æœªè®¾ç½®') + '\n' +
                            'å·²æœ‰è®°å½•ï¼š' + (similarProject.totalSessions || 0) + ' æ¡\n\n' +
                            'æ˜¯å¦ä½¿ç”¨ç°æœ‰é¡¹ç›®ï¼Ÿ\n\n' +
                            'ç‚¹å‡»ã€ç¡®å®šã€‘â†’ ä½¿ç”¨ç°æœ‰é¡¹ç›®ï¼ˆæ¨èï¼‰\n' +
                            'ç‚¹å‡»ã€å–æ¶ˆã€‘â†’ åˆ›å»ºæ–°é¡¹ç›®'
                        );
                        
                        if (useExisting) {
                            projectId = similarProject.id;
                            console.log('ç”¨æˆ·é€‰æ‹©ä½¿ç”¨ç°æœ‰é¡¹ç›®:', projectId);
                        }
                    }
                }
                
                // å¦‚æœè¿˜æ˜¯æ²¡æœ‰projectIdï¼Œåˆ›å»ºæ–°é¡¹ç›®
                if (!projectId) {
                    const projectData = {
                        customerName: document.getElementById('customer-name').value.trim(),
                        customerIndustry: document.getElementById('customer-industry').value,
                        customerCountry: document.getElementById('customer-country').value,
                        projectName: document.getElementById('project-name').value.trim(),
                        projectType: document.getElementById('project-type').value,
                        projectStage: document.getElementById('project-stage').value,
                        status: 'è¿›è¡Œä¸­',
                        salesPerson: document.getElementById('sales-person').value.trim(),
                        projectAmount: document.getElementById('project-amount').value ? 
                            parseFloat(document.getElementById('project-amount').value) : null,
                        projectCurrency: document.getElementById('project-currency').value,
                        startDate: document.getElementById('start-date').value,
                        totalWorkHours: 0,
                        totalSessions: 0,
                        assignedEngineers: [currentUser.uid],
                        createdBy: currentUser.uid,
                        createdByName: userData?.chineseName || currentUser.displayName || currentUser.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const projectRef = await db.collection('projects').add(projectData);
                    projectId = projectRef.id;
                    console.log('åˆ›å»ºæ–°é¡¹ç›®:', projectId);
                }
                
                // åˆ›å»ºå·¥ä½œè®°å½•
                const startDate = document.getElementById('start-date').value;
                const startTime = document.getElementById('start-time').value;
                const endDate = document.getElementById('end-date').value;
                const endTime = document.getElementById('end-time').value;
                
                const recordData = {
                    // å…³è”é¡¹ç›®
                    projectId: projectId,
                    
                    // ç”¨æˆ·ä¿¡æ¯
                    userId: currentUser.uid,
                    userName: userData?.chineseName || currentUser.displayName,
                    userEmail: currentUser.email,
                    department: userData?.department || 'ICTéƒ¨é—¨',
                    technicalTeam: userData?.technicalTeam || '',
                    
                    // å®¢æˆ·å’Œé¡¹ç›®ä¿¡æ¯
                    customerName: document.getElementById('customer-name').value.trim(),
                    customerIndustry: document.getElementById('customer-industry').value,
                    customerCountry: document.getElementById('customer-country').value,
                    projectName: document.getElementById('project-name').value.trim(),
                    projectType: document.getElementById('project-type').value,
                    projectStage: document.getElementById('project-stage').value,
                    supportType: document.getElementById('support-type').value,
                    salesPerson: document.getElementById('sales-person').value.trim(),
                    projectAmount: document.getElementById('project-amount').value ? 
                        parseFloat(document.getElementById('project-amount').value) : null,
                    projectCurrency: document.getElementById('project-currency').value,
                    
                    // æ—¶é—´ä¿¡æ¯ï¼ˆæ”¯æŒè·¨å¤©ï¼‰
                    startDate: startDate,
                    startTime: startTime,
                    endDate: endDate,
                    endTime: endTime,
                    startDateTime: firebase.firestore.Timestamp.fromDate(new Date(`${startDate}T${startTime}`)),
                    endDateTime: firebase.firestore.Timestamp.fromDate(new Date(`${endDate}T${endTime}`)),
                    isHolidayWork: document.getElementById('is-holiday').checked,
                    holidayType: document.getElementById('is-holiday').checked ? 
                        (document.getElementById('holiday-type').value || 'Custom') : null,
                    
                    // å·¥æ—¶
                    normalWorkingHours: parseFloat(document.getElementById('normal-hours').textContent),
                    overtimeHours: parseFloat(document.getElementById('overtime-hours').textContent),
                    totalWorkingHours: parseFloat(document.getElementById('total-hours').textContent),
                    
                    // å·¥ä½œå†…å®¹
                    workDescription: document.getElementById('work-description').value.trim(),
                    nextWeekPlan: document.getElementById('next-week-plan').value.trim(),
                    
                    // å…ƒæ•°æ®
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('workRecords').add(recordData);
                
                // æ›´æ–°é¡¹ç›®ç»Ÿè®¡
                const projectRef = db.collection('projects').doc(projectId);
                await projectRef.update({
                    totalWorkHours: firebase.firestore.FieldValue.increment(recordData.totalWorkingHours),
                    totalSessions: firebase.firestore.FieldValue.increment(1),
                    assignedEngineers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('âœ… å·¥ä½œè®°å½•ä¿å­˜æˆåŠŸï¼');
                window.location.href = 'dashboard.html';
                
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'âœ… ä¿å­˜å·¥ä½œè®°å½•';
            }
        });
    </script>
</body>
</html>
