<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ - é£ä¹¦ç‰ˆ</title>
    <!-- é£ä¹¦SDK -->
    <script src="https://open.feishu.cn/open-apis/jssdk/1.1.0/feishu.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1f2937;
            --secondary: #374151;
            --accent: #2563eb;
            --accent-light: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #e5e7eb;
            --bg-light: #f9fafb;
            --text-dark: #111827;
            --text-light: #6b7280;
        }

        /* é£ä¹¦æ·±è‰²æ¨¡å¼æ”¯æŒ */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #0a0e27;
                --secondary: #151a2e;
                --accent: #3b82f6;
                --border: #374151;
                --bg-light: #1f2937;
                --text-dark: #f3f4f6;
                --text-light: #d1d5db;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans CJK SC', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
            padding: 0;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: var(--bg-light);
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .main-content {
            padding: 16px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        @media (prefers-color-scheme: dark) {
            .stat-card {
                background: var(--secondary);
            }
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            font-weight: 600;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-light);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: white;
            color: var(--text-dark);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-light);
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        @media (prefers-color-scheme: dark) {
            .table-wrapper {
                background: var(--secondary);
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            background: var(--bg-light);
            border-bottom: 1px solid var(--border);
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: var(--text-dark);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text-dark);
        }

        tbody tr:hover {
            background: var(--bg-light);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-presales {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
        }

        .badge-aftersales {
            background: rgba(6, 182, 212, 0.1);
            color: #06b6d4;
        }

        .btn-small {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-edit {
            background: rgba(37, 99, 235, 0.1);
            color: var(--accent);
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 16px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @media (prefers-color-scheme: dark) {
            .modal-content {
                background: var(--secondary);
            }
        }

        .modal-header {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-dark);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            color: var(--text-dark);
        }

        @media (prefers-color-scheme: dark) {
            .form-group input,
            .form-group textarea,
            .form-group select {
                background: var(--primary);
                color: var(--text-dark);
            }
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-section {
            border-top: 1px solid var(--border);
            padding-top: 12px;
            margin-top: 12px;
        }

        .form-section-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--accent);
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            border-top: 1px solid var(--border);
            padding-top: 16px;
        }

        .time-entries {
            background: var(--bg-light);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .time-entry {
            background: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            font-size: 12px;
        }

        @media (prefers-color-scheme: dark) {
            .time-entry {
                background: var(--secondary);
            }
        }

        .time-entry-remove {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .hidden-section {
            display: none;
        }

        .hidden-section.active {
            display: block;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            margin: 0;
        }

        .footer {
            background: var(--bg-light);
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            text-align: center;
            font-size: 12px;
            color: var(--text-light);
            margin-top: 20px;
        }

        .user-info {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        @media (max-width: 768px) {
            .header {
                padding: 16px;
            }

            .main-content {
                padding: 12px;
            }

            .header h1 {
                font-size: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
            }

            .search-box {
                min-width: 100%;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }

            .user-info {
                position: static;
                margin-top: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info" id="userInfo"></div>
            <h1>ğŸ“Š å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ</h1>
            <p>æ™ºèƒ½å·¥ä½œæ—¶é—´è¿½è¸ªä¸å·¥ä½œé‡ç»Ÿè®¡</p>
        </div>

        <div class="main-content">
            <div class="stats">
                <div class="stat-card">
                    <span class="stat-label">æ€»é¡¹ç›®é‡‘é¢</span>
                    <span class="stat-value" id="totalAmount">Â£0K</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">å·¥ä½œæ—¶é•¿</span>
                    <span class="stat-value" id="totalWorkHours">0h</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">åŠ ç­æ—¶é•¿</span>
                    <span class="stat-value" id="totalOvertimeHours">0h</span>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="openAddModal()">â• æ·»åŠ æ–°é¡¹ç›®</button>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="æœç´¢..." onkeyup="filterTable()">
                </div>
                <button class="btn btn-secondary" onclick="openExportModal()">ğŸ’¾ å¯¼å‡º</button>
                <button class="btn btn-secondary" onclick="openImportModal()">ğŸ“¥ å¯¼å…¥</button>
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>å®¢æˆ·</th>
                            <th>é¡¹ç›®</th>
                            <th>è¡Œä¸š</th>
                            <th>ç±»å‹</th>
                            <th>è§„æ¨¡(KÂ£)</th>
                            <th>é”€å”®</th>
                            <th>å·¥ç¨‹å¸ˆ</th>
                            <th>å·¥ä½œæ—¶é•¿</th>
                            <th>åŠ ç­æ—¶é•¿</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
        <div id="exportModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">å¯¼å‡ºæ•°æ®</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="btn btn-secondary" onclick="exportCSV()" style="padding: 12px; text-align: center;">ğŸ“„ å¯¼å‡º CSV</button>
                    <button class="btn btn-secondary" onclick="exportExcel()" style="padding: 12px; text-align: center;">ğŸ“Š å¯¼å‡º Excel</button>
                    <button class="btn btn-secondary" onclick="downloadTemplate()" style="padding: 12px; text-align: center;">ğŸ“‹ ä¸‹è½½æ¨¡æ¿</button>
                    <button class="btn btn-secondary" onclick="closeExportModal()" style="padding: 12px; text-align: center;">å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- å¯¼å…¥æ¨¡æ€æ¡† -->
        <div id="importModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">å¯¼å…¥æ•°æ®</div>
                <div style="margin-bottom: 12px;">
                    <p style="margin-bottom: 8px; font-size: 13px;">æ”¯æŒ CSV æˆ– Excel æ ¼å¼</p>
                    <input type="file" id="fileInput" accept=".csv,.xls,.xlsx" onchange="handleFileImport(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()" style="width: 100%; margin-top: 8px;">é€‰æ‹©æ–‡ä»¶</button>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="closeImportModal()" style="flex: 1;">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="importData()" id="importBtn" style="flex: 1;" disabled>å¯¼å…¥</button>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div id="formModal" class="modal">
            <div class="modal-content">
                <div class="modal-header" id="modalTitle">æ·»åŠ æ–°é¡¹ç›®</div>
                <form id="dataForm" onsubmit="saveData(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>å‘¨èµ·å§‹æ—¥æœŸ *</label>
                            <input type="text" id="weekStartDate" placeholder="YYYY-MM-DD">
                        </div>
                        <div class="form-group">
                            <label>å®¢æˆ·åç§° *</label>
                            <input type="text" id="clientName">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>é¡¹ç›®åç§° *</label>
                            <input type="text" id="projectName">
                        </div>
                        <div class="form-group">
                            <label>è¡Œä¸š *</label>
                            <input type="text" id="industry">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>å›½å®¶ *</label>
                            <input type="text" id="country">
                        </div>
                        <div class="form-group">
                            <label>é¡¹ç›®è§„æ¨¡ (KÂ£) *</label>
                            <input type="number" id="projectScale" step="0.1" min="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>é¡¹ç›®ç±»å‹ *</label>
                            <select id="projectType" onchange="updateProjectStages()">
                                <option value="">-- è¯·é€‰æ‹© --</option>
                                <option value="presales">å”®å‰</option>
                                <option value="aftersales">å”®å</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é”€å”®äººå‘˜ *</label>
                            <input type="text" id="salesperson">
                        </div>
                    </div>

                    <div id="presalesSection" class="form-group hidden-section">
                        <label>ç­¾å•çŠ¶æ€</label>
                        <select id="signedStatus">
                            <option value="pipeline">Pipeline</option>
                            <option value="signed">å·²ç­¾å•</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>è¿›åº¦é˜¶æ®µ *</label>
                        <select id="projectStage">
                            <option value="">-- è¯·å…ˆé€‰æ‹©é¡¹ç›®ç±»å‹ --</option>
                        </select>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">â° å·¥ä½œæ—¶é—´</div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="margin-bottom: 4px;">å¼€å§‹æ—¥æœŸ</label>
                                <input type="text" id="timeEntryStartDate" placeholder="YYYY-MM-DD">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="margin-bottom: 4px;">å¼€å§‹æ—¶é—´</label>
                                <input type="time" id="timeEntryStartTime">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="margin-bottom: 4px;">ç»“æŸæ—¥æœŸ</label>
                                <input type="text" id="timeEntryEndDate" placeholder="YYYY-MM-DD">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="margin-bottom: 4px;">ç»“æŸæ—¶é—´</label>
                                <input type="time" id="timeEntryEndTime">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>å·¥ä½œå†…å®¹</label>
                            <textarea id="timeEntryContent" style="min-height: 60px;"></textarea>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="timeEntryHoliday">
                            <label for="timeEntryHoliday" style="margin: 0; font-weight: 400;">åŒ…å«ç‰¹æ®Šå‡æœŸ</label>
                        </div>

                        <button type="button" class="btn btn-primary" onclick="addTimeEntry()" style="width: 100%;">+ æ·»åŠ æ—¶é—´è®°å½•</button>

                        <div class="time-entries" id="timeEntriesContainer">
                            <div style="color: var(--text-light); font-size: 12px; text-align: center; padding: 12px;">æš‚æ— æ—¶é—´è®°å½•</div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">ğŸ‘¥ å·¥ç¨‹å¸ˆä¿¡æ¯</div>
                        <div class="form-group">
                            <label>ä¸»å·¥ç¨‹å¸ˆåå­— *</label>
                            <input type="text" id="engineerName">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="hasCollaborators" onchange="toggleCollaborators()">
                            <label for="hasCollaborators" style="margin: 0; font-weight: 400;">æœ‰åˆä½œå·¥ç¨‹å¸ˆ</label>
                        </div>
                        <div id="collaboratorSection" class="hidden-section">
                            <div class="form-group">
                                <label>åˆä½œå·¥ç¨‹å¸ˆåå•</label>
                                <textarea id="collaboratorNames" style="min-height: 60px;"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeFormModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="footer">æœ€åæ›´æ–°ï¼š<span id="lastUpdate">-</span></div>
    </div>

    <script>
        let allData = [];
        let editingIndex = -1;
        let timeEntries = [];
        let importedFile = null;
        let currentUser = null;
        const STORAGE_KEY = 'weeklyReportData_feishu';
        const WORK_START = 9;
        const WORK_END = 17.5;
        const WORK_DAYS = [1, 2, 3, 4, 5];

        const stageOptions = {
            presales: ['éœ€æ±‚è°ƒç ”', 'æŠ€æœ¯ç ”è®¨', 'å·¥å‹˜', 'æŠ€æœ¯æ–¹æ¡ˆ', 'é¢„ç®—å®¡æ‰¹', 'æ‹›æ ‡ä¸­', 'æŠ•æ ‡ææ–™å‡†å¤‡', 'æäº¤æŠ¥ä»·', 'å¾…å…¬å¸ƒç»“æœ', 'å·²å…¬å¸ƒç»“æœ', 'å·²ä¸‹å•', 'å·²åˆ°è´§'],
            aftersales: ['ç¼–å†™å”®åå®æ–½æ–¹æ¡ˆ', 'ç¼–å†™å®æ–½è®¡åˆ’', 'æ•´ç†éªŒæ”¶æ–‡æ¡£', 'ç°åœºäº¤ä»˜', 'å‰²æ¥', 'ç°åœºä¿éšœ', 'ç”¨æˆ·åŸ¹è®­', 'ç°åœºéªŒæ”¶', 'è¿ç»´æ”¯æŒ', 'æ•…éšœæ’æŸ¥']
        };

        // é£ä¹¦SDKåˆå§‹åŒ–
        function initFeishu() {
            if (window.feishu) {
                // è·å–ç”¨æˆ·ä¿¡æ¯
                feishu.getUserInfo().then(user => {
                    currentUser = user;
                    document.getElementById('userInfo').textContent = `ğŸ‘¤ ${user.name}`;
                    // è‡ªåŠ¨å¡«å……å·¥ç¨‹å¸ˆåå­—
                    if (document.getElementById('engineerName').value === '') {
                        document.getElementById('engineerName').value = user.name;
                    }
                }).catch(err => {
                    console.log('é£ä¹¦SDKè·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼ˆå¯èƒ½æ˜¯éé£ä¹¦ç¯å¢ƒï¼‰:', err);
                });
            }
        }

        function init() {
            loadData();
            renderTable();
            updateStats();
            setDefaultDate();
            initFeishu();
        }

        function setDefaultDate() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const monday = new Date(today.setDate(diff));
            document.getElementById('weekStartDate').value = monday.toISOString().split('T')[0];
        }

        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            allData = stored ? JSON.parse(stored) : [];
        }

        function calculateTimespan(startDate, startTime, endDate, endTime, isHoliday) {
            const start = new Date(startDate + 'T' + startTime);
            const end = new Date(endDate + 'T' + endTime);
            
            if (start >= end) {
                return { workHours: 0, overtimeHours: 0, error: 'ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´' };
            }

            let totalWorkHours = 0;
            let totalOvertimeHours = 0;
            let currentDate = new Date(start);

            while (currentDate <= end) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayStart = new Date(dateStr + 'T00:00:00');
                const dayEnd = new Date(dateStr + 'T23:59:59');

                let periodStart = start > dayStart ? start : dayStart;
                let periodEnd = end < dayEnd ? end : dayEnd;

                if (periodStart <= periodEnd) {
                    const periodHours = (periodEnd - periodStart) / (1000 * 60 * 60);
                    const isWork = !isHoliday && WORK_DAYS.includes(currentDate.getDay());

                    if (isWork) {
                        const workStart = new Date(dateStr + 'T09:00:00');
                        const workEnd = new Date(dateStr + 'T17:30:00');
                        const workPeriodStart = periodStart > workStart ? periodStart : workStart;
                        const workPeriodEnd = periodEnd < workEnd ? periodEnd : workEnd;
                        const workHours = Math.max(0, (workPeriodEnd - workPeriodStart) / (1000 * 60 * 60));
                        const overtimeHours = Math.max(0, periodHours - workHours);

                        totalWorkHours += workHours;
                        totalOvertimeHours += overtimeHours;
                    } else {
                        totalOvertimeHours += periodHours;
                    }
                }

                currentDate.setDate(currentDate.getDate() + 1);
            }

            return {
                workHours: parseFloat(totalWorkHours.toFixed(2)),
                overtimeHours: parseFloat(totalOvertimeHours.toFixed(2))
            };
        }

        function addTimeEntry() {
            const startDate = document.getElementById('timeEntryStartDate').value;
            const startTime = document.getElementById('timeEntryStartTime').value;
            const endDate = document.getElementById('timeEntryEndDate').value;
            const endTime = document.getElementById('timeEntryEndTime').value;
            const content = document.getElementById('timeEntryContent').value;
            const isHoliday = document.getElementById('timeEntryHoliday').checked;

            if (!startDate || !startTime || !endDate || !endTime) {
                alert('è¯·å¡«å†™å®Œæ•´çš„æ—¥æœŸå’Œæ—¶é—´');
                return;
            }

            const calc = calculateTimespan(startDate, startTime, endDate, endTime, isHoliday);
            if (calc.error) {
                alert(calc.error);
                return;
            }

            timeEntries.push({
                startDate, startTime, endDate, endTime, isHoliday, content,
                workHours: calc.workHours,
                overtimeHours: calc.overtimeHours
            });

            document.getElementById('timeEntryStartDate').value = '';
            document.getElementById('timeEntryStartTime').value = '';
            document.getElementById('timeEntryEndDate').value = '';
            document.getElementById('timeEntryEndTime').value = '';
            document.getElementById('timeEntryContent').value = '';
            document.getElementById('timeEntryHoliday').checked = false;

            renderTimeEntries();
        }

        function renderTimeEntries() {
            const container = document.getElementById('timeEntriesContainer');
            
            if (timeEntries.length === 0) {
                container.innerHTML = '<div style="color: var(--text-light); font-size: 12px; text-align: center; padding: 12px;">æš‚æ— æ—¶é—´è®°å½•</div>';
                return;
            }

            let totalWorkHours = 0;
            let totalOvertimeHours = 0;

            const entriesHtml = timeEntries.map((entry, index) => {
                totalWorkHours += entry.workHours;
                totalOvertimeHours += entry.overtimeHours;

                const dateLabel = entry.startDate === entry.endDate 
                    ? entry.startDate 
                    : `${entry.startDate}~${entry.endDate}`;

                return `
                    <div class="time-entry">
                        <div style="flex: 1;">
                            <div>${dateLabel} ${entry.startTime}-${entry.endTime}</div>
                            ${entry.content ? `<div style="font-size: 11px; color: var(--text-light); margin-top: 2px;">${entry.content}</div>` : ''}
                            <div style="font-size: 11px; color: var(--text-light); margin-top: 2px;">å·¥ä½œ: ${entry.workHours}h | åŠ ç­: ${entry.overtimeHours}h</div>
                        </div>
                        <button type="button" class="time-entry-remove" onclick="removeTimeEntry(${index})">åˆ é™¤</button>
                    </div>
                `;
            }).join('');

            container.innerHTML = entriesHtml;
        }

        function removeTimeEntry(index) {
            timeEntries.splice(index, 1);
            renderTimeEntries();
        }

        function updateProjectStages() {
            const type = document.getElementById('projectType').value;
            const stageSelect = document.getElementById('projectStage');
            const presalesSection = document.getElementById('presalesSection');
            
            stageSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';

            if (type === 'presales') {
                presalesSection.classList.add('active');
            } else {
                presalesSection.classList.remove('active');
            }

            if (type && stageOptions[type]) {
                stageOptions[type].forEach(stage => {
                    const option = document.createElement('option');
                    option.value = stage;
                    option.textContent = stage;
                    stageSelect.appendChild(option);
                });
            }
        }

        function toggleCollaborators() {
            const checkbox = document.getElementById('hasCollaborators');
            const section = document.getElementById('collaboratorSection');
            if (checkbox.checked) {
                section.classList.add('active');
            } else {
                section.classList.remove('active');
            }
        }

        function saveData(event) {
            event.preventDefault();

            if (timeEntries.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€æ¡æ—¶é—´è®°å½•');
                return;
            }

            let totalWorkHours = 0;
            let totalOvertimeHours = 0;
            timeEntries.forEach(entry => {
                totalWorkHours += entry.workHours;
                totalOvertimeHours += entry.overtimeHours;
            });

            const newData = {
                weekStartDate: document.getElementById('weekStartDate').value,
                clientName: document.getElementById('clientName').value,
                projectName: document.getElementById('projectName').value,
                industry: document.getElementById('industry').value,
                country: document.getElementById('country').value,
                projectScale: parseFloat(document.getElementById('projectScale').value),
                projectType: document.getElementById('projectType').value,
                signedStatus: document.getElementById('projectType').value === 'presales' ? document.getElementById('signedStatus').value : '',
                projectStage: document.getElementById('projectStage').value,
                salesperson: document.getElementById('salesperson').value,
                timeEntries: JSON.parse(JSON.stringify(timeEntries)),
                workHours: parseFloat(totalWorkHours.toFixed(2)),
                overtimeHours: parseFloat(totalOvertimeHours.toFixed(2)),
                engineerName: document.getElementById('engineerName').value,
                hasCollaborators: document.getElementById('hasCollaborators').checked,
                collaboratorNames: document.getElementById('collaboratorNames').value,
                date: new Date().toISOString()
            };

            if (editingIndex >= 0) {
                allData[editingIndex] = newData;
            } else {
                allData.push(newData);
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
            renderTable();
            updateStats();
            closeFormModal();
        }

        function deleteData(index) {
            if (confirm('ç¡®å®šåˆ é™¤?')) {
                allData.splice(index, 1);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
                renderTable();
                updateStats();
            }
        }

        function editData(index) {
            editingIndex = index;
            const data = allData[index];

            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘é¡¹ç›®';
            document.getElementById('weekStartDate').value = data.weekStartDate;
            document.getElementById('clientName').value = data.clientName;
            document.getElementById('projectName').value = data.projectName;
            document.getElementById('industry').value = data.industry;
            document.getElementById('country').value = data.country;
            document.getElementById('projectScale').value = data.projectScale;
            document.getElementById('projectType').value = data.projectType;
            document.getElementById('salesperson').value = data.salesperson;
            
            updateProjectStages();
            
            if (data.projectType === 'presales') {
                document.getElementById('signedStatus').value = data.signedStatus || 'pipeline';
            }
            
            document.getElementById('projectStage').value = data.projectStage;
            document.getElementById('engineerName').value = data.engineerName;
            document.getElementById('hasCollaborators').checked = data.hasCollaborators;
            
            if (data.hasCollaborators) {
                document.getElementById('collaboratorSection').classList.add('active');
            }
            
            document.getElementById('collaboratorNames').value = data.collaboratorNames;

            timeEntries = data.timeEntries ? JSON.parse(JSON.stringify(data.timeEntries)) : [];
            renderTimeEntries();

            document.getElementById('formModal').classList.add('active');
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            if (allData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 30px;">æš‚æ— æ•°æ®</td></tr>`;
                return;
            }

            tbody.innerHTML = allData.map((item, index) => {
                const typeBadge = item.projectType === 'presales' 
                    ? '<span class="badge badge-presales">å”®å‰</span>'
                    : '<span class="badge badge-aftersales">å”®å</span>';

                return `
                    <tr>
                        <td>${item.clientName}</td>
                        <td>${item.projectName}</td>
                        <td>${item.industry}</td>
                        <td>${typeBadge}</td>
                        <td>Â£${item.projectScale}</td>
                        <td>${item.salesperson}</td>
                        <td>${item.engineerName}</td>
                        <td>${item.workHours}h</td>
                        <td>${item.overtimeHours}h</td>
                        <td>
                            <button class="btn-small btn-edit" onclick="editData(${index})">ç¼–è¾‘</button>
                            <button class="btn-small btn-delete" onclick="deleteData(${index})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStats() {
            const totalAmount = allData.reduce((sum, item) => sum + item.projectScale, 0);
            const totalWorkHours = allData.reduce((sum, item) => sum + (item.workHours || 0), 0);
            const totalOvertimeHours = allData.reduce((sum, item) => sum + (item.overtimeHours || 0), 0);

            document.getElementById('totalAmount').textContent = 'Â£' + totalAmount.toFixed(1) + 'K';
            document.getElementById('totalWorkHours').textContent = totalWorkHours.toFixed(1) + 'h';
            document.getElementById('totalOvertimeHours').textContent = totalOvertimeHours.toFixed(1) + 'h';
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-CN');
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
            });
        }

        function openExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            importedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('importBtn').disabled = true;
        }

        function downloadTemplate() {
            const headers = ['å‘¨èµ·å§‹æ—¥æœŸ', 'å®¢æˆ·åç§°', 'é¡¹ç›®åç§°', 'è¡Œä¸š', 'å›½å®¶', 'é¡¹ç›®è§„æ¨¡(KÂ£)', 'é¡¹ç›®ç±»å‹', 'ç­¾å•çŠ¶æ€', 'è¿›åº¦é˜¶æ®µ', 'é”€å”®äººå‘˜', 'ä¸»å·¥ç¨‹å¸ˆ', 'åˆä½œå·¥ç¨‹å¸ˆ', 'æ—¶é—´å¼€å§‹æ—¥æœŸ', 'æ—¶é—´å¼€å§‹æ—¶é—´', 'æ—¶é—´ç»“æŸæ—¥æœŸ', 'æ—¶é—´ç»“æŸæ—¶é—´', 'å·¥ä½œå†…å®¹', 'æ˜¯å¦å‡æœŸ'];
            const exampleRow = ['2026-01-18', 'China Telecom', 'Network Upgrade', 'ç”µä¿¡', 'Germany', '250', 'å”®å', '', 'ç°åœºä¿éšœ', 'æå››', 'Xinyu', 'John, Mary', '2026-01-18', '09:00', '2026-01-18', '17:30', 'ç³»ç»Ÿé…ç½®æµ‹è¯•', 'FALSE'];
            
            const csv = [headers, exampleRow].map(row => 
                row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            downloadFile(csv, 'template.csv', 'text/csv;charset=utf-8;');
        }

        function exportCSV() {
            if (allData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }

            const headers = ['å‘¨èµ·å§‹æ—¥æœŸ', 'å®¢æˆ·åç§°', 'é¡¹ç›®åç§°', 'è¡Œä¸š', 'å›½å®¶', 'é¡¹ç›®è§„æ¨¡(KÂ£)', 'é¡¹ç›®ç±»å‹', 'ç­¾å•çŠ¶æ€', 'è¿›åº¦é˜¶æ®µ', 'é”€å”®äººå‘˜', 'ä¸»å·¥ç¨‹å¸ˆ', 'åˆä½œå·¥ç¨‹å¸ˆ', 'æ—¶é—´å¼€å§‹æ—¥æœŸ', 'æ—¶é—´å¼€å§‹æ—¶é—´', 'æ—¶é—´ç»“æŸæ—¥æœŸ', 'æ—¶é—´ç»“æŸæ—¶é—´', 'å·¥ä½œå†…å®¹', 'æ˜¯å¦å‡æœŸ', 'å·¥ä½œæ—¶é•¿', 'åŠ ç­æ—¶é•¿'];
            const rows = [];

            allData.forEach(item => {
                if (item.timeEntries && item.timeEntries.length > 0) {
                    item.timeEntries.forEach(entry => {
                        rows.push([
                            item.weekStartDate, item.clientName, item.projectName, item.industry, item.country,
                            item.projectScale, item.projectType, item.signedStatus, item.projectStage,
                            item.salesperson, item.engineerName, item.collaboratorNames,
                            entry.startDate, entry.startTime, entry.endDate, entry.endTime,
                            entry.content, entry.isHoliday ? 'TRUE' : 'FALSE', entry.workHours, entry.overtimeHours
                        ]);
                    });
                }
            });

            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            downloadFile(csv, 'weekly-report.csv', 'text/csv;charset=utf-8;');
            closeExportModal();
        }

        function exportExcel() {
            if (allData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }

            let html = '<table border="1"><tr><th>å‘¨èµ·å§‹æ—¥æœŸ</th><th>å®¢æˆ·</th><th>é¡¹ç›®</th><th>è¡Œä¸š</th><th>å›½å®¶</th><th>è§„æ¨¡</th><th>ç±»å‹</th><th>ç­¾å•</th><th>é˜¶æ®µ</th><th>é”€å”®</th><th>å·¥ç¨‹å¸ˆ</th><th>åˆä½œ</th><th>å¼€å§‹æ—¥æœŸ</th><th>å¼€å§‹æ—¶é—´</th><th>ç»“æŸæ—¥æœŸ</th><th>ç»“æŸæ—¶é—´</th><th>å†…å®¹</th><th>å‡æœŸ</th><th>å·¥ä½œ</th><th>åŠ ç­</th></tr>';

            allData.forEach(item => {
                if (item.timeEntries && item.timeEntries.length > 0) {
                    item.timeEntries.forEach(entry => {
                        html += `<tr><td>${item.weekStartDate}</td><td>${item.clientName}</td><td>${item.projectName}</td><td>${item.industry}</td><td>${item.country}</td><td>${item.projectScale}</td><td>${item.projectType}</td><td>${item.signedStatus}</td><td>${item.projectStage}</td><td>${item.salesperson}</td><td>${item.engineerName}</td><td>${item.collaboratorNames}</td><td>${entry.startDate}</td><td>${entry.startTime}</td><td>${entry.endDate}</td><td>${entry.endTime}</td><td>${entry.content}</td><td>${entry.isHoliday ? 'æ˜¯' : 'å¦'}</td><td>${entry.workHours}</td><td>${entry.overtimeHours}</td></tr>`;
                    });
                }
            });

            html += '</table>';
            downloadFile(html, 'weekly-report.xls', 'application/vnd.ms-excel;charset=utf-8;');
            closeExportModal();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            importedFile = file;
            document.getElementById('importBtn').disabled = false;
            alert('å·²é€‰æ‹©: ' + file.name);
        }

        function importData() {
            if (!importedFile) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSVæ ¼å¼é”™è¯¯');
                        return;
                    }

                    const parseCSVLine = (line) => {
                        const result = [];
                        let current = '';
                        let insideQuotes = false;
                        
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            if (char === '"') {
                                if (insideQuotes && line[i + 1] === '"') {
                                    current += '"';
                                    i++;
                                } else {
                                    insideQuotes = !insideQuotes;
                                }
                            } else if (char === ',' && !insideQuotes) {
                                result.push(current);
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        result.push(current);
                        return result;
                    };

                    const headers = parseCSVLine(lines[0]).map(h => h.trim());
                    const groupedByProject = {};

                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCSVLine(lines[i]).map(v => v.trim());
                        if (values.length < headers.length) continue;

                        const row = {};
                        headers.forEach((h, idx) => {
                            row[h] = values[idx] || '';
                        });

                        const projectKey = `${row['å‘¨èµ·å§‹æ—¥æœŸ']}_${row['å®¢æˆ·åç§°']}_${row['é¡¹ç›®åç§°']}`;
                        if (!groupedByProject[projectKey]) {
                            groupedByProject[projectKey] = {
                                weekStartDate: row['å‘¨èµ·å§‹æ—¥æœŸ'],
                                clientName: row['å®¢æˆ·åç§°'],
                                projectName: row['é¡¹ç›®åç§°'],
                                industry: row['è¡Œä¸š'],
                                country: row['å›½å®¶'],
                                projectScale: parseFloat(row['é¡¹ç›®è§„æ¨¡(KÂ£)']) || 0,
                                projectType: row['é¡¹ç›®ç±»å‹'],
                                signedStatus: row['ç­¾å•çŠ¶æ€'],
                                projectStage: row['è¿›åº¦é˜¶æ®µ'],
                                salesperson: row['é”€å”®äººå‘˜'],
                                engineerName: row['ä¸»å·¥ç¨‹å¸ˆ'],
                                collaboratorNames: row['åˆä½œå·¥ç¨‹å¸ˆ'],
                                hasCollaborators: !!row['åˆä½œå·¥ç¨‹å¸ˆ'],
                                timeEntries: [],
                                workHours: 0,
                                overtimeHours: 0,
                                date: new Date().toISOString()
                            };
                        }

                        groupedByProject[projectKey].timeEntries.push({
                            startDate: row['æ—¶é—´å¼€å§‹æ—¥æœŸ'],
                            startTime: row['æ—¶é—´å¼€å§‹æ—¶é—´'],
                            endDate: row['æ—¶é—´ç»“æŸæ—¥æœŸ'],
                            endTime: row['æ—¶é—´ç»“æŸæ—¶é—´'],
                            content: row['å·¥ä½œå†…å®¹'],
                            isHoliday: row['æ˜¯å¦å‡æœŸ'].toUpperCase() === 'TRUE',
                            workHours: parseFloat(row['å·¥ä½œæ—¶é•¿']) || 0,
                            overtimeHours: parseFloat(row['åŠ ç­æ—¶é•¿']) || 0
                        });
                    }

                    Object.values(groupedByProject).forEach(item => {
                        item.workHours = parseFloat(item.timeEntries.reduce((sum, e) => sum + (e.workHours || 0), 0).toFixed(2));
                        item.overtimeHours = parseFloat(item.timeEntries.reduce((sum, e) => sum + (e.overtimeHours || 0), 0).toFixed(2));
                        allData.push(item);
                    });

                    localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
                    renderTable();
                    updateStats();
                    closeImportModal();
                    alert(`æˆåŠŸå¯¼å…¥ ${Object.keys(groupedByProject).length} æ¡é¡¹ç›®`);
                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥: ' + error.message);
                }
            };

            reader.readAsText(importedFile);
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function openAddModal() {
            editingIndex = -1;
            document.getElementById('modalTitle').textContent = 'æ·»åŠ æ–°é¡¹ç›®';
            document.getElementById('dataForm').reset();
            setDefaultDate();
            document.getElementById('projectStage').innerHTML = '<option value="">-- è¯·å…ˆé€‰æ‹©é¡¹ç›®ç±»å‹ --</option>';
            document.getElementById('collaboratorSection').classList.remove('active');
            document.getElementById('presalesSection').classList.remove('active');
            timeEntries = [];
            renderTimeEntries();
            document.getElementById('formModal').classList.add('active');
        }

        function closeFormModal() {
            document.getElementById('formModal').classList.remove('active');
            editingIndex = -1;
            timeEntries = [];
        }

        window.onclick = function(event) {
            if (event.target.id === 'formModal') closeFormModal();
            if (event.target.id === 'exportModal') closeExportModal();
            if (event.target.id === 'importModal') closeImportModal();
        }

        init();
    </script>
</body>
</html>
