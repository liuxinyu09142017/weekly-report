<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¨æŠ¥ç³»ç»Ÿ - ä¸»é¡µ</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .welcome-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .welcome-card h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .welcome-card p {
            color: #666;
            font-size: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .action-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .action-card h2 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .action-btn.secondary {
            background: #f5f7fa;
            color: #667eea;
        }
        
        .loading {
            text-align: center;
            padding: 100px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="header">
        <div class="header-content">
            <div class="logo">ğŸ“Š å‘¨æŠ¥ç³»ç»Ÿ</div>
            <div class="user-info">
                <img id="user-avatar" class="user-avatar" src="" alt="å¤´åƒ" style="display: none;">
                <span id="user-name">åŠ è½½ä¸­...</span>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½ä¸­ -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>æ­£åœ¨åŠ è½½...</div>
    </div>
    
    <!-- ä¸»å†…å®¹ -->
    <div id="main-content" class="container" style="display: none;">
        <!-- æ¬¢è¿å¡ç‰‡ -->
        <div class="welcome-card">
            <h1>æ¬¢è¿å›æ¥ï¼ğŸ‘‹</h1>
            <p id="welcome-message">ä»Šå¤©æ˜¯ä¸ªé€‚åˆå†™å‘¨æŠ¥çš„å¥½æ—¥å­ï¼</p>
        </div>
        
        <!-- å¼€å‘æç¤º -->
        <div class="notice">
            <strong>ğŸš§ å¼€å‘ä¸­</strong><br>
            è¿™æ˜¯Dashboardçš„åŸºç¡€ç‰ˆæœ¬ï¼Œå®Œæ•´åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ã€‚ç›®å‰å¯ä»¥æµ‹è¯•ç™»å½•å’Œç™»å‡ºåŠŸèƒ½ã€‚
        </div>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“</div>
                <div class="stat-number" id="total-reports">0</div>
                <div class="stat-label">æ€»å‘¨æŠ¥æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“…</div>
                <div class="stat-number" id="this-month">0</div>
                <div class="stat-label">æœ¬æœˆå‘¨æŠ¥</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">âœ…</div>
                <div class="stat-number" id="completed-tasks">0</div>
                <div class="stat-label">å®Œæˆä»»åŠ¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ”¥</div>
                <div class="stat-number" id="streak-days">0</div>
                <div class="stat-label">è¿ç»­å¤©æ•°</div>
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="action-card">
            <h2>å¿«é€Ÿæ“ä½œ</h2>
            <button class="action-btn" onclick="alert('åˆ›å»ºå‘¨æŠ¥åŠŸèƒ½å¼€å‘ä¸­...')">
                âœï¸ åˆ›å»ºæ–°å‘¨æŠ¥
            </button>
            <button class="action-btn secondary" onclick="alert('æŸ¥çœ‹å†å²åŠŸèƒ½å¼€å‘ä¸­...')">
                ğŸ“‹ æŸ¥çœ‹å†å²å‘¨æŠ¥
            </button>
            <button class="action-btn secondary" onclick="window.open('firestore-test.html', '_blank')">
                ğŸ§ª æµ‹è¯•æ•°æ®åº“
            </button>
        </div>
    </div>

    <script>
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBzcAr_OJFdIMnaYXRCE7TJs2qlK_TAy9U",
            authDomain: "weekly-report-d55e9.firebaseapp.com",
            projectId: "weekly-report-d55e9",
            storageBucket: "weekly-report-d55e9.appspot.com",
            messagingSenderId: "315332641675",
            appId: "1:315332641675:web:e1b52c3d4c5fcc7b8c0de7"
        };

        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('ç”¨æˆ·å·²ç™»å½•:', user.email);
                
                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                document.getElementById('user-name').textContent = user.displayName || user.email;
                
                if (user.photoURL) {
                    const avatar = document.getElementById('user-avatar');
                    avatar.src = user.photoURL;
                    avatar.style.display = 'block';
                }
                
                // æ›´æ–°æ¬¢è¿æ¶ˆæ¯
                const now = new Date();
                const hour = now.getHours();
                let greeting = 'ä½ å¥½';
                if (hour < 12) greeting = 'æ—©ä¸Šå¥½';
                else if (hour < 18) greeting = 'ä¸‹åˆå¥½';
                else greeting = 'æ™šä¸Šå¥½';
                
                document.getElementById('welcome-message').textContent = 
                    `${greeting}ï¼Œ${user.displayName || ''}ï¼ä»Šå¤©æ˜¯ ${now.toLocaleDateString('zh-CN')}`;
                
                // åŠ è½½ç»Ÿè®¡æ•°æ®
                await loadStats(user.uid);
                
                // æ˜¾ç¤ºä¸»å†…å®¹
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                
            } else {
                console.log('ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ');
                window.location.href = 'index.html';
            }
        });

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats(userId) {
            try {
                // æŸ¥è¯¢ç”¨æˆ·çš„å‘¨æŠ¥
                const snapshot = await db.collection('reports')
                    .where('userId', '==', userId)
                    .get();
                
                document.getElementById('total-reports').textContent = snapshot.size;
                
                // è®¡ç®—æœ¬æœˆå‘¨æŠ¥
                const now = new Date();
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const thisMonthCount = snapshot.docs.filter(doc => {
                    const createdAt = doc.data().createdAt?.toDate();
                    return createdAt && createdAt >= monthStart;
                }).length;
                
                document.getElementById('this-month').textContent = thisMonthCount;
                
                // è®¡ç®—å®Œæˆä»»åŠ¡ï¼ˆç¤ºä¾‹ï¼‰
                let totalTasks = 0;
                snapshot.docs.forEach(doc => {
                    const tasks = doc.data().tasks || [];
                    totalTasks += tasks.filter(t => t.status === 'å®Œæˆ').length;
                });
                document.getElementById('completed-tasks').textContent = totalTasks;
                
                console.log('ç»Ÿè®¡æ•°æ®åŠ è½½å®Œæˆ');
                
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                // å³ä½¿å¤±è´¥ä¹Ÿæ˜¾ç¤º0ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
            }
        }

        // ç™»å‡º
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                auth.signOut().then(() => {
                    console.log('å·²é€€å‡ºç™»å½•');
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error('é€€å‡ºå¤±è´¥:', error);
                    alert('é€€å‡ºç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }
        }
    </script>
</body>
</html>
