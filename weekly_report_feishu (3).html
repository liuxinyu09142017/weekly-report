<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ - å¢å¼ºç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1f2937;
            --secondary: #374151;
            --accent: #2563eb;
            --border: #e5e7eb;
            --bg-light: #f9fafb;
            --text-dark: #111827;
            --text-light: #6b7280;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --pre-sales: #8b5cf6;
            --after-sales: #06b6d4;
            --signed: #10b981;
            --pipeline: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans CJK SC', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            padding: 16px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 24px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .main {
            padding: 24px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-light);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-sub {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .filters {
            background: var(--bg-light);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-dark);
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        .analysis-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .analysis-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }

        .analysis-card h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-dark);
            border-bottom: 2px solid var(--accent);
            padding-bottom: 8px;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .analysis-item:last-child {
            border-bottom: none;
        }

        .analysis-label {
            color: var(--text-light);
        }

        .analysis-value {
            font-weight: 600;
            color: var(--accent);
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: white;
        }

        .table-wrapper {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            background: var(--bg-light);
            border-bottom: 1px solid var(--border);
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        tbody tr:hover {
            background: var(--bg-light);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-presales {
            background: rgba(139, 92, 246, 0.1);
            color: var(--pre-sales);
        }

        .badge-aftersales {
            background: rgba(6, 182, 212, 0.1);
            color: var(--after-sales);
        }

        .badge-signed {
            background: rgba(16, 185, 129, 0.1);
            color: var(--signed);
        }

        .badge-pipeline {
            background: rgba(245, 158, 11, 0.1);
            color: var(--pipeline);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
        }

        .footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-light);
            text-align: right;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .filters {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .analysis-cards {
                grid-template-columns: 1fr;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ - å¢å¼ºç‰ˆ</h1>
            <p>æ™ºèƒ½å·¥ä½œæ—¶é—´è¿½è¸ªã€å¤šç»´åº¦ç»Ÿè®¡åˆ†æä¸å·¥ä½œé‡ç®¡ç†</p>
        </div>

        <div class="main">
            <!-- æ—¥æœŸèŒƒå›´è¿‡æ»¤ -->
            <div class="filters">
                <div class="filter-group">
                    <label>å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="filterStartDate">
                </div>
                <div class="filter-group">
                    <label>ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="filterEndDate">
                </div>
                <div class="filter-group">
                    <label>é¡¹ç›®ç±»å‹</label>
                    <select id="filterProjectType">
                        <option value="">å…¨éƒ¨</option>
                        <option value="presales">å”®å‰</option>
                        <option value="aftersales">å”®å</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ç­¾å•çŠ¶æ€</label>
                    <select id="filterSignedStatus">
                        <option value="">å…¨éƒ¨</option>
                        <option value="signed">å·²ç­¾å•</option>
                        <option value="pipeline">Pipeline</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>è¡Œä¸š</label>
                    <input type="text" id="filterIndustry" placeholder="è¾“å…¥è¡Œä¸š">
                </div>
                <div class="filter-group">
                    <label>å®¢æˆ·</label>
                    <input type="text" id="filterClient" placeholder="è¾“å…¥å®¢æˆ·å">
                </div>
                <div class="filter-group">
                    <label>é”€å”®äººå‘˜</label>
                    <input type="text" id="filterSalesperson" placeholder="è¾“å…¥é”€å”®å">
                </div>
                <div class="filter-group" style="align-self: flex-end;">
                    <button class="btn btn-primary" onclick="applyFilters()">åº”ç”¨ç­›é€‰</button>
                </div>
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">æ€»é¡¹ç›®é‡‘é¢</div>
                    <div class="stat-value" id="totalAmount">Â£0K</div>
                    <div class="stat-sub" id="totalCount">å…±0ä¸ªé¡¹ç›®</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">å”®å‰é¡¹ç›®é‡‘é¢</div>
                    <div class="stat-value" id="preSalesAmount">Â£0K</div>
                    <div class="stat-sub" id="preSalesCount">å…±0ä¸ªé¡¹ç›®</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">å”®å‰å·²ç­¾å•</div>
                    <div class="stat-value" id="signedAmount" style="color: var(--signed);">Â£0K</div>
                    <div class="stat-sub" id="signedCount">å…±0ä¸ªé¡¹ç›®</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">å”®å‰Pipeline</div>
                    <div class="stat-value" id="pipelineAmount" style="color: var(--pipeline);">Â£0K</div>
                    <div class="stat-sub" id="pipelineCount">å…±0ä¸ªé¡¹ç›®</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">å”®åé¡¹ç›®é‡‘é¢</div>
                    <div class="stat-value" id="afterSalesAmount">Â£0K</div>
                    <div class="stat-sub" id="afterSalesCount">å…±0ä¸ªé¡¹ç›®</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">å·¥ä½œæ—¶é•¿</div>
                    <div class="stat-value" id="workHours">0h</div>
                    <div class="stat-sub" id="workDays">0å¤©</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">åŠ ç­æ—¶é•¿</div>
                    <div class="stat-value" id="overtimeHours" style="color: var(--danger);">0h</div>
                    <div class="stat-sub" id="overtimeDays">0å¤©</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">å®¢æˆ·æ•° / é”€å”®äººå‘˜æ•°</div>
                    <div class="stat-value" id="clientCount">0 / 0</div>
                    <div class="stat-sub">ä¸é‡å¤è®¡ç®—</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">æœ¬å‘¨åŠ ç­æ—¶é•¿</div>
                    <div class="stat-value" id="weekOvertimeHours" style="color: var(--danger);">0h</div>
                    <div class="stat-sub" id="weekOvertimeInfo">æœ¬å‘¨ï¼š0å¤©åŠ ç­</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">æœ¬å‘¨æ”¯æŒé¡¹ç›®æ•°</div>
                    <div class="stat-value" id="weekProjectCount">0</div>
                    <div class="stat-sub" id="weekProjectInfo">ä¸ªé¡¹ç›®</div>
                </div>
            </div>

            <!-- å¤šç»´åº¦åˆ†æ -->
            <div class="analysis-cards">
                <div class="analysis-card">
                    <h3>æŒ‰è¡Œä¸šç»Ÿè®¡é‡‘é¢</h3>
                    <div id="industryAnalysis"></div>
                </div>

                <div class="analysis-card">
                    <h3>æŒ‰å®¢æˆ·ç»Ÿè®¡é‡‘é¢</h3>
                    <div id="clientAnalysis"></div>
                </div>

                <div class="analysis-card">
                    <h3>æŒ‰é”€å”®äººå‘˜ç»Ÿè®¡é‡‘é¢</h3>
                    <div id="salespersonAnalysis"></div>
                </div>
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="controls">
                <button class="btn btn-primary" onclick="openAddModal()">â• æ·»åŠ æ–°é¡¹ç›®</button>
                <button class="btn btn-secondary" onclick="exportData()">ğŸ’¾ å¯¼å‡ºæ•°æ®</button>
                <button class="btn btn-secondary" onclick="openImportModal()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
                <button class="btn btn-secondary" onclick="resetFilters()">ğŸ”„ é‡ç½®ç­›é€‰</button>
                <button class="btn btn-primary" onclick="generateWeeklyReport()">ğŸ“‹ ç”Ÿæˆå‘¨æŠ¥</button>
                <button class="btn btn-primary" onclick="sendEmailReport()">ğŸ“§ å‘é€é‚®ä»¶</button>
            </div>

            <!-- æ•°æ®è¡¨æ ¼ -->
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>å®¢æˆ·</th>
                            <th>é¡¹ç›®</th>
                            <th>è¡Œä¸š</th>
                            <th>ç±»å‹</th>
                            <th>ç­¾å•</th>
                            <th>è§„æ¨¡(KÂ£)</th>
                            <th>é”€å”®</th>
                            <th>å·¥ç¨‹å¸ˆ</th>
                            <th>å·¥ä½œæ—¶é•¿</th>
                            <th>åŠ ç­æ—¶é•¿</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="footer">æœ€åæ›´æ–°ï¼š<span id="lastUpdate">-</span></div>
    </div>

    <!-- æ·»åŠ é¡¹ç›®æ¨¡æ€æ¡† -->
    <div id="formModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ æ–°é¡¹ç›®</div>
            <form onsubmit="saveData(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>å‘¨èµ·å§‹æ—¥æœŸ *</label>
                        <input type="date" id="weekStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>å®¢æˆ·åç§° *</label>
                        <input type="text" id="clientName" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é¡¹ç›®åç§° *</label>
                        <input type="text" id="projectName" required>
                    </div>
                    <div class="form-group">
                        <label>è¡Œä¸š *</label>
                        <input type="text" id="industry" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>å›½å®¶ *</label>
                        <input type="text" id="country" required>
                    </div>
                    <div class="form-group">
                        <label>é¡¹ç›®è§„æ¨¡ (KÂ£) *</label>
                        <input type="number" id="projectScale" step="0.1" min="0" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é¡¹ç›®ç±»å‹ *</label>
                        <select id="projectType" onchange="updateProjectStages()" required>
                            <option value="">-- è¯·é€‰æ‹© --</option>
                            <option value="presales">å”®å‰</option>
                            <option value="aftersales">å”®å</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é”€å”®äººå‘˜ *</label>
                        <input type="text" id="salesperson" required>
                    </div>
                </div>

                <div id="presalesSection" style="display:none;">
                    <div class="form-group">
                        <label>ç­¾å•çŠ¶æ€</label>
                        <select id="signedStatus">
                            <option value="pipeline">Pipeline</option>
                            <option value="signed">å·²ç­¾å•</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>è¿›åº¦é˜¶æ®µ</label>
                    <input type="text" id="projectStage" placeholder="å¦‚ï¼šæŠ€æœ¯æ–¹æ¡ˆã€ç°åœºä¿éšœ">
                </div>

                <div class="form-group">
                    <label>å·¥ä½œæ—¶é•¿ (h)</label>
                    <input type="number" id="workHours" step="0.5" min="0" value="0">
                </div>

                <div class="form-group">
                    <label>åŠ ç­æ—¶é•¿ (h)</label>
                    <input type="number" id="overtimeHours" step="0.5" min="0" value="0">
                </div>

                <div class="form-group">
                    <label>ä¸»å·¥ç¨‹å¸ˆ</label>
                    <input type="text" id="engineerName">
                </div>

                <div class="form-group">
                    <label>åˆä½œå·¥ç¨‹å¸ˆ</label>
                    <input type="text" id="collaboratorNames" placeholder="å¤šä¸ªå·¥ç¨‹å¸ˆç”¨é€—å·åˆ†éš”">
                </div>

                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeFormModal()" style="flex:1;">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" style="flex:1;">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å¯¼å…¥æ¨¡æ€æ¡† -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">å¯¼å…¥æ•°æ®</div>
            <div class="form-group">
                <label>é€‰æ‹©CSVæˆ–Excelæ–‡ä»¶</label>
                <input type="file" id="fileInput" accept=".csv,.xls,.xlsx">
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="closeImportModal()" style="flex:1;">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="importData()" style="flex:1;">å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <!-- å‘¨æŠ¥é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="reportModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">å·¥ä½œå‘¨æŠ¥ - æ–‡å­—ç‰ˆ</div>
            <div id="reportContent" style="background: white; padding: 16px; border-radius: 8px; max-height: 600px; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.6; color: var(--text-dark);"></div>
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button class="btn btn-secondary" onclick="closeReportModal()" style="flex:1;">å…³é—­</button>
                <button class="btn btn-primary" onclick="copyReportToClipboard()" style="flex:1;">ğŸ“‹ å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
                <button class="btn btn-primary" onclick="generateAISummary()" style="flex:1;">âœ¨ AIç”Ÿæˆæ‘˜è¦</button>
                <button class="btn btn-primary" onclick="sendEmailReport()" style="flex:1;">ğŸ“§ å‘é€é‚®ä»¶</button>
            </div>
        </div>
    </div>

    <!-- å‘é€é‚®ä»¶æ¨¡æ€æ¡† -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">å‘é€å‘¨æŠ¥é‚®ä»¶</div>
            <div class="form-group">
                <label>æ”¶ä»¶äººé‚®ç®± *</label>
                <input type="email" id="emailRecipient" placeholder="example@company.com" required>
            </div>
            <div class="form-group">
                <label>æŠ„é€ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="emailCC" placeholder="å¤šä¸ªé‚®ç®±ç”¨é€—å·åˆ†éš”">
            </div>
            <div class="form-group">
                <label>é‚®ä»¶ä¸»é¢˜ *</label>
                <input type="text" id="emailSubject" placeholder="å·¥ä½œå‘¨æŠ¥" required>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="closeEmailModal()" style="flex:1;">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="sendEmail()" style="flex:1;">ğŸ“§ å‘é€</button>
            </div>
        </div>
    </div>

    <!-- AIæ‘˜è¦æ¨¡æ€æ¡† -->
    <div id="aiSummaryModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">âœ¨ AIç”Ÿæˆæ‘˜è¦</div>
            <div style="margin-bottom: 16px;">
                <label style="font-size: 13px; color: var(--text-light);">
                    <input type="checkbox" id="useAISummary" checked> ä½¿ç”¨AIç”Ÿæˆçš„æ‘˜è¦ï¼ˆä½¿ç”¨Claude APIï¼‰
                </label>
            </div>
            <div id="aiSummaryContent" style="background: white; padding: 16px; border-radius: 8px; max-height: 600px; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.6; color: var(--text-dark); border: 1px solid var(--border);"></div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-light);">
                <p>æ³¨ï¼šAIæ‘˜è¦ä½¿ç”¨Claude APIç”Ÿæˆï¼Œéœ€è¦è”ç½‘ã€‚å¦‚æ— ç½‘ç»œæˆ–APIä¸å¯ç”¨ï¼Œè¯·ä½¿ç”¨åŸå§‹å‘¨æŠ¥ã€‚</p>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button class="btn btn-secondary" onclick="closeAISummaryModal()" style="flex:1;">å…³é—­</button>
                <button class="btn btn-primary" onclick="copyAISummaryToClipboard()" style="flex:1;">ğŸ“‹ å¤åˆ¶æ‘˜è¦</button>
                <button class="btn btn-primary" onclick="useAISummaryForEmail()" style="flex:1;">ğŸ“§ ç”¨æ­¤æ‘˜è¦å‘é€é‚®ä»¶</button>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        const STORAGE_KEY = 'weeklyReportData_enhanced';

        const stageOptions = {
            presales: ['éœ€æ±‚è°ƒç ”', 'æŠ€æœ¯ç ”è®¨', 'å·¥å‹˜', 'æŠ€æœ¯æ–¹æ¡ˆ', 'é¢„ç®—å®¡æ‰¹', 'æ‹›æ ‡ä¸­', 'æŠ•æ ‡ææ–™å‡†å¤‡', 'æäº¤æŠ¥ä»·', 'å¾…å…¬å¸ƒç»“æœ', 'å·²å…¬å¸ƒç»“æœ', 'å·²ä¸‹å•', 'å·²åˆ°è´§'],
            aftersales: ['ç¼–å†™å”®åå®æ–½æ–¹æ¡ˆ', 'ç¼–å†™å®æ–½è®¡åˆ’', 'æ•´ç†éªŒæ”¶æ–‡æ¡£', 'ç°åœºäº¤ä»˜', 'å‰²æ¥', 'ç°åœºä¿éšœ', 'ç”¨æˆ·åŸ¹è®­', 'ç°åœºéªŒæ”¶', 'è¿ç»´æ”¯æŒ', 'æ•…éšœæ’æŸ¥']
        };

        function init() {
            loadData();
            setDefaultDate();
            updateStats();
        }

        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            allData = stored ? JSON.parse(stored) : [];
            filteredData = JSON.parse(JSON.stringify(allData));
            renderTable();
        }

        function setDefaultDate() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const monday = new Date(today.setDate(diff));
            document.getElementById('weekStartDate').value = monday.toISOString().split('T')[0];
        }

        function updateProjectStages() {
            const type = document.getElementById('projectType').value;
            const presalesSection = document.getElementById('presalesSection');
            if (type === 'presales') {
                presalesSection.style.display = 'block';
            } else {
                presalesSection.style.display = 'none';
            }
        }

        function applyFilters() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const projectType = document.getElementById('filterProjectType').value;
            const signedStatus = document.getElementById('filterSignedStatus').value;
            const industry = document.getElementById('filterIndustry').value.toLowerCase();
            const client = document.getElementById('filterClient').value.toLowerCase();
            const salesperson = document.getElementById('filterSalesperson').value.toLowerCase();

            filteredData = allData.filter(item => {
                if (startDate && item.weekStartDate < startDate) return false;
                if (endDate && item.weekStartDate > endDate) return false;
                if (projectType && item.projectType !== projectType) return false;
                if (signedStatus && item.signedStatus !== signedStatus) return false;
                if (industry && !item.industry.toLowerCase().includes(industry)) return false;
                if (client && !item.clientName.toLowerCase().includes(client)) return false;
                if (salesperson && !item.salesperson.toLowerCase().includes(salesperson)) return false;
                return true;
            });

            renderTable();
            updateStats();
        }

        function resetFilters() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterProjectType').value = '';
            document.getElementById('filterSignedStatus').value = '';
            document.getElementById('filterIndustry').value = '';
            document.getElementById('filterClient').value = '';
            document.getElementById('filterSalesperson').value = '';
            filteredData = JSON.parse(JSON.stringify(allData));
            renderTable();
            updateStats();
        }

        function getWeekStartDate() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const monday = new Date(today.setDate(diff));
            return monday.toISOString().split('T')[0];
        }

        function updateStats() {
            // åŸºç¡€ç»Ÿè®¡
            const totalAmount = filteredData.reduce((sum, item) => sum + item.projectScale, 0);
            const preSalesData = filteredData.filter(item => item.projectType === 'presales');
            const preSalesAmount = preSalesData.reduce((sum, item) => sum + item.projectScale, 0);
            const signedData = preSalesData.filter(item => item.signedStatus === 'signed');
            const signedAmount = signedData.reduce((sum, item) => sum + item.projectScale, 0);
            const pipelineData = preSalesData.filter(item => item.signedStatus === 'pipeline');
            const pipelineAmount = pipelineData.reduce((sum, item) => sum + item.projectScale, 0);
            const afterSalesAmount = filteredData.filter(item => item.projectType === 'aftersales').reduce((sum, item) => sum + item.projectScale, 0);

            const totalWorkHours = filteredData.reduce((sum, item) => sum + (item.workHours || 0), 0);
            const totalOvertimeHours = filteredData.reduce((sum, item) => sum + (item.overtimeHours || 0), 0);

            // ç»Ÿè®¡å®¢æˆ·å’Œé”€å”®äººå‘˜
            const uniqueClients = new Set(filteredData.map(item => item.clientName));
            const uniqueSalespeople = new Set(filteredData.map(item => item.salesperson));

            // æœ¬å‘¨ç»Ÿè®¡
            const weekStartDate = getWeekStartDate();
            const weekEndDate = new Date(new Date(weekStartDate).getTime() + 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            const weekData = allData.filter(item => item.weekStartDate === weekStartDate);
            const weekOvertimeHours = weekData.reduce((sum, item) => sum + (item.overtimeHours || 0), 0);
            const weekProjectCount = new Set(weekData.map(item => item.projectName)).size;

            // æ›´æ–°å¡ç‰‡
            document.getElementById('totalAmount').textContent = 'Â£' + totalAmount.toFixed(1) + 'K';
            document.getElementById('totalCount').textContent = 'å…±' + filteredData.length + 'ä¸ªé¡¹ç›®';

            document.getElementById('preSalesAmount').textContent = 'Â£' + preSalesAmount.toFixed(1) + 'K';
            document.getElementById('preSalesCount').textContent = 'å…±' + preSalesData.length + 'ä¸ªé¡¹ç›®';

            document.getElementById('signedAmount').textContent = 'Â£' + signedAmount.toFixed(1) + 'K';
            document.getElementById('signedCount').textContent = 'å…±' + signedData.length + 'ä¸ªé¡¹ç›®';

            document.getElementById('pipelineAmount').textContent = 'Â£' + pipelineAmount.toFixed(1) + 'K';
            document.getElementById('pipelineCount').textContent = 'å…±' + pipelineData.length + 'ä¸ªé¡¹ç›®';

            document.getElementById('afterSalesAmount').textContent = 'Â£' + afterSalesAmount.toFixed(1) + 'K';
            document.getElementById('afterSalesCount').textContent = 'å…±' + filteredData.filter(item => item.projectType === 'aftersales').length + 'ä¸ªé¡¹ç›®';

            document.getElementById('workHours').textContent = totalWorkHours.toFixed(1) + 'h';
            document.getElementById('workDays').textContent = 'çº¦' + Math.ceil(totalWorkHours / 8.5) + 'å¤©';

            document.getElementById('overtimeHours').textContent = totalOvertimeHours.toFixed(1) + 'h';
            document.getElementById('overtimeDays').textContent = 'çº¦' + Math.ceil(totalOvertimeHours / 8.5) + 'å¤©';

            document.getElementById('clientCount').textContent = uniqueClients.size + ' / ' + uniqueSalespeople.size;

            // æœ¬å‘¨ç»Ÿè®¡
            document.getElementById('weekOvertimeHours').textContent = weekOvertimeHours.toFixed(1) + 'h';
            const weekDays = Math.ceil(weekOvertimeHours / 8.5);
            document.getElementById('weekOvertimeInfo').textContent = `å‘¨æœŸï¼š${weekStartDate} åˆ° ${weekEndDate}`;

            document.getElementById('weekProjectCount').textContent = weekProjectCount;
            document.getElementById('weekProjectInfo').textContent = `æœ¬å‘¨æ”¯æŒ ${weekProjectCount} ä¸ªé¡¹ç›®`;

            // å¤šç»´åº¦åˆ†æ
            updateAnalysis();
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-CN');
        }

        function updateAnalysis() {
            // æŒ‰è¡Œä¸šç»Ÿè®¡
            const industryMap = {};
            filteredData.forEach(item => {
                industryMap[item.industry] = (industryMap[item.industry] || 0) + item.projectScale;
            });

            const industryHTML = Object.entries(industryMap)
                .sort((a, b) => b[1] - a[1])
                .map(([industry, amount]) => `
                    <div class="analysis-item">
                        <span class="analysis-label">${industry}</span>
                        <span class="analysis-value">Â£${amount.toFixed(1)}K</span>
                    </div>
                `).join('');
            document.getElementById('industryAnalysis').innerHTML = industryHTML || '<div class="analysis-item"><span>æ— æ•°æ®</span></div>';

            // æŒ‰å®¢æˆ·ç»Ÿè®¡
            const clientMap = {};
            filteredData.forEach(item => {
                clientMap[item.clientName] = (clientMap[item.clientName] || 0) + item.projectScale;
            });

            const clientHTML = Object.entries(clientMap)
                .sort((a, b) => b[1] - a[1])
                .map(([client, amount]) => `
                    <div class="analysis-item">
                        <span class="analysis-label">${client}</span>
                        <span class="analysis-value">Â£${amount.toFixed(1)}K</span>
                    </div>
                `).join('');
            document.getElementById('clientAnalysis').innerHTML = clientHTML || '<div class="analysis-item"><span>æ— æ•°æ®</span></div>';

            // æŒ‰é”€å”®äººå‘˜ç»Ÿè®¡
            const salespersonMap = {};
            filteredData.forEach(item => {
                salespersonMap[item.salesperson] = (salespersonMap[item.salesperson] || 0) + item.projectScale;
            });

            const salespersonHTML = Object.entries(salespersonMap)
                .sort((a, b) => b[1] - a[1])
                .map(([salesperson, amount]) => `
                    <div class="analysis-item">
                        <span class="analysis-label">${salesperson}</span>
                        <span class="analysis-value">Â£${amount.toFixed(1)}K</span>
                    </div>
                `).join('');
            document.getElementById('salespersonAnalysis').innerHTML = salespersonHTML || '<div class="analysis-item"><span>æ— æ•°æ®</span></div>';
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:40px;">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = filteredData.map((item, index) => {
                const typeBadge = item.projectType === 'presales' 
                    ? '<span class="badge badge-presales">å”®å‰</span>'
                    : '<span class="badge badge-aftersales">å”®å</span>';

                const signedBadge = item.projectType === 'presales'
                    ? (item.signedStatus === 'signed' 
                        ? '<span class="badge badge-signed">å·²ç­¾å•</span>'
                        : '<span class="badge badge-pipeline">Pipeline</span>')
                    : '-';

                return `
                    <tr>
                        <td>${item.clientName}</td>
                        <td>${item.projectName}</td>
                        <td>${item.industry}</td>
                        <td>${typeBadge}</td>
                        <td>${signedBadge}</td>
                        <td>Â£${item.projectScale}</td>
                        <td>${item.salesperson}</td>
                        <td>${item.engineerName}</td>
                        <td>${item.workHours}h</td>
                        <td>${item.overtimeHours}h</td>
                        <td>
                            <button class="btn btn-small btn-primary" onclick="editData(${index})">ç¼–è¾‘</button>
                            <button class="btn btn-small btn-secondary" onclick="deleteData(${index})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function saveData(event) {
            event.preventDefault();

            const newData = {
                weekStartDate: document.getElementById('weekStartDate').value,
                clientName: document.getElementById('clientName').value,
                projectName: document.getElementById('projectName').value,
                industry: document.getElementById('industry').value,
                country: document.getElementById('country').value,
                projectScale: parseFloat(document.getElementById('projectScale').value),
                projectType: document.getElementById('projectType').value,
                signedStatus: document.getElementById('projectType').value === 'presales' ? document.getElementById('signedStatus').value : '',
                projectStage: document.getElementById('projectStage').value,
                salesperson: document.getElementById('salesperson').value,
                workHours: parseFloat(document.getElementById('workHours').value) || 0,
                overtimeHours: parseFloat(document.getElementById('overtimeHours').value) || 0,
                engineerName: document.getElementById('engineerName').value,
                collaboratorNames: document.getElementById('collaboratorNames').value,
                date: new Date().toISOString()
            };

            allData.push(newData);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
            filteredData = JSON.parse(JSON.stringify(allData));
            renderTable();
            updateStats();
            closeFormModal();
        }

        function deleteData(index) {
            if (confirm('ç¡®å®šåˆ é™¤?')) {
                const dataIndex = allData.findIndex(item => JSON.stringify(item) === JSON.stringify(filteredData[index]));
                if (dataIndex >= 0) {
                    allData.splice(dataIndex, 1);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
                    filteredData.splice(index, 1);
                    renderTable();
                    updateStats();
                }
            }
        }

        function editData(index) {
            alert('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...');
        }

        function exportData() {
            const headers = ['å‘¨èµ·å§‹æ—¥æœŸ', 'å®¢æˆ·åç§°', 'é¡¹ç›®åç§°', 'è¡Œä¸š', 'å›½å®¶', 'é¡¹ç›®è§„æ¨¡(KÂ£)', 'é¡¹ç›®ç±»å‹', 'ç­¾å•çŠ¶æ€', 'è¿›åº¦é˜¶æ®µ', 'é”€å”®äººå‘˜', 'ä¸»å·¥ç¨‹å¸ˆ', 'åˆä½œå·¥ç¨‹å¸ˆ', 'å·¥ä½œæ—¶é•¿', 'åŠ ç­æ—¶é•¿'];
            const rows = filteredData.map(item => [
                item.weekStartDate, item.clientName, item.projectName, item.industry, item.country,
                item.projectScale, item.projectType, item.signedStatus, item.projectStage,
                item.salesperson, item.engineerName, item.collaboratorNames, item.workHours, item.overtimeHours
            ]);

            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'weekly-report.csv';
            link.click();
        }

        function importData() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) {
                alert('è¯·é€‰æ‹©æ–‡ä»¶');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('æ–‡ä»¶æ ¼å¼é”™è¯¯');
                        return;
                    }

                    // ç®€å•çš„CSVè§£æ
                    const parseCSVLine = (line) => {
                        const result = [];
                        let current = '';
                        let insideQuotes = false;
                        
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            if (char === '"') {
                                if (insideQuotes && line[i + 1] === '"') {
                                    current += '"';
                                    i++;
                                } else {
                                    insideQuotes = !insideQuotes;
                                }
                            } else if (char === ',' && !insideQuotes) {
                                result.push(current);
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        result.push(current);
                        return result;
                    };

                    const headers = parseCSVLine(lines[0]);
                    let importCount = 0;

                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCSVLine(lines[i]);
                        if (values.length < headers.length) continue;

                        const row = {};
                        headers.forEach((h, idx) => {
                            row[h.trim()] = values[idx] || '';
                        });

                        allData.push({
                            weekStartDate: row['å‘¨èµ·å§‹æ—¥æœŸ'],
                            clientName: row['å®¢æˆ·åç§°'],
                            projectName: row['é¡¹ç›®åç§°'],
                            industry: row['è¡Œä¸š'],
                            country: row['å›½å®¶'],
                            projectScale: parseFloat(row['é¡¹ç›®è§„æ¨¡(KÂ£)']) || 0,
                            projectType: row['é¡¹ç›®ç±»å‹'],
                            signedStatus: row['ç­¾å•çŠ¶æ€'],
                            projectStage: row['è¿›åº¦é˜¶æ®µ'],
                            salesperson: row['é”€å”®äººå‘˜'],
                            workHours: parseFloat(row['å·¥ä½œæ—¶é•¿']) || 0,
                            overtimeHours: parseFloat(row['åŠ ç­æ—¶é•¿']) || 0,
                            engineerName: row['ä¸»å·¥ç¨‹å¸ˆ'],
                            collaboratorNames: row['åˆä½œå·¥ç¨‹å¸ˆ'],
                            date: new Date().toISOString()
                        });
                        importCount++;
                    }

                    localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
                    filteredData = JSON.parse(JSON.stringify(allData));
                    renderTable();
                    updateStats();
                    closeImportModal();
                    alert(`æˆåŠŸå¯¼å…¥ ${importCount} æ¡è®°å½•`);
                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥: ' + error.message);
                }
            };

            reader.readAsText(file);
        }

        function openAddModal() {
            document.getElementById('formModal').classList.add('active');
        }

        function closeFormModal() {
            document.getElementById('formModal').classList.remove('active');
            document.getElementById('dataForm').reset();
            setDefaultDate();
        }

        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            document.getElementById('fileInput').value = '';
        }

        function generateWeeklyReport() {
            const weekStartDate = getWeekStartDate();
            const weekData = allData.filter(item => item.weekStartDate === weekStartDate);

            if (weekData.length === 0) {
                alert('æœ¬å‘¨æš‚æ— é¡¹ç›®æ•°æ®ï¼Œæ— æ³•ç”Ÿæˆå‘¨æŠ¥');
                return;
            }

            let report = generateReportContent(weekData, weekStartDate);
            document.getElementById('reportContent').textContent = report;
            document.getElementById('reportModal').classList.add('active');
        }

        function generateReportContent(weekData, weekStartDate) {
            const today = new Date();
            const dateStr = today.toLocaleDateString('zh-CN');
            const weekEndDate = new Date(new Date(weekStartDate).getTime() + 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            // ç®€å•ç»Ÿè®¡
            const totalAmount = weekData.reduce((sum, item) => sum + item.projectScale, 0);
            const totalWorkHours = weekData.reduce((sum, item) => sum + (item.workHours || 0), 0);
            const totalOvertimeHours = weekData.reduce((sum, item) => sum + (item.overtimeHours || 0), 0);

            let report = `å‘¨æŠ¥ - ${weekStartDate}\n\n`;

            // æŒ‰å®¢æˆ·åˆ†ç»„æ˜¾ç¤ºé¡¹ç›®
            const groupedByClient = {};
            weekData.forEach(item => {
                if (!groupedByClient[item.clientName]) {
                    groupedByClient[item.clientName] = [];
                }
                groupedByClient[item.clientName].push(item);
            });

            let projectIndex = 1;
            Object.entries(groupedByClient).forEach(([client, projects]) => {
                const clientTotal = projects.reduce((sum, p) => sum + p.projectScale, 0);

                report += `${projectIndex}. ${client}\n`;
                report += `å†…å®¹ï¼š${projects.map(p => p.projectName).join('ã€')}\n`;
                report += `è§„æ¨¡ï¼š${clientTotal.toFixed(1)}K EURO\n`;
                report += `ä¸‹ä¸€æ­¥å·¥ä½œè®¡åˆ’ï¼šå®Œæˆ${projects[0].projectStage || 'é¡¹ç›®äº¤ä»˜'}ï¼Œç›¸å…³ç»†èŠ‚éœ€è¦åŒæ–¹æ²Ÿé€šç¡®è®¤\n`;
                report += `\n`;

                projectIndex++;
            });

            // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            report += `å·¥ä½œæ€»ç»“ï¼š\n`;
            report += `æœ¬å‘¨å…±æ”¯æŒ ${Object.keys(groupedByClient).length} ä¸ªå®¢æˆ·ï¼Œ${weekData.length} ä¸ªé¡¹ç›®\n`;
            report += `é¡¹ç›®æ€»é‡‘é¢ï¼š${totalAmount.toFixed(1)}K EURO\n`;
            report += `å·¥ä½œæ—¶é•¿ï¼š${totalWorkHours.toFixed(1)}h\n`;
            report += `åŠ ç­æ—¶é•¿ï¼š${totalOvertimeHours.toFixed(1)}h\n`;

            return report;
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('active');
        }

        function copyReportToClipboard() {
            const reportContent = document.getElementById('reportContent').textContent;
            navigator.clipboard.writeText(reportContent).then(() => {
                alert('å‘¨æŠ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        function downloadReportAsText() {
            const reportContent = document.getElementById('reportContent').textContent;
            const weekStartDate = getWeekStartDate();
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å‘¨æŠ¥_${weekStartDate}.txt`;
            link.click();
        }

        function openEmailModal() {
            document.getElementById('emailModal').classList.add('active');
            const weekStartDate = getWeekStartDate();
            document.getElementById('emailSubject').value = `${weekStartDate} å‘¨å·¥ä½œå‘¨æŠ¥`;
        }

        function closeEmailModal() {
            document.getElementById('emailModal').classList.remove('active');
        }

        function sendEmailReport() {
            openEmailModal();
        }

        async function generateAISummary() {
            const reportContent = document.getElementById('reportContent').textContent;
            
            document.getElementById('aiSummaryContent').textContent = 'æ­£åœ¨ç”Ÿæˆæ‘˜è¦ï¼Œè¯·ç¨å€™...';
            document.getElementById('aiSummaryModal').classList.add('active');

            try {
                // è°ƒç”¨Claude APIæ¥ç”Ÿæˆæ‘˜è¦
                const apiKey = prompt('è¯·è¾“å…¥ä½ çš„Claude API Keyï¼ˆç”¨äºç”ŸæˆAIæ‘˜è¦ï¼‰ï¼š\n\nå¦‚æœæ²¡æœ‰ï¼Œå¯ä»¥åˆ° https://console.anthropic.com è·å–\n\nç•™ç©ºå°†ä½¿ç”¨åŸå§‹å‘¨æŠ¥');
                
                if (apiKey === null) {
                    // ç”¨æˆ·å–æ¶ˆ
                    document.getElementById('aiSummaryContent').textContent = reportContent;
                    return;
                }

                if (!apiKey) {
                    // ç”¨æˆ·æ²¡æœ‰è¾“å…¥API Keyï¼Œä½¿ç”¨åŸå§‹å‘¨æŠ¥
                    document.getElementById('aiSummaryContent').textContent = reportContent;
                    alert('å·²ä½¿ç”¨åŸå§‹å‘¨æŠ¥ã€‚å¦‚éœ€AIæ‘˜è¦ï¼Œè¯·æä¾›API Keyã€‚');
                    return;
                }

                // å‘é€è¯·æ±‚åˆ°Claude API
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-opus-4-20250805',
                        max_tokens: 1000,
                        messages: [
                            {
                                role: 'user',
                                content: `è¯·æ ¹æ®ä»¥ä¸‹å·¥ä½œå‘¨æŠ¥ï¼Œç”Ÿæˆä¸€ä»½ç®€æ´çš„é‚®ä»¶æ‘˜è¦ã€‚è¦æ±‚ï¼š
1. æ ¼å¼ç®€æ´ï¼ŒæŒ‰ç…§"å®¢æˆ·åç§° - é¡¹ç›®å†…å®¹ - ä¸‹ä¸€æ­¥è®¡åˆ’"çš„æ ¼å¼
2. çªå‡ºé‡ç‚¹ï¼ŒåŒ…å«é‡‘é¢å’Œå…³é”®äº¤ä»˜å†…å®¹
3. é€‚åˆç›´æ¥å‘é€ç»™éƒ¨é—¨é¢†å¯¼
4. ä¸­æ–‡å›å¤ï¼Œä¿æŒä¸“ä¸šè¯­æ°”

åŸå§‹å‘¨æŠ¥ï¼š
${reportContent}

è¯·ç”Ÿæˆé‚®ä»¶æ‘˜è¦ï¼š`
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'ç”Ÿæˆæ‘˜è¦å¤±è´¥');
                }

                const data = await response.json();
                const summary = data.content[0].text;
                document.getElementById('aiSummaryContent').textContent = summary;
            } catch (error) {
                document.getElementById('aiSummaryContent').textContent = `ç”Ÿæˆæ‘˜è¦å¤±è´¥ï¼š${error.message}\n\nå·²å›é€€åˆ°åŸå§‹å‘¨æŠ¥ï¼š\n\n${reportContent}`;
            }
        }

        function closeAISummaryModal() {
            document.getElementById('aiSummaryModal').classList.remove('active');
        }

        function copyAISummaryToClipboard() {
            const summaryContent = document.getElementById('aiSummaryContent').textContent;
            navigator.clipboard.writeText(summaryContent).then(() => {
                alert('æ‘˜è¦å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        function useAISummaryForEmail() {
            const summaryContent = document.getElementById('aiSummaryContent').textContent;
            
            // ä¿å­˜æ‘˜è¦å†…å®¹åˆ°ä¸´æ—¶å˜é‡
            window.currentEmailContent = summaryContent;
            
            closeAISummaryModal();
            openEmailModal();
        }

        function sendEmail() {
            const recipient = document.getElementById('emailRecipient').value;
            const cc = document.getElementById('emailCC').value;
            const subject = document.getElementById('emailSubject').value;
            
            // ä¼˜å…ˆä½¿ç”¨AIæ‘˜è¦ï¼Œå…¶æ¬¡ä½¿ç”¨åŸå§‹å‘¨æŠ¥
            let emailContent = window.currentEmailContent || document.getElementById('reportContent').textContent;

            if (!recipient) {
                alert('è¯·è¾“å…¥æ”¶ä»¶äººé‚®ç®±');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(recipient)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                return;
            }

            const mailtoBody = encodeURIComponent(emailContent).substring(0, 32000);
            const mailtoCC = cc ? `&cc=${encodeURIComponent(cc)}` : '';
            const mailtoUrl = `mailto:${recipient}?subject=${encodeURIComponent(subject)}${mailtoCC}&body=${mailtoBody}`;

            alert(`å³å°†æ‰“å¼€é‚®ä»¶å®¢æˆ·ç«¯...`);
            window.open(mailtoUrl);
            closeEmailModal();
            
            // æ¸…é™¤ä¸´æ—¶ä¿å­˜çš„AIæ‘˜è¦
            window.currentEmailContent = null;
        }

        window.onclick = function(event) {
            if (event.target.id === 'formModal') closeFormModal();
            if (event.target.id === 'importModal') closeImportModal();
            if (event.target.id === 'reportModal') closeReportModal();
            if (event.target.id === 'emailModal') closeEmailModal();
            if (event.target.id === 'aiSummaryModal') closeAISummaryModal();
        }

        init();
    </script>
</body>
</html>
