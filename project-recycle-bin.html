<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›æ”¶ç«™ - å·¥ç¨‹å¸ˆå·¥æ—¶ç³»ç»Ÿ</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f5f7fa; }
        
        .header { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .header-title { display: flex; align-items: center; gap: 12px; }
        .header-title h1 { font-size: 22px; }
        .header-actions { display: flex; gap: 15px; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
        .btn-secondary { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; }
        .btn-secondary:hover { background: rgba(255,255,255,0.3); }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        
        /* æç¤ºä¿¡æ¯ */
        .info-banner { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 25px; display: flex; align-items: flex-start; gap: 15px; }
        .info-banner-icon { font-size: 32px; }
        .info-banner-content h3 { color: #92400e; margin-bottom: 8px; font-size: 16px; }
        .info-banner-content p { color: #a16207; font-size: 14px; line-height: 1.6; }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-row { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
        .stat-card { background: white; padding: 20px 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; min-width: 200px; }
        .stat-icon { font-size: 36px; }
        .stat-info .stat-value { font-size: 28px; font-weight: bold; color: #4b5563; }
        .stat-info .stat-label { font-size: 13px; color: #6b7280; }
        
        /* æ“ä½œæ  */
        .action-bar { background: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .action-bar-left { display: flex; align-items: center; gap: 15px; }
        .select-all-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .select-all-checkbox input { width: 18px; height: 18px; cursor: pointer; }
        .selected-count { font-size: 14px; color: #6b7280; }
        .action-bar-right { display: flex; gap: 10px; }
        .btn-action { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .btn-restore { background: #d1fae5; color: #059669; }
        .btn-restore:hover { background: #a7f3d0; }
        .btn-restore:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-delete-permanent { background: #fee2e2; color: #dc2626; }
        .btn-delete-permanent:hover { background: #fecaca; }
        .btn-delete-permanent:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* é¡¹ç›®åˆ—è¡¨ */
        .projects-list { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .list-header { display: grid; grid-template-columns: 40px 2fr 1fr 1fr 1fr 1fr 150px; padding: 15px 20px; background: #f8f9fa; border-bottom: 2px solid #e5e7eb; font-weight: 600; font-size: 13px; color: #6b7280; }
        .list-row { display: grid; grid-template-columns: 40px 2fr 1fr 1fr 1fr 1fr 150px; padding: 15px 20px; border-bottom: 1px solid #f0f0f0; align-items: center; transition: background 0.2s; }
        .list-row:hover { background: #f9fafb; }
        .list-row:last-child { border-bottom: none; }
        .list-row.selected { background: #fef2f2; }
        
        .row-checkbox { display: flex; align-items: center; justify-content: center; }
        .row-checkbox input { width: 18px; height: 18px; cursor: pointer; }
        
        .project-info .project-name { font-weight: 600; color: #333; margin-bottom: 3px; }
        .project-info .customer-name { font-size: 12px; color: #6b7280; }
        
        .list-cell { font-size: 13px; color: #4b5563; }
        .list-cell.type { display: flex; align-items: center; gap: 5px; }
        .type-badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .type-badge.presales { background: #ede9fe; color: #7c3aed; }
        .type-badge.postsales { background: #fef3c7; color: #d97706; }
        
        .delete-info { font-size: 12px; }
        .delete-info .delete-date { color: #6b7280; }
        .delete-info .days-remaining { color: #dc2626; font-weight: 600; }
        .delete-info .days-remaining.warning { color: #f59e0b; }
        .delete-info .days-remaining.safe { color: #10b981; }
        
        .row-actions { display: flex; gap: 8px; }
        .row-btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .row-btn-restore { background: #d1fae5; color: #059669; }
        .row-btn-restore:hover { background: #a7f3d0; }
        .row-btn-delete { background: #fee2e2; color: #dc2626; }
        .row-btn-delete:hover { background: #fecaca; }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state { text-align: center; padding: 80px 20px; }
        .empty-icon { font-size: 80px; margin-bottom: 20px; opacity: 0.5; }
        .empty-title { font-size: 20px; color: #6b7280; margin-bottom: 10px; }
        .empty-desc { font-size: 14px; color: #9ca3af; }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading { text-align: center; padding: 80px 20px; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #6b7280; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ç¡®è®¤å¯¹è¯æ¡† */
        .confirm-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .confirm-modal.show { display: flex; }
        .confirm-modal-content { background: white; border-radius: 16px; padding: 30px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .confirm-modal-header { text-align: center; margin-bottom: 20px; }
        .confirm-modal-icon { font-size: 50px; margin-bottom: 15px; }
        .confirm-modal-title { font-size: 20px; font-weight: 600; color: #333; margin-bottom: 10px; }
        .confirm-modal-desc { font-size: 14px; color: #666; line-height: 1.6; }
        .confirm-modal-warning { background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px 15px; margin: 20px 0; font-size: 13px; color: #991b1b; }
        .confirm-modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .confirm-modal-actions button { padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
        .btn-modal-cancel { background: #f0f0f0; color: #666; }
        .btn-modal-confirm { background: #dc2626; color: white; }
        .btn-modal-confirm.restore { background: #059669; }
        
        @media (max-width: 1024px) {
            .list-header, .list-row { grid-template-columns: 40px 2fr 1fr 1fr 150px; }
            .list-header > *:nth-child(4), .list-row > *:nth-child(4),
            .list-header > *:nth-child(5), .list-row > *:nth-child(5) { display: none; }
        }
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 15px; }
            .stats-row { flex-direction: column; }
            .list-header, .list-row { grid-template-columns: 40px 1fr 120px; }
            .list-header > *:nth-child(3), .list-row > *:nth-child(3),
            .list-header > *:nth-child(4), .list-row > *:nth-child(4),
            .list-header > *:nth-child(5), .list-row > *:nth-child(5),
            .list-header > *:nth-child(6), .list-row > *:nth-child(6) { display: none; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <h1>ğŸ—‘ï¸ å›æ”¶ç«™</h1>
            </div>
            <div class="header-actions">
                <a href="project-management.html" class="btn btn-secondary">ğŸ“ é¡¹ç›®ç®¡ç†</a>
                <a href="dashboard.html" class="btn btn-secondary">ğŸ  è¿”å›é¦–é¡µ</a>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="info-banner">
            <div class="info-banner-icon">âš ï¸</div>
            <div class="info-banner-content">
                <h3>å›æ”¶ç«™è¯´æ˜</h3>
                <p>å·²åˆ é™¤çš„é¡¹ç›®å°†åœ¨å›æ”¶ç«™ä¿ç•™ <strong>30å¤©</strong>ï¼Œä¹‹åå°†è¢«è‡ªåŠ¨æ°¸ä¹…åˆ é™¤ã€‚<br>
                åœ¨æ­¤æœŸé—´ï¼Œæ‚¨å¯ä»¥éšæ—¶æ¢å¤é¡¹ç›®ã€‚æ°¸ä¹…åˆ é™¤åï¼Œé¡¹ç›®æ•°æ®å°†æ— æ³•æ¢å¤ã€‚</p>
            </div>
        </div>
        
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-icon">ğŸ—‘ï¸</div>
                <div class="stat-info">
                    <div class="stat-value" id="total-deleted">0</div>
                    <div class="stat-label">å·²åˆ é™¤é¡¹ç›®</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">âš ï¸</div>
                <div class="stat-info">
                    <div class="stat-value" id="expiring-soon">0</div>
                    <div class="stat-label">å³å°†è¿‡æœŸï¼ˆ7å¤©å†…ï¼‰</div>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>æ­£åœ¨åŠ è½½...</div>
        </div>
        
        <div id="main-content" style="display: none;">
            <div class="action-bar" id="action-bar" style="display: none;">
                <div class="action-bar-left">
                    <label class="select-all-checkbox">
                        <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                        <span>å…¨é€‰</span>
                    </label>
                    <span class="selected-count" id="selected-count">å·²é€‰æ‹© 0 ä¸ªé¡¹ç›®</span>
                </div>
                <div class="action-bar-right">
                    <button class="btn-action btn-restore" id="btn-batch-restore" disabled onclick="batchRestore()">
                        â™»ï¸ æ‰¹é‡æ¢å¤
                    </button>
                    <button class="btn-action btn-delete-permanent" id="btn-batch-delete" disabled onclick="showBatchDeleteModal()">
                        ğŸ—‘ï¸ æ‰¹é‡æ°¸ä¹…åˆ é™¤
                    </button>
                </div>
            </div>
            
            <div class="projects-list" id="projects-list">
                <div class="list-header">
                    <div></div>
                    <div>é¡¹ç›®ä¿¡æ¯</div>
                    <div>ç±»å‹</div>
                    <div>åˆ é™¤è€…</div>
                    <div>åˆ é™¤æ—¶é—´</div>
                    <div>å‰©ä½™å¤©æ•°</div>
                    <div>æ“ä½œ</div>
                </div>
                <div id="list-body"></div>
            </div>
            
            <div class="empty-state" id="empty-state" style="display: none;">
                <div class="empty-icon">ğŸ‰</div>
                <div class="empty-title">å›æ”¶ç«™æ˜¯ç©ºçš„</div>
                <div class="empty-desc">æ²¡æœ‰å·²åˆ é™¤çš„é¡¹ç›®</div>
            </div>
        </div>
    </div>
    
    <!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="confirm-modal" id="confirm-modal">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <div class="confirm-modal-icon" id="modal-icon">ğŸ—‘ï¸</div>
                <div class="confirm-modal-title" id="modal-title">ç¡®è®¤æ“ä½œ</div>
                <div class="confirm-modal-desc" id="modal-desc">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div>
            </div>
            <div class="confirm-modal-warning" id="modal-warning" style="display: none;"></div>
            <div class="confirm-modal-actions">
                <button type="button" class="btn-modal-cancel" onclick="hideModal()">å–æ¶ˆ</button>
                <button type="button" class="btn-modal-confirm" id="modal-confirm-btn" onclick="confirmModalAction()">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBzcAr_OJFdIMnaYXRCE7TJs2qlK_TAy9U",
            authDomain: "weekly-report-d55e9.firebaseapp.com",
            projectId: "weekly-report-d55e9",
            storageBucket: "weekly-report-d55e9.appspot.com",
            messagingSenderId: "315332641675",
            appId: "1:315332641675:web:e1b52c3d4c5fcc7b8c0de7"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUser = null, userData = null, deletedProjects = [], selectedIds = new Set();
        let modalAction = null, modalData = null;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                await loadDeletedProjects();
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                userData = userDoc.exists ? userDoc.data() : { role: 'engineer' };
            } catch (e) {
                userData = { role: 'engineer' };
            }
        }

        async function loadDeletedProjects() {
            try {
                let query = db.collection('projects').where('deleted', '==', true);
                
                // éç®¡ç†å‘˜åªèƒ½çœ‹åˆ°è‡ªå·±åˆ é™¤çš„é¡¹ç›®
                if (userData.role !== 'admin') {
                    query = query.where('deletedBy', '==', currentUser.uid);
                }
                
                const snapshot = await query.get();
                deletedProjects = [];
                
                // è·å–åˆ é™¤è€…ä¿¡æ¯
                const userIds = new Set();
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.deletedBy) userIds.add(data.deletedBy);
                });
                
                const usersMap = {};
                for (const userId of userIds) {
                    try {
                        const userDoc = await db.collection('users').doc(userId).get();
                        if (userDoc.exists) {
                            const uData = userDoc.data();
                            usersMap[userId] = uData.fullName || uData.displayName || uData.email?.split('@')[0] || 'æœªçŸ¥';
                        }
                    } catch (e) {}
                }
                
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const deletedAt = data.deletedAt?.toDate ? data.deletedAt.toDate() : new Date(data.deletedAt);
                    const daysRemaining = Math.max(0, 30 - Math.floor((Date.now() - deletedAt.getTime()) / (1000 * 60 * 60 * 24)));
                    
                    deletedProjects.push({
                        id: doc.id,
                        ...data,
                        deletedAtDate: deletedAt,
                        daysRemaining,
                        deletedByName: usersMap[data.deletedBy] || 'æœªçŸ¥'
                    });
                });
                
                // æŒ‰åˆ é™¤æ—¶é—´æ’åºï¼ˆæœ€è¿‘åˆ é™¤çš„åœ¨å‰ï¼‰
                deletedProjects.sort((a, b) => b.deletedAtDate - a.deletedAtDate);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                
                updateStats();
                renderProjects();
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                document.getElementById('loading').innerHTML = `<div style="color: #dc2626;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        function updateStats() {
            document.getElementById('total-deleted').textContent = deletedProjects.length;
            document.getElementById('expiring-soon').textContent = deletedProjects.filter(p => p.daysRemaining <= 7).length;
        }

        function renderProjects() {
            const listBody = document.getElementById('list-body');
            const emptyState = document.getElementById('empty-state');
            const projectsList = document.getElementById('projects-list');
            const actionBar = document.getElementById('action-bar');
            
            if (deletedProjects.length === 0) {
                projectsList.style.display = 'none';
                actionBar.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            projectsList.style.display = 'block';
            actionBar.style.display = 'flex';
            emptyState.style.display = 'none';
            
            listBody.innerHTML = deletedProjects.map(project => {
                const isSelected = selectedIds.has(project.id);
                const typeClass = project.projectType === 'å”®å‰é¡¹ç›®' ? 'presales' : 'postsales';
                const typeText = project.projectType === 'å”®å‰é¡¹ç›®' ? 'å”®å‰' : 'å”®å';
                
                const deleteDate = project.deletedAtDate.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                
                let daysClass = 'safe';
                if (project.daysRemaining <= 3) daysClass = '';
                else if (project.daysRemaining <= 7) daysClass = 'warning';
                
                return `
                    <div class="list-row ${isSelected ? 'selected' : ''}" data-id="${project.id}">
                        <div class="row-checkbox">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelect('${project.id}')">
                        </div>
                        <div class="project-info">
                            <div class="project-name">${project.projectName || 'æœªå‘½åé¡¹ç›®'}</div>
                            <div class="customer-name">${project.customerName || '-'}</div>
                        </div>
                        <div class="list-cell type">
                            <span class="type-badge ${typeClass}">${typeText}</span>
                        </div>
                        <div class="list-cell">${project.deletedByName}</div>
                        <div class="list-cell delete-info">
                            <div class="delete-date">${deleteDate}</div>
                        </div>
                        <div class="list-cell delete-info">
                            <div class="days-remaining ${daysClass}">${project.daysRemaining}å¤©</div>
                        </div>
                        <div class="row-actions">
                            <button class="row-btn row-btn-restore" onclick="restoreProject('${project.id}')">â™»ï¸ æ¢å¤</button>
                            <button class="row-btn row-btn-delete" onclick="showDeleteModal('${project.id}')">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleSelect(projectId) {
            if (selectedIds.has(projectId)) {
                selectedIds.delete(projectId);
            } else {
                selectedIds.add(projectId);
            }
            updateSelectionUI();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all');
            if (selectAllCheckbox.checked) {
                deletedProjects.forEach(p => selectedIds.add(p.id));
            } else {
                selectedIds.clear();
            }
            updateSelectionUI();
            renderProjects();
        }

        function updateSelectionUI() {
            const count = selectedIds.size;
            document.getElementById('selected-count').textContent = `å·²é€‰æ‹© ${count} ä¸ªé¡¹ç›®`;
            document.getElementById('btn-batch-restore').disabled = count === 0;
            document.getElementById('btn-batch-delete').disabled = count === 0;
            document.getElementById('select-all').checked = count === deletedProjects.length && count > 0;
        }

        // æ¢å¤å•ä¸ªé¡¹ç›®
        async function restoreProject(projectId) {
            if (!confirm('ç¡®å®šè¦æ¢å¤æ­¤é¡¹ç›®å—ï¼Ÿ')) return;
            
            try {
                await db.collection('projects').doc(projectId).update({
                    deleted: false,
                    deletedAt: firebase.firestore.FieldValue.delete(),
                    deletedBy: firebase.firestore.FieldValue.delete(),
                    restoredAt: firebase.firestore.FieldValue.serverTimestamp(),
                    restoredBy: currentUser.uid,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('é¡¹ç›®å·²æ¢å¤');
                location.reload();
            } catch (error) {
                alert('æ¢å¤å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºå•ä¸ªåˆ é™¤ç¡®è®¤
        function showDeleteModal(projectId) {
            const project = deletedProjects.find(p => p.id === projectId);
            if (!project) return;
            
            modalAction = 'deleteSingle';
            modalData = { projectId, projectName: project.projectName };
            
            document.getElementById('modal-icon').textContent = 'ğŸ—‘ï¸';
            document.getElementById('modal-title').textContent = 'æ°¸ä¹…åˆ é™¤é¡¹ç›®';
            document.getElementById('modal-desc').textContent = `ç¡®å®šè¦æ°¸ä¹…åˆ é™¤é¡¹ç›® "${project.projectName}" å—ï¼Ÿ`;
            document.getElementById('modal-warning').style.display = 'block';
            document.getElementById('modal-warning').innerHTML = 'âš ï¸ <strong>æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼</strong><br>é¡¹ç›®æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ï¼Œå…³è”çš„å·¥ä½œè®°å½•å°†å¤±å»é¡¹ç›®å…³è”ã€‚';
            document.getElementById('modal-confirm-btn').className = 'btn-modal-confirm';
            document.getElementById('modal-confirm-btn').textContent = 'æ°¸ä¹…åˆ é™¤';
            document.getElementById('confirm-modal').classList.add('show');
        }

        // æ˜¾ç¤ºæ‰¹é‡åˆ é™¤ç¡®è®¤
        function showBatchDeleteModal() {
            if (selectedIds.size === 0) return;
            
            modalAction = 'deleteBatch';
            modalData = { ids: Array.from(selectedIds) };
            
            document.getElementById('modal-icon').textContent = 'ğŸ—‘ï¸';
            document.getElementById('modal-title').textContent = 'æ‰¹é‡æ°¸ä¹…åˆ é™¤';
            document.getElementById('modal-desc').textContent = `ç¡®å®šè¦æ°¸ä¹…åˆ é™¤é€‰ä¸­çš„ ${selectedIds.size} ä¸ªé¡¹ç›®å—ï¼Ÿ`;
            document.getElementById('modal-warning').style.display = 'block';
            document.getElementById('modal-warning').innerHTML = 'âš ï¸ <strong>æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼</strong><br>æ‰€æœ‰é€‰ä¸­çš„é¡¹ç›®æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚';
            document.getElementById('modal-confirm-btn').className = 'btn-modal-confirm';
            document.getElementById('modal-confirm-btn').textContent = 'æ°¸ä¹…åˆ é™¤';
            document.getElementById('confirm-modal').classList.add('show');
        }

        function hideModal() {
            document.getElementById('confirm-modal').classList.remove('show');
            modalAction = null;
            modalData = null;
        }

        async function confirmModalAction() {
            if (modalAction === 'deleteSingle') {
                await permanentDeleteProject(modalData.projectId);
            } else if (modalAction === 'deleteBatch') {
                await batchPermanentDelete(modalData.ids);
            }
            hideModal();
        }

        // æ°¸ä¹…åˆ é™¤å•ä¸ªé¡¹ç›®
        async function permanentDeleteProject(projectId) {
            try {
                const project = deletedProjects.find(p => p.id === projectId);
                
                // æ›´æ–°å…³è”çš„å·¥ä½œè®°å½•
                const workRecords = await db.collection('workRecords').where('projectId', '==', projectId).get();
                const batch = db.batch();
                
                workRecords.docs.forEach(doc => {
                    batch.update(doc.ref, {
                        projectId: null,
                        projectName: (project?.projectName || 'æœªçŸ¥é¡¹ç›®') + ' (å·²åˆ é™¤)',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                batch.delete(db.collection('projects').doc(projectId));
                await batch.commit();
                
                alert('é¡¹ç›®å·²æ°¸ä¹…åˆ é™¤');
                location.reload();
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // æ‰¹é‡æ¢å¤
        async function batchRestore() {
            if (selectedIds.size === 0) return;
            if (!confirm(`ç¡®å®šè¦æ¢å¤é€‰ä¸­çš„ ${selectedIds.size} ä¸ªé¡¹ç›®å—ï¼Ÿ`)) return;
            
            try {
                const batch = db.batch();
                
                selectedIds.forEach(projectId => {
                    const ref = db.collection('projects').doc(projectId);
                    batch.update(ref, {
                        deleted: false,
                        deletedAt: firebase.firestore.FieldValue.delete(),
                        deletedBy: firebase.firestore.FieldValue.delete(),
                        restoredAt: firebase.firestore.FieldValue.serverTimestamp(),
                        restoredBy: currentUser.uid,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                await batch.commit();
                alert(`å·²æ¢å¤ ${selectedIds.size} ä¸ªé¡¹ç›®`);
                location.reload();
            } catch (error) {
                alert('æ‰¹é‡æ¢å¤å¤±è´¥: ' + error.message);
            }
        }

        // æ‰¹é‡æ°¸ä¹…åˆ é™¤
        async function batchPermanentDelete(ids) {
            try {
                for (const projectId of ids) {
                    const project = deletedProjects.find(p => p.id === projectId);
                    
                    const workRecords = await db.collection('workRecords').where('projectId', '==', projectId).get();
                    const batch = db.batch();
                    
                    workRecords.docs.forEach(doc => {
                        batch.update(doc.ref, {
                            projectId: null,
                            projectName: (project?.projectName || 'æœªçŸ¥é¡¹ç›®') + ' (å·²åˆ é™¤)',
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    
                    batch.delete(db.collection('projects').doc(projectId));
                    await batch.commit();
                }
                
                alert(`å·²æ°¸ä¹…åˆ é™¤ ${ids.length} ä¸ªé¡¹ç›®`);
                location.reload();
            } catch (error) {
                alert('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>
