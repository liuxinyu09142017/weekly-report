<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œè®°å½•åˆ—è¡¨ - å·¥ç¨‹å¸ˆå·¥æ—¶ç³»ç»Ÿ</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebaseåˆå§‹åŒ–æ¨¡å— -->
    <script src="js/firebase-init.js"></script>
    
    <!-- è´§å¸è½¬æ¢æ¨¡å— -->
    <script src="js/currency-converter.js"></script>
    
    <!-- é‡‘é¢æ ¼å¼åŒ–æ¨¡å— -->
    <script src="js/amount-formatter.js"></script>
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid white;
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .panel-title {
            color: #333;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .batch-actions {
            display: none;
            gap: 10px;
        }
        
        .batch-actions.show {
            display: flex;
        }
        
        .btn-batch {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-delete-batch {
            background: #f48771;
            color: white;
        }
        
        .btn-delete-batch:hover {
            background: #e57361;
        }
        
        .btn-export {
            background: #4ec9b0;
            color: white;
        }
        
        .btn-export:hover {
            background: #3db89a;
        }
        
        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
        }
        
        .filter-input,
        .filter-select {
            padding: 8px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-filter {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }
        
        .btn-filter:hover {
            background: #5568d3;
        }
        
        .btn-reset {
            padding: 8px 20px;
            background: #f5f7fa;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }
        
        .btn-reset:hover {
            background: #e7eaf0;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .export-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn-export-excel {
            padding: 10px 20px;
            background: #217346;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-export-excel:hover {
            background: #1a5c37;
        }
        
        .btn-export-pdf {
            padding: 10px 20px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-export-pdf:hover {
            background: #b71c1c;
        }
        
        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .records-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #666;
            font-size: 13px;
            border-bottom: 2px solid #e1e8ed;
        }
        
        .records-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        
        .records-table tr:hover {
            background: #f8f9fa;
        }
        
        .checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .record-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-edit {
            background: #667eea;
            color: white;
        }
        
        .btn-edit:hover {
            background: #5568d3;
        }
        
        .btn-delete {
            background: #f48771;
            color: white;
        }
        
        .btn-delete:hover {
            background: #e57361;
        }
        
        .loading {
            text-align: center;
            padding: 100px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #666;
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="header">
        <div class="header-content">
            <h2>ğŸ“‹ å·¥ä½œè®°å½•åˆ—è¡¨</h2>
            <div class="header-actions">
                <a href="dashboard.html" class="btn btn-secondary">â† è¿”å›ä¸»é¡µ</a>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½ä¸­ -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>æ­£åœ¨åŠ è½½...</div>
    </div>
    
    <!-- ä¸»å†…å®¹ -->
    <div id="main-content" class="container" style="display: none;">
        <div class="panel">
            <div class="panel-header">
                <h3 class="panel-title">ğŸ“Š æˆ‘çš„å·¥ä½œè®°å½•</h3>
                <div class="batch-actions" id="batch-actions">
                    <button class="btn-batch btn-delete-batch" onclick="batchDelete()">
                        ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­ (<span id="selected-count">0</span>)
                    </button>
                    <button class="btn-batch btn-export" onclick="exportSelected()">
                        ğŸ“¥ å¯¼å‡ºé€‰ä¸­
                    </button>
                </div>
            </div>
            
            <!-- ç­›é€‰æ¡ä»¶ -->
            <div class="filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">æ—¶é—´èŒƒå›´</label>
                        <select id="time-range" class="filter-select" onchange="toggleCustomDateRange()">
                            <option value="all">å…¨éƒ¨æ—¶é—´</option>
                            <option value="today">ä»Šå¤©</option>
                            <option value="week">æœ¬å‘¨</option>
                            <option value="month">æœ¬æœˆ</option>
                            <option value="custom">è‡ªå®šä¹‰æ—¥æœŸ</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">é¡¹ç›®ç±»å‹</label>
                        <select id="project-type" class="filter-select">
                            <option value="">å…¨éƒ¨</option>
                            <option value="å”®å‰é¡¹ç›®">å”®å‰é¡¹ç›®</option>
                            <option value="å”®åé¡¹ç›®">å”®åé¡¹ç›®</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">æ”¯æŒç±»å‹</label>
                        <select id="support-type" class="filter-select">
                            <option value="">å…¨éƒ¨</option>
                            <option value="ç°åœºæ”¯æŒ">ç°åœºæ”¯æŒ</option>
                            <option value="è¿œç¨‹æ”¯æŒ">è¿œç¨‹æ”¯æŒ</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">é”€å”®äººå‘˜</label>
                        <select id="sales-person" class="filter-select">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-row" id="custom-date-row" style="display: none;">
                    <div class="filter-group">
                        <label class="filter-label">å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="start-date" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="end-date" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">å®¢æˆ·åç§°</label>
                        <input type="text" id="customer-name" class="filter-input" placeholder="æœç´¢å®¢æˆ·...">
                    </div>
                </div>
                
                <div class="filter-row" id="normal-customer-row">
                    <div class="filter-group">
                        <label class="filter-label">å®¢æˆ·åç§°</label>
                        <input type="text" id="customer-name-normal" class="filter-input" placeholder="æœç´¢å®¢æˆ·...">
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn-filter" onclick="applyFilters()">ğŸ” åº”ç”¨ç­›é€‰</button>
                    <button class="btn-reset" onclick="resetFilters()">ğŸ”„ é‡ç½®</button>
                </div>
            </div>
            
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value" id="total-records">0</div>
                    <div class="stat-label">è®°å½•æ€»æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-hours">0</div>
                    <div class="stat-label">æ€»å·¥æ—¶</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-customers">0</div>
                    <div class="stat-label">å®¢æˆ·æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="normal-hours">0</div>
                    <div class="stat-label">æ­£å¸¸å·¥æ—¶</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="overtime-hours">0</div>
                    <div class="stat-label">åŠ ç­å·¥æ—¶</div>
                </div>
            </div>
            
            <!-- å¯¼å‡ºæ“ä½œ -->
            <div class="export-actions">
                <button class="btn-export-excel" onclick="exportToExcel()">
                    ğŸ“Š å¯¼å‡ºExcel
                </button>
                <button class="btn-export-pdf" onclick="exportToPDF()">
                    ğŸ“„ å¯¼å‡ºPDF
                </button>
            </div>
            
            <!-- è®°å½•è¡¨æ ¼ -->
            <table class="records-table" id="records-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" class="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                        <th>æ—¥æœŸ</th>
                        <th>å®¢æˆ·</th>
                        <th>é¡¹ç›®</th>
                        <th>ç±»å‹</th>
                        <th>å·¥æ—¶</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="records-tbody">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </tbody>
            </table>
            
            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-icon">ğŸ“­</div>
                <div>æš‚æ— å·¥ä½œè®°å½•</div>
            </div>
        </div>
    </div>

    <script>
        // Firebaseé…ç½®
        // Firebaseå·²ç”±firebase-init.jsåˆå§‹åŒ–
        // auth å’Œ db å˜é‡å·²å…¨å±€å¯ç”¨
        // ä»¥ä¸‹ä»£ç å·²æ³¨é‡Šï¼ˆä¿ç•™ä¾›å‚è€ƒï¼‰
        /*
        const firebaseConfig = {
            apiKey: "AIzaSyBzcAr_OJFdIMnaYXRCE7TJs2qlK_TAy9U",
            authDomain: "weekly-report-d55e9.firebaseapp.com",
            projectId: "weekly-report-d55e9",
            storageBucket: "weekly-report-d55e9.appspot.com",
            messagingSenderId: "315332641675",
            appId: "1:315332641675:web:e1b52c3d4c5fcc7b8c0de7"
        };

        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        */
        
        let currentUser = null;
        let userData = null;
        let allRecords = [];
        let filteredRecords = [];
        let selectedRecords = new Set();
        let targetUserId = null;  // ä»URLå‚æ•°è·å–çš„ç›®æ ‡ç”¨æˆ·ID
        let targetUserName = null;  // ä»URLå‚æ•°è·å–çš„ç›®æ ‡ç”¨æˆ·å

        // è§£æURLå‚æ•°
        function parseUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            targetUserId = urlParams.get('userId');
            targetUserName = urlParams.get('userName');
            
            // å¦‚æœæœ‰ç”¨æˆ·å‚æ•°ï¼Œæ›´æ–°é¡µé¢æ ‡é¢˜
            if (targetUserName) {
                document.querySelector('.header h2').textContent = `ğŸ“‹ ${decodeURIComponent(targetUserName)} çš„å·¥ä½œè®°å½•`;
                document.querySelector('.panel-title').textContent = `ğŸ“Š ${decodeURIComponent(targetUserName)} çš„å·¥ä½œè®°å½•`;
            }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                console.log('ç”¨æˆ·å·²ç™»å½•:', user.email);
                parseUrlParams();  // è§£æURLå‚æ•°
                await loadUserData();
                await loadRecords();
            } else {
                console.log('ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ');
                window.location.href = 'index.html';
            }
        });

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½è®°å½•
        async function loadRecords() {
            try {
                let query = db.collection('workRecords');
                
                // å¦‚æœæœ‰URLå‚æ•°æŒ‡å®šç”¨æˆ·ï¼ŒåªæŸ¥è¯¥ç”¨æˆ·çš„è®°å½•
                if (targetUserId) {
                    query = query.where('userId', '==', targetUserId);
                } else {
                    // æ ¹æ®è§’è‰²åŠ è½½ä¸åŒæ•°æ®
                    if (userData && userData.role === 'admin') {
                        // ç®¡ç†å‘˜çœ‹æ‰€æœ‰
                    } else if (userData && userData.role === 'team_lead') {
                        // éƒ¨é—¨é¢†å¯¼çœ‹æ‰€æœ‰ICTéƒ¨é—¨
                    } else {
                        // å·¥ç¨‹å¸ˆåªçœ‹è‡ªå·±çš„
                        query = query.where('userId', '==', currentUser.uid);
                    }
                }
                
                query = query.orderBy('startDateTime', 'desc');
                
                const snapshot = await query.get();
                
                allRecords = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log('åŠ è½½äº†', allRecords.length, 'æ¡è®°å½•');
                
                // æ„å»ºé”€å”®äººå‘˜åˆ—è¡¨
                buildSalesFilterList();
                
                // åº”ç”¨ç­›é€‰
                applyFilters();
                
                // æ˜¾ç¤ºé¡µé¢
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                
            } catch (error) {
                console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // æ„å»ºé”€å”®äººå‘˜ç­›é€‰åˆ—è¡¨
        function buildSalesFilterList() {
            const salesSet = new Set();
            allRecords.forEach(record => {
                if (record.salesPerson) {
                    salesSet.add(record.salesPerson);
                }
            });
            
            const salesSelect = document.getElementById('sales-person');
            salesSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
            
            Array.from(salesSet).sort().forEach(sales => {
                const option = document.createElement('option');
                option.value = sales;
                option.textContent = sales;
                salesSelect.appendChild(option);
            });
        }

        // åˆ‡æ¢è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´
        function toggleCustomDateRange() {
            const timeRange = document.getElementById('time-range').value;
            const customRow = document.getElementById('custom-date-row');
            const normalRow = document.getElementById('normal-customer-row');
            
            if (timeRange === 'custom') {
                customRow.style.display = 'grid';
                normalRow.style.display = 'none';
            } else {
                customRow.style.display = 'none';
                normalRow.style.display = 'grid';
            }
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            filteredRecords = allRecords.filter(record => {
                // æ—¶é—´ç­›é€‰
                const timeRange = document.getElementById('time-range').value;
                if (timeRange !== 'all') {
                    const recordDate = record.startDateTime.toDate();
                    const now = new Date();
                    
                    if (timeRange === 'today') {
                        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        if (recordDate < today) return false;
                    } else if (timeRange === 'week') {
                        const weekStart = new Date(now);
                        weekStart.setDate(now.getDate() - now.getDay() + 1);
                        weekStart.setHours(0, 0, 0, 0);
                        if (recordDate < weekStart) return false;
                    } else if (timeRange === 'month') {
                        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                        if (recordDate < monthStart) return false;
                    } else if (timeRange === 'custom') {
                        const startDate = document.getElementById('start-date').value;
                        const endDate = document.getElementById('end-date').value;
                        
                        if (startDate) {
                            const start = new Date(startDate);
                            start.setHours(0, 0, 0, 0);
                            if (recordDate < start) return false;
                        }
                        
                        if (endDate) {
                            const end = new Date(endDate);
                            end.setHours(23, 59, 59, 999);
                            if (recordDate > end) return false;
                        }
                    }
                }
                
                // é¡¹ç›®ç±»å‹ç­›é€‰
                const projectType = document.getElementById('project-type').value;
                if (projectType && record.projectType !== projectType) return false;
                
                // æ”¯æŒç±»å‹ç­›é€‰
                const supportType = document.getElementById('support-type').value;
                if (supportType && record.supportType !== supportType) return false;
                
                // é”€å”®äººå‘˜ç­›é€‰
                const salesPerson = document.getElementById('sales-person').value;
                if (salesPerson && record.salesPerson !== salesPerson) return false;
                
                // å®¢æˆ·åç§°ç­›é€‰
                const customerName = document.getElementById('time-range').value === 'custom' ?
                    document.getElementById('customer-name').value.trim() :
                    document.getElementById('customer-name-normal').value.trim();
                
                if (customerName && !record.customerName.toLowerCase().includes(customerName.toLowerCase())) {
                    return false;
                }
                
                return true;
            });
            
            renderRecords();
            updateStats();
        }

        // æ¸²æŸ“è®°å½•
        function renderRecords() {
            const tbody = document.getElementById('records-tbody');
            const emptyState = document.getElementById('empty-state');
            const table = document.getElementById('records-table');
            
            if (filteredRecords.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            table.style.display = 'table';
            emptyState.style.display = 'none';
            
            tbody.innerHTML = filteredRecords.map(record => {
                const date = record.startDateTime.toDate().toLocaleDateString('zh-CN');
                const isSelected = selectedRecords.has(record.id);
                
                return `
                    <tr>
                        <td>
                            <input type="checkbox" class="checkbox" 
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleSelect('${record.id}')">
                        </td>
                        <td>${date}</td>
                        <td>${record.customerName}</td>
                        <td>${record.projectName}</td>
                        <td>${record.projectType}</td>
                        <td>${record.totalWorkingHours.toFixed(1)}h</td>
                        <td>
                            <div class="record-actions">
                                <button class="action-btn btn-edit" onclick="editRecord('${record.id}')">
                                    âœï¸ ç¼–è¾‘
                                </button>
                                <button class="action-btn btn-delete" onclick="deleteRecord('${record.id}')">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            const totalRecords = filteredRecords.length;
            let totalHours = 0;
            let normalHours = 0;
            let overtimeHours = 0;
            const customers = new Set();
            
            filteredRecords.forEach(record => {
                totalHours += record.totalWorkingHours || 0;
                normalHours += record.normalWorkingHours || 0;
                overtimeHours += record.overtimeHours || 0;
                customers.add(record.customerName);
            });
            
            document.getElementById('total-records').textContent = totalRecords;
            document.getElementById('total-hours').textContent = totalHours.toFixed(1) + 'h';
            document.getElementById('total-customers').textContent = customers.size;
            document.getElementById('normal-hours').textContent = normalHours.toFixed(1) + 'h';
            document.getElementById('overtime-hours').textContent = overtimeHours.toFixed(1) + 'h';
        }

        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.getElementById('time-range').value = 'all';
            document.getElementById('project-type').value = '';
            document.getElementById('support-type').value = '';
            document.getElementById('sales-person').value = '';
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-name-normal').value = '';
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            
            toggleCustomDateRange();
            applyFilters();
        }

        // åˆ‡æ¢é€‰æ‹©
        function toggleSelect(recordId) {
            if (selectedRecords.has(recordId)) {
                selectedRecords.delete(recordId);
            } else {
                selectedRecords.add(recordId);
            }
            
            updateBatchActions();
            updateSelectAllCheckbox();
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all').checked;
            
            if (selectAll) {
                filteredRecords.forEach(record => selectedRecords.add(record.id));
            } else {
                selectedRecords.clear();
            }
            
            renderRecords();
            updateBatchActions();
        }

        // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('select-all');
            const allSelected = filteredRecords.length > 0 && 
                filteredRecords.every(record => selectedRecords.has(record.id));
            
            selectAll.checked = allSelected;
        }

        // æ›´æ–°æ‰¹é‡æ“ä½œ
        function updateBatchActions() {
            const batchActions = document.getElementById('batch-actions');
            const selectedCount = document.getElementById('selected-count');
            
            selectedCount.textContent = selectedRecords.size;
            
            if (selectedRecords.size > 0) {
                batchActions.classList.add('show');
            } else {
                batchActions.classList.remove('show');
            }
        }

        // æ‰¹é‡åˆ é™¤
        async function batchDelete() {
            if (selectedRecords.size === 0) return;
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedRecords.size} æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`)) {
                return;
            }
            
            try {
                const deletePromises = Array.from(selectedRecords).map(recordId => 
                    db.collection('workRecords').doc(recordId).delete()
                );
                
                await Promise.all(deletePromises);
                
                alert('âœ… åˆ é™¤æˆåŠŸï¼');
                selectedRecords.clear();
                await loadRecords();
                
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
                alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // å¯¼å‡ºé€‰ä¸­
        function exportSelected() {
            if (selectedRecords.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„è®°å½•');
                return;
            }
            
            const recordsToExport = filteredRecords.filter(record => 
                selectedRecords.has(record.id)
            );
            
            exportToExcelData(recordsToExport);
        }

        // å¯¼å‡ºExcel
        function exportToExcel() {
            exportToExcelData(filteredRecords);
        }

        // å¯¼å‡ºExcelæ•°æ®
        function exportToExcelData(records) {
            if (records.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }
            
            // å‡†å¤‡æ•°æ®
            const data = records.map(record => ({
                'æ—¥æœŸ': record.startDate,
                'å¼€å§‹æ—¶é—´': record.startTime,
                'ç»“æŸæ—¶é—´': record.endTime,
                'å®¢æˆ·åç§°': record.customerName,
                'å®¢æˆ·è¡Œä¸š': record.customerIndustry || '-',
                'é¡¹ç›®åç§°': record.projectName,
                'é¡¹ç›®ç±»å‹': record.projectType,
                'é¡¹ç›®é˜¶æ®µ': record.projectStage,
                'æ”¯æŒç±»å‹': record.supportType,
                'é”€å”®äººå‘˜': record.salesPerson || '-',
                'é¡¹ç›®é‡‘é¢': record.projectAmount ? `${record.projectAmount}K ${record.projectCurrency}` : '-',
                'æ­£å¸¸å·¥æ—¶': record.normalWorkingHours.toFixed(1),
                'åŠ ç­å·¥æ—¶': record.overtimeHours.toFixed(1),
                'æ€»å·¥æ—¶': record.totalWorkingHours.toFixed(1),
                'æ˜¯å¦èŠ‚å‡æ—¥': record.isHolidayWork ? 'æ˜¯' : 'å¦',
                'å·¥ä½œæè¿°': record.workDescription,
                'ä¸‹ä¸€æ­¥è®¡åˆ’': record.nextWeekPlan || '-'
            }));
            
            // åˆ›å»ºå·¥ä½œç°¿
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'å·¥ä½œè®°å½•');
            
            // å¯¼å‡º
            const fileName = `å·¥ä½œè®°å½•_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            console.log('Excelå¯¼å‡ºæˆåŠŸ');
        }

        // å¯¼å‡ºPDF
        function exportToPDF() {
            if (filteredRecords.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // æ·»åŠ ä¸­æ–‡å­—ä½“æ”¯æŒï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
            let yPos = 20;
            
            doc.setFontSize(16);
            doc.text('Work Records Report', 105, yPos, { align: 'center' });
            yPos += 15;
            
            doc.setFontSize(10);
            filteredRecords.forEach((record, index) => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.text(`${index + 1}. ${record.customerName} - ${record.projectName}`, 20, yPos);
                yPos += 7;
                doc.text(`   Date: ${record.startDate}  Hours: ${record.totalWorkingHours.toFixed(1)}h`, 20, yPos);
                yPos += 7;
                doc.text(`   Type: ${record.projectType}  Support: ${record.supportType}`, 20, yPos);
                yPos += 10;
            });
            
            const fileName = `WorkRecords_${new Date().toLocaleDateString('en-US').replace(/\//g, '-')}.pdf`;
            doc.save(fileName);
            
            console.log('PDFå¯¼å‡ºæˆåŠŸ');
        }

        // ç¼–è¾‘è®°å½•
        function editRecord(recordId) {
            window.location.href = `edit-work-record.html?id=${recordId}`;
        }

        // åˆ é™¤è®°å½•
        async function deleteRecord(recordId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
                return;
            }
            
            try {
                await db.collection('workRecords').doc(recordId).delete();
                alert('âœ… åˆ é™¤æˆåŠŸï¼');
                await loadRecords();
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>
