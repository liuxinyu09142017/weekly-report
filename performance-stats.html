<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸šç»©ç»Ÿè®¡ - å·¥ç¨‹å¸ˆå·¥æ—¶ç³»ç»Ÿ</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-init.js"></script>
    <!-- å·¥å…·æ¨¡å— -->
    <script src="js/currency-converter.js"></script>
    <script src="js/amount-formatter.js"></script>
    <script src="js/countries-list.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); min-height: 100vh; }
        .header { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3); position: sticky; top: 0; z-index: 1000; }
        .header-content { max-width: 1600px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .header h1 { font-size: 24px; font-weight: 600; }
        .header-info { font-size: 12px; opacity: 0.9; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; text-decoration: none; }
        .btn-back { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; }
        .btn-back:hover { background: rgba(255,255,255,0.3); }
        .container { max-width: 1600px; margin: 20px auto; padding: 0 20px; }
        
        /* è§†å›¾åˆ‡æ¢ */
        .view-switcher { background: white; border-radius: 16px; padding: 20px 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        .view-switcher-label { font-weight: 600; color: #333; font-size: 15px; }
        .view-tabs { display: flex; gap: 8px; flex-wrap: wrap; }
        .view-tab { padding: 10px 20px; border: 2px solid #e5e7eb; background: white; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; color: #666; transition: all 0.3s; }
        .view-tab:hover { border-color: #10b981; color: #10b981; }
        .view-tab.active { background: linear-gradient(135deg, #10b981, #059669); color: white; border-color: transparent; }
        
        /* ç­›é€‰é¢æ¿ */
        .filter-panel { background: white; border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .filter-title { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .filter-item label { display: block; font-size: 12px; color: #666; margin-bottom: 6px; font-weight: 500; }
        .filter-item select, .filter-item input { width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.3s; }
        .filter-item select:focus, .filter-item input:focus { outline: none; border-color: #10b981; }
        .filter-actions { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-primary { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border-radius: 10px; font-weight: 600; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(16,185,129,0.4); }
        .btn-secondary { background: #f3f4f6; color: #666; padding: 12px 24px; border-radius: 10px; }
        .btn-secondary:hover { background: #e5e7eb; }
        
        /* æ±‡ç‡ä¿¡æ¯ */
        .rate-info { background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 10px 15px; margin-bottom: 20px; font-size: 13px; color: #166534; display: flex; align-items: center; gap: 10px; }
        .rate-info-icon { font-size: 18px; }
        
        /* ä¸šç»©å¡ç‰‡ */
        .stats-overview { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        @media (max-width: 1200px) { .stats-overview { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .stats-overview { grid-template-columns: 1fr; } }
        .stat-card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .stat-card.presale-signed::before { background: linear-gradient(90deg, #10b981, #34d399); }
        .stat-card.presale-pipeline::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .stat-card.postsale-completed::before { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
        .stat-card.postsale-ongoing::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .stat-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .stat-card.presale-signed .stat-icon { background: #d1fae5; }
        .stat-card.presale-pipeline .stat-icon { background: #dbeafe; }
        .stat-card.postsale-completed .stat-icon { background: #ede9fe; }
        .stat-card.postsale-ongoing .stat-icon { background: #fef3c7; }
        .stat-title { font-size: 14px; color: #666; font-weight: 500; }
        .stat-amount { font-size: 32px; font-weight: 700; margin-bottom: 5px; }
        .stat-amount-detail { font-size: 13px; color: #999; margin-bottom: 10px; }
        .stat-card.presale-signed .stat-amount { color: #059669; }
        .stat-card.presale-pipeline .stat-amount { color: #2563eb; }
        .stat-card.postsale-completed .stat-amount { color: #7c3aed; }
        .stat-card.postsale-ongoing .stat-amount { color: #d97706; }
        .stat-details { display: flex; gap: 20px; padding-top: 15px; border-top: 1px solid #f3f4f6; }
        .stat-detail-item { text-align: center; }
        .stat-detail-value { font-size: 18px; font-weight: 600; color: #333; }
        .stat-detail-label { font-size: 12px; color: #999; }
        
        /* å›¾è¡¨ */
        .charts-section { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px; }
        @media (max-width: 1000px) { .charts-section { grid-template-columns: 1fr; } }
        .chart-card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .chart-card.full-width { grid-column: span 2; }
        @media (max-width: 1000px) { .chart-card.full-width { grid-column: span 1; } }
        .chart-title { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 20px; }
        .chart-container { position: relative; height: 300px; }
        .chart-container.tall { height: 400px; }
        
        /* æ’è¡Œæ¦œ */
        .ranking-section { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .ranking-title { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 20px; }
        .ranking-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .ranking-tab { padding: 8px 16px; border: 1px solid #e5e7eb; background: white; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.3s; }
        .ranking-tab:hover { border-color: #10b981; }
        .ranking-tab.active { background: #10b981; color: white; border-color: #10b981; }
        .ranking-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .ranking-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: #f9fafb; border-radius: 12px; transition: all 0.3s; }
        .ranking-item:hover { background: #f3f4f6; transform: translateX(5px); }
        .ranking-position { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; }
        .ranking-position.gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; }
        .ranking-position.silver { background: linear-gradient(135deg, #9ca3af, #6b7280); color: white; }
        .ranking-position.bronze { background: linear-gradient(135deg, #d97706, #b45309); color: white; }
        .ranking-position.normal { background: #e5e7eb; color: #666; }
        .ranking-info { flex: 1; }
        .ranking-name { font-weight: 600; color: #333; font-size: 15px; }
        .ranking-dept { font-size: 12px; color: #999; }
        .ranking-amount { font-size: 18px; font-weight: 700; color: #10b981; }
        
        /* é¡¹ç›®åˆ—è¡¨ */
        .projects-section { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .projects-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .projects-title { font-size: 16px; font-weight: 600; color: #333; }
        .projects-count { background: #f3f4f6; padding: 5px 12px; border-radius: 20px; font-size: 13px; color: #666; }
        .table-wrapper { overflow-x: auto; }
        .projects-table { width: 100%; border-collapse: collapse; min-width: 900px; }
        .projects-table th { text-align: left; padding: 12px 15px; background: #f9fafb; font-size: 13px; font-weight: 600; color: #666; border-bottom: 2px solid #e5e7eb; white-space: nowrap; }
        .projects-table td { padding: 15px; border-bottom: 1px solid #f3f4f6; font-size: 14px; color: #333; }
        .projects-table tr:hover { background: #f9fafb; }
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; white-space: nowrap; }
        .status-badge.signed { background: #d1fae5; color: #059669; }
        .status-badge.pipeline { background: #dbeafe; color: #2563eb; }
        .status-badge.completed { background: #ede9fe; color: #7c3aed; }
        .status-badge.ongoing { background: #fef3c7; color: #d97706; }
        .tech-badge { padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 500; }
        .tech-badge.network { background: #dbeafe; color: #2563eb; }
        .tech-badge.system { background: #fce7f3; color: #db2777; }
        .tech-badge.infra { background: #fef3c7; color: #d97706; }
        .amount-cell { white-space: nowrap; }
        .amount-original { font-size: 11px; color: #999; }
        
        /* çŠ¶æ€ */
        .loading { text-align: center; padding: 60px; color: #666; }
        .loading .spinner { width: 50px; height: 50px; border: 4px solid #e5e7eb; border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 60px; color: #999; }
        .empty-state-icon { font-size: 64px; margin-bottom: 20px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <h1>ğŸ“Š ä¸šç»©ç»Ÿè®¡åˆ†æ</h1>
                <div class="header-info" id="rate-header-info"></div>
            </div>
            <a href="index.html" class="btn btn-back">â† è¿”å›é¦–é¡µ</a>
        </div>
    </div>
    
    <div class="container">
        <!-- è§†å›¾åˆ‡æ¢ -->
        <div class="view-switcher" id="view-switcher">
            <span class="view-switcher-label">ğŸ“Œ ç»Ÿè®¡è§†è§’ï¼š</span>
            <div class="view-tabs">
                <button class="view-tab active" data-view="personal" onclick="switchView('personal')">ğŸ‘¤ æˆ‘çš„ä¸šç»©</button>
                <button class="view-tab" data-view="team" onclick="switchView('team')">ğŸ‘¥ å›¢é˜Ÿä¸šç»©</button>
                <button class="view-tab" data-view="tech" onclick="switchView('tech')">ğŸ”§ æŠ€æœ¯æ–¹å‘</button>
                <button class="view-tab" data-view="region" onclick="switchView('region')">ğŸŒ åŒºåŸŸåˆ†å¸ƒ</button>
            </div>
        </div>
        
        <!-- æ±‡ç‡ä¿¡æ¯ -->
        <div class="rate-info" id="rate-info">
            <span class="rate-info-icon">ğŸ’±</span>
            <span id="rate-info-text">æ­£åœ¨è·å–æ±‡ç‡ä¿¡æ¯...</span>
        </div>
        
        <!-- ç­›é€‰é¢æ¿ -->
        <div class="filter-panel">
            <div class="filter-title">ğŸ” ç­›é€‰æ¡ä»¶</div>
            <div class="filter-grid">
                <div class="filter-item">
                    <label>ç»Ÿè®¡å‘¨æœŸ</label>
                    <select id="period-filter" onchange="toggleCustomDate()">
                        <option value="year">æœ¬å¹´åº¦</option>
                        <option value="quarter">æœ¬å­£åº¦</option>
                        <option value="month">æœ¬æœˆ</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                <div class="filter-item" id="start-date-item" style="display:none;">
                    <label>å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="start-date">
                </div>
                <div class="filter-item" id="end-date-item" style="display:none;">
                    <label>ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="end-date">
                </div>
                <div class="filter-item" id="engineer-filter-item">
                    <label>å·¥ç¨‹å¸ˆ</label>
                    <select id="engineer-filter"><option value="">å…¨éƒ¨å·¥ç¨‹å¸ˆ</option></select>
                </div>
                <div class="filter-item">
                    <label>æŠ€æœ¯æ–¹å‘</label>
                    <select id="tech-direction-filter">
                        <option value="">å…¨éƒ¨æ–¹å‘</option>
                        <option value="ç½‘ç»œ">ğŸŒ ç½‘ç»œ</option>
                        <option value="ç³»ç»Ÿ">ğŸ–¥ï¸ ç³»ç»Ÿ</option>
                        <option value="èƒ½åŸº">ğŸ¢ èƒ½åŸº</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>è¡Œä¸š</label>
                    <select id="industry-filter">
                        <option value="">å…¨éƒ¨è¡Œä¸š</option>
                        <option value="é“¶è¡Œ">ğŸ¦ é“¶è¡Œ</option>
                        <option value="é‡‘è">ğŸ’° é‡‘è</option>
                        <option value="èƒ½æº">âš¡ èƒ½æº</option>
                        <option value="åˆ¶é€ ">ğŸ­ åˆ¶é€ </option>
                        <option value="é›¶å”®">ğŸ›’ é›¶å”®</option>
                        <option value="ç”µä¿¡">ğŸ“¡ ç”µä¿¡</option>
                        <option value="å…¶ä»–">ğŸ“‹ å…¶ä»–</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>å›½å®¶/åŒºåŸŸ</label>
                    <select id="country-filter"></select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="loadStats()">ğŸ“Š ç»Ÿè®¡åˆ†æ</button>
                <button class="btn btn-secondary" onclick="resetFilters()">ğŸ”„ é‡ç½®</button>
                <button class="btn btn-secondary" onclick="exportStats()">ğŸ“¥ å¯¼å‡ºæŠ¥è¡¨</button>
            </div>
        </div>
        
        <!-- åŠ è½½çŠ¶æ€ -->
        <div class="loading hidden" id="loading"><div class="spinner"></div><div>æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...</div></div>
        <div class="empty-state hidden" id="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div>è¯·é€‰æ‹©ç­›é€‰æ¡ä»¶åç‚¹å‡»"ç»Ÿè®¡åˆ†æ"</div></div>
        
        <!-- ç»Ÿè®¡å†…å®¹ -->
        <div id="stats-content" class="hidden">
            <div class="stats-overview">
                <div class="stat-card presale-signed">
                    <div class="stat-card-header"><div class="stat-icon">âœ…</div><div class="stat-title">å”®å‰å·²ç­¾å•</div></div>
                    <div class="stat-amount" id="presale-signed-amount">Â£0</div>
                    <div class="stat-amount-detail" id="presale-signed-detail"></div>
                    <div class="stat-details">
                        <div class="stat-detail-item"><div class="stat-detail-value" id="presale-signed-count">0</div><div class="stat-detail-label">é¡¹ç›®æ•°</div></div>
                        <div class="stat-detail-item"><div class="stat-detail-value" id="presale-signed-customers">0</div><div class="stat-detail-label">å®¢æˆ·æ•°</div></div>
                    </div>
                </div>
                <div class="stat-card presale-pipeline">
                    <div class="stat-card-header"><div class="stat-icon">ğŸ“‹</div><div class="stat-title">å”®å‰Pipeline</div></div>
                    <div class="stat-amount" id="presale-pipeline-amount">Â£0</div>
                    <div class="stat-amount-detail" id="presale-pipeline-detail"></div>
                    <div class="stat-details">
                        <div class="stat-detail-item"><div class="stat-detail-value" id="presale-pipeline-count">0</div><div class="stat-detail-label">é¡¹ç›®æ•°</div></div>
                        <div class="stat-detail-item"><div class="stat-detail-value" id="presale-pipeline-customers">0</div><div class="stat-detail-label">å®¢æˆ·æ•°</div></div>
                    </div>
                </div>
                <div class="stat-card postsale-completed">
                    <div class="stat-card-header"><div class="stat-icon">ğŸ†</div><div class="stat-title">å”®åå·²æŠ¥ç«£</div></div>
                    <div class="stat-amount" id="postsale-completed-amount">Â£0</div>
                    <div class="stat-amount-detail" id="postsale-completed-detail"></div>
                    <div class="stat-details">
                        <div class="stat-detail-item"><div class="stat-detail-value" id="postsale-completed-count">0</div><div class="stat-detail-label">é¡¹ç›®æ•°</div></div>
                        <div class="stat-detail-item"><div class="stat-detail-value" id="postsale-completed-customers">0</div><div class="stat-detail-label">å®¢æˆ·æ•°</div></div>
                    </div>
                </div>
                <div class="stat-card postsale-ongoing">
                    <div class="stat-card-header"><div class="stat-icon">ğŸš€</div><div class="stat-title">å”®åè¿›è¡Œä¸­</div></div>
                    <div class="stat-amount" id="postsale-ongoing-amount">Â£0</div>
                    <div class="stat-amount-detail" id="postsale-ongoing-detail"></div>
                    <div class="stat-details">
                        <div class="stat-detail-item"><div class="stat-detail-value" id="postsale-ongoing-count">0</div><div class="stat-detail-label">é¡¹ç›®æ•°</div></div>
                        <div class="stat-detail-item"><div class="stat-detail-value" id="postsale-ongoing-customers">0</div><div class="stat-detail-label">å®¢æˆ·æ•°</div></div>
                    </div>
                </div>
            </div>
            
            <div class="charts-section">
                <div class="chart-card"><div class="chart-title">ğŸ“Š ä¸šç»©åˆ†å¸ƒå¯¹æ¯”</div><div class="chart-container"><canvas id="overview-chart"></canvas></div></div>
                <div class="chart-card"><div class="chart-title">ğŸ”§ æŠ€æœ¯æ–¹å‘ä¸šç»©</div><div class="chart-container"><canvas id="tech-chart"></canvas></div></div>
                <div class="chart-card"><div class="chart-title">ğŸŒ åŒºåŸŸä¸šç»©åˆ†å¸ƒ</div><div class="chart-container"><canvas id="region-chart"></canvas></div></div>
                <div class="chart-card"><div class="chart-title">ğŸ¢ è¡Œä¸šä¸šç»©åˆ†å¸ƒ</div><div class="chart-container"><canvas id="industry-chart"></canvas></div></div>
                <div class="chart-card full-width"><div class="chart-title">ğŸ“ˆ æœˆåº¦ä¸šç»©è¶‹åŠ¿</div><div class="chart-container tall"><canvas id="trend-chart"></canvas></div></div>
            </div>
            
            <div class="ranking-section" id="ranking-section">
                <div class="ranking-title">ğŸ… å·¥ç¨‹å¸ˆä¸šç»©æ’è¡Œ</div>
                <div class="ranking-tabs">
                    <button class="ranking-tab active" data-type="presale" onclick="switchRanking('presale')">å”®å‰ç­¾å•</button>
                    <button class="ranking-tab" data-type="pipeline" onclick="switchRanking('pipeline')">å”®å‰Pipeline</button>
                    <button class="ranking-tab" data-type="postsale" onclick="switchRanking('postsale')">å”®åæŠ¥ç«£</button>
                    <button class="ranking-tab" data-type="total" onclick="switchRanking('total')">ç»¼åˆä¸šç»©</button>
                </div>
                <div class="ranking-list" id="ranking-list"></div>
            </div>
            
            <div class="projects-section">
                <div class="projects-header">
                    <div class="projects-title">ğŸ“‹ é¡¹ç›®æ˜ç»†</div>
                    <div class="projects-count">å…± <span id="project-count">0</span> ä¸ªé¡¹ç›®</div>
                </div>
                <div class="table-wrapper">
                    <table class="projects-table">
                        <thead><tr><th>é¡¹ç›®åç§°</th><th>å®¢æˆ·</th><th>æŠ€æœ¯æ–¹å‘</th><th>ç±»å‹</th><th>çŠ¶æ€</th><th>å›½å®¶</th><th>åŸå§‹é‡‘é¢</th><th>æŠ˜åˆè‹±é•‘</th><th>è´Ÿè´£äºº</th></tr></thead>
                        <tbody id="projects-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        let currentUser = null, userData = null, allProjects = [], allEngineers = [], filteredProjects = [], currentView = 'personal', charts = {};
        
        // åˆå§‹åŒ–
        firebase.auth().onAuthStateChanged(async (user) => {
            if (!user) { window.location.href = 'login.html'; return; }
            currentUser = user;
            const userDoc = await db.collection('users').doc(user.uid).get();
            userData = userDoc.data() || {};
            
            // åˆå§‹åŒ–æ±‡ç‡è½¬æ¢
            await initCurrencyConverter();
            
            setupRoleBasedUI();
            await loadEngineers();
            loadCountriesDropdown();
            loadStats();
        });
        
        // åˆå§‹åŒ–è´§å¸è½¬æ¢å™¨
        async function initCurrencyConverter() {
            try {
                await currencyConverter.init();
                const info = currencyConverter.getInfo();
                document.getElementById('rate-info-text').textContent = 
                    `æ±‡ç‡æ¥æº: ${info.source} | æ›´æ–°æ—¥æœŸ: ${info.date} | åŸºå‡†è´§å¸: GBP`;
                document.getElementById('rate-header-info').textContent = 
                    `æ±‡ç‡: ${info.date}`;
            } catch (error) {
                document.getElementById('rate-info-text').textContent = 'ä½¿ç”¨é»˜è®¤æ±‡ç‡ï¼ˆè·å–å¤±è´¥ï¼‰';
            }
        }
        
        function setupRoleBasedUI() {
            const isAdmin = userData.role === 'admin';
            const isManager = userData.role === 'manager';
            if (!isAdmin && !isManager) {
                document.getElementById('view-switcher').classList.add('hidden');
                document.getElementById('engineer-filter-item').classList.add('hidden');
                document.getElementById('ranking-section').classList.add('hidden');
            }
        }
        
        async function loadEngineers() {
            const snapshot = await db.collection('users').get();
            allEngineers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const select = document.getElementById('engineer-filter');
            allEngineers.forEach(eng => {
                const name = eng.chineseName || eng.displayName || eng.email;
                select.innerHTML += `<option value="${eng.id}">${name}</option>`;
            });
        }
        
        // ä½¿ç”¨countries-list.jså¡«å……å›½å®¶ä¸‹æ‹‰æ¡†
        function loadCountriesDropdown() {
            if (typeof populateCountrySelect === 'function') {
                populateCountrySelect('country-filter', {
                    addEmptyOption: true,
                    emptyOptionText: 'å…¨éƒ¨å›½å®¶'
                });
            }
        }
        
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.view-tab[data-view="${view}"]`).classList.add('active');
            if (view === 'personal') document.getElementById('engineer-filter-item').classList.add('hidden');
            else document.getElementById('engineer-filter-item').classList.remove('hidden');
            loadStats();
        }
        
        function toggleCustomDate() {
            const period = document.getElementById('period-filter').value;
            const show = period === 'custom';
            document.getElementById('start-date-item').style.display = show ? 'block' : 'none';
            document.getElementById('end-date-item').style.display = show ? 'block' : 'none';
        }
        
        function getTimeRange() {
            const period = document.getElementById('period-filter').value;
            const now = new Date();
            let startDate, endDate;
            switch (period) {
                case 'year': startDate = new Date(now.getFullYear(), 0, 1); endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59); break;
                case 'quarter': const q = Math.floor(now.getMonth() / 3); startDate = new Date(now.getFullYear(), q * 3, 1); endDate = new Date(now.getFullYear(), q * 3 + 3, 0, 23, 59, 59); break;
                case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59); break;
                case 'custom': startDate = new Date(document.getElementById('start-date').value || now); endDate = new Date(document.getElementById('end-date').value || now); endDate.setHours(23, 59, 59); break;
            }
            return { startDate, endDate };
        }
        
        // è½¬æ¢é¡¹ç›®é‡‘é¢åˆ°GBP
        function convertProjectAmount(project) {
            const amount = project.projectAmount || 0;
            const currency = project.projectCurrency || 'GBP';
            const country = project.customerCountry || '';
            
            // å¦‚æœå·²ç»æ˜¯GBPï¼Œç›´æ¥è¿”å›
            if (currency === 'GBP') {
                return { original: amount, currency: 'GBP', gbp: amount, needsConversion: false };
            }
            
            // ä½¿ç”¨è´§å¸è½¬æ¢å™¨
            const result = currencyConverter.convertToGBP(amount, country);
            return {
                original: amount,
                currency: currency,
                gbp: result.gbp,
                needsConversion: true,
                rate: result.rate
            };
        }
        
        async function loadStats() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('stats-content').classList.add('hidden');
            
            try {
                let query = db.collection('projects');
                if (userData.role === 'engineer' || currentView === 'personal') {
                    query = query.where('assignedEngineers', 'array-contains', currentUser.uid);
                }
                const snapshot = await query.get();
                allProjects = snapshot.docs.map(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    // é¢„å¤„ç†ï¼šè½¬æ¢é‡‘é¢åˆ°GBP
                    data.amountData = convertProjectAmount(data);
                    return data;
                });
                
                filteredProjects = applyFilters(allProjects);
                const stats = calculateStats(filteredProjects);
                displayOverview(stats);
                displayCharts(stats);
                displayRanking(stats);
                displayProjects(filteredProjects);
                document.getElementById('stats-content').classList.remove('hidden');
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }
        
        function applyFilters(projects) {
            const { startDate, endDate } = getTimeRange();
            const engineerId = document.getElementById('engineer-filter').value;
            const techDirection = document.getElementById('tech-direction-filter').value;
            const industry = document.getElementById('industry-filter').value;
            const country = document.getElementById('country-filter').value;
            
            return projects.filter(p => {
                if (p.createdAt) { const created = p.createdAt.toDate(); if (created < startDate || created > endDate) return false; }
                if (engineerId && !(p.assignedEngineers || []).includes(engineerId)) return false;
                if (techDirection && p.techDirection !== techDirection) return false;
                if (industry && p.customerIndustry !== industry) return false;
                if (country && p.customerCountry !== country) return false;
                return true;
            });
        }
        
        function calculateStats(projects) {
            const stats = {
                presaleSigned: { amount: 0, count: 0, customers: new Set(), projects: [] },
                presalePipeline: { amount: 0, count: 0, customers: new Set(), projects: [] },
                postsaleCompleted: { amount: 0, count: 0, customers: new Set(), projects: [] },
                postsaleOngoing: { amount: 0, count: 0, customers: new Set(), projects: [] },
                byTech: {}, byRegion: {}, byIndustry: {}, byEngineer: {}, byMonth: {}
            };
            
            projects.forEach(p => {
                // ä½¿ç”¨è½¬æ¢åçš„GBPé‡‘é¢
                const gbpAmount = p.amountData?.gbp || 0;
                const tech = p.techDirection || 'æœªè®¾ç½®';
                const region = p.customerCountry || 'æœªçŸ¥';
                const industry = p.customerIndustry || 'å…¶ä»–';
                
                // åˆ†ç±»ç»Ÿè®¡ï¼ˆä½¿ç”¨GBPé‡‘é¢ï¼‰
                if (p.projectType === 'å”®å‰é¡¹ç›®') {
                    if (p.performanceData?.contractSigned || p.status === 'å·²å®Œæˆ') {
                        stats.presaleSigned.amount += gbpAmount;
                        stats.presaleSigned.count++;
                        stats.presaleSigned.customers.add(p.customerName);
                        stats.presaleSigned.projects.push(p);
                    } else {
                        stats.presalePipeline.amount += gbpAmount;
                        stats.presalePipeline.count++;
                        stats.presalePipeline.customers.add(p.customerName);
                        stats.presalePipeline.projects.push(p);
                    }
                } else if (p.projectType === 'å”®åé¡¹ç›®') {
                    if (p.performanceData?.reported || p.status === 'å·²å®Œæˆ') {
                        stats.postsaleCompleted.amount += gbpAmount;
                        stats.postsaleCompleted.count++;
                        stats.postsaleCompleted.customers.add(p.customerName);
                        stats.postsaleCompleted.projects.push(p);
                    } else {
                        stats.postsaleOngoing.amount += gbpAmount;
                        stats.postsaleOngoing.count++;
                        stats.postsaleOngoing.customers.add(p.customerName);
                        stats.postsaleOngoing.projects.push(p);
                    }
                }
                
                // æŒ‰ç»´åº¦ç»Ÿè®¡ï¼ˆéƒ½ä½¿ç”¨GBPï¼‰
                if (!stats.byTech[tech]) stats.byTech[tech] = { presale: 0, postsale: 0 };
                if (p.projectType === 'å”®å‰é¡¹ç›®') stats.byTech[tech].presale += gbpAmount;
                else stats.byTech[tech].postsale += gbpAmount;
                
                if (!stats.byRegion[region]) stats.byRegion[region] = { presale: 0, postsale: 0 };
                if (p.projectType === 'å”®å‰é¡¹ç›®') stats.byRegion[region].presale += gbpAmount;
                else stats.byRegion[region].postsale += gbpAmount;
                
                if (!stats.byIndustry[industry]) stats.byIndustry[industry] = { presale: 0, postsale: 0 };
                if (p.projectType === 'å”®å‰é¡¹ç›®') stats.byIndustry[industry].presale += gbpAmount;
                else stats.byIndustry[industry].postsale += gbpAmount;
                
                (p.assignedEngineers || []).forEach(engId => {
                    if (!stats.byEngineer[engId]) stats.byEngineer[engId] = { presale: 0, pipeline: 0, postsale: 0, total: 0 };
                    if (p.projectType === 'å”®å‰é¡¹ç›®') {
                        if (p.performanceData?.contractSigned || p.status === 'å·²å®Œæˆ') stats.byEngineer[engId].presale += gbpAmount;
                        else stats.byEngineer[engId].pipeline += gbpAmount;
                    } else if (p.performanceData?.reported || p.status === 'å·²å®Œæˆ') {
                        stats.byEngineer[engId].postsale += gbpAmount;
                    }
                    stats.byEngineer[engId].total += gbpAmount;
                });
                
                if (p.createdAt) {
                    const month = p.createdAt.toDate().toISOString().slice(0, 7);
                    if (!stats.byMonth[month]) stats.byMonth[month] = { presale: 0, postsale: 0 };
                    if (p.projectType === 'å”®å‰é¡¹ç›®') stats.byMonth[month].presale += gbpAmount;
                    else stats.byMonth[month].postsale += gbpAmount;
                }
            });
            
            return stats;
        }
        
        // ä½¿ç”¨AmountFormatteræ ¼å¼åŒ–
        function formatAmount(amount) {
            if (typeof AmountFormatter !== 'undefined') {
                return AmountFormatter.formatCompact(amount * 1000, 'GBP'); // é‡‘é¢å­˜å‚¨ä¸ºKï¼Œè½¬æ¢ä¸ºå®é™…å€¼
            }
            // åå¤‡æ–¹æ¡ˆ
            if (amount >= 1000) return 'Â£' + (amount / 1000).toFixed(1) + 'M';
            return 'Â£' + amount.toFixed(0) + 'K';
        }
        
        function displayOverview(stats) {
            document.getElementById('presale-signed-amount').textContent = formatAmount(stats.presaleSigned.amount);
            document.getElementById('presale-signed-count').textContent = stats.presaleSigned.count;
            document.getElementById('presale-signed-customers').textContent = stats.presaleSigned.customers.size;
            
            document.getElementById('presale-pipeline-amount').textContent = formatAmount(stats.presalePipeline.amount);
            document.getElementById('presale-pipeline-count').textContent = stats.presalePipeline.count;
            document.getElementById('presale-pipeline-customers').textContent = stats.presalePipeline.customers.size;
            
            document.getElementById('postsale-completed-amount').textContent = formatAmount(stats.postsaleCompleted.amount);
            document.getElementById('postsale-completed-count').textContent = stats.postsaleCompleted.count;
            document.getElementById('postsale-completed-customers').textContent = stats.postsaleCompleted.customers.size;
            
            document.getElementById('postsale-ongoing-amount').textContent = formatAmount(stats.postsaleOngoing.amount);
            document.getElementById('postsale-ongoing-count').textContent = stats.postsaleOngoing.count;
            document.getElementById('postsale-ongoing-customers').textContent = stats.postsaleOngoing.customers.size;
        }
        
        function displayCharts(stats) {
            Object.values(charts).forEach(c => c?.destroy()); charts = {};
            
            // 1. ä¸šç»©åˆ†å¸ƒ
            charts.overview = new Chart(document.getElementById('overview-chart'), {
                type: 'doughnut',
                data: {
                    labels: ['å”®å‰ç­¾å•', 'å”®å‰Pipeline', 'å”®åæŠ¥ç«£', 'å”®åè¿›è¡Œä¸­'],
                    datasets: [{
                        data: [stats.presaleSigned.amount, stats.presalePipeline.amount, stats.postsaleCompleted.amount, stats.postsaleOngoing.amount],
                        backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { callbacks: { label: ctx => ctx.label + ': ' + formatAmount(ctx.raw) } }
                    }
                }
            });
            
            // 2. æŠ€æœ¯æ–¹å‘
            const techLabels = Object.keys(stats.byTech);
            charts.tech = new Chart(document.getElementById('tech-chart'), {
                type: 'bar',
                data: {
                    labels: techLabels,
                    datasets: [
                        { label: 'å”®å‰', data: techLabels.map(t => stats.byTech[t].presale), backgroundColor: '#10b981' },
                        { label: 'å”®å', data: techLabels.map(t => stats.byTech[t].postsale), backgroundColor: '#8b5cf6' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + formatAmount(ctx.raw) } } },
                    scales: { y: { beginAtZero: true, ticks: { callback: v => formatAmount(v) } } }
                }
            });
            
            // 3. åŒºåŸŸåˆ†å¸ƒ
            const regionEntries = Object.entries(stats.byRegion).sort((a, b) => (b[1].presale + b[1].postsale) - (a[1].presale + a[1].postsale)).slice(0, 8);
            const regionLabels = regionEntries.map(e => e[0]);
            charts.region = new Chart(document.getElementById('region-chart'), {
                type: 'pie',
                data: {
                    labels: regionLabels,
                    datasets: [{
                        data: regionLabels.map(r => stats.byRegion[r].presale + stats.byRegion[r].postsale),
                        backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#06b6d4', '#84cc16', '#f97316']
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' }, tooltip: { callbacks: { label: ctx => ctx.label + ': ' + formatAmount(ctx.raw) } } }
                }
            });
            
            // 4. è¡Œä¸šåˆ†å¸ƒ
            const industryLabels = Object.keys(stats.byIndustry);
            charts.industry = new Chart(document.getElementById('industry-chart'), {
                type: 'polarArea',
                data: {
                    labels: industryLabels,
                    datasets: [{
                        data: industryLabels.map(i => stats.byIndustry[i].presale + stats.byIndustry[i].postsale),
                        backgroundColor: ['rgba(16,185,129,0.7)', 'rgba(59,130,246,0.7)', 'rgba(139,92,246,0.7)', 'rgba(245,158,11,0.7)', 'rgba(239,68,68,0.7)', 'rgba(6,182,212,0.7)', 'rgba(132,204,22,0.7)']
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' }, tooltip: { callbacks: { label: ctx => ctx.label + ': ' + formatAmount(ctx.raw) } } }
                }
            });
            
            // 5. æœˆåº¦è¶‹åŠ¿
            const months = Object.keys(stats.byMonth).sort();
            charts.trend = new Chart(document.getElementById('trend-chart'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        { label: 'å”®å‰ä¸šç»©', data: months.map(m => stats.byMonth[m].presale), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.4 },
                        { label: 'å”®åä¸šç»©', data: months.map(m => stats.byMonth[m].postsale), borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.1)', fill: true, tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + formatAmount(ctx.raw) } } },
                    scales: { y: { beginAtZero: true, ticks: { callback: v => formatAmount(v) } } }
                }
            });
        }
        
        let currentRankingType = 'presale';
        function switchRanking(type) {
            currentRankingType = type;
            document.querySelectorAll('.ranking-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.ranking-tab[data-type="${type}"]`).classList.add('active');
            const stats = calculateStats(filteredProjects);
            displayRanking(stats);
        }
        
        function displayRanking(stats) {
            const list = document.getElementById('ranking-list');
            const rankings = Object.entries(stats.byEngineer).map(([id, data]) => {
                const eng = allEngineers.find(e => e.id === id);
                let amount = 0;
                switch (currentRankingType) {
                    case 'presale': amount = data.presale; break;
                    case 'pipeline': amount = data.pipeline; break;
                    case 'postsale': amount = data.postsale; break;
                    case 'total': amount = data.total; break;
                }
                return { id, name: eng?.chineseName || eng?.displayName || eng?.email || 'æœªçŸ¥', dept: eng?.department || '', techDirection: eng?.techDirection || '', amount };
            }).filter(r => r.amount > 0).sort((a, b) => b.amount - a.amount).slice(0, 10);
            
            list.innerHTML = rankings.map((r, i) => {
                let posClass = 'normal';
                if (i === 0) posClass = 'gold';
                else if (i === 1) posClass = 'silver';
                else if (i === 2) posClass = 'bronze';
                return `<div class="ranking-item"><div class="ranking-position ${posClass}">${i + 1}</div><div class="ranking-info"><div class="ranking-name">${r.name}</div><div class="ranking-dept">${r.dept} ${r.techDirection ? 'Â· ' + r.techDirection : ''}</div></div><div class="ranking-amount">${formatAmount(r.amount)}</div></div>`;
            }).join('');
            
            if (rankings.length === 0) list.innerHTML = '<div style="text-align:center;color:#999;padding:30px;">æš‚æ— æ•°æ®</div>';
        }
        
        function displayProjects(projects) {
            document.getElementById('project-count').textContent = projects.length;
            const tbody = document.getElementById('projects-tbody');
            
            tbody.innerHTML = projects.map(p => {
                let statusBadge = '', statusClass = '';
                if (p.projectType === 'å”®å‰é¡¹ç›®') {
                    if (p.performanceData?.contractSigned || p.status === 'å·²å®Œæˆ') { statusBadge = 'å·²ç­¾å•'; statusClass = 'signed'; }
                    else { statusBadge = 'Pipeline'; statusClass = 'pipeline'; }
                } else {
                    if (p.performanceData?.reported || p.status === 'å·²å®Œæˆ') { statusBadge = 'å·²æŠ¥ç«£'; statusClass = 'completed'; }
                    else { statusBadge = 'è¿›è¡Œä¸­'; statusClass = 'ongoing'; }
                }
                
                let techBadge = '-';
                if (p.techDirection === 'ç½‘ç»œ') techBadge = '<span class="tech-badge network">ç½‘ç»œ</span>';
                else if (p.techDirection === 'ç³»ç»Ÿ') techBadge = '<span class="tech-badge system">ç³»ç»Ÿ</span>';
                else if (p.techDirection === 'èƒ½åŸº') techBadge = '<span class="tech-badge infra">èƒ½åŸº</span>';
                
                const engIds = p.assignedEngineers || [];
                const engNames = engIds.map(id => { const eng = allEngineers.find(e => e.id === id); return eng?.chineseName || eng?.displayName || ''; }).filter(n => n).join(', ') || '-';
                
                // æ˜¾ç¤ºåŸå§‹é‡‘é¢å’Œè½¬æ¢åé‡‘é¢
                const amtData = p.amountData || { original: 0, currency: 'GBP', gbp: 0 };
                const originalDisplay = `${amtData.original}K ${amtData.currency}`;
                const gbpDisplay = amtData.needsConversion ? `Â£${amtData.gbp.toFixed(0)}K` : '-';
                
                return `<tr>
                    <td><strong>${p.projectName || '-'}</strong></td>
                    <td>${p.customerName || '-'}</td>
                    <td>${techBadge}</td>
                    <td>${p.projectType || '-'}</td>
                    <td><span class="status-badge ${statusClass}">${statusBadge}</span></td>
                    <td>${p.customerCountry || '-'}</td>
                    <td class="amount-cell">${originalDisplay}</td>
                    <td class="amount-cell"><strong>${gbpDisplay}</strong></td>
                    <td>${engNames}</td>
                </tr>`;
            }).join('');
        }
        
        function resetFilters() {
            document.getElementById('period-filter').value = 'year';
            document.getElementById('engineer-filter').value = '';
            document.getElementById('tech-direction-filter').value = '';
            document.getElementById('industry-filter').value = '';
            document.getElementById('country-filter').value = '';
            document.getElementById('start-date-item').style.display = 'none';
            document.getElementById('end-date-item').style.display = 'none';
            loadStats();
        }
        
        function exportStats() {
            if (filteredProjects.length === 0) { alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º'); return; }
            let csv = '\uFEFFé¡¹ç›®åç§°,å®¢æˆ·åç§°,æŠ€æœ¯æ–¹å‘,é¡¹ç›®ç±»å‹,çŠ¶æ€,å›½å®¶,è¡Œä¸š,åŸå§‹é‡‘é¢,åŸå§‹å¸ç§,æŠ˜åˆè‹±é•‘(K),é”€å”®äººå‘˜\n';
            filteredProjects.forEach(p => {
                let status = '';
                if (p.projectType === 'å”®å‰é¡¹ç›®') { status = (p.performanceData?.contractSigned || p.status === 'å·²å®Œæˆ') ? 'å·²ç­¾å•' : 'Pipeline'; }
                else { status = (p.performanceData?.reported || p.status === 'å·²å®Œæˆ') ? 'å·²æŠ¥ç«£' : 'è¿›è¡Œä¸­'; }
                const amtData = p.amountData || { original: 0, currency: 'GBP', gbp: 0 };
                csv += `"${p.projectName || ''}","${p.customerName || ''}","${p.techDirection || ''}","${p.projectType || ''}","${status}","${p.customerCountry || ''}","${p.customerIndustry || ''}","${amtData.original}","${amtData.currency}","${amtData.gbp.toFixed(2)}","${p.salesPerson || ''}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ä¸šç»©ç»Ÿè®¡_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
    </script>
</body>
</html>
