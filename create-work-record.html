<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºå·¥ä½œè®°å½• - å·¥ç¨‹å¸ˆå·¥æ—¶ç³»ç»Ÿ</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebaseåˆå§‹åŒ–æ¨¡å— -->
    <script src="js/firebase-init.js"></script>
    
    <!-- è´§å¸è½¬æ¢æ¨¡å— -->
    <script src="js/currency-converter.js"></script>
    
    <!-- é‡‘é¢æ ¼å¼åŒ–æ¨¡å— -->
    <script src="js/amount-formatter.js"></script>
    <!-- å›½å®¶åˆ—è¡¨æ¨¡å— -->
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            padding-bottom: 50px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        /* é¡¹ç›®é€‰æ‹©æç¤ºæ¡† */
        .project-notice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .project-notice h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .project-notice p {
            opacity: 0.9;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* é¡¹ç›®åŒ¹é…æç¤º */
        .project-match-alert {
            display: none;
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            animation: slideIn 0.3s ease;
        }
        
        .project-match-alert.show {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .match-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .match-icon {
            font-size: 32px;
        }
        
        .match-title {
            font-size: 18px;
            font-weight: bold;
            color: #856404;
        }
        
        .match-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .match-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .match-item:last-child {
            border-bottom: none;
        }
        
        .match-label {
            color: #666;
            font-weight: 600;
        }
        
        .match-value {
            color: #333;
        }
        
        .match-actions {
            display: flex;
            gap: 12px;
        }
        
        .match-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-use-project {
            background: #28a745;
            color: white;
        }
        
        .btn-use-project:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .btn-create-new {
            background: white;
            color: #856404;
            border: 2px solid #ffc107;
        }
        
        .btn-create-new:hover {
            background: #fff8e1;
        }
        
        .form-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .form-card h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .form-subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .form-section {
            margin-bottom: 35px;
            border-left: 4px solid #667eea;
            padding-left: 20px;
        }
        
        .form-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row.single {
            grid-template-columns: 1fr;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-label {
            color: #333;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .required {
            color: #f48771;
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-input:disabled,
        .form-select:disabled {
            background: #f5f7fa;
            cursor: not-allowed;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .checkbox-input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .hours-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .hours-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .hour-item {
            text-align: center;
        }
        
        .hour-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .hour-label {
            font-size: 12px;
            color: #666;
        }
        
        .submit-section {
            display: flex;
            gap: 15px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e1e8ed;
        }
        
        .submit-btn {
            flex: 1;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .cancel-btn {
            padding: 18px 40px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .cancel-btn:hover {
            background: #f5f7fa;
        }
    
        /* ========================================
           é¡¹ç›®é˜¶æ®µåˆ†ç±»é€‰æ‹©å™¨æ ·å¼
           ======================================== */
        .stage-category-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .category-btn {
            padding: 10px 16px;
            border: 2px solid #E5E7EB;
            background: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
        }
        
        .category-btn:hover {
            border-color: #667eea;
            background: #F9FAFB;
            transform: translateY(-1px);
        }
        
        .category-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        /* ========================================
           è‡ªå®šä¹‰é˜¶æ®µè¾“å…¥åŒºåŸŸæ ·å¼
           ======================================== */
        .custom-stage-section {
            margin-top: 12px;
            padding: 16px;
            background: #F9FAFB;
            border-radius: 10px;
            border: 2px dashed #D1D5DB;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .custom-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .custom-input-group input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #D1D5DB;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .custom-input-group input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-add-custom {
            padding: 10px 20px;
            background: #10B981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .btn-add-custom:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-cancel-custom {
            padding: 10px 20px;
            background: #6B7280;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .btn-cancel-custom:hover {
            background: #4B5563;
        }
        
        .custom-hint {
            font-size: 12px;
            color: #6B7280;
            padding: 6px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

    </style>
    <script>
        /**
 * EMEA å›½å®¶åˆ—è¡¨ - é€šç”¨æ¨¡å—
 * åŒ…å«æ¬§æ´²ã€ä¸­ä¸œã€éæ´²åœ°åŒºçš„å®Œæ•´å›½å®¶åˆ—è¡¨
 * 
 * ä½¿ç”¨æ–¹æ³•:
 * <script src="countries-list.js"></script>
 * <select id="country-select"></select>
 * <script>
 *   populateCountrySelect('country-select');
 * </script>
 */

// EMEA å›½å®¶åˆ—è¡¨ï¼ˆæŒ‰åœ°åŒºåˆ†ç»„ï¼‰
const COUNTRIES_LIST = {
    // è¥¿æ¬§
    westEurope: [
        { value: 'è‹±å›½', label: 'è‹±å›½ (UK)', en: 'United Kingdom' },
        { value: 'æ³•å›½', label: 'æ³•å›½ (France)', en: 'France' },
        { value: 'å¾·å›½', label: 'å¾·å›½ (Germany)', en: 'Germany' },
        { value: 'è·å…°', label: 'è·å…° (Netherlands)', en: 'Netherlands' },
        { value: 'æ¯”åˆ©æ—¶', label: 'æ¯”åˆ©æ—¶ (Belgium)', en: 'Belgium' },
        { value: 'å¢æ£®å ¡', label: 'å¢æ£®å ¡ (Luxembourg)', en: 'Luxembourg' },
        { value: 'çˆ±å°”å…°', label: 'çˆ±å°”å…° (Ireland)', en: 'Ireland' },
        { value: 'ç‘å£«', label: 'ç‘å£« (Switzerland)', en: 'Switzerland' },
        { value: 'å¥¥åœ°åˆ©', label: 'å¥¥åœ°åˆ© (Austria)', en: 'Austria' }
    ],
    
    // å—æ¬§
    southEurope: [
        { value: 'æ„å¤§åˆ©', label: 'æ„å¤§åˆ© (Italy)', en: 'Italy' },
        { value: 'è¥¿ç­ç‰™', label: 'è¥¿ç­ç‰™ (Spain)', en: 'Spain' },
        { value: 'è‘¡è„ç‰™', label: 'è‘¡è„ç‰™ (Portugal)', en: 'Portugal' },
        { value: 'å¸Œè…Š', label: 'å¸Œè…Š (Greece)', en: 'Greece' },
        { value: 'å¡æµ¦è·¯æ–¯', label: 'å¡æµ¦è·¯æ–¯ (Cyprus)', en: 'Cyprus' },
        { value: 'é©¬è€³ä»–', label: 'é©¬è€³ä»– (Malta)', en: 'Malta' }
    ],
    
    // åŒ—æ¬§
    northEurope: [
        { value: 'ç‘å…¸', label: 'ç‘å…¸ (Sweden)', en: 'Sweden' },
        { value: 'æŒªå¨', label: 'æŒªå¨ (Norway)', en: 'Norway' },
        { value: 'ä¸¹éº¦', label: 'ä¸¹éº¦ (Denmark)', en: 'Denmark' },
        { value: 'èŠ¬å…°', label: 'èŠ¬å…° (Finland)', en: 'Finland' },
        { value: 'å†°å²›', label: 'å†°å²› (Iceland)', en: 'Iceland' }
    ],
    
    // ä¸œæ¬§ â­ é‡ç‚¹æ‰©å……
    eastEurope: [
        { value: 'æ³¢å…°', label: 'æ³¢å…° (Poland)', en: 'Poland' },
        { value: 'æ·å…‹', label: 'æ·å…‹ (Czech Republic)', en: 'Czech Republic' },
        { value: 'åŒˆç‰™åˆ©', label: 'åŒˆç‰™åˆ© (Hungary)', en: 'Hungary' },
        { value: 'ç½—é©¬å°¼äºš', label: 'ç½—é©¬å°¼äºš (Romania)', en: 'Romania' },
        { value: 'ä¿åŠ åˆ©äºš', label: 'ä¿åŠ åˆ©äºš (Bulgaria)', en: 'Bulgaria' },
        { value: 'æ–¯æ´›ä¼å…‹', label: 'æ–¯æ´›ä¼å…‹ (Slovakia)', en: 'Slovakia' },
        { value: 'æ–¯æ´›æ–‡å°¼äºš', label: 'æ–¯æ´›æ–‡å°¼äºš (Slovenia)', en: 'Slovenia' },
        { value: 'å…‹ç½—åœ°äºš', label: 'å…‹ç½—åœ°äºš (Croatia)', en: 'Croatia' },
        { value: 'å¡å°”ç»´äºš', label: 'å¡å°”ç»´äºš (Serbia)', en: 'Serbia' },
        { value: 'æ³¢é»‘', label: 'æ³¢é»‘ (Bosnia and Herzegovina)', en: 'Bosnia and Herzegovina' },
        { value: 'é»‘å±±', label: 'é»‘å±± (Montenegro)', en: 'Montenegro' },
        { value: 'åŒ—é©¬å…¶é¡¿', label: 'åŒ—é©¬å…¶é¡¿ (North Macedonia)', en: 'North Macedonia' },
        { value: 'é˜¿å°”å·´å°¼äºš', label: 'é˜¿å°”å·´å°¼äºš (Albania)', en: 'Albania' },
        { value: 'ç§‘ç´¢æ²ƒ', label: 'ç§‘ç´¢æ²ƒ (Kosovo)', en: 'Kosovo' },
        { value: 'çˆ±æ²™å°¼äºš', label: 'çˆ±æ²™å°¼äºš (Estonia)', en: 'Estonia' },
        { value: 'æ‹‰è„±ç»´äºš', label: 'æ‹‰è„±ç»´äºš (Latvia)', en: 'Latvia' },
        { value: 'ç«‹é™¶å®›', label: 'ç«‹é™¶å®› (Lithuania)', en: 'Lithuania' }
    ],
    
    // ä¸­ä¸œ â­ é‡ç‚¹åœ°åŒº
    middleEast: [
        { value: 'åœŸè€³å…¶', label: 'åœŸè€³å…¶ (Turkey)', en: 'Turkey' },
        { value: 'é˜¿è”é…‹', label: 'é˜¿è”é…‹ (UAE)', en: 'United Arab Emirates' },
        { value: 'æ²™ç‰¹é˜¿æ‹‰ä¼¯', label: 'æ²™ç‰¹é˜¿æ‹‰ä¼¯ (Saudi Arabia)', en: 'Saudi Arabia' },
        { value: 'å¡å¡”å°”', label: 'å¡å¡”å°” (Qatar)', en: 'Qatar' },
        { value: 'ç§‘å¨ç‰¹', label: 'ç§‘å¨ç‰¹ (Kuwait)', en: 'Kuwait' },
        { value: 'é˜¿æ›¼', label: 'é˜¿æ›¼ (Oman)', en: 'Oman' },
        { value: 'å·´æ—', label: 'å·´æ— (Bahrain)', en: 'Bahrain' },
        { value: 'ä»¥è‰²åˆ—', label: 'ä»¥è‰²åˆ— (Israel)', en: 'Israel' },
        { value: 'çº¦æ—¦', label: 'çº¦æ—¦ (Jordan)', en: 'Jordan' },
        { value: 'é»å·´å«©', label: 'é»å·´å«© (Lebanon)', en: 'Lebanon' },
        { value: 'ä¼Šæ‹‰å…‹', label: 'ä¼Šæ‹‰å…‹ (Iraq)', en: 'Iraq' },
        { value: 'ä¼Šæœ—', label: 'ä¼Šæœ— (Iran)', en: 'Iran' },
        { value: 'ä¹Ÿé—¨', label: 'ä¹Ÿé—¨ (Yemen)', en: 'Yemen' }
    ],
    
    // åŒ—é
    northAfrica: [
        { value: 'åŸƒåŠ', label: 'åŸƒåŠ (Egypt)', en: 'Egypt' },
        { value: 'æ‘©æ´›å“¥', label: 'æ‘©æ´›å“¥ (Morocco)', en: 'Morocco' },
        { value: 'é˜¿å°”åŠåˆ©äºš', label: 'é˜¿å°”åŠåˆ©äºš (Algeria)', en: 'Algeria' },
        { value: 'çªå°¼æ–¯', label: 'çªå°¼æ–¯ (Tunisia)', en: 'Tunisia' },
        { value: 'åˆ©æ¯”äºš', label: 'åˆ©æ¯”äºš (Libya)', en: 'Libya' },
        { value: 'è‹ä¸¹', label: 'è‹ä¸¹ (Sudan)', en: 'Sudan' }
    ],
    
    // æ’’å“ˆæ‹‰ä»¥å—éæ´²
    subSaharanAfrica: [
        { value: 'å—é', label: 'å—é (South Africa)', en: 'South Africa' },
        { value: 'å°¼æ—¥åˆ©äºš', label: 'å°¼æ—¥åˆ©äºš (Nigeria)', en: 'Nigeria' },
        { value: 'è‚¯å°¼äºš', label: 'è‚¯å°¼äºš (Kenya)', en: 'Kenya' },
        { value: 'åŠ çº³', label: 'åŠ çº³ (Ghana)', en: 'Ghana' },
        { value: 'åŸƒå¡ä¿„æ¯”äºš', label: 'åŸƒå¡ä¿„æ¯”äºš (Ethiopia)', en: 'Ethiopia' }
    ],
    
    // äºšæ´²ï¼ˆä¸­å›½ç”µä¿¡ä¸šåŠ¡ç›¸å…³ï¼‰
    asia: [
        { value: 'ä¸­å›½', label: 'ä¸­å›½ (China)', en: 'China' },
        { value: 'æ–°åŠ å¡', label: 'æ–°åŠ å¡ (Singapore)', en: 'Singapore' },
        { value: 'æ—¥æœ¬', label: 'æ—¥æœ¬ (Japan)', en: 'Japan' },
        { value: 'éŸ©å›½', label: 'éŸ©å›½ (South Korea)', en: 'South Korea' },
        { value: 'å°åº¦', label: 'å°åº¦ (India)', en: 'India' },
        { value: 'é©¬æ¥è¥¿äºš', label: 'é©¬æ¥è¥¿äºš (Malaysia)', en: 'Malaysia' },
        { value: 'æ³°å›½', label: 'æ³°å›½ (Thailand)', en: 'Thailand' },
        { value: 'è¶Šå—', label: 'è¶Šå— (Vietnam)', en: 'Vietnam' },
        { value: 'å°åº¦å°¼è¥¿äºš', label: 'å°åº¦å°¼è¥¿äºš (Indonesia)', en: 'Indonesia' },
        { value: 'è²å¾‹å®¾', label: 'è²å¾‹å®¾ (Philippines)', en: 'Philippines' }
    ],
    
    // ç¾æ´²ï¼ˆå¯é€‰ï¼‰
    americas: [
        { value: 'ç¾å›½', label: 'ç¾å›½ (USA)', en: 'United States' },
        { value: 'åŠ æ‹¿å¤§', label: 'åŠ æ‹¿å¤§ (Canada)', en: 'Canada' },
        { value: 'å·´è¥¿', label: 'å·´è¥¿ (Brazil)', en: 'Brazil' },
        { value: 'å¢¨è¥¿å“¥', label: 'å¢¨è¥¿å“¥ (Mexico)', en: 'Mexico' },
        { value: 'é˜¿æ ¹å»·', label: 'é˜¿æ ¹å»· (Argentina)', en: 'Argentina' }
    ],
    
    // å¤§æ´‹æ´²ï¼ˆå¯é€‰ï¼‰
    oceania: [
        { value: 'æ¾³å¤§åˆ©äºš', label: 'æ¾³å¤§åˆ©äºš (Australia)', en: 'Australia' },
        { value: 'æ–°è¥¿å…°', label: 'æ–°è¥¿å…° (New Zealand)', en: 'New Zealand' }
    ]
};

// åœ°åŒºåç§°æ˜ å°„ï¼ˆä¸­æ–‡ï¼‰
const REGION_NAMES = {
    westEurope: 'è¥¿æ¬§',
    southEurope: 'å—æ¬§',
    northEurope: 'åŒ—æ¬§',
    eastEurope: 'ä¸œæ¬§',
    middleEast: 'ä¸­ä¸œ',
    northAfrica: 'åŒ—é',
    subSaharanAfrica: 'æ’’å“ˆæ‹‰ä»¥å—éæ´²',
    asia: 'äºšæ´²',
    americas: 'ç¾æ´²',
    oceania: 'å¤§æ´‹æ´²'
};

/**
 * å¡«å……å›½å®¶é€‰æ‹©å™¨
 * @param {string} selectId - selectå…ƒç´ çš„ID
 * @param {object} options - é…ç½®é€‰é¡¹
 * @param {boolean} options.includeAllRegions - æ˜¯å¦åŒ…å«æ‰€æœ‰åœ°åŒºï¼ˆé»˜è®¤trueï¼‰
 * @param {Array} options.excludeRegions - è¦æ’é™¤çš„åœ°åŒºï¼ˆå¯é€‰ï¼‰
 * @param {boolean} options.addEmptyOption - æ˜¯å¦æ·»åŠ "è¯·é€‰æ‹©"é€‰é¡¹ï¼ˆé»˜è®¤trueï¼‰
 */
function populateCountrySelect(selectId, options = {}) {
    const select = document.getElementById(selectId);
    if (!select) {
        console.error(`Select element with id '${selectId}' not found`);
        return;
    }
    
    // é»˜è®¤é…ç½®
    const config = {
        includeAllRegions: true,
        excludeRegions: [],
        addEmptyOption: true,
        emptyOptionText: 'è¯·é€‰æ‹©',  // æ–°å¢ï¼šå¯è‡ªå®šä¹‰ç©ºé€‰é¡¹æ–‡æœ¬
        ...options
    };
    
    // æ¸…ç©ºç°æœ‰é€‰é¡¹
    select.innerHTML = '';
    
    // æ·»åŠ ç©ºé€‰é¡¹ï¼ˆå¯è‡ªå®šä¹‰æ–‡æœ¬ï¼‰
    if (config.addEmptyOption) {
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = config.emptyOptionText;
        select.appendChild(emptyOption);
    }
    
    // æŒ‰åœ°åŒºæ·»åŠ å›½å®¶é€‰é¡¹
    Object.keys(COUNTRIES_LIST).forEach(region => {
        if (config.excludeRegions.includes(region)) {
            return;
        }
        
        const countries = COUNTRIES_LIST[region];
        const regionName = REGION_NAMES[region];
        
        // åˆ›å»ºoptgroup
        const optgroup = document.createElement('optgroup');
        optgroup.label = regionName;
        
        // æ·»åŠ å›½å®¶é€‰é¡¹
        countries.forEach(country => {
            const option = document.createElement('option');
            option.value = country.value;
            option.textContent = country.label;
            option.dataset.en = country.en;
            optgroup.appendChild(option);
        });
        
        select.appendChild(optgroup);
    });
}

/**
 * è·å–æ‰€æœ‰å›½å®¶åˆ—è¡¨ï¼ˆæ‰å¹³åŒ–ï¼‰
 * @returns {Array} å›½å®¶æ•°ç»„
 */
function getAllCountries() {
    const allCountries = [];
    Object.values(COUNTRIES_LIST).forEach(region => {
        allCountries.push(...region);
    });
    return allCountries;
}

/**
 * æœç´¢å›½å®¶ï¼ˆæ”¯æŒä¸­æ–‡ã€è‹±æ–‡ï¼‰
 * @param {string} query - æœç´¢å…³é”®è¯
 * @returns {Array} åŒ¹é…çš„å›½å®¶åˆ—è¡¨
 */
function searchCountries(query) {
    const lowerQuery = query.toLowerCase();
    const allCountries = getAllCountries();
    
    return allCountries.filter(country => {
        return country.value.toLowerCase().includes(lowerQuery) ||
               country.label.toLowerCase().includes(lowerQuery) ||
               country.en.toLowerCase().includes(lowerQuery);
    });
}

/**
 * æŒ‰åœ°åŒºè·å–å›½å®¶åˆ—è¡¨
 * @param {string} region - åœ°åŒºåç§°ï¼ˆå¦‚ 'eastEurope'ï¼‰
 * @returns {Array} è¯¥åœ°åŒºçš„å›½å®¶åˆ—è¡¨
 */
function getCountriesByRegion(region) {
    return COUNTRIES_LIST[region] || [];
}

// å¯¼å‡ºä¾›å¤–éƒ¨ä½¿ç”¨
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        COUNTRIES_LIST,
        REGION_NAMES,
        populateCountrySelect,
        getAllCountries,
        searchCountries,
        getCountriesByRegion
    };
}

    </script>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="header">
        <div class="header-content">
            <h2>âœï¸ åˆ›å»ºå·¥ä½œè®°å½•</h2>
            <a href="dashboard.html" class="back-btn">â† è¿”å›ä¸»é¡µ</a>
        </div>
    </div>
    
    <div class="container">
        <!-- é¡¹ç›®é€‰æ‹©æç¤º -->
        <div class="project-notice">
            <h3>ğŸ’¡ æ™ºèƒ½é¡¹ç›®å…³è”</h3>
            <p>è¾“å…¥å®¢æˆ·å’Œé¡¹ç›®åç§°æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹æ˜¯å¦å·²å­˜åœ¨è¯¥é¡¹ç›®ã€‚å¦‚æœé¡¹ç›®å·²å­˜åœ¨ï¼Œå¯ä»¥ç›´æ¥å…³è”ï¼›å¦‚æœæ˜¯æ–°é¡¹ç›®ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºé¡¹ç›®è®°å½•ã€‚</p>
        </div>
        
        <!-- é¡¹ç›®åŒ¹é…æç¤ºæ¡† -->
        <div class="project-match-alert" id="project-match-alert">
            <div class="match-header">
                <span class="match-icon">ğŸ¯</span>
                <div>
                    <div class="match-title">æ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®ï¼</div>
                    <div style="font-size: 13px; color: #856404; margin-top: 5px;">
                        ç³»ç»Ÿæ£€æµ‹åˆ°è¯¥é¡¹ç›®å·²å­˜åœ¨ï¼Œæ‚¨å¯ä»¥é€‰æ‹©ï¼š
                    </div>
                </div>
            </div>
            
            <div class="match-content" id="match-content">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
            
            <div class="match-actions">
                <button class="match-btn btn-use-project" onclick="useExistingProject()">
                    âœ… å…³è”åˆ°æ­¤é¡¹ç›®
                </button>
                <button class="match-btn btn-create-new" onclick="createNewProject()">
                    â• åˆ›å»ºæ–°é¡¹ç›®
                </button>
            </div>
        </div>
        
        <!-- ä¸»è¡¨å• -->
        <div class="form-card">
            <h1>ğŸ“ è®°å½•ä»Šæ—¥å·¥ä½œ</h1>
            <p class="form-subtitle">å¡«å†™å·¥ä½œå†…å®¹ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®—å·¥æ—¶</p>
            
            <form id="work-record-form">
                <!-- å®¢æˆ·ä¿¡æ¯ -->
                <div class="form-section">
                    <h3>ğŸ‘¤ å®¢æˆ·ä¿¡æ¯</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                å®¢æˆ·åç§° <span class="required">*</span>
                            </label>
                            <input type="text" id="customer-name" class="form-input" 
                                   required placeholder="ä¾‹å¦‚: æ‹›å•†é“¶è¡Œ"
                                   onblur="checkExistingProject()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å®¢æˆ·è¡Œä¸š</label>
                            <select id="customer-industry" class="form-select">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="é“¶è¡Œ">é“¶è¡Œ</option>
                                <option value="ä¿é™©">ä¿é™©</option>
                                <option value="è¯åˆ¸">è¯åˆ¸</option>
                                <option value="åŸºé‡‘">åŸºé‡‘</option>
                                <option value="ä¿¡æ‰˜">ä¿¡æ‰˜</option>
                                <option value="åˆ¶é€ ä¸š">åˆ¶é€ ä¸š</option>
                                <option value="èƒ½æº">èƒ½æº</option>
                                <option value="é›¶å”®">é›¶å”®</option>
                                <option value="ç‰©æµ">ç‰©æµ</option>
                                <option value="ç”µä¿¡">ç”µä¿¡</option>
                                <option value="äº’è”ç½‘">äº’è”ç½‘</option>
                                <option value="æ•™è‚²">æ•™è‚²</option>
                                <option value="åŒ»ç–—">åŒ»ç–—</option>
                                <option value="æ”¿åºœ">æ”¿åºœ</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">å›½å®¶/åœ°åŒº</label>
                            <select id="customer-country" class="form-select">
    <!-- é€šè¿‡ countries-list.js è‡ªåŠ¨å¡«å…… -->
                           </select>
                        </div>
                    </div>
                </div>
                
                <!-- é¡¹ç›®ä¿¡æ¯ -->
                <div class="form-section">
                    <h3>ğŸ“Š é¡¹ç›®ä¿¡æ¯</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                é¡¹ç›®åç§° <span class="required">*</span>
                            </label>
                            <input type="text" id="project-name" class="form-input" 
                                   required placeholder="ä¾‹å¦‚: IPç”µè¯ç³»ç»Ÿå‡çº§"
                                   onblur="checkExistingProject()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                é¡¹ç›®ç±»å‹ <span class="required">*</span>
                            </label>
                            <select id="project-type" class="form-select" required>
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="å”®å‰é¡¹ç›®">å”®å‰é¡¹ç›®</option>
                                <option value="å”®åé¡¹ç›®">å”®åé¡¹ç›®</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                é¡¹ç›®é˜¶æ®µ <span class="required">*</span>
                            </label>
                            
                            <!-- é˜¶æ®µåˆ†ç±»é€‰æ‹©ï¼ˆä»…å”®åé¡¹ç›®æ˜¾ç¤ºï¼‰ -->
                            <div class="stage-category-selector" id="stage-category-selector" style="display: none;">
                                <button type="button" class="category-btn active" data-category="general" onclick="selectStageCategory('general')">
                                    ğŸ“¦ é€šç”¨é˜¶æ®µ
                                </button>
                                <button type="button" class="category-btn" data-category="network" onclick="selectStageCategory('network')">
                                    ğŸŒ ç½‘ç»œé¡¹ç›®
                                </button>
                                <button type="button" class="category-btn" data-category="system" onclick="selectStageCategory('system')">
                                    ğŸ–¥ï¸ ç³»ç»Ÿé¡¹ç›®
                                </button>
                                <button type="button" class="category-btn" data-category="infrastructure" onclick="selectStageCategory('infrastructure')">
                                    ğŸ¢ èƒ½åŸºé¡¹ç›®
                                </button>
                            </div>
                            
                            <!-- é˜¶æ®µé€‰æ‹©ä¸‹æ‹‰åˆ—è¡¨ -->
                            <select id="project-stage" class="form-select" required>
                                <option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®ç±»å‹</option>
                            </select>
                            
                            <!-- è‡ªå®šä¹‰é˜¶æ®µè¾“å…¥åŒºåŸŸ -->
                            <div class="custom-stage-section" id="custom-stage-section" style="display: none;">
                                <div class="custom-input-group">
                                    <input type="text" id="custom-stage-input" class="form-input" 
                                           placeholder="è¾“å…¥è‡ªå®šä¹‰é˜¶æ®µåç§°ï¼ˆä¾‹å¦‚ï¼šå®¹å™¨åŒ–éƒ¨ç½²ï¼‰">
                                    <button type="button" class="btn-add-custom" onclick="addCustomStage()">
                                        âœ… æ·»åŠ 
                                    </button>
                                    <button type="button" class="btn-cancel-custom" onclick="cancelCustomStage()">
                                        âŒ å–æ¶ˆ
                                    </button>
                                </div>
                                <div class="custom-hint">
                                    ğŸ’¡ æ­¤é˜¶æ®µå°†ä¿å­˜åˆ°æ‚¨çš„ä¸ªäººé€‰é¡¹åº“ï¼Œä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                æ”¯æŒç±»å‹ <span class="required">*</span>
                            </label>
                            <select id="support-type" class="form-select" required>
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="ç°åœºæ”¯æŒ">ç°åœºæ”¯æŒ</option>
                                <option value="è¿œç¨‹æ”¯æŒ">è¿œç¨‹æ”¯æŒ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é”€å”®äººå‘˜</label>
                            <input type="text" id="sales-person" class="form-input" 
                                   placeholder="è´Ÿè´£çš„é”€å”®äººå‘˜">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®é‡‘é¢ï¼ˆå¯é€‰ï¼‰</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="project-amount" class="form-input" 
                                       placeholder="é‡‘é¢ï¼ˆKï¼‰" style="flex: 2;">
                                <select id="project-currency" class="form-select" style="flex: 1;">
                                    <option value="GBP">GBP</option>
                                    <option value="EUR">EUR</option>
                                    <option value="USD">USD</option>
                                    <option value="CNY">CNY</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ—¶é—´ä¿¡æ¯ -->
                <div class="form-section">
                    <h3>â° æ—¶é—´ä¿¡æ¯</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                å·¥ä½œæ—¥æœŸ <span class="required">*</span>
                            </label>
                            <input type="date" id="work-date" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ˜¯å¦èŠ‚å‡æ—¥å·¥ä½œ</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="is-holiday" class="checkbox-input" 
                                       onchange="calculateHours()">
                                <label for="is-holiday" style="cursor: pointer;">
                                    èŠ‚å‡æ—¥å·¥ä½œï¼ˆå…¨éƒ¨ç®—åŠ ç­ï¼‰
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                å¼€å§‹æ—¶é—´ <span class="required">*</span>
                            </label>
                            <input type="time" id="start-time" class="form-input" 
                                   required onchange="calculateHours()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                ç»“æŸæ—¶é—´ <span class="required">*</span>
                            </label>
                            <input type="time" id="end-time" class="form-input" 
                                   required onchange="calculateHours()">
                        </div>
                    </div>
                    
                    <!-- å·¥æ—¶æ˜¾ç¤º -->
                    <div class="hours-display" id="hours-display" style="display: none;">
                        <div class="hours-grid">
                            <div class="hour-item">
                                <div class="hour-value" id="normal-hours">0.0</div>
                                <div class="hour-label">æ­£å¸¸å·¥æ—¶</div>
                            </div>
                            <div class="hour-item">
                                <div class="hour-value" id="overtime-hours">0.0</div>
                                <div class="hour-label">åŠ ç­å·¥æ—¶</div>
                            </div>
                            <div class="hour-item">
                                <div class="hour-value" id="total-hours">0.0</div>
                                <div class="hour-label">æ€»å·¥æ—¶</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å·¥ä½œå†…å®¹ -->
                <div class="form-section">
                    <h3>ğŸ“‹ å·¥ä½œå†…å®¹</h3>
                    <div class="form-row single">
                        <div class="form-group">
                            <label class="form-label">
                                å·¥ä½œæè¿° <span class="required">*</span>
                            </label>
                            <textarea id="work-description" class="form-textarea" 
                                      required placeholder="è¯¦ç»†æè¿°ä»Šå¤©å®Œæˆçš„å·¥ä½œå†…å®¹..."></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row single">
                        <div class="form-group">
                            <label class="form-label">ä¸‹å‘¨å·¥ä½œè®¡åˆ’</label>
                            <textarea id="next-week-plan" class="form-textarea" 
                                      placeholder="ä¸‹ä¸€æ­¥çš„å·¥ä½œè®¡åˆ’..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- æäº¤æŒ‰é’® -->
                <div class="submit-section">
                    <button type="submit" class="submit-btn" id="submit-btn">
                        âœ… ä¿å­˜å·¥ä½œè®°å½•
                    </button>
                    <button type="button" class="cancel-btn" 
                            onclick="window.location.href='dashboard.html'">
                        å–æ¶ˆ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å›½å®¶åˆ—è¡¨
    document.addEventListener('DOMContentLoaded', () => {
        populateCountrySelect('customer-country');
    });
    
    // Firebaseé…ç½®
    // Firebaseå·²ç”±firebase-init.jsåˆå§‹åŒ–
        // auth å’Œ db å˜é‡å·²å…¨å±€å¯ç”¨
        // ä»¥ä¸‹ä»£ç å·²æ³¨é‡Šï¼ˆä¿ç•™ä¾›å‚è€ƒï¼‰
        /*
        const firebaseConfig = {
            apiKey: "AIzaSyBzcAr_OJFdIMnaYXRCE7TJs2qlK_TAy9U",
            authDomain: "weekly-report-d55e9.firebaseapp.com",
            projectId: "weekly-report-d55e9",
            storageBucket: "weekly-report-d55e9.appspot.com",
            messagingSenderId: "315332641675",
            appId: "1:315332641675:web:e1b52c3d4c5fcc7b8c0de7"
        };

        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        */
        
        let currentUser = null;
        let userData = null;
        let matchedProject = null;

        // ============================================
        // é¡¹ç›®é˜¶æ®µå®Œæ•´å®šä¹‰ï¼ˆ260ä¸ªä¸“ä¸šé˜¶æ®µï¼‰
        // ============================================
        
        // å”®å‰é¡¹ç›®é˜¶æ®µï¼ˆ37ä¸ªï¼‰
        const presalesStages = [
            'åˆæ­¥æ¥è§¦', 'å®¢æˆ·æ‹œè®¿', 'éœ€æ±‚æŒ–æ˜', 'å•†æœºè¯†åˆ«', 'éœ€æ±‚è°ƒç ”',
            'é¢„ç®—ç¡®è®¤', 'å†³ç­–æµç¨‹äº†è§£', 'æ—¶é—´è®¡åˆ’ç¡®è®¤', 'èµ„æ ¼è¯„ä¼°',
            'éœ€æ±‚åˆ†æ', 'æŠ€æœ¯äº¤æµ', 'æ–¹æ¡ˆè®¾è®¡', 'æ–¹æ¡ˆè¯„å®¡', 'æˆæœ¬ä¼°ç®—',
            'æ–¹æ¡ˆæ¼”ç¤º', 'POCæµ‹è¯•', 'æŠ€æœ¯ç­”ç–‘', 'ç°åœºå‹˜æŸ¥', 'æ·±åº¦æŠ€æœ¯äº¤æµ',
            'æŠ•æ ‡å‡†å¤‡', 'RFPå“åº”', 'æŠ•æ ‡ç­”è¾©', 'å•†åŠ¡æŠ¥ä»·', 'åˆè§„å®¡æŸ¥',
            'åˆåŒè°ˆåˆ¤', 'ä»·æ ¼è°ˆåˆ¤', 'ä»˜æ¬¾æ¡ä»¶è°ˆåˆ¤', 'SLAè°ˆåˆ¤', 'é£é™©è¯„ä¼°',
            'åˆåŒå®¡æ‰¹', 'æ³•åŠ¡å®¡æ ¸', 'åˆåŒç­¾ç½²', 'é¡¹ç›®ç«‹é¡¹',
            'é¡¹ç›®æš‚åœ', 'å®¢æˆ·å…³ç³»ç»´æŠ¤', 'å…¶ä»–å”®å‰æ´»åŠ¨', 'å¾…å®š'
        ];
        
        // ç½‘ç»œé¡¹ç›®é˜¶æ®µï¼ˆ56ä¸ªï¼‰
        const networkStages = [
            'éœ€æ±‚åˆ†æ', 'ç½‘ç»œæ‹“æ‰‘è®¾è®¡', 'è®¾å¤‡é€‰å‹', 'IPåœ°å€è§„åˆ’', 'VLANè§„åˆ’', 'è·¯ç”±è§„åˆ’', 'å®‰å…¨ç­–ç•¥è®¾è®¡',
            'ç½‘ç»œå¸ƒçº¿', 'è®¾å¤‡å®‰è£…ä¸Šæ¶', 'äº¤æ¢æœºé…ç½®', 'è·¯ç”±å™¨é…ç½®', 'VLANé…ç½®', 'é“¾è·¯èšåˆé…ç½®',
            'æ•°æ®ä¸­å¿ƒç½‘ç»œè®¾è®¡', 'æ ¸å¿ƒäº¤æ¢é…ç½®', 'æœåŠ¡å™¨æ¥å…¥é…ç½®', 'å­˜å‚¨ç½‘ç»œé…ç½®',
            'WANé“¾è·¯é…ç½®', 'MPLSé…ç½®', 'VPNé…ç½®', 'SD-WANéƒ¨ç½²',
            'æ— çº¿APéƒ¨ç½²', 'ACæ§åˆ¶å™¨é…ç½®', 'æ— çº¿ç½‘ç»œä¼˜åŒ–', 'æ— çº¿è¦†ç›–æµ‹è¯•',
            'IPç”µè¯ç³»ç»Ÿè®¾è®¡', 'CUCMæœåŠ¡å™¨éƒ¨ç½²', 'è¯­éŸ³ç½‘å…³é…ç½®', 'SIPä¸­ç»§é…ç½®', 'è¯æœºé…ç½®', 'è¯­éŸ³è´¨é‡æµ‹è¯•',
            'è§†é¢‘ä¼šè®®ç³»ç»Ÿéƒ¨ç½²', 'MCUé…ç½®', 'è§†é¢‘ç»ˆç«¯é…ç½®', 'è§†é¢‘ä¼šè®®æµ‹è¯•',
            'é˜²ç«å¢™éƒ¨ç½²', 'é˜²ç«å¢™ç­–ç•¥é…ç½®', 'IPS/IDSéƒ¨ç½²', 'å ¡å’æœºéƒ¨ç½²', 'ä¸Šç½‘è¡Œä¸ºç®¡ç†', 'NACéƒ¨ç½²',
            'ç½‘ç»œè¿é€šæ€§æµ‹è¯•', 'ç½‘ç»œæ€§èƒ½æµ‹è¯•', 'ç½‘ç»œå®‰å…¨æµ‹è¯•', 'å‹åŠ›æµ‹è¯•', 'æ•…éšœåˆ‡æ¢æµ‹è¯•',
            'ç½‘ç»œç›‘æ§éƒ¨ç½²', 'ç½‘ç»œè¿ç»´', 'ç½‘ç»œä¼˜åŒ–', 'æ•…éšœæ’æŸ¥', 'è®¾å¤‡ç»´æŠ¤', 'é…ç½®å¤‡ä»½',
            'ç½‘ç»œå‰²æ¥', 'ç½‘ç»œæ‰©å®¹', 'ç½‘ç»œå‡çº§', 'åº”æ€¥å“åº”'
        ];
        
        // ç³»ç»Ÿé¡¹ç›®é˜¶æ®µï¼ˆ61ä¸ªï¼‰
        const systemStages = [
            'éœ€æ±‚åˆ†æ', 'ç³»ç»Ÿæ¶æ„è®¾è®¡', 'å®¹é‡è§„åˆ’', 'é«˜å¯ç”¨è®¾è®¡', 'ç¾å¤‡æ–¹æ¡ˆè®¾è®¡', 'æœåŠ¡å™¨é€‰å‹', 'å­˜å‚¨é€‰å‹',
            'æœåŠ¡å™¨å®‰è£…ä¸Šæ¶', 'RAIDé…ç½®', 'æ“ä½œç³»ç»Ÿå®‰è£…', 'ç³»ç»Ÿåˆå§‹åŒ–', 'ç³»ç»Ÿé…ç½®', 'ç³»ç»ŸåŠ å›º', 'è¡¥ä¸å®‰è£…',
            'å­˜å‚¨è®¾å¤‡å®‰è£…', 'å­˜å‚¨é…ç½®', 'LUNåˆ’åˆ†', 'å­˜å‚¨æ˜ å°„', 'å­˜å‚¨æ€§èƒ½ä¼˜åŒ–',
            'è™šæ‹ŸåŒ–å¹³å°éƒ¨ç½²', 'VMware ESXiå®‰è£…', 'vCenteré…ç½®', 'è™šæ‹Ÿæœºåˆ›å»º', 'è™šæ‹Ÿç½‘ç»œé…ç½®', 'è™šæ‹Ÿå­˜å‚¨é…ç½®', 'è™šæ‹Ÿæœºè¿ç§»',
            'äº‘å¹³å°éƒ¨ç½²', 'äº‘è´¦å·å¼€é€š', 'äº‘èµ„æºç”³è¯·', 'äº‘ç½‘ç»œé…ç½®', 'äº‘å®‰å…¨é…ç½®', 'äº‘ç›‘æ§é…ç½®', 'åº”ç”¨äº‘åŒ–æ”¹é€ ', 'æ•°æ®äº‘è¿ç§»',
            'ä¸­é—´ä»¶éƒ¨ç½²', 'æ•°æ®åº“å®‰è£…', 'æ•°æ®åº“é…ç½®', 'åº”ç”¨è½¯ä»¶éƒ¨ç½²', 'åº”ç”¨é…ç½®', 'æ•°æ®å¯¼å…¥',
            'å¤‡ä»½ç³»ç»Ÿéƒ¨ç½²', 'å¤‡ä»½ç­–ç•¥é…ç½®', 'å¤‡ä»½æµ‹è¯•', 'ç¾å¤‡ç³»ç»Ÿéƒ¨ç½²', 'ç¾å¤‡æ¼”ç»ƒ',
            'åŠŸèƒ½æµ‹è¯•', 'æ€§èƒ½æµ‹è¯•', 'å‹åŠ›æµ‹è¯•', 'å…¼å®¹æ€§æµ‹è¯•', 'å®‰å…¨æµ‹è¯•', 'å®¹ç¾åˆ‡æ¢æµ‹è¯•',
            'ç³»ç»Ÿç›‘æ§éƒ¨ç½²', 'ç³»ç»Ÿè¿ç»´', 'æ€§èƒ½ä¼˜åŒ–', 'è¡¥ä¸ç®¡ç†', 'å¤‡ä»½ç®¡ç†', 'æ•…éšœæ¢å¤',
            'ç³»ç»Ÿå‡çº§', 'ç³»ç»Ÿæ‰©å®¹', 'ç³»ç»Ÿè¿ç§»', 'ä¸šåŠ¡å‰²æ¥'
        ];
        
        // èƒ½åŸºé¡¹ç›®é˜¶æ®µï¼ˆ66ä¸ªï¼‰
        const infrastructureStages = [
            'éœ€æ±‚è°ƒç ”', 'ç°åœºå‹˜æŸ¥', 'æœºæˆ¿è®¾è®¡', 'æœºæˆ¿è§„åˆ’', 'æ‰¿é‡è¯„ä¼°', 'ç”µåŠ›å®¹é‡è¯„ä¼°', 'åˆ¶å†·éœ€æ±‚è¯„ä¼°',
            'æœºæˆ¿è£…ä¿®', 'é˜²é™ç”µåœ°æ¿é“ºè®¾', 'åŠé¡¶å®‰è£…', 'éš”æ–­å®‰è£…', 'æœºæˆ¿é—¨çª—å®‰è£…',
            'é…ç”µæŸœå®‰è£…', 'é…ç”µç³»ç»Ÿå®‰è£…', 'UPSå®‰è£…', 'UPSé…ç½®', 'ç”µæ± å®‰è£…', 'PDUå®‰è£…', 'ä¾›ç”µæµ‹è¯•',
            'ç²¾å¯†ç©ºè°ƒå®‰è£…', 'ç©ºè°ƒé…ç½®', 'å†·é€šé“éƒ¨ç½²', 'æ–°é£ç³»ç»Ÿå®‰è£…', 'åˆ¶å†·æµ‹è¯•',
            'æœºæŸœå®‰è£…', 'æœºæŸœå¸ƒå±€', 'æœºæŸœæ¥åœ°', 'æœºæŸœç†çº¿',
            'æ¡¥æ¶å®‰è£…', 'ç»¼åˆå¸ƒçº¿', 'ç½‘ç»œå¸ƒçº¿', 'ç”µåŠ›å¸ƒçº¿', 'å…‰çº¤ç†”æ¥', 'çº¿ç¼†æ ‡è¯†', 'å¸ƒçº¿æµ‹è¯•',
            'æ°”ä½“æ¶ˆé˜²ç³»ç»Ÿå®‰è£…', 'çƒŸæ„Ÿæ¢æµ‹å™¨å®‰è£…', 'æ¶ˆé˜²æµ‹è¯•',
            'é—¨ç¦ç³»ç»Ÿå®‰è£…', 'é—¨ç¦é…ç½®', 'è§†é¢‘ç›‘æ§å®‰è£…', 'ç›‘æ§é…ç½®', 'ç›‘æ§å­˜å‚¨é…ç½®',
            'åŠ¨ç¯ç›‘æ§ç³»ç»Ÿéƒ¨ç½²', 'æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨å®‰è£…', 'æ¼æ°´æ£€æµ‹å®‰è£…', 'ç”µé‡ç›‘æµ‹é…ç½®', 'åŠ¨ç¯å¹³å°é…ç½®', 'å‘Šè­¦é…ç½®',
            'ä¾›ç”µç³»ç»Ÿæµ‹è¯•', 'åˆ¶å†·ç³»ç»Ÿæµ‹è¯•', 'æ¶ˆé˜²ç³»ç»Ÿæµ‹è¯•', 'å®‰é˜²ç³»ç»Ÿæµ‹è¯•', 'åŠ¨ç¯ç³»ç»Ÿæµ‹è¯•', 'ç»¼åˆæµ‹è¯•', 'æ»¡è´Ÿè½½æµ‹è¯•',
            'æœºæˆ¿å·¡æ£€', 'è®¾å¤‡ç»´æŠ¤', 'UPSç»´æŠ¤', 'ç©ºè°ƒç»´æŠ¤', 'ç”µæ± ç»´æŠ¤', 'ç¯å¢ƒç›‘æµ‹',
            'æœºæˆ¿æ¬è¿', 'æœºæˆ¿æ”¹é€ ', 'æœºæˆ¿æ‰©å®¹', 'åº”æ€¥ç»´æŠ¤'
        ];
        
        // é€šç”¨é˜¶æ®µï¼ˆ40ä¸ªï¼‰
        const generalStages = [
            'é¡¹ç›®å¯åŠ¨', 'é¡¹ç›®ç«‹é¡¹', 'éœ€æ±‚ç¡®è®¤', 'éœ€æ±‚åˆ†æ', 'æ–¹æ¡ˆè®¾è®¡', 'æ–¹æ¡ˆè¯„å®¡',
            'è®¾å¤‡é€‰å‹', 'è®¾å¤‡é‡‡è´­', 'è®¾å¤‡åˆ°è´§', 'è®¾å¤‡éªŒæ”¶',
            'ç°åœºå‹˜æŸ¥', 'è®¾å¤‡å®‰è£…', 'ç³»ç»Ÿéƒ¨ç½²', 'ç³»ç»Ÿé…ç½®', 'ç³»ç»Ÿé›†æˆ',
            'å•å…ƒæµ‹è¯•', 'é›†æˆæµ‹è¯•', 'ç³»ç»Ÿæµ‹è¯•', 'ç”¨æˆ·éªŒæ”¶æµ‹è¯•', 'æ€§èƒ½æµ‹è¯•',
            'è¯•è¿è¡Œ', 'æ•°æ®è¿ç§»', 'ä¸šåŠ¡å‰²æ¥', 'æ­£å¼ä¸Šçº¿',
            'ç”¨æˆ·åŸ¹è®­', 'ç®¡ç†å‘˜åŸ¹è®­', 'æ“ä½œæ‰‹å†Œç¼–å†™', 'æŠ€æœ¯æ–‡æ¡£ç¼–å†™',
            'é¡¹ç›®éªŒæ”¶', 'éªŒæ”¶æŠ¥å‘Š', 'é¡¹ç›®äº¤æ¥',
            'è´¨ä¿æœŸç»´æŠ¤', 'è¿ç»´æ”¯æŒ', 'æ—¥å¸¸ç»´æŠ¤', 'æ•…éšœå¤„ç†', 'å·¡æ£€ç»´æŠ¤', 'åº”æ€¥å“åº”',
            'é¡¹ç›®æš‚åœ', 'é¡¹ç›®å®Œæˆ', 'å…¶ä»–'
        ];
        
        // ============================================
        // åº”æ€¥é¡¹ç›®é€šç”¨é˜¶æ®µï¼ˆ15ä¸ªï¼‰
        // ============================================
        const emergencyStages = [
            // å“åº”é˜¶æ®µ
            'åº”æ€¥å¯åŠ¨', 'åº”æ€¥å›¢é˜Ÿé›†ç»“', 'ç°åœºè¯„ä¼°', 'å½±å“èŒƒå›´ç¡®è®¤',
            
            // å¤„ç†é˜¶æ®µ
            'æ•…éšœå¿«é€Ÿå®šä½', 'åº”æ€¥æ–¹æ¡ˆåˆ¶å®š', 'ä¸´æ—¶æªæ–½å®æ–½', 'ä¸šåŠ¡å¿«é€Ÿæ¢å¤',
            
            // ä¿®å¤é˜¶æ®µ
            'æ ¹å› åˆ†æ', 'æ°¸ä¹…è§£å†³æ–¹æ¡ˆ', 'ç³»ç»Ÿä¿®å¤', 'åŠŸèƒ½éªŒè¯',
            
            // æ€»ç»“é˜¶æ®µ
            'åº”æ€¥æ€»ç»“', 'æ”¹è¿›æªæ–½', 'æ–‡æ¡£å½’æ¡£'
        ];
        
        // ============================================
        // æ‰©å®¹é¡¹ç›®é€šç”¨é˜¶æ®µï¼ˆ12ä¸ªï¼‰
        // ============================================
        const expansionStages = [
            // è¯„ä¼°é˜¶æ®µ
            'å®¹é‡ç°çŠ¶è¯„ä¼°', 'ä¸šåŠ¡å¢é•¿é¢„æµ‹', 'æ‰©å®¹éœ€æ±‚åˆ†æ',
            
            // è®¾è®¡é˜¶æ®µ
            'æ‰©å®¹æ–¹æ¡ˆè®¾è®¡', 'èµ„æºè§„åˆ’', 'é¢„ç®—è¯„ä¼°',
            
            // å®æ–½é˜¶æ®µ
            'èµ„æºé‡‡è´­', 'æ‰©å®¹å®æ–½', 'é…ç½®è°ƒæ•´',
            
            // éªŒè¯é˜¶æ®µ
            'æ€§èƒ½æµ‹è¯•', 'å‹åŠ›æµ‹è¯•', 'æ‰©å®¹éªŒæ”¶'
        ];
        
        // ============================================
        // ä¼˜åŒ–é¡¹ç›®é€šç”¨é˜¶æ®µï¼ˆ10ä¸ªï¼‰
        // ============================================
        const optimizationStages = [
            // åˆ†æé˜¶æ®µ
            'æ€§èƒ½ç°çŠ¶åˆ†æ', 'ç“¶é¢ˆè¯†åˆ«', 'ä¼˜åŒ–éœ€æ±‚ç¡®è®¤',
            
            // è®¾è®¡é˜¶æ®µ
            'ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡', 'ä¼˜åŒ–ç›®æ ‡è®¾å®š',
            
            // å®æ–½é˜¶æ®µ
            'ä¼˜åŒ–æªæ–½å®æ–½', 'å‚æ•°è°ƒä¼˜', 'é…ç½®ä¼˜åŒ–',
            
            // éªŒè¯é˜¶æ®µ
            'ä¼˜åŒ–æ•ˆæœæµ‹è¯•', 'ä¼˜åŒ–æˆæœéªŒæ”¶'
        ];

        
        // å”®åé¡¹ç›®é˜¶æ®µåˆ†ç±»
        const postsalesStageCategories = {
            general: { label: 'é€šç”¨é˜¶æ®µ', icon: 'ğŸ“¦', stages: generalStages },
            network: { label: 'ç½‘ç»œé¡¹ç›®', icon: 'ğŸŒ', stages: networkStages },
            system: { label: 'ç³»ç»Ÿé¡¹ç›®', icon: 'ğŸ–¥ï¸', stages: systemStages },
            infrastructure: { label: 'èƒ½åŸºé¡¹ç›®', icon: 'ğŸ¢', stages: infrastructureStages },
            emergency: { label: 'åº”æ€¥é¡¹ç›®', icon: 'ğŸš¨', stages: emergencyStages },
            expansion: { label: 'æ‰©å®¹é¡¹ç›®', icon: 'ğŸ“ˆ', stages: expansionStages },
            optimization: { label: 'ä¼˜åŒ–é¡¹ç›®', icon: 'âš¡', stages: optimizationStages }
        };
        
        // å½“å‰é€‰ä¸­çš„å”®åé˜¶æ®µåˆ†ç±»
        let currentStageCategory = 'general';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                initForm();
            } else {
                window.location.href = 'index.html';
            }
        });

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–è¡¨å•
        function initForm() {
            // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('work-date').value = today;
            
            // åˆå§‹åŒ–å›½å®¶åˆ—è¡¨
            if (typeof populateCountrySelect === 'function') {
                populateCountrySelect();
            }
            
            // æ£€æŸ¥URLå‚æ•°ï¼ˆä»é¡¹ç›®è¯¦æƒ…é¡µè·³è½¬è¿‡æ¥ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('projectId');
            
            if (projectId) {
                loadProjectData(projectId);
            }
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            // é¡¹ç›®ç±»å‹å˜æ›´æ—¶æ›´æ–°é˜¶æ®µ
            document.getElementById('project-type').addEventListener('change', function() {
                updateStageOptions(this.value);
                checkExistingProject();
            });
            
            // é¡¹ç›®é˜¶æ®µé€‰æ‹©å˜æ›´æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦é€‰æ‹©è‡ªå®šä¹‰
            document.getElementById('project-stage').addEventListener('change', function(e) {
                if (e.target.value === '__custom__') {
                    document.getElementById('custom-stage-section').style.display = 'block';
                    document.getElementById('custom-stage-input').focus();
                    e.target.value = '';
                } else {
                    document.getElementById('custom-stage-section').style.display = 'none';
                }
            });
        }

        // åŠ è½½é¡¹ç›®æ•°æ®ï¼ˆä»é¡¹ç›®è¯¦æƒ…é¡µè·³è½¬è¿‡æ¥ï¼‰
        async function loadProjectData(projectId) {
            try {
                const projectDoc = await db.collection('projects').doc(projectId).get();
                if (projectDoc.exists) {
                    matchedProject = { id: projectDoc.id, ...projectDoc.data() };
                    useExistingProject();
                }
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®æ•°æ®å¤±è´¥:', error);
            }
        }

        /* æ—§å‡½æ•° - å·²è¢«updateStageOptionsæ›¿ä»£
// æ›´æ–°é¡¹ç›®é˜¶æ®µ
        function updateProjectStages() {
            const projectType = document.getElementById('project-type').value;
            const stageSelect = document.getElementById('project-stage');
            
            if (!projectType) {
                stageSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®ç±»å‹</option>';
                return;
            }
*/
        
        // ============================================
        // é¡¹ç›®é˜¶æ®µç®¡ç†å‡½æ•°ï¼ˆæ–°å¢ï¼‰
        // ============================================
        
        // æ›´æ–°é¡¹ç›®é˜¶æ®µé€‰é¡¹ï¼ˆä¸»å‡½æ•°ï¼‰
        function updateStageOptions(projectType) {
            const stageSelect = document.getElementById('project-stage');
            const categorySelector = document.getElementById('stage-category-selector');
            
            if (projectType === 'å”®å‰é¡¹ç›®') {
                // å”®å‰é¡¹ç›®ï¼šéšè—åˆ†ç±»é€‰æ‹©ï¼Œæ˜¾ç¤ºå”®å‰é˜¶æ®µ
                categorySelector.style.display = 'none';
                populateStageSelect(presalesStages, projectType);
                
            } else if (projectType === 'å”®åé¡¹ç›®' || projectType === 'äº¤ä»˜å®æ–½ä¸­') {
                // å”®åé¡¹ç›®ï¼šæ˜¾ç¤ºåˆ†ç±»é€‰æ‹©ï¼Œé»˜è®¤æ˜¾ç¤ºé€šç”¨é˜¶æ®µ
                categorySelector.style.display = 'flex';
                currentStageCategory = 'general';
                selectStageCategory('general');
            } else {
                // å…¶ä»–æƒ…å†µï¼šæ¸…ç©º
                stageSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®ç±»å‹</option>';
                categorySelector.style.display = 'none';
            }
        }
        
        // é€‰æ‹©å”®åé˜¶æ®µåˆ†ç±»
        function selectStageCategory(category) {
            currentStageCategory = category;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.category-btn').forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // åŠ è½½å¯¹åº”åˆ†ç±»çš„é˜¶æ®µ
            const projectType = document.getElementById('project-type').value;
            const categoryData = postsalesStageCategories[category];
            populateStageSelect(categoryData.stages, projectType);
        }
        
        // å¡«å……é˜¶æ®µé€‰æ‹©åˆ—è¡¨
        async function populateStageSelect(stages, projectType) {
            const stageSelect = document.getElementById('project-stage');
            
            let html = '<option value="">è¯·é€‰æ‹©</option>';
            
            // æ·»åŠ æ ‡å‡†é˜¶æ®µ
            stages.forEach(stage => {
                html += `<option value="${stage}">${stage}</option>`;
            });
            
            // åŠ è½½å¹¶æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰é˜¶æ®µ
            const customStages = await loadCustomStages(projectType);
            if (customStages && customStages.length > 0) {
                html += '<option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>';
                html += '<option disabled>ğŸ“Œ æˆ‘çš„è‡ªå®šä¹‰é˜¶æ®µ</option>';
                customStages.forEach(stage => {
                    html += `<option value="${stage}">${stage}</option>`;
                });
            }
            
            // æ·»åŠ "è‡ªå®šä¹‰"é€‰é¡¹
            html += '<option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>';
            html += '<option value="__custom__">â• è‡ªå®šä¹‰...</option>';
            
            stageSelect.innerHTML = html;
        }
        
        // åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰é˜¶æ®µ
        async function loadCustomStages(projectType) {
            try {
                const doc = await db.collection('customOptions').doc(currentUser.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    const field = projectType === 'å”®å‰é¡¹ç›®' ? 'presales' : 'postsales';
                    return data.customStages?.[field] || [];
                }
                return [];
            } catch (error) {
                console.error('åŠ è½½è‡ªå®šä¹‰é˜¶æ®µå¤±è´¥:', error);
                return [];
            }
        }
        
        // ============================================
        // è‡ªå®šä¹‰é˜¶æ®µåŠŸèƒ½
        // ============================================
        
        // æ·»åŠ è‡ªå®šä¹‰é˜¶æ®µ
        async function addCustomStage() {
            const input = document.getElementById('custom-stage-input');
            const customStage = input.value.trim();
            
            if (!customStage) {
                alert('âš ï¸ è¯·è¾“å…¥é˜¶æ®µåç§°');
                return;
            }
            
            // éªŒè¯é•¿åº¦
            if (customStage.length > 30) {
                alert('âš ï¸ é˜¶æ®µåç§°ä¸èƒ½è¶…è¿‡30ä¸ªå­—ç¬¦');
                return;
            }
            
            const projectType = document.getElementById('project-type').value;
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const allStages = getAllStages(projectType);
            if (allStages.includes(customStage)) {
                alert('âš ï¸ æ­¤é˜¶æ®µå·²å­˜åœ¨ï¼');
                return;
            }
            
            try {
                // ä¿å­˜åˆ°Firestore
                await saveCustomStage(customStage, projectType);
                
                // é‡æ–°åŠ è½½é˜¶æ®µåˆ—è¡¨
                if (projectType === 'å”®å‰é¡¹ç›®') {
                    await populateStageSelect(presalesStages, projectType);
                } else {
                    selectStageCategory(currentStageCategory);
                }
                
                // é€‰ä¸­åˆšæ·»åŠ çš„é˜¶æ®µ
                setTimeout(() => {
                    document.getElementById('project-stage').value = customStage;
                }, 100);
                
                // éšè—è¾“å…¥æ¡†
                document.getElementById('custom-stage-section').style.display = 'none';
                input.value = '';
                
                alert('âœ… è‡ªå®šä¹‰é˜¶æ®µå·²æ·»åŠ å¹¶ä¿å­˜ï¼');
                
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // å–æ¶ˆè‡ªå®šä¹‰
        function cancelCustomStage() {
            document.getElementById('custom-stage-section').style.display = 'none';
            document.getElementById('custom-stage-input').value = '';
            document.getElementById('project-stage').value = '';
        }
        
        // ä¿å­˜è‡ªå®šä¹‰é˜¶æ®µåˆ°Firestore
        async function saveCustomStage(stage, projectType) {
            const field = projectType === 'å”®å‰é¡¹ç›®' ? 'presales' : 'postsales';
            
            await db.collection('customOptions').doc(currentUser.uid).set({
                [`customStages.${field}`]: firebase.firestore.FieldValue.arrayUnion(stage),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }
        
        // è·å–æ‰€æœ‰é˜¶æ®µï¼ˆç”¨äºéªŒè¯ï¼‰
        function getAllStages(projectType) {
            if (projectType === 'å”®å‰é¡¹ç›®') {
                return presalesStages;
            } else {
                return [
                    ...generalStages,
                    ...networkStages,
                    ...systemStages,
                    ...infrastructureStages,
                    ...emergencyStages,
                    ...expansionStages,
                    ...optimizationStages
                ];
            }
        }
            
            const stages = projectType === 'å”®å‰é¡¹ç›®' ? presalesStages : postsalesStages;
            stageSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>' + 
                stages.map(stage => `<option value="${stage}">${stage}</option>`).join('');
        }

        // æ£€æŸ¥å·²æœ‰é¡¹ç›®
        async function checkExistingProject() {
            const customerName = document.getElementById('customer-name').value.trim();
            const projectName = document.getElementById('project-name').value.trim();
            
            if (!customerName || !projectName) {
                return;
            }
            
            try {
                // æŸ¥è¯¢åŒ¹é…çš„é¡¹ç›®
                const projectsSnapshot = await db.collection('projects')
                    .where('customerName', '==', customerName)
                    .where('projectName', '==', projectName)
                    .limit(1)
                    .get();
                
                if (!projectsSnapshot.empty) {
                    // æ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®
                    matchedProject = {
                        id: projectsSnapshot.docs[0].id,
                        ...projectsSnapshot.docs[0].data()
                    };
                    
                    showProjectMatch();
                } else {
                    // æ²¡æ‰¾åˆ°ï¼Œéšè—æç¤º
                    hideProjectMatch();
                    matchedProject = null;
                }
            } catch (error) {
                console.error('æŸ¥è¯¢é¡¹ç›®å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºé¡¹ç›®åŒ¹é…æç¤º
        function showProjectMatch() {
            const alert = document.getElementById('project-match-alert');
            const content = document.getElementById('match-content');
            
            content.innerHTML = `
                <div class="match-item">
                    <span class="match-label">é¡¹ç›®åç§°</span>
                    <span class="match-value">${matchedProject.projectName}</span>
                </div>
                <div class="match-item">
                    <span class="match-label">å®¢æˆ·åç§°</span>
                    <span class="match-value">${matchedProject.customerName}</span>
                </div>
                <div class="match-item">
                    <span class="match-label">é¡¹ç›®ç±»å‹</span>
                    <span class="match-value">${matchedProject.projectType}</span>
                </div>
                <div class="match-item">
                    <span class="match-label">å½“å‰é˜¶æ®µ</span>
                    <span class="match-value">${matchedProject.projectStage}</span>
                </div>
                <div class="match-item">
                    <span class="match-label">é¡¹ç›®çŠ¶æ€</span>
                    <span class="match-value">${matchedProject.status}</span>
                </div>
                <div class="match-item">
                    <span class="match-label">å·²æœ‰å·¥ä½œè®°å½•</span>
                    <span class="match-value">${matchedProject.totalSessions || 0} æ¡</span>
                </div>
                <div class="match-item">
                    <span class="match-label">ç´¯è®¡å·¥æ—¶</span>
                    <span class="match-value">${(matchedProject.totalWorkHours || 0).toFixed(1)} å°æ—¶</span>
                </div>
            `;
            
            alert.classList.add('show');
        }

        // éšè—é¡¹ç›®åŒ¹é…æç¤º
        function hideProjectMatch() {
            document.getElementById('project-match-alert').classList.remove('show');
        }

        // ä½¿ç”¨ç°æœ‰é¡¹ç›®
        function useExistingProject() {
            if (!matchedProject) return;
            
            // è‡ªåŠ¨å¡«å……é¡¹ç›®ä¿¡æ¯
            document.getElementById('customer-name').value = matchedProject.customerName;
            document.getElementById('customer-industry').value = matchedProject.customerIndustry || '';
            document.getElementById('customer-country').value = matchedProject.customerCountry || '';
            document.getElementById('project-name').value = matchedProject.projectName;
            document.getElementById('project-type').value = matchedProject.projectType;
            
            // æ›´æ–°é˜¶æ®µåˆ—è¡¨
            updateStageOptions(this.value);
            document.getElementById('project-stage').value = matchedProject.projectStage;
            
            document.getElementById('sales-person').value = matchedProject.salesPerson || '';
            document.getElementById('project-amount').value = matchedProject.projectAmount || '';
            document.getElementById('project-currency').value = matchedProject.projectCurrency || 'GBP';
            
            // ç¦ç”¨é¡¹ç›®ä¿¡æ¯å­—æ®µï¼ˆå·²å…³è”åˆ°é¡¹ç›®ï¼‰
            document.getElementById('customer-name').disabled = true;
            document.getElementById('customer-industry').disabled = true;
            document.getElementById('customer-country').disabled = true;
            document.getElementById('project-name').disabled = true;
            document.getElementById('project-type').disabled = true;
            document.getElementById('project-stage').disabled = true;
            document.getElementById('sales-person').disabled = true;
            document.getElementById('project-amount').disabled = true;
            document.getElementById('project-currency').disabled = true;
            
            hideProjectMatch();
            
            alert('âœ… å·²å…³è”åˆ°ç°æœ‰é¡¹ç›®ï¼é¡¹ç›®ä¿¡æ¯å·²è‡ªåŠ¨å¡«å……ã€‚');
        }

        // åˆ›å»ºæ–°é¡¹ç›®
        function createNewProject() {
            matchedProject = null;
            
            // å¯ç”¨æ‰€æœ‰å­—æ®µ
            document.getElementById('customer-name').disabled = false;
            document.getElementById('customer-industry').disabled = false;
            document.getElementById('customer-country').disabled = false;
            document.getElementById('project-name').disabled = false;
            document.getElementById('project-type').disabled = false;
            document.getElementById('project-stage').disabled = false;
            document.getElementById('sales-person').disabled = false;
            document.getElementById('project-amount').disabled = false;
            document.getElementById('project-currency').disabled = false;
            
            hideProjectMatch();
            
            alert('âœ… å°†åˆ›å»ºæ–°é¡¹ç›®ï¼è¯·å®Œæ•´å¡«å†™é¡¹ç›®ä¿¡æ¯ã€‚');
        }

        // è®¡ç®—å·¥æ—¶
        function calculateHours() {
            const workDate = document.getElementById('work-date').value;
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const isHoliday = document.getElementById('is-holiday').checked;
            
            if (!workDate || !startTime || !endTime) {
                return;
            }
            
            // è®¡ç®—æ€»å·¥æ—¶
            const start = new Date(`${workDate} ${startTime}`);
            const end = new Date(`${workDate} ${endTime}`);
            const totalHours = (end - start) / (1000 * 60 * 60);
            
            if (totalHours <= 0) {
                alert('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´ï¼');
                return;
            }
            
            let normalHours = 0;
            let overtimeHours = 0;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å‘¨æœ«
            const dayOfWeek = start.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            
            if (isHoliday || isWeekend) {
                // èŠ‚å‡æ—¥æˆ–å‘¨æœ«ï¼Œå…¨éƒ¨ç®—åŠ ç­
                overtimeHours = totalHours;
            } else {
                // å·¥ä½œæ—¥ï¼Œè®¡ç®—æ­£å¸¸å’ŒåŠ ç­å·¥æ—¶
                const workStart = 9;  // 9:00
                const workEnd = 17.5; // 17:30
                
                const startHour = start.getHours() + start.getMinutes() / 60;
                const endHour = end.getHours() + end.getMinutes() / 60;
                
                // è®¡ç®—æ­£å¸¸å·¥æ—¶
                const normalStart = Math.max(startHour, workStart);
                const normalEnd = Math.min(endHour, workEnd);
                normalHours = Math.max(0, normalEnd - normalStart);
                
                // åŠ ç­å·¥æ—¶ = æ€»å·¥æ—¶ - æ­£å¸¸å·¥æ—¶
                overtimeHours = totalHours - normalHours;
            }
            
            // æ˜¾ç¤ºå·¥æ—¶
            document.getElementById('normal-hours').textContent = normalHours.toFixed(1);
            document.getElementById('overtime-hours').textContent = overtimeHours.toFixed(1);
            document.getElementById('total-hours').textContent = totalHours.toFixed(1);
            document.getElementById('hours-display').style.display = 'block';
        }

        // æäº¤è¡¨å•
        document.getElementById('work-record-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ä¿å­˜ä¸­...';
            
            try {
                // å¦‚æœæ²¡æœ‰åŒ¹é…çš„é¡¹ç›®ï¼Œå…ˆåˆ›å»ºé¡¹ç›®
                let projectId = matchedProject ? matchedProject.id : null;
                
                if (!projectId) {
                    const projectData = {
                        customerName: document.getElementById('customer-name').value.trim(),
                        customerIndustry: document.getElementById('customer-industry').value,
                        customerCountry: document.getElementById('customer-country').value,
                        projectName: document.getElementById('project-name').value.trim(),
                        projectType: document.getElementById('project-type').value,
                        projectStage: document.getElementById('project-stage').value,
                        status: 'è¿›è¡Œä¸­',
                        salesPerson: document.getElementById('sales-person').value.trim(),
                        projectAmount: document.getElementById('project-amount').value ? 
                            parseFloat(document.getElementById('project-amount').value) : null,
                        projectCurrency: document.getElementById('project-currency').value,
                        startDate: document.getElementById('work-date').value,
                        totalWorkHours: 0,
                        totalSessions: 0,
                        assignedEngineers: [currentUser.uid],
                        createdBy: currentUser.uid,
                        createdByName: userData?.chineseName || currentUser.displayName || currentUser.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const projectRef = await db.collection('projects').add(projectData);
                    projectId = projectRef.id;
                    console.log('åˆ›å»ºæ–°é¡¹ç›®:', projectId);
                }
                
                // åˆ›å»ºå·¥ä½œè®°å½•
                const workDate = document.getElementById('work-date').value;
                const startTime = document.getElementById('start-time').value;
                const endTime = document.getElementById('end-time').value;
                
                const recordData = {
                    // å…³è”é¡¹ç›®
                    projectId: projectId,
                    
                    // ç”¨æˆ·ä¿¡æ¯
                    userId: currentUser.uid,
                    userName: userData?.chineseName || currentUser.displayName,
                    userEmail: currentUser.email,
                    department: userData?.department || 'ICTéƒ¨é—¨',
                    technicalTeam: userData?.technicalTeam || '',
                    
                    // å®¢æˆ·å’Œé¡¹ç›®ä¿¡æ¯
                    customerName: document.getElementById('customer-name').value.trim(),
                    customerIndustry: document.getElementById('customer-industry').value,
                    customerCountry: document.getElementById('customer-country').value,
                    projectName: document.getElementById('project-name').value.trim(),
                    projectType: document.getElementById('project-type').value,
                    projectStage: document.getElementById('project-stage').value,
                    supportType: document.getElementById('support-type').value,
                    salesPerson: document.getElementById('sales-person').value.trim(),
                    projectAmount: document.getElementById('project-amount').value ? 
                        parseFloat(document.getElementById('project-amount').value) : null,
                    projectCurrency: document.getElementById('project-currency').value,
                    
                    // æ—¶é—´ä¿¡æ¯
                    startDate: workDate,
                    startTime: startTime,
                    endTime: endTime,
                    startDateTime: firebase.firestore.Timestamp.fromDate(new Date(`${workDate} ${startTime}`)),
                    endDateTime: firebase.firestore.Timestamp.fromDate(new Date(`${workDate} ${endTime}`)),
                    isHolidayWork: document.getElementById('is-holiday').checked,
                    
                    // å·¥æ—¶
                    normalWorkingHours: parseFloat(document.getElementById('normal-hours').textContent),
                    overtimeHours: parseFloat(document.getElementById('overtime-hours').textContent),
                    totalWorkingHours: parseFloat(document.getElementById('total-hours').textContent),
                    
                    // å·¥ä½œå†…å®¹
                    workDescription: document.getElementById('work-description').value.trim(),
                    nextWeekPlan: document.getElementById('next-week-plan').value.trim(),
                    
                    // å…ƒæ•°æ®
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('workRecords').add(recordData);
                
                // æ›´æ–°é¡¹ç›®ç»Ÿè®¡
                const projectRef = db.collection('projects').doc(projectId);
                await projectRef.update({
                    totalWorkHours: firebase.firestore.FieldValue.increment(recordData.totalWorkingHours),
                    totalSessions: firebase.firestore.FieldValue.increment(1),
                    assignedEngineers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('âœ… å·¥ä½œè®°å½•ä¿å­˜æˆåŠŸï¼');
                window.location.href = 'dashboard.html';
                
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'âœ… ä¿å­˜å·¥ä½œè®°å½•';
            }
        });
    </script>
</body>
</html>
