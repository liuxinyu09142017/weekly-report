<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ V11 - å¤šç”¨æˆ·äº‘ç«¯ç‰ˆ</title>
    
    <!-- Google OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>
    
    <!-- JWTè§£ç  -->
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3/build/jwt-decode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1f2937;
            --secondary: #374151;
            --accent: #2563eb;
            --border: #e5e7eb;
            --bg-light: #f9fafb;
            --text-dark: #111827;
            --text-light: #6b7280;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans CJK SC', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            padding: 16px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 14px;
        }

        .user-role {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .login-page, .main-page {
            padding: 40px;
        }

        .login-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            gap: 20px;
        }

        .login-title {
            font-size: 32px;
            margin-bottom: 20px;
            text-align: center;
        }

        #g_id_onload {
            display: flex;
            justify-content: center;
        }

        .main {
            padding: 24px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-light);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-sub {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .table-wrapper {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: var(--bg-light);
            border-bottom: 1px solid var(--border);
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-dark);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        tbody tr:hover {
            background: var(--bg-light);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-presales {
            background: #e0e7ff;
            color: #4f46e5;
        }

        .badge-aftersales {
            background: #cffafe;
            color: #0369a1;
        }

        .badge-signed {
            background: #dcfce7;
            color: #166534;
        }

        .badge-pipeline {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-admin {
            background: #fee2e2;
            color: #991b1b;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--bg-light);
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-dark);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        .error {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #991b1b;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .success {
            background: #dcfce7;
            border: 1px solid #86efac;
            color: #166534;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 16px;
            }

            .user-info {
                width: 100%;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å½•é¡µé¢ -->
        <div id="loginPage" class="login-page">
            <div class="login-center">
                <h1 class="login-title">ğŸ“Š ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ</h1>
                <p style="font-size: 16px; color: var(--text-light); text-align: center;">
                    ä½¿ç”¨Googleè´¦æˆ·ä¸€é”®ç™»å½•<br>
                    æ”¯æŒå¤šç”¨æˆ·ã€æƒé™ç®¡ç†ã€äº‘ç«¯æ•°æ®åŒæ­¥
                </p>
                <div id="g_id_onload"
                     data-client_id="1018033981926-cg6bl58ehp3kpm0rlcr7vlgeg8iore3g.apps.googleusercontent.com"
                     data-callback="handleCredentialResponse">
                </div>
                <script>
                    window.onload = function () {
                        google.accounts.id.renderButton(
                            document.getElementById('g_id_onload'),
                            { theme: 'outline', size: 'large' }
                        );
                    }
                </script>
            </div>
        </div>

        <!-- ä¸»é¡µé¢ -->
        <div id="mainPage" class="main" style="display: none;">
            <div class="header">
                <div>
                    <h1>ğŸ“Š ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ V11</h1>
                    <p style="font-size: 14px; opacity: 0.9;">å¤šç”¨æˆ·äº‘ç«¯ç‰ˆ - Firestoreæ•°æ®åº“</p>
                </div>
                <div class="user-info">
                    <img id="userAvatar" class="user-avatar" src="">
                    <div class="user-details">
                        <div id="userName" style="font-weight: 600;">ç”¨æˆ·å</div>
                        <div id="userEmail" style="font-size: 12px;">é‚®ç®±</div>
                        <span class="user-role" id="userRole">Engineer</span>
                    </div>
                    <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
                    <button class="btn btn-primary" id="adminBtn" onclick="switchTab('admin')" style="display:none;">âš™ï¸ ç®¡ç†</button>
                </div>
            </div>

            <div class="main">
                <!-- å¯¼èˆªæ ‡ç­¾ -->
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('projects')">ğŸ“‹ æˆ‘çš„é¡¹ç›®</button>
                    <button class="tab-btn" id="analyzeTabBtn" onclick="switchTab('analyze')" style="display:none;">ğŸ“Š å›¢é˜Ÿåˆ†æ</button>
                    <button class="tab-btn" id="adminTabBtn" onclick="switchTab('admin')" style="display:none;">âš™ï¸ ç®¡ç†</button>
                </div>

                <!-- é¡¹ç›®æ ‡ç­¾é¡µ -->
                <div id="projectsTab" class="tab-content active">
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="openAddProjectModal()">+ æ–°å¢é¡¹ç›®</button>
                    </div>

                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-label">å”®å‰å·²ç­¾å•</div>
                            <div class="stat-value" id="signedAmount">Â£0K</div>
                            <div class="stat-sub" id="signedCount">0ä¸ªé¡¹ç›®</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">å”®å‰Pipeline</div>
                            <div class="stat-value" id="pipelineAmount">Â£0K</div>
                            <div class="stat-sub" id="pipelineCount">0ä¸ªé¡¹ç›®</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">å”®åé¡¹ç›®é‡‘é¢</div>
                            <div class="stat-value" id="afterSalesAmount">Â£0K</div>
                            <div class="stat-sub" id="afterSalesCount">0ä¸ªé¡¹ç›®</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æ€»é¡¹ç›®é‡‘é¢</div>
                            <div class="stat-value" id="totalAmount">Â£0K</div>
                            <div class="stat-sub" id="totalCount">0ä¸ªé¡¹ç›®</div>
                        </div>
                    </div>

                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>å®¢æˆ·</th>
                                    <th>é¡¹ç›®</th>
                                    <th>è¡Œä¸š</th>
                                    <th>ç±»å‹</th>
                                    <th>ç­¾å•</th>
                                    <th>å”®åäº¤ä»˜</th>
                                    <th>è§„æ¨¡</th>
                                    <th>é”€å”®</th>
                                    <th>å·¥ç¨‹å¸ˆ</th>
                                    <th>ä¸“ä¸šæ–¹å‘</th>
                                    <th>å·¥ä½œæ—¶é•¿</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="projectsTableBody">
                                <tr><td colspan="12" style="text-align: center; padding: 40px;">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- å›¢é˜Ÿåˆ†ææ ‡ç­¾é¡µ -->
                <div id="analyzeTab" class="tab-content" style="display:none;">
                    <div class="filters">
                        <div class="filter-group">
                            <label>å·¥ç¨‹å¸ˆåå­—</label>
                            <input type="text" id="filterEngineer" placeholder="æœç´¢å·¥ç¨‹å¸ˆ">
                        </div>
                        <div class="filter-group">
                            <label>ä¸“ä¸šæ–¹å‘</label>
                            <select id="filterSpecialty">
                                <option value="">å…¨éƒ¨</option>
                                <option value="ç½‘ç»œ">ç½‘ç»œ</option>
                                <option value="ç³»ç»Ÿ">ç³»ç»Ÿ</option>
                                <option value="åŸºç¡€è®¾æ–½">åŸºç¡€è®¾æ–½</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="filterStartDate">
                        </div>
                        <div class="filter-group">
                            <label>ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="filterEndDate">
                        </div>
                        <div class="filter-group" style="align-self: flex-end;">
                            <button class="btn btn-primary" onclick="applyAnalyzeFilters()">åº”ç”¨ç­›é€‰</button>
                            <button class="btn btn-secondary" onclick="resetAnalyzeFilters()" style="margin-top: 8px;">é‡ç½®</button>
                        </div>
                    </div>

                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-label">å‚ä¸äººæ•°</div>
                            <div class="stat-value" id="participantCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æ€»é¡¹ç›®æ•°</div>
                            <div class="stat-value" id="totalProjectCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æ€»é‡‘é¢</div>
                            <div class="stat-value" id="analyzeTotal">Â£0K</div>
                        </div>
                    </div>

                    <h3 style="margin-bottom: 16px; margin-top: 24px;">æŒ‰å·¥ç¨‹å¸ˆç»Ÿè®¡</h3>
                    <div class="table-wrapper" style="margin-bottom: 24px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>å·¥ç¨‹å¸ˆåå­—</th>
                                    <th>ä¸“ä¸šæ–¹å‘</th>
                                    <th>é¡¹ç›®æ•°</th>
                                    <th>æ€»é‡‘é¢</th>
                                    <th>å·¥ä½œæ—¶é•¿</th>
                                </tr>
                            </thead>
                            <tbody id="engineerStatsBody">
                                <tr><td colspan="5" style="text-align: center; padding: 20px;">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <h3 style="margin-bottom: 16px;">æŒ‰ä¸“ä¸šæ–¹å‘ç»Ÿè®¡</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>ä¸“ä¸šæ–¹å‘</th>
                                    <th>äººæ•°</th>
                                    <th>é¡¹ç›®æ•°</th>
                                    <th>æ€»é‡‘é¢</th>
                                </tr>
                            </thead>
                            <tbody id="specialtyStatsBody">
                                <tr><td colspan="4" style="text-align: center; padding: 20px;">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ç®¡ç†æ ‡ç­¾é¡µ -->
                <div id="adminTab" class="tab-content" style="display:none;">
                    <div style="margin-bottom: 24px;">
                        <h2 style="margin-bottom: 16px;">ç®¡ç†å‘˜é¢æ¿</h2>
                        <p style="color: var(--text-light); margin-bottom: 16px;">ä»…ç®¡ç†å‘˜å¯è®¿é—®</p>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px;">å…¨éƒ¨é¡¹ç›®</h3>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ç”¨æˆ·</th>
                                        <th>å®¢æˆ·</th>
                                        <th>é¡¹ç›®</th>
                                        <th>ç±»å‹</th>
                                        <th>è§„æ¨¡</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="adminProjectsBody">
                                    <tr><td colspan="6" style="text-align: center; padding: 20px;">åŠ è½½ä¸­...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <h3 style="margin-bottom: 16px;">ç³»ç»Ÿä¿¡æ¯</h3>
                        <div style="background: var(--bg-light); padding: 16px; border-radius: 8px;">
                            <p><strong>é¡¹ç›®IDï¼š</strong> weekly-report-d55e9</p>
                            <p><strong>å½“å‰ç”¨æˆ·ï¼š</strong> <span id="adminCurrentUser">-</span></p>
                            <p><strong>æ•°æ®åº“ï¼š</strong> Firestore</p>
                            <p><strong>ç”¨æˆ·æ•°ï¼š</strong> <span id="adminUserCount">-</span></p>
                            <p><strong>é¡¹ç›®æ•°ï¼š</strong> <span id="adminProjectCount">-</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ é¡¹ç›®æ¨¡æ€æ¡† -->
    <div id="addProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ æ–°é¡¹ç›®</div>
            <form onsubmit="saveProject(event)">
                <div class="form-group">
                    <label>å‘¨èµ·å§‹æ—¥æœŸ *</label>
                    <input type="date" id="weekStartDate" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>å®¢æˆ·åç§° *</label>
                        <input type="text" id="clientName" required>
                    </div>
                    <div class="form-group">
                        <label>é¡¹ç›®åç§° *</label>
                        <input type="text" id="projectName" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>è¡Œä¸š *</label>
                        <input type="text" id="industry" required>
                    </div>
                    <div class="form-group">
                        <label>å›½å®¶</label>
                        <input type="text" id="country">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é¡¹ç›®è§„æ¨¡ (KÂ£) *</label>
                        <input type="number" id="projectScale" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label>ä¸“ä¸šæ–¹å‘ *</label>
                        <select id="specialty" required>
                            <option value="">-- è¯·é€‰æ‹© --</option>
                            <option value="ç½‘ç»œ">ç½‘ç»œ</option>
                            <option value="ç³»ç»Ÿ">ç³»ç»Ÿ</option>
                            <option value="åŸºç¡€è®¾æ–½">åŸºç¡€è®¾æ–½</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é¡¹ç›®ç±»å‹ *</label>
                        <select id="projectType" onchange="updateProjectTypeFields()" required>
                            <option value="">-- è¯·é€‰æ‹© --</option>
                            <option value="presales">å”®å‰</option>
                            <option value="aftersales">å”®å</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é”€å”®äººå‘˜ *</label>
                        <input type="text" id="salesperson" required>
                    </div>
                </div>

                <div id="presalesFields" style="display:none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç­¾å•çŠ¶æ€</label>
                            <select id="signedStatus" onchange="updateProjectTypeFields()">
                                <option value="pipeline">Pipeline</option>
                                <option value="signed">å·²ç­¾å•</option>
                            </select>
                        </div>
                        <div class="form-group" id="aftersalesDeliveryField" style="display:none;">
                            <label>æ˜¯å¦å‚ä¸å”®åäº¤ä»˜</label>
                            <select id="participateAftersales">
                                <option value="no">å¦</option>
                                <option value="yes">æ˜¯</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>è¿›åº¦é˜¶æ®µ</label>
                    <input type="text" id="projectStage" placeholder="å¦‚ï¼šæŠ€æœ¯æ–¹æ¡ˆã€ç°åœºä¿éšœ">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>å·¥ä½œæ—¶é•¿ (h)</label>
                        <input type="number" id="workHours" step="0.5" value="0">
                    </div>
                    <div class="form-group">
                        <label>åŠ ç­æ—¶é•¿ (h)</label>
                        <input type="number" id="overtimeHours" step="0.5" value="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ä¸»å·¥ç¨‹å¸ˆ</label>
                        <input type="text" id="engineerName">
                    </div>
                    <div class="form-group">
                        <label>åˆä½œå·¥ç¨‹å¸ˆ</label>
                        <input type="text" id="collaboratorNames" placeholder="å¤šä¸ªå·¥ç¨‹å¸ˆç”¨é€—å·åˆ†éš”">
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddProjectModal()" style="flex:1;">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" style="flex:1;">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBzcAr_OJFdIMnaYXRCE7TJs2qLK_TAy9U",
            authDomain: "weekly-report-d55e9.firebaseapp.com",
            projectId: "weekly-report-d55e9",
            storageBucket: "weekly-report-d55e9.firebasestorage.app",
            messagingSenderId: "315332641675",
            appId: "1:315332641675:web:1f8ab523df0b86a47c258e"
        };

        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // å½“å‰ç”¨æˆ·ä¿¡æ¯
        let currentUser = null;
        let currentUserRole = 'engineer';
        let filteredProjects = [];
        let allProjects = [];

        // åˆå§‹åŒ–Googleç™»å½•
        google.accounts.id.initialize({
            client_id: '1018033981926-cg6bl58ehp3kpm0rlcr7vlgeg8iore3g.apps.googleusercontent.com',
            callback: handleCredentialResponse
        });

        // å¤„ç†Googleç™»å½•å›è°ƒ
        async function handleCredentialResponse(response) {
            try {
                const token = response.credential;
                const decoded = jwt_decode(token);
                
                currentUser = {
                    email: decoded.email,
                    name: decoded.name,
                    picture: decoded.picture,
                    uid: decoded.email
                };

                // å­˜å‚¨åˆ°localStorageä½œä¸ºå¤‡ä»½
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                // ä»Firestoreè·å–ç”¨æˆ·è§’è‰²
                await getUserRole();

                // æ˜¾ç¤ºä¸»ç•Œé¢
                showMainInterface();

                // åŠ è½½é¡¹ç›®
                await loadProjects();

            } catch(error) {
                console.error('ç™»å½•å¤±è´¥ï¼š', error);
                alert('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // è·å–ç”¨æˆ·è§’è‰²
        async function getUserRole() {
            try {
                const configDoc = await db.collection('config').doc('settings').get();
                
                if (configDoc.exists) {
                    const settings = configDoc.data();
                    if (settings.adminEmails && settings.adminEmails.includes(currentUser.email)) {
                        currentUserRole = 'admin';
                    }
                } else {
                    // å¦‚æœé…ç½®ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                    await db.collection('config').doc('settings').set({
                        adminEmails: ['liuxinyu0914@gmail.com'],
                        teamLeadEmails: [],
                        specialties: ['ç½‘ç»œ', 'ç³»ç»Ÿ', 'åŸºç¡€è®¾æ–½']
                    });
                    
                    if (currentUser.email === 'liuxinyu0914@gmail.com') {
                        currentUserRole = 'admin';
                    }
                }

                updateUIBasedOnRole();
            } catch(error) {
                console.error('è·å–è§’è‰²å¤±è´¥ï¼š', error);
            }
        }

        // æ›´æ–°UIåŸºäºè§’è‰²
        function updateUIBasedOnRole() {
            document.getElementById('userRole').textContent = 
                currentUserRole === 'admin' ? 'ç®¡ç†å‘˜' : 
                currentUserRole === 'team_lead' ? 'å°ç»„é•¿' : 'å·¥ç¨‹å¸ˆ';

            document.getElementById('adminBtn').style.display = 
                currentUserRole === 'admin' ? 'block' : 'none';
            document.getElementById('adminTabBtn').style.display = 
                currentUserRole === 'admin' ? 'block' : 'none';
            document.getElementById('analyzeTabBtn').style.display = 
                (currentUserRole === 'admin' || currentUserRole === 'team_lead') ? 'block' : 'none';
        }

        // æ˜¾ç¤ºä¸»ç•Œé¢
        function showMainInterface() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainPage').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').src = currentUser.picture;
            document.getElementById('adminCurrentUser').textContent = currentUser.name;
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            const tabContent = document.getElementById(tabName + 'Tab');
            if (tabContent) {
                tabContent.classList.add('active');
            }

            // æ ‡è®°æŒ‰é’®ä¸ºactive
            event.target?.classList.add('active');

            // åŠ è½½åˆ†ææ•°æ®
            if (tabName === 'analyze') {
                loadAnalyzeData();
            } else if (tabName === 'admin') {
                loadAdminData();
            }
        }

        // æ‰“å¼€æ·»åŠ é¡¹ç›®æ¨¡æ€æ¡†
        function openAddProjectModal() {
            document.getElementById('addProjectModal').classList.add('active');
            // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸ
            document.getElementById('weekStartDate').valueAsDate = new Date();
        }

        // å…³é—­æ·»åŠ é¡¹ç›®æ¨¡æ€æ¡†
        function closeAddProjectModal() {
            document.getElementById('addProjectModal').classList.remove('active');
        }

        // æ›´æ–°é¡¹ç›®ç±»å‹å­—æ®µ
        function updateProjectTypeFields() {
            const type = document.getElementById('projectType').value;
            const presalesFields = document.getElementById('presalesFields');
            const aftersalesDeliveryField = document.getElementById('aftersalesDeliveryField');
            const signedStatus = document.getElementById('signedStatus').value;

            if (type === 'presales') {
                presalesFields.style.display = 'block';
                if (signedStatus === 'signed') {
                    aftersalesDeliveryField.style.display = 'block';
                } else {
                    aftersalesDeliveryField.style.display = 'none';
                }
            } else {
                presalesFields.style.display = 'none';
            }
        }

        // ä¿å­˜é¡¹ç›®
        async function saveProject(event) {
            event.preventDefault();

            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            try {
                const projectData = {
                    weekStartDate: document.getElementById('weekStartDate').value,
                    clientName: document.getElementById('clientName').value,
                    projectName: document.getElementById('projectName').value,
                    industry: document.getElementById('industry').value,
                    country: document.getElementById('country').value,
                    projectScale: parseFloat(document.getElementById('projectScale').value),
                    projectType: document.getElementById('projectType').value,
                    signedStatus: document.getElementById('projectType').value === 'presales' 
                        ? document.getElementById('signedStatus').value : '',
                    participateAftersales: document.getElementById('projectType').value === 'presales' && 
                        document.getElementById('signedStatus').value === 'signed'
                        ? document.getElementById('participateAftersales').value : '',
                    projectStage: document.getElementById('projectStage').value,
                    salesperson: document.getElementById('salesperson').value,
                    workHours: parseFloat(document.getElementById('workHours').value) || 0,
                    overtimeHours: parseFloat(document.getElementById('overtimeHours').value) || 0,
                    engineerName: document.getElementById('engineerName').value || currentUser.name,
                    collaboratorNames: document.getElementById('collaboratorNames').value,
                    specialty: document.getElementById('specialty').value,
                    userId: currentUser.email,
                    userName: currentUser.name,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                // ä¿å­˜åˆ°Firestore
                await db.collection('projects').add(projectData);

                alert('é¡¹ç›®å·²ä¿å­˜ï¼');
                closeAddProjectModal();

                // é‡ç½®è¡¨å•
                document.querySelector('form').reset();

                // é‡æ–°åŠ è½½é¡¹ç›®
                await loadProjects();

            } catch(error) {
                console.error('ä¿å­˜å¤±è´¥ï¼š', error);
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }

        // åŠ è½½é¡¹ç›®
        async function loadProjects() {
            try {
                let query = db.collection('projects');

                // æ ¹æ®è§’è‰²è¿‡æ»¤
                if (currentUserRole === 'engineer') {
                    query = query.where('userId', '==', currentUser.email);
                }

                const snapshot = await query.get();
                allProjects = [];

                snapshot.forEach(doc => {
                    allProjects.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                filteredProjects = [...allProjects];
                renderProjects();
                updateStats();

            } catch(error) {
                console.error('åŠ è½½é¡¹ç›®å¤±è´¥ï¼š', error);
                document.getElementById('projectsTableBody').innerHTML = 
                    '<tr><td colspan="12" style="text-align: center; color: var(--danger);">åŠ è½½å¤±è´¥ï¼š' + error.message + '</td></tr>';
            }
        }

        // æ¸²æŸ“é¡¹ç›®è¡¨æ ¼
        function renderProjects() {
            const tbody = document.getElementById('projectsTableBody');

            if (filteredProjects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 40px;">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = filteredProjects.map((item, index) => {
                const typeBadge = item.projectType === 'presales' 
                    ? '<span class="badge badge-presales">å”®å‰</span>'
                    : '<span class="badge badge-aftersales">å”®å</span>';

                const signedBadge = item.projectType === 'presales'
                    ? (item.signedStatus === 'signed' 
                        ? '<span class="badge badge-signed">å·²ç­¾å•</span>'
                        : '<span class="badge badge-pipeline">Pipeline</span>')
                    : '-';

                const afterSalesBadge = item.projectType === 'presales' && item.signedStatus === 'signed'
                    ? (item.participateAftersales === 'yes'
                        ? '<span class="badge badge-signed">æ˜¯</span>'
                        : '<span class="badge badge-pipeline">å¦</span>')
                    : '-';

                const canEdit = currentUserRole === 'admin' || item.userId === currentUser.email;
                const canDelete = currentUserRole === 'admin' || item.userId === currentUser.email;

                return `
                    <tr>
                        <td>${item.clientName}</td>
                        <td>${item.projectName}</td>
                        <td>${item.industry}</td>
                        <td>${typeBadge}</td>
                        <td>${signedBadge}</td>
                        <td>${afterSalesBadge}</td>
                        <td>Â£${item.projectScale}</td>
                        <td>${item.salesperson}</td>
                        <td>${item.engineerName || '-'}</td>
                        <td>${item.specialty || '-'}</td>
                        <td>${item.workHours}h</td>
                        <td>
                            ${canEdit ? `<button class="btn btn-small btn-primary" onclick="editProject('${item.id}')">ç¼–è¾‘</button>` : ''}
                            ${canDelete ? `<button class="btn btn-small btn-danger" onclick="deleteProject('${item.id}')">åˆ é™¤</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // åˆ é™¤é¡¹ç›®
        async function deleteProject(projectId) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ')) return;

            try {
                await db.collection('projects').doc(projectId).delete();
                await loadProjects();
            } catch(error) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            const presalesSignedData = filteredProjects.filter(item => 
                item.projectType === 'presales' && item.signedStatus === 'signed');
            const presalesSignedAmount = presalesSignedData.reduce((sum, item) => sum + item.projectScale, 0);

            const presalesPipelineData = filteredProjects.filter(item => 
                item.projectType === 'presales' && item.signedStatus === 'pipeline');
            const presalesPipelineAmount = presalesPipelineData.reduce((sum, item) => sum + item.projectScale, 0);

            const directAftersalesData = filteredProjects.filter(item => item.projectType === 'aftersales');
            const participatingAftersalesData = filteredProjects.filter(item => 
                item.projectType === 'presales' && item.signedStatus === 'signed' && item.participateAftersales === 'yes');
            const afterSalesAmount = directAftersalesData.reduce((sum, item) => sum + item.projectScale, 0) + 
                                     participatingAftersalesData.reduce((sum, item) => sum + item.projectScale, 0);

            const totalAmount = presalesSignedAmount + presalesPipelineAmount + afterSalesAmount;

            document.getElementById('signedAmount').textContent = 'Â£' + presalesSignedAmount.toFixed(1) + 'K';
            document.getElementById('signedCount').textContent = 'å…±' + presalesSignedData.length + 'ä¸ªé¡¹ç›®';

            document.getElementById('pipelineAmount').textContent = 'Â£' + presalesPipelineAmount.toFixed(1) + 'K';
            document.getElementById('pipelineCount').textContent = 'å…±' + presalesPipelineData.length + 'ä¸ªé¡¹ç›®';

            document.getElementById('afterSalesAmount').textContent = 'Â£' + afterSalesAmount.toFixed(1) + 'K';
            document.getElementById('afterSalesCount').textContent = 'å…±' + (directAftersalesData.length + participatingAftersalesData.length) + 'ä¸ªé¡¹ç›®';

            document.getElementById('totalAmount').textContent = 'Â£' + totalAmount.toFixed(1) + 'K';
            document.getElementById('totalCount').textContent = 'å…±' + filteredProjects.length + 'ä¸ªé¡¹ç›®';
        }

        // åŠ è½½åˆ†ææ•°æ®
        async function loadAnalyzeData() {
            try {
                let query = db.collection('projects');

                // å¦‚æœæ˜¯å·¥ç¨‹å¸ˆï¼Œåªçœ‹è‡ªå·±çš„
                if (currentUserRole === 'engineer') {
                    query = query.where('userId', '==', currentUser.email);
                }

                const snapshot = await query.get();
                let projects = [];

                snapshot.forEach(doc => {
                    projects.push(doc.data());
                });

                // æŒ‰å·¥ç¨‹å¸ˆç»Ÿè®¡
                const engineerStats = {};
                projects.forEach(project => {
                    const name = project.engineerName || project.userName;
                    if (!engineerStats[name]) {
                        engineerStats[name] = {
                            name: name,
                            specialty: project.specialty,
                            count: 0,
                            amount: 0,
                            workHours: 0
                        };
                    }
                    engineerStats[name].count++;
                    engineerStats[name].amount += project.projectScale;
                    engineerStats[name].workHours += project.workHours || 0;
                });

                // æ¸²æŸ“æŒ‰å·¥ç¨‹å¸ˆç»Ÿè®¡
                const engineerStatsBody = document.getElementById('engineerStatsBody');
                engineerStatsBody.innerHTML = Object.values(engineerStats)
                    .sort((a, b) => b.amount - a.amount)
                    .map(stat => `
                        <tr>
                            <td>${stat.name}</td>
                            <td>${stat.specialty || '-'}</td>
                            <td>${stat.count}</td>
                            <td>Â£${stat.amount.toFixed(1)}K</td>
                            <td>${stat.workHours.toFixed(1)}h</td>
                        </tr>
                    `).join('');

                // æŒ‰ä¸“ä¸šæ–¹å‘ç»Ÿè®¡
                const specialtyStats = {};
                projects.forEach(project => {
                    const specialty = project.specialty || 'æœªåˆ†ç±»';
                    if (!specialtyStats[specialty]) {
                        specialtyStats[specialty] = {
                            specialty: specialty,
                            people: new Set(),
                            count: 0,
                            amount: 0
                        };
                    }
                    specialtyStats[specialty].people.add(project.engineerName || project.userName);
                    specialtyStats[specialty].count++;
                    specialtyStats[specialty].amount += project.projectScale;
                });

                // æ¸²æŸ“æŒ‰ä¸“ä¸šæ–¹å‘ç»Ÿè®¡
                const specialtyStatsBody = document.getElementById('specialtyStatsBody');
                specialtyStatsBody.innerHTML = Object.values(specialtyStats)
                    .sort((a, b) => b.amount - a.amount)
                    .map(stat => `
                        <tr>
                            <td>${stat.specialty}</td>
                            <td>${stat.people.size}</td>
                            <td>${stat.count}</td>
                            <td>Â£${stat.amount.toFixed(1)}K</td>
                        </tr>
                    `).join('');

                // æ›´æ–°æ±‡æ€»ç»Ÿè®¡
                const totalAmount = projects.reduce((sum, p) => sum + p.projectScale, 0);
                const uniqueEngineers = new Set(projects.map(p => p.engineerName || p.userName));

                document.getElementById('participantCount').textContent = uniqueEngineers.size;
                document.getElementById('totalProjectCount').textContent = projects.length;
                document.getElementById('analyzeTotal').textContent = 'Â£' + totalAmount.toFixed(1) + 'K';

            } catch(error) {
                console.error('åŠ è½½åˆ†ææ•°æ®å¤±è´¥ï¼š', error);
            }
        }

        // åº”ç”¨åˆ†æç­›é€‰
        function applyAnalyzeFilters() {
            loadAnalyzeData();
        }

        // é‡ç½®åˆ†æç­›é€‰
        function resetAnalyzeFilters() {
            document.getElementById('filterEngineer').value = '';
            document.getElementById('filterSpecialty').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            loadAnalyzeData();
        }

        // åŠ è½½ç®¡ç†æ•°æ®
        async function loadAdminData() {
            try {
                const snapshot = await db.collection('projects').get();
                let projects = [];

                snapshot.forEach(doc => {
                    projects.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // æ¸²æŸ“æ‰€æœ‰é¡¹ç›®
                const tbody = document.getElementById('adminProjectsBody');
                tbody.innerHTML = projects.map(project => `
                    <tr>
                        <td>${project.userName || project.userId}</td>
                        <td>${project.clientName}</td>
                        <td>${project.projectName}</td>
                        <td>${project.projectType === 'presales' ? 'å”®å‰' : 'å”®å'}</td>
                        <td>Â£${project.projectScale}</td>
                        <td>
                            <button class="btn btn-small btn-danger" onclick="deleteProject('${project.id}')">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');

                // æ›´æ–°ç³»ç»Ÿä¿¡æ¯
                const users = new Set();
                projects.forEach(p => {
                    users.add(p.userId);
                });

                document.getElementById('adminUserCount').textContent = users.size;
                document.getElementById('adminProjectCount').textContent = projects.length;

            } catch(error) {
                console.error('åŠ è½½ç®¡ç†æ•°æ®å¤±è´¥ï¼š', error);
            }
        }

        // ç™»å‡º
        function logout() {
            google.accounts.id.disableAutoSelect();
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('mainPage').style.display = 'none';
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        window.addEventListener('load', function() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    getUserRole().then(() => {
                        showMainInterface();
                        loadProjects();
                    });
                } catch(e) {
                    console.log('æ— æ³•æ¢å¤ç™»å½•çŠ¶æ€');
                }
            }
        });
    </script>
</body>
</html>
