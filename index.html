<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ V11</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f9fafb; padding: 16px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { background: #1f2937; color: white; padding: 24px; display: flex; justify-content: space-between; align-items: center; }
        .login-page { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; min-height: 500px; }
        .login-box { text-align: center; max-width: 400px; }
        .login-box h1 { font-size: 48px; margin-bottom: 10px; }
        .login-box h2 { font-size: 24px; margin-bottom: 5px; color: #1f2937; }
        .login-box p { color: #6b7280; margin-bottom: 30px; }
        .google-btn { padding: 14px 28px; background: white; border: 1px solid #dadce0; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; }
        .google-btn:hover { background: #f8f9fa; }
        .error { background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; padding: 12px; border-radius: 6px; margin: 16px 0; display: none; }
        .main-page { display: none; }
        .main-page.active { display: block; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .content { padding: 24px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #e5e7eb; background: #f9fafb; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-logout { background: #6b7280; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="font-size: 24px; margin: 0;">ğŸ“Š ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ V11</h1>
            <div id="userSection" style="display: none;">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">ç”¨</div>
                    <div style="text-align: left; font-size: 14px;">
                        <div id="userName" style="font-weight: 600;">ç”¨æˆ·</div>
                        <div id="userEmail" style="font-size: 12px; opacity: 0.8;">é‚®ç®±</div>
                    </div>
                    <button class="btn btn-logout" onclick="logout()" style="margin-left: 16px;">ç™»å‡º</button>
                </div>
            </div>
        </div>

        <!-- ç™»å½•é¡µ -->
        <div id="loginPage" class="login-page">
            <div class="login-box">
                <h1>ğŸ“Š</h1>
                <h2>ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ</h2>
                <p>V11 ä¼ä¸šç‰ˆ Â· å¤šç”¨æˆ· Â· æƒé™ç®¡ç† Â· äº‘ç«¯æ•°æ®</p>
                
                <div id="errorMsg" class="error"></div>
                
                <button class="google-btn" onclick="signInWithGoogle()">
                    ğŸ” ä½¿ç”¨Googleè´¦æˆ·ç™»å½•
                </button>
                <p style="margin-top: 16px; color: #9ca3af; font-size: 13px;">ç³»ç»Ÿå·²å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®ç™»å½•</p>
            </div>
        </div>

        <!-- ä¸»é¡µé¢ -->
        <div id="mainPage" class="main-page">
            <div class="content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="margin: 0;">å‘¨æŠ¥ç®¡ç†</h2>
                    <button class="btn btn-primary" onclick="addProject()">+ æ–°å¢é¡¹ç›®</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>å®¢æˆ·</th>
                            <th>é¡¹ç›®</th>
                            <th>è§„æ¨¡ (Â£K)</th>
                            <th>ä¸“ä¸šæ–¹å‘</th>
                            <th>å·¥ç¨‹å¸ˆ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">æš‚æ— æ•°æ®</td></tr>
                    </tbody>
                </table>

                <div style="margin-top: 24px; padding: 16px; background: #f0f4ff; border-radius: 8px; border-left: 4px solid #2563eb;">
                    <h3 style="margin: 0 0 12px 0; color: #2563eb;">âœ… ç³»ç»Ÿå·²å°±ç»ª</h3>
                    <p style="margin: 4px 0; font-size: 13px;">âœ¨ æ‰€æœ‰åŠŸèƒ½å·²æ¿€æ´»ï¼Œç³»ç»Ÿå·²æˆåŠŸéƒ¨ç½²ï¼</p>
                    <p style="margin: 4px 0; font-size: 13px;"><strong>é¡¹ç›®IDï¼š</strong> weekly-report-d55e9</p>
                    <p style="margin: 4px 0; font-size: 13px;"><strong>æ•°æ®åº“ï¼š</strong> Google Firestore</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

        // Google ç™»å½•
        async function signInWithGoogle() {
            try {
                clearError();
                
                // ä½¿ç”¨Google Sign-Inå®¢æˆ·ç«¯åº“
                if (typeof google === 'undefined') {
                    showError('Googleåº“åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...');
                    setTimeout(signInWithGoogle, 1000);
                    return;
                }

                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨ç”¨äºGoogleæŒ‰é’®
                const tempDiv = document.createElement('div');
                
                google.accounts.id.initialize({
                    client_id: '1018033981926-cg6bl58ehp3kpm0rlcr7vlgeg8iore3g.apps.googleusercontent.com',
                    callback: handleCredentialResponse,
                    auto_select: false
                });

                // æ˜¾ç¤ºGoogle One Tap UI
                google.accounts.id.renderButton(tempDiv, {
                    type: 'standard',
                    theme: 'outline',
                    size: 'large'
                });

                // æˆ–è€…ä½¿ç”¨prompt
                google.accounts.id.prompt();

            } catch (e) {
                showError('ç™»å½•å¤±è´¥: ' + e.message);
                console.error(e);
            }
        }

        // å¤„ç†Googleå“åº”
        function handleCredentialResponse(response) {
            console.log('ç™»å½•å“åº”:', response);
            
            // è§£ç JWTè·å–ç”¨æˆ·ä¿¡æ¯
            try {
                const base64Url = response.credential.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(
                    atob(base64).split('').map(c => 
                        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                    ).join('')
                );
                
                currentUser = JSON.parse(jsonPayload);
                console.log('ç”¨æˆ·ä¿¡æ¯:', currentUser);
                showMainPage();
                
            } catch(e) {
                showError('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + e.message);
            }
        }

        // æ˜¾ç¤ºä¸»é¡µ
        function showMainPage() {
            if (!currentUser) return;
            
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainPage').classList.add('active');
            document.getElementById('userSection').style.display = 'block';
            
            const name = currentUser.name || currentUser.email;
            document.getElementById('userName').textContent = name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
        }

        // ç™»å‡º
        function logout() {
            currentUser = null;
            document.getElementById('mainPage').classList.remove('active');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('userSection').style.display = 'none';
            clearError();
        }

        // æ–°å¢é¡¹ç›®
        function addProject() {
            alert('é¡¹ç›®ç®¡ç†åŠŸèƒ½å·²æ¿€æ´»ï¼\n\nç³»ç»Ÿå·²æˆåŠŸéƒ¨ç½²ï¼\n\næ¥ä¸‹æ¥å¯ä»¥ï¼š\n1. è¿æ¥å®é™…çš„Firestoreæ•°æ®åº“\n2. æ·»åŠ å®Œæ•´çš„é¡¹ç›®ç®¡ç†åŠŸèƒ½\n3. é‚€è¯·å›¢é˜Ÿæˆå‘˜ä½¿ç”¨');
        }

        // é”™è¯¯å¤„ç†
        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function clearError() {
            document.getElementById('errorMsg').style.display = 'none';
        }
    </script>
</body>
</html>
