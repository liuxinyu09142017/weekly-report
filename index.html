<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¨æŠ¥ç³»ç»Ÿ - ç™»å½•</title>
    
    <!-- Firebase 9.x compatç‰ˆæœ¬ -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- FirebaseUI -->
    <script src="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 450px;
            width: 90%;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .logo p {
            color: #666;
            font-size: 14px;
        }
        
        #firebaseui-auth-container {
            margin-top: 20px;
        }
        
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 14px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .debug-info {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .debug-info h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
        }
        
        .debug-log {
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">
            <h1>ğŸ“Š å‘¨æŠ¥ç³»ç»Ÿ</h1>
            <p>ä½¿ç”¨Googleè´¦å·ç™»å½•</p>
        </div>
        
        <div id="error-message" class="error-message"></div>
        
        <div id="loader" class="loading">
            <div class="spinner"></div>
            <div>æ­£åœ¨åŠ è½½è®¤è¯ç³»ç»Ÿ...</div>
        </div>
        
        <div id="firebaseui-auth-container"></div>
        
        <!-- Debugä¿¡æ¯ -->
        <div id="debug-info" class="debug-info">
            <h3>ğŸ” è°ƒè¯•ä¿¡æ¯</h3>
            <div id="debug-log" class="debug-log"></div>
        </div>
        
        <div class="footer">
            <small>Weekly Report System v1.0</small>
        </div>
    </div>

    <script>
        // ==================== è°ƒè¯•æ—¥å¿— ====================
        const debugLog = [];
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLog.push(logMessage);
            console.log(logMessage);
            
            const debugPanel = document.getElementById('debug-log');
            if (debugPanel) {
                debugPanel.textContent = debugLog.join('\n');
            }
        }

        // ==================== Firebase é…ç½® ====================
        // ä½¿ç”¨æ–°åˆ›å»ºçš„APIå¯†é’¥ï¼ˆ2025-01-21æ›´æ–°ï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyBzcAr_OJFdIMnaYXRCE7TJs2qlK_TAy9U",
            authDomain: "weekly-report-d55e9.firebaseapp.com",
            projectId: "weekly-report-d55e9",
            storageBucket: "weekly-report-d55e9.appspot.com",
            messagingSenderId: "315332641675",
            appId: "1:315332641675:web:e1b52c3d4c5fcc7b8c0de7"
        };

        log('Firebaseé…ç½®å·²åŠ è½½');
        log(`Project ID: ${firebaseConfig.projectId}`);

        // ==================== å…¨å±€å˜é‡ ====================
        let app, auth, ui;
        
        // ==================== å·¥å…·å‡½æ•° ====================
        function showElement(id) {
            const element = document.getElementById(id);
            if (element) element.style.display = 'block';
        }
        
        function hideElement(id) {
            const element = document.getElementById(id);
            if (element) element.style.display = 'none';
        }

        function showError(message) {
            log(message, 'error');
            const errorDiv = document.getElementById('error-message');
            errorDiv.innerHTML = `
                <strong>âŒ é”™è¯¯ï¼š</strong><br>
                ${message}
                <br><br>
                <small>è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯</small>
            `;
            showElement('error-message');
            hideElement('loader');
            showElement('debug-info');
        }

        function showSuccess(message) {
            log(message, 'success');
            const errorDiv = document.getElementById('error-message');
            errorDiv.style.background = '#e7f5e7';
            errorDiv.style.border = '1px solid #a3d9a3';
            errorDiv.style.color = '#2d662d';
            errorDiv.innerHTML = `
                <strong>âœ… æˆåŠŸï¼š</strong><br>
                ${message}
            `;
            showElement('error-message');
            hideElement('loader');
        }

        // ==================== åˆå§‹åŒ– Firebase ====================
        function initializeFirebase() {
            try {
                log('å¼€å§‹åˆå§‹åŒ–Firebase...');
                
                // æ£€æŸ¥Firebase SDK
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDKæœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
                log('âœ… Firebase SDKå·²åŠ è½½');
                
                // åˆå§‹åŒ–Firebase App
                if (!firebase.apps.length) {
                    app = firebase.initializeApp(firebaseConfig);
                    log('âœ… Firebaseåº”ç”¨åˆå§‹åŒ–æˆåŠŸ');
                } else {
                    app = firebase.app();
                    log('âœ… ä½¿ç”¨ç°æœ‰Firebaseåº”ç”¨å®ä¾‹');
                }
                
                // åˆå§‹åŒ–Auth
                auth = firebase.auth();
                log('âœ… Firebase Authåˆå§‹åŒ–æˆåŠŸ');
                
                // è®¾ç½®Authè¯­è¨€
                auth.languageCode = 'zh-CN';
                log('âœ… Authè¯­è¨€è®¾ç½®ä¸ºä¸­æ–‡');
                
                // æ£€æŸ¥FirebaseUI
                if (typeof firebaseui === 'undefined') {
                    throw new Error('FirebaseUIæœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
                log('âœ… FirebaseUIåº“å·²åŠ è½½');
                
                // åˆå§‹åŒ–FirebaseUI
                ui = new firebaseui.auth.AuthUI(auth);
                log('âœ… FirebaseUIåˆå§‹åŒ–æˆåŠŸ');
                
                return true;
            } catch (error) {
                log(`Firebaseåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
                showError(`ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        // ==================== FirebaseUI é…ç½® ====================
        const uiConfig = {
            callbacks: {
                signInSuccessWithAuthResult: function(authResult, redirectUrl) {
                    const user = authResult.user;
                    log(`âœ… ç™»å½•æˆåŠŸ: ${user.email}`);
                    log(`ç”¨æˆ·ID: ${user.uid}`);
                    log(`æ˜¾ç¤ºåç§°: ${user.displayName || 'æœªè®¾ç½®'}`);
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showSuccess(`æ¬¢è¿ ${user.displayName || user.email}ï¼<br>æ­£åœ¨è·³è½¬...`);
                    
                    // è·³è½¬åˆ°ä¸»é¡µ
                    setTimeout(() => {
                        log('è·³è½¬åˆ°dashboard.html...');
                        window.location.href = 'dashboard.html';
                    }, 1500);
                    
                    return false;
                },
                signInFailure: function(error) {
                    log(`ç™»å½•å¤±è´¥: ${error.code} - ${error.message}`, 'error');
                    
                    // å‹å¥½çš„é”™è¯¯æç¤º
                    let friendlyMessage = 'ç™»å½•å¤±è´¥';
                    switch(error.code) {
                        case 'auth/popup-closed-by-user':
                            friendlyMessage = 'æ‚¨å–æ¶ˆäº†ç™»å½•æ“ä½œ';
                            break;
                        case 'auth/popup-blocked':
                            friendlyMessage = 'æµè§ˆå™¨é˜»æ­¢äº†å¼¹çª—ï¼Œè¯·å…è®¸å¼¹çª—åé‡è¯•';
                            break;
                        case 'auth/network-request-failed':
                            friendlyMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•';
                            break;
                        case 'auth/internal-error':
                            friendlyMessage = 'å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                            break;
                        case 'auth/unauthorized-domain':
                            friendlyMessage = 'å½“å‰åŸŸåæœªæˆæƒï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                            break;
                        default:
                            friendlyMessage = `ç™»å½•å¤±è´¥: ${error.message}`;
                    }
                    
                    showError(friendlyMessage);
                    return Promise.resolve();
                },
                uiShown: function() {
                    log('âœ… ç™»å½•ç•Œé¢å·²æ˜¾ç¤º');
                    hideElement('loader');
                }
            },
            signInOptions: [
                {
                    provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                    customParameters: {
                        prompt: 'select_account'
                    }
                }
            ],
            signInFlow: 'popup',
            tosUrl: '#',
            privacyPolicyUrl: '#'
        };

        // ==================== å¯åŠ¨è®¤è¯UI ====================
        function startAuthUI() {
            try {
                log('å¯åŠ¨è®¤è¯UI...');
                
                // æ¸…ç©ºå®¹å™¨
                const container = document.getElementById('firebaseui-auth-container');
                container.innerHTML = '';
                
                // å¯åŠ¨UI
                ui.start('#firebaseui-auth-container', uiConfig);
                log('âœ… è®¤è¯UIå·²å¯åŠ¨');
                
            } catch (error) {
                log(`å¯åŠ¨è®¤è¯UIå¤±è´¥: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
                showError(`å¯åŠ¨ç™»å½•ç•Œé¢å¤±è´¥: ${error.message}`);
            }
        }

        // ==================== æ£€æŸ¥ç™»å½•çŠ¶æ€ ====================
        function checkAuthState() {
            log('æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€...');
            
            auth.onAuthStateChanged((user) => {
                if (user) {
                    log(`âœ… ç”¨æˆ·å·²ç™»å½•: ${user.email}`);
                    log(`æ˜¾ç¤ºåç§°: ${user.displayName || 'æœªè®¾ç½®'}`);
                    log(`UID: ${user.uid}`);
                    
                    // æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
                    hideElement('loader');
                    hideElement('firebaseui-auth-container');
                    showSuccess(`æ¬¢è¿å›æ¥ï¼<br>${user.displayName || user.email}<br><small>æ­£åœ¨è·³è½¬åˆ°ä¸»é¡µ...</small>`);
                    
                    // è·³è½¬
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1500);
                } else {
                    log('â„¹ï¸ ç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢');
                    startAuthUI();
                }
            }, (error) => {
                log(`æ£€æŸ¥ç™»å½•çŠ¶æ€æ—¶å‡ºé”™: ${error.message}`, 'error');
                showError(`æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: ${error.message}`);
            });
        }

        // ==================== é¡µé¢åŠ è½½äº‹ä»¶ ====================
        window.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ é¡µé¢DOMåŠ è½½å®Œæˆ');
        });

        window.addEventListener('load', () => {
            log('ğŸš€ é¡µé¢å®Œå…¨åŠ è½½å®Œæˆ');
            log('ç­‰å¾…Firebaseè„šæœ¬åŠ è½½...');
            
            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ
            setTimeout(() => {
                if (initializeFirebase()) {
                    checkAuthState();
                }
            }, 500);
        });

        // ==================== å…¨å±€é”™è¯¯å¤„ç† ====================
        window.addEventListener('error', (e) => {
            log(`å…¨å±€é”™è¯¯: ${e.message}`, 'error');
            console.error('é”™è¯¯è¯¦æƒ…:', e.error);
            
            if (e.message.includes('firebase') || e.message.includes('firebaseui')) {
                showError('Firebaseè„šæœ¬åŠ è½½å¤±è´¥<br>å¯èƒ½çš„åŸå› ï¼š<br>1. ç½‘ç»œè¿æ¥é—®é¢˜<br>2. é˜²ç«å¢™é™åˆ¶<br>3. éœ€è¦ä½¿ç”¨VPN');
            }
        });

        window.addEventListener('unhandledrejection', (e) => {
            log(`æœªå¤„ç†çš„Promiseé”™è¯¯: ${e.reason}`, 'error');
            console.error('Promiseé”™è¯¯è¯¦æƒ…:', e.reason);
        });

        // ==================== è°ƒè¯•é¢æ¿å¼€å…³ ====================
        document.addEventListener('DOMContentLoaded', () => {
            const logo = document.querySelector('.logo h1');
            if (logo) {
                let clickCount = 0;
                let clickTimer = null;
                
                logo.addEventListener('click', () => {
                    clickCount++;
                    
                    if (clickTimer) {
                        clearTimeout(clickTimer);
                    }
                    
                    clickTimer = setTimeout(() => {
                        if (clickCount >= 2) {
                            const debugPanel = document.getElementById('debug-info');
                            if (debugPanel.style.display === 'none' || !debugPanel.style.display) {
                                showElement('debug-info');
                                log('è°ƒè¯•é¢æ¿å·²æ‰“å¼€');
                            } else {
                                hideElement('debug-info');
                                log('è°ƒè¯•é¢æ¿å·²å…³é—­');
                            }
                        }
                        clickCount = 0;
                    }, 300);
                });
            }
        });
    </script>
</body>
</html>
