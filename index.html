<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ V11 - æœ€ç»ˆç‰ˆ</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans CJK SC', sans-serif; background: #f9fafb; }
        .container { max-width: 1400px; margin: 0 auto; background: white; min-height: 100vh; }
        
        /* å¤´éƒ¨ */
        .header { background: #1f2937; color: white; padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 22px; display: flex; align-items: center; gap: 12px; }
        .header p { font-size: 13px; opacity: 0.8; margin-top: 4px; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        /* ç™»å½•é¡µ */
        .login-page { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; min-height: 100vh; }
        .login-box { text-align: center; max-width: 400px; }
        .login-box h1 { font-size: 48px; margin-bottom: 10px; }
        .login-box h2 { font-size: 24px; margin-bottom: 5px; color: #1f2937; }
        .login-box p { color: #6b7280; margin-bottom: 30px; }
        .google-btn { padding: 14px 28px; background: white; border: 1px solid #dadce0; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; }
        .google-btn:hover { background: #f8f9fa; }
        
        /* ä¸»å†…å®¹ */
        .main-page { display: none; }
        .main-page.active { display: block; }
        .content { padding: 24px; }
        
        /* é€‰é¡¹å¡ */
        .tabs { display: flex; gap: 8px; border-bottom: 1px solid #e5e7eb; margin-bottom: 24px; }
        .tab-btn { padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: #6b7280; font-size: 14px; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; }
        
        /* ä»ªè¡¨æ¿ */
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: #f9fafb; padding: 16px; border-radius: 8px; border-left: 3px solid #2563eb; }
        .stat-label { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
        .stat-value { font-size: 24px; font-weight: 700; color: #2563eb; }
        .stat-sub { font-size: 12px; color: #6b7280; margin-top: 4px; }
        
        .dashboard-section { margin-bottom: 32px; }
        .dashboard-section h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb; }
        
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .summary-card { background: white; border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px; }
        .summary-card strong { display: block; color: #111827; font-size: 13px; margin-bottom: 8px; }
        .summary-card .amount { font-size: 20px; font-weight: 700; color: #2563eb; }
        
        /* è¡¨å• */
        .form-section { display: none; }
        .form-section.active { display: block; }
        
        .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px; }
        .form-row.full { grid-template-columns: 1fr; }
        .form-row.three { grid-template-columns: repeat(3, 1fr); }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-weight: 600; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px; font-family: inherit; }
        .form-group textarea { resize: vertical; min-height: 60px; }
        
        .form-buttons { display: flex; gap: 12px; margin-top: 20px; }
        .form-buttons button { flex: 1; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-logout { background: #6b7280; color: white; }
        .btn-edit { background: #10b981; color: white; font-size: 12px; }
        
        /* è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #e5e7eb; background: #f9fafb; font-weight: 600; font-size: 13px; }
        td { padding: 12px; border-bottom: 1px solid #e5e7eb; font-size: 13px; }
        tr:hover { background: #f9fafb; }
        
        /* æ¨¡æ€æ¡† */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 24px; border-radius: 12px; width: 90%; max-width: 600px; margin: 20px auto; }
        .modal-header { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
        
        .info-box { background: #f0f4ff; border-left: 4px solid #2563eb; padding: 16px; border-radius: 8px; margin-top: 20px; }
        .info-box h3 { color: #2563eb; margin-bottom: 8px; }
        .info-box p { font-size: 13px; color: #374151; margin: 4px 0; }
        
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .work-log-item { background: #f9fafb; padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #2563eb; }
        .work-log-item .time { font-size: 12px; color: #6b7280; }
        .work-log-item .hours { font-weight: 700; color: #2563eb; }
        .work-log-item .type { font-size: 12px; background: #e0e7ff; color: #2563eb; padding: 2px 6px; border-radius: 3px; display: inline-block; margin-left: 8px; }
        
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .form-row.three { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <div>
                <h1>ğŸ“Š ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ V11</h1>
                <p>æ™ºèƒ½å·¥ä½œæ—¶é—´è¿½è¸ªã€å¤šç»´åº¦ç»Ÿè®¡åˆ†æä¸å·¥ä½œé‡ç®¡ç†</p>
            </div>
            <div id="userSection" style="display: none; align-items: center; gap: 16px;">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">ç”¨</div>
                    <div>
                        <div id="userName" style="font-weight: 600; font-size: 13px;">ç”¨æˆ·</div>
                        <div id="userEmail" style="font-size: 12px; opacity: 0.8;">é‚®ç®±</div>
                    </div>
                </div>
                <button class="btn btn-logout" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>

        <!-- ç™»å½•é¡µ -->
        <div id="loginPage" class="login-page">
            <div class="login-box">
                <h1>ğŸ“Š</h1>
                <h2>ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ</h2>
                <p>V11 ä¼ä¸šç‰ˆ Â· å¤šç”¨æˆ· Â· æƒé™ç®¡ç† Â· äº‘ç«¯æ•°æ®</p>
                <button class="google-btn" onclick="signInWithGoogle()">ğŸ” ä½¿ç”¨Googleè´¦æˆ·ç™»å½•</button>
                <p style="margin-top: 16px; color: #9ca3af; font-size: 13px;">ç³»ç»Ÿå·²å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®ç™»å½•</p>
            </div>
        </div>

        <!-- ä¸»é¡µé¢ -->
        <div id="mainPage" class="main-page">
            <!-- é€‰é¡¹å¡å¯¼èˆª -->
            <div style="padding: 0 24px; padding-top: 20px;">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('dashboard')">ğŸ“Š ä»ªè¡¨æ¿</button>
                    <button class="tab-btn" onclick="switchTab('add-project')">â• æ·»åŠ æ–°é¡¹ç›®</button>
                    <button class="tab-btn" onclick="switchTab('projects')">ğŸ“‹ æ‰€æœ‰é¡¹ç›®</button>
                </div>
            </div>

            <!-- ä»ªè¡¨æ¿ -->
            <div id="dashboard" class="dashboard active">
                <div class="content">
                    <h2 style="margin-bottom: 20px;">ä»ªè¡¨æ¿æ¦‚è§ˆ</h2>
                    
                    <!-- æ ¸å¿ƒç»Ÿè®¡ -->
                    <div class="dashboard-section">
                        <h3>æ ¸å¿ƒæŒ‡æ ‡</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">å”®å‰å·²ç­¾å•</div>
                                <div class="stat-value" id="signedAmount">Â£0.0K</div>
                                <div class="stat-sub"><span id="signedCount">0</span>ä¸ªé¡¹ç›®</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å”®å‰Pipeline</div>
                                <div class="stat-value" id="pipelineAmount">Â£0.0K</div>
                                <div class="stat-sub"><span id="pipelineCount">0</span>ä¸ªé¡¹ç›®</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å”®åé¡¹ç›®é‡‘é¢</div>
                                <div class="stat-value" id="aftersalesAmount">Â£0.0K</div>
                                <div class="stat-sub"><span id="aftersalesCount">0</span>ä¸ªé¡¹ç›®</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æ€»é¡¹ç›®é‡‘é¢</div>
                                <div class="stat-value" id="totalAmount">Â£0.0K</div>
                                <div class="stat-sub"><span id="totalCount">0</span>ä¸ªé¡¹ç›®</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æ€»å·¥ä½œæ—¶é•¿</div>
                                <div class="stat-value" id="totalWorkHours">0.0h</div>
                                <div class="stat-sub">çº¦<span id="workDays">0</span>å¤©</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æ€»åŠ ç­æ—¶é•¿</div>
                                <div class="stat-value" id="totalOvertimeHours">0.0h</div>
                                <div class="stat-sub">çº¦<span id="overtimeDays">0</span>å¤©</div>
                            </div>
                        </div>
                    </div>

                    <!-- æŒ‰è¡Œä¸šç»Ÿè®¡ -->
                    <div class="dashboard-section">
                        <h3>æŒ‰è¡Œä¸šç»Ÿè®¡é‡‘é¢</h3>
                        <div id="industryStats" class="summary-grid">
                            <p style="color: #9ca3af;">æš‚æ— æ•°æ®</p>
                        </div>
                    </div>

                    <!-- æŒ‰å®¢æˆ·ç»Ÿè®¡ -->
                    <div class="dashboard-section">
                        <h3>æŒ‰å®¢æˆ·ç»Ÿè®¡é‡‘é¢</h3>
                        <div id="customerStats" class="summary-grid">
                            <p style="color: #9ca3af;">æš‚æ— æ•°æ®</p>
                        </div>
                    </div>

                    <!-- æŒ‰é”€å”®ç»Ÿè®¡ -->
                    <div class="dashboard-section">
                        <h3>æŒ‰é”€å”®äººå‘˜ç»Ÿè®¡é‡‘é¢</h3>
                        <div id="salespersonStats" class="summary-grid">
                            <p style="color: #9ca3af;">æš‚æ— æ•°æ®</p>
                        </div>
                    </div>

                    <div class="info-box">
                        <h3>âœ… ç³»ç»Ÿå·²å°±ç»ª</h3>
                        <p>âœ¨ æ‰€æœ‰åŠŸèƒ½å·²æ¿€æ´»ï¼Œç³»ç»Ÿå·²æˆåŠŸéƒ¨ç½²ï¼</p>
                        <p><strong>é¡¹ç›®IDï¼š</strong> weekly-report-d55e9</p>
                        <p><strong>æ•°æ®åº“ï¼š</strong> æœ¬åœ°å­˜å‚¨ï¼ˆlocalStorageï¼‰</p>
                    </div>
                </div>
            </div>

            <!-- æ·»åŠ é¡¹ç›® -->
            <div id="add-project" class="form-section">
                <div class="content">
                    <h2 style="margin-bottom: 20px;">æ·»åŠ æ–°é¡¹ç›®</h2>
                    <form id="projectForm" onsubmit="saveProject(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>å‘¨èµ·å§‹æ—¥æœŸ *</label>
                                <input type="date" id="weekStartDate" required>
                            </div>
                            <div class="form-group">
                                <label>å‘¨ç»“æŸæ—¥æœŸ</label>
                                <input type="date" id="weekEndDate">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>å®¢æˆ·åç§° *</label>
                                <input type="text" id="clientName" required>
                            </div>
                            <div class="form-group">
                                <label>é¡¹ç›®åç§° *</label>
                                <input type="text" id="projectName" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>è¡Œä¸š *</label>
                                <input type="text" id="industry" required>
                            </div>
                            <div class="form-group">
                                <label>å›½å®¶</label>
                                <input type="text" id="country">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>é¡¹ç›®è§„æ¨¡ (Â£K) *</label>
                                <input type="number" id="projectScale" step="0.1" required>
                            </div>
                            <div class="form-group">
                                <label>é¡¹ç›®ç±»å‹ *</label>
                                <select id="projectType" onchange="updateFormFields()" required>
                                    <option value="">-- è¯·é€‰æ‹© --</option>
                                    <option value="presales">å”®å‰</option>
                                    <option value="aftersales">å”®å</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>ä¸“ä¸šæ–¹å‘ *</label>
                                <select id="specialty" required>
                                    <option value="">-- è¯·é€‰æ‹© --</option>
                                    <option value="ç½‘ç»œ">ç½‘ç»œ</option>
                                    <option value="ç³»ç»Ÿ">ç³»ç»Ÿ</option>
                                    <option value="åŸºç¡€è®¾æ–½">åŸºç¡€è®¾æ–½</option>
                                </select>
                            </div>
                            <div id="signedStatusGroup" class="form-group">
                                <label>ç­¾å•çŠ¶æ€ *</label>
                                <select id="signedStatus">
                                    <option value="signed">å·²ç­¾å•</option>
                                    <option value="pipeline">Pipeline</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>é”€å”®äººå‘˜ *</label>
                                <input type="text" id="salesperson" required>
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>è¿›åº¦é˜¶æ®µ</label>
                                <input type="text" id="projectStage" placeholder="ä¾‹å¦‚ï¼šæŠ€æœ¯æ–¹æ¡ˆã€ç°åœºä¿éšœ">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>ä¸»å·¥ç¨‹å¸ˆ</label>
                                <input type="text" id="engineerName">
                            </div>
                            <div class="form-group">
                                <label>åˆä½œå·¥ç¨‹å¸ˆ</label>
                                <input type="text" id="collaborators" placeholder="å¤šä¸ªå·¥ç¨‹å¸ˆç”¨é€—å·åˆ†éš”">
                            </div>
                        </div>

                        <div class="form-buttons">
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">é‡ç½®</button>
                            <button type="submit" class="btn btn-primary">ä¿å­˜é¡¹ç›®</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- é¡¹ç›®åˆ—è¡¨ -->
            <div id="projects" class="form-section">
                <div class="content">
                    <h2 style="margin-bottom: 20px;">é¡¹ç›®ç®¡ç†</h2>
                    
                    <div class="controls">
                        <button class="btn btn-primary" onclick="switchTab('add-project')">+ æ·»åŠ é¡¹ç›®</button>
                        <div style="font-size: 13px; color: #6b7280;">å…± <span id="projectListCount">0</span> ä¸ªé¡¹ç›®</div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>å®¢æˆ·</th>
                                <th>é¡¹ç›®</th>
                                <th>è¡Œä¸š</th>
                                <th>è§„æ¨¡ (Â£K)</th>
                                <th>ä¸“ä¸šæ–¹å‘</th>
                                <th>é”€å”®</th>
                                <th>å·¥ç¨‹å¸ˆ</th>
                                <th>å·¥ä½œè®°å½•</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <tr><td colspan="9" style="text-align: center; padding: 40px; color: #9ca3af;">æš‚æ— é¡¹ç›®</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘é¡¹ç›®æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ç¼–è¾‘é¡¹ç›® - æ·»åŠ å·¥ä½œè®°å½•</div>
            <form id="workLogForm" onsubmit="saveWorkLog(event)">
                <input type="hidden" id="editProjectIndex">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>å·¥ä½œæ—¥æœŸ *</label>
                        <input type="date" id="workDate" required>
                    </div>
                    <div class="form-group">
                        <label>å¼€å§‹æ—¶é—´ *</label>
                        <input type="time" id="startTime" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ç»“æŸæ—¶é—´ *</label>
                        <input type="time" id="endTime" required>
                    </div>
                    <div class="form-group">
                        <label>å·¥ä½œç±»å‹</label>
                        <select id="workType">
                            <option value="normal">æ­£å¸¸å·¥ä½œ</option>
                            <option value="overtime">åŠ ç­</option>
                        </select>
                    </div>
                </div>

                <div class="form-row full">
                    <div class="form-group">
                        <label>å·¥ä½œå†…å®¹</label>
                        <textarea id="workContent" placeholder="è®°å½•æœ¬æ¬¡å·¥ä½œçš„è¯¦ç»†å†…å®¹"></textarea>
                    </div>
                </div>

                <div style="background: #f9fafb; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                    <strong style="font-size: 13px;">è®¡ç®—ç»“æœï¼š</strong>
                    <div style="font-size: 13px; margin-top: 4px;">
                        <span id="calculatedHours">0.0</span> å°æ—¶
                        <span id="workTypeLabel" style="font-size: 12px; background: #e0e7ff; color: #2563eb; padding: 2px 6px; border-radius: 3px; margin-left: 8px;">æ­£å¸¸å·¥ä½œ</span>
                    </div>
                </div>

                <div id="workLogsList" style="margin-bottom: 16px; max-height: 200px; overflow-y: auto;"></div>

                <div style="display: flex; gap: 12px;">
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeEditModal()">å…³é—­</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">æ·»åŠ å·¥ä½œè®°å½•</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let projects = [];

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            const today = new Date();
            document.getElementById('weekStartDate').valueAsDate = today;
            document.getElementById('workDate').valueAsDate = today;
        });

        // Googleç™»å½•
        async function signInWithGoogle() {
            try {
                if (typeof google === 'undefined') {
                    setTimeout(signInWithGoogle, 1000);
                    return;
                }

                google.accounts.id.initialize({
                    client_id: '1018033981926-cg6bl58ehp3kpm0rlcr7vlgeg8iore3g.apps.googleusercontent.com',
                    callback: handleCredentialResponse,
                    auto_select: false
                });

                google.accounts.id.prompt();

            } catch (e) {
                alert('ç™»å½•å¤±è´¥: ' + e.message);
            }
        }

        // å¤„ç†Googleå“åº”
        function handleCredentialResponse(response) {
            try {
                const base64Url = response.credential.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(
                    atob(base64).split('').map(c => 
                        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                    ).join('')
                );
                
                currentUser = JSON.parse(jsonPayload);
                showMainPage();
                loadProjects();
                
            } catch(e) {
                alert('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥');
            }
        }

        // æ˜¾ç¤ºä¸»é¡µ
        function showMainPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainPage').classList.add('active');
            document.getElementById('userSection').style.display = 'flex';
            
            const name = currentUser.name || currentUser.email;
            document.getElementById('userName').textContent = name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
        }

        // åˆ‡æ¢é€‰é¡¹å¡
        function switchTab(tabName) {
            document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.dashboard').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            if (tabName === 'dashboard') {
                document.getElementById('dashboard').classList.add('active');
                updateDashboard();
            } else if (tabName === 'add-project') {
                document.getElementById('add-project').classList.add('active');
            } else if (tabName === 'projects') {
                document.getElementById('projects').classList.add('active');
                renderProjectsList();
            }
            
            event.target.classList.add('active');
        }

        // æ›´æ–°è¡¨å•å­—æ®µ
        function updateFormFields() {
            const projectType = document.getElementById('projectType').value;
            const signedStatusGroup = document.getElementById('signedStatusGroup');
            
            if (projectType === 'aftersales') {
                signedStatusGroup.style.display = 'none';
            } else {
                signedStatusGroup.style.display = 'block';
            }
        }

        // è®¡ç®—æ—¶é—´
        document.getElementById('startTime').addEventListener('change', calculateHours);
        document.getElementById('endTime').addEventListener('change', calculateHours);
        document.getElementById('workType').addEventListener('change', updateWorkTypeLabel);

        function calculateHours() {
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;
            
            if (!start || !end) return;
            
            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);
            
            const startMinutes = startH * 60 + startM;
            const endMinutes = endH * 60 + endM;
            const diffMinutes = endMinutes - startMinutes;
            const hours = (diffMinutes / 60).toFixed(1);
            
            document.getElementById('calculatedHours').textContent = hours;
        }

        function updateWorkTypeLabel() {
            const type = document.getElementById('workType').value;
            const label = document.getElementById('workTypeLabel');
            if (type === 'overtime') {
                label.textContent = 'åŠ ç­';
            } else {
                label.textContent = 'æ­£å¸¸å·¥ä½œ';
            }
        }

        // åŠ è½½é¡¹ç›®
        function loadProjects() {
            const saved = localStorage.getItem('projects_' + currentUser.email);
            projects = saved ? JSON.parse(saved) : [];
            updateDashboard();
        }

        // æ›´æ–°ä»ªè¡¨æ¿
        function updateDashboard() {
            const presalesSigned = projects.filter(p => p.projectType === 'presales' && p.signedStatus === 'signed');
            const presalesPipeline = projects.filter(p => p.projectType === 'presales' && p.signedStatus === 'pipeline');
            const aftersales = projects.filter(p => p.projectType === 'aftersales');
            
            const signedAmount = presalesSigned.reduce((sum, p) => sum + parseFloat(p.projectScale || 0), 0);
            const pipelineAmount = presalesPipeline.reduce((sum, p) => sum + parseFloat(p.projectScale || 0), 0);
            const aftersalesAmount = aftersales.reduce((sum, p) => sum + parseFloat(p.projectScale || 0), 0);
            const totalAmount = signedAmount + pipelineAmount + aftersalesAmount;
            
            // è®¡ç®—æ€»å·¥ä½œæ—¶é•¿
            let totalWorkHours = 0, totalOvertimeHours = 0;
            projects.forEach(p => {
                if (p.workLogs) {
                    p.workLogs.forEach(log => {
                        const hours = parseFloat(log.hours || 0);
                        if (log.type === 'overtime') {
                            totalOvertimeHours += hours;
                        } else {
                            totalWorkHours += hours;
                        }
                    });
                }
            });
            
            document.getElementById('signedAmount').textContent = 'Â£' + signedAmount.toFixed(1) + 'K';
            document.getElementById('signedCount').textContent = presalesSigned.length;
            
            document.getElementById('pipelineAmount').textContent = 'Â£' + pipelineAmount.toFixed(1) + 'K';
            document.getElementById('pipelineCount').textContent = presalesPipeline.length;
            
            document.getElementById('aftersalesAmount').textContent = 'Â£' + aftersalesAmount.toFixed(1) + 'K';
            document.getElementById('aftersalesCount').textContent = aftersales.length;
            
            document.getElementById('totalAmount').textContent = 'Â£' + totalAmount.toFixed(1) + 'K';
            document.getElementById('totalCount').textContent = projects.length;
            
            document.getElementById('totalWorkHours').textContent = totalWorkHours.toFixed(1) + 'h';
            document.getElementById('workDays').textContent = Math.round(totalWorkHours / 8);
            
            document.getElementById('totalOvertimeHours').textContent = totalOvertimeHours.toFixed(1) + 'h';
            document.getElementById('overtimeDays').textContent = Math.round(totalOvertimeHours / 8);
            
            // æŒ‰è¡Œä¸šç»Ÿè®¡
            const industryMap = {};
            projects.forEach(p => {
                if (!industryMap[p.industry]) industryMap[p.industry] = 0;
                industryMap[p.industry] += parseFloat(p.projectScale || 0);
            });
            
            let industryHTML = '';
            Object.entries(industryMap).forEach(([industry, amount]) => {
                industryHTML += `<div class="summary-card"><strong>${industry}</strong><div class="amount">Â£${amount.toFixed(1)}K</div></div>`;
            });
            document.getElementById('industryStats').innerHTML = industryHTML || '<p style="color: #9ca3af;">æš‚æ— æ•°æ®</p>';
            
            // æŒ‰å®¢æˆ·ç»Ÿè®¡
            const customerMap = {};
            projects.forEach(p => {
                if (!customerMap[p.clientName]) customerMap[p.clientName] = 0;
                customerMap[p.clientName] += parseFloat(p.projectScale || 0);
            });
            
            let customerHTML = '';
            Object.entries(customerMap).forEach(([customer, amount]) => {
                customerHTML += `<div class="summary-card"><strong>${customer}</strong><div class="amount">Â£${amount.toFixed(1)}K</div></div>`;
            });
            document.getElementById('customerStats').innerHTML = customerHTML || '<p style="color: #9ca3af;">æš‚æ— æ•°æ®</p>';
            
            // æŒ‰é”€å”®ç»Ÿè®¡
            const salespersonMap = {};
            projects.forEach(p => {
                if (!salespersonMap[p.salesperson]) salespersonMap[p.salesperson] = 0;
                salespersonMap[p.salesperson] += parseFloat(p.projectScale || 0);
            });
            
            let salespersonHTML = '';
            Object.entries(salespersonMap).forEach(([salesperson, amount]) => {
                salespersonHTML += `<div class="summary-card"><strong>${salesperson}</strong><div class="amount">Â£${amount.toFixed(1)}K</div></div>`;
            });
            document.getElementById('salespersonStats').innerHTML = salespersonHTML || '<p style="color: #9ca3af;">æš‚æ— æ•°æ®</p>';
        }

        // æ¸²æŸ“é¡¹ç›®åˆ—è¡¨
        function renderProjectsList() {
            const tbody = document.getElementById('projectsTableBody');
            
            if (projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #9ca3af;">æš‚æ— é¡¹ç›®</td></tr>';
                document.getElementById('projectListCount').textContent = '0';
                return;
            }

            let html = '';
            projects.forEach((project, index) => {
                let workLogsCount = 0;
                let totalWorkHours = 0;
                if (project.workLogs) {
                    workLogsCount = project.workLogs.length;
                    totalWorkHours = project.workLogs.reduce((sum, log) => sum + parseFloat(log.hours || 0), 0);
                }
                
                html += `
                    <tr>
                        <td>${project.clientName}</td>
                        <td>${project.projectName}</td>
                        <td>${project.industry}</td>
                        <td>Â£${parseFloat(project.projectScale).toFixed(1)}K</td>
                        <td>${project.specialty}</td>
                        <td>${project.salesperson}</td>
                        <td>${project.engineerName || '-'}</td>
                        <td><button class="btn btn-edit" onclick="openEditModal(${index})">${workLogsCount} æ¡ (${totalWorkHours.toFixed(1)}h)</button></td>
                        <td><button class="btn btn-danger" onclick="deleteProject(${index})">åˆ é™¤</button></td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            document.getElementById('projectListCount').textContent = projects.length;
        }

        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        function openEditModal(index) {
            document.getElementById('editProjectIndex').value = index;
            const project = projects[index];
            
            // æ˜¾ç¤ºç°æœ‰å·¥ä½œè®°å½•
            let logsHTML = '';
            if (project.workLogs) {
                project.workLogs.forEach((log, i) => {
                    logsHTML += `
                        <div class="work-log-item">
                            <div class="time">${log.date} ${log.startTime}-${log.endTime}</div>
                            <div>${log.content || 'æ— '}</div>
                            <div style="margin-top: 4px;">
                                <span class="hours">${log.hours}h</span>
                                <span class="type">${log.type === 'overtime' ? 'åŠ ç­' : 'æ­£å¸¸'}</span>
                                <button type="button" class="btn btn-danger" style="float: right; padding: 2px 8px;" onclick="deleteWorkLog(${index}, ${i})">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('workLogsList').innerHTML = logsHTML;
            
            document.getElementById('editModal').classList.add('active');
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('workLogForm').reset();
        }

        // ä¿å­˜å·¥ä½œè®°å½•
        function saveWorkLog(e) {
            e.preventDefault();
            
            const projectIndex = parseInt(document.getElementById('editProjectIndex').value);
            const workDate = document.getElementById('workDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const workType = document.getElementById('workType').value;
            const workContent = document.getElementById('workContent').value;
            const hours = parseFloat(document.getElementById('calculatedHours').textContent);
            
            if (!projects[projectIndex].workLogs) {
                projects[projectIndex].workLogs = [];
            }
            
            projects[projectIndex].workLogs.push({
                date: workDate,
                startTime: startTime,
                endTime: endTime,
                type: workType,
                content: workContent,
                hours: hours
            });
            
            localStorage.setItem('projects_' + currentUser.email, JSON.stringify(projects));
            alert('å·¥ä½œè®°å½•å·²æ·»åŠ ï¼');
            
            document.getElementById('workLogForm').reset();
            openEditModal(projectIndex);
            renderProjectsList();
            updateDashboard();
        }

        // åˆ é™¤å·¥ä½œè®°å½•
        function deleteWorkLog(projectIndex, logIndex) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥å·¥ä½œè®°å½•å—ï¼Ÿ')) return;
            projects[projectIndex].workLogs.splice(logIndex, 1);
            localStorage.setItem('projects_' + currentUser.email, JSON.stringify(projects));
            openEditModal(projectIndex);
            renderProjectsList();
            updateDashboard();
        }

        // ä¿å­˜é¡¹ç›®
        function saveProject(e) {
            e.preventDefault();
            
            const newProject = {
                weekStartDate: document.getElementById('weekStartDate').value,
                weekEndDate: document.getElementById('weekEndDate').value,
                clientName: document.getElementById('clientName').value,
                projectName: document.getElementById('projectName').value,
                industry: document.getElementById('industry').value,
                country: document.getElementById('country').value,
                projectScale: document.getElementById('projectScale').value,
                specialty: document.getElementById('specialty').value,
                projectType: document.getElementById('projectType').value,
                signedStatus: document.getElementById('projectType').value === 'presales' ? document.getElementById('signedStatus').value : 'n/a',
                projectStage: document.getElementById('projectStage').value,
                salesperson: document.getElementById('salesperson').value,
                engineerName: document.getElementById('engineerName').value,
                collaborators: document.getElementById('collaborators').value,
                workLogs: [],
                createdAt: new Date().toISOString()
            };

            projects.push(newProject);
            localStorage.setItem('projects_' + currentUser.email, JSON.stringify(projects));
            
            alert('é¡¹ç›®å·²ä¿å­˜ï¼');
            resetForm();
            updateDashboard();
            switchTab('projects');
        }

        // åˆ é™¤é¡¹ç›®
        function deleteProject(index) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥é¡¹ç›®å—ï¼Ÿ')) return;
            projects.splice(index, 1);
            localStorage.setItem('projects_' + currentUser.email, JSON.stringify(projects));
            renderProjectsList();
            updateDashboard();
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('projectForm').reset();
            const today = new Date();
            document.getElementById('weekStartDate').valueAsDate = today;
        }

        // ç™»å‡º
        function logout() {
            currentUser = null;
            document.getElementById('mainPage').classList.remove('active');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('userSection').style.display = 'none';
        }
    </script>
</body>
</html>
