<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ V11</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #1f2937;
            --secondary: #374151;
            --accent: #2563eb;
            --border: #e5e7eb;
            --bg-light: #f9fafb;
            --text-dark: #111827;
            --success: #10b981;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            margin: 0;
            padding: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            min-height: 80vh;
        }

        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 80vh;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px 12px 0 0;
        }

        .user-pill {
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .role-badge {
            background: var(--accent);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .main-content { padding: 24px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border); color: #6b7280; font-size: 13px; }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-outline { border: 1px solid var(--border); background: white; }
        .btn-danger { color: var(--danger); background: none; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background:white; padding:24px; border-radius:12px; width:400px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display:block; margin-bottom:5px; font-size:12px; font-weight:600; }
        .form-group input, .form-group select { width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; box-sizing: border-box; }
        
        .error-msg { background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; padding: 12px; border-radius: 6px; margin-bottom: 16px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="authCheck" style="text-align: center; padding: 50px;">æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</div>

        <div id="loginPage" class="login-container" style="display: none;">
            <div style="text-align: center;">
                <h1 style="font-size: 48px; margin-bottom: 10px;">ğŸ“Š</h1>
                <h2 style="margin-bottom: 5px;">ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ</h2>
                <p style="color: #6b7280; margin-bottom: 30px;">V11 ä¼ä¸šç‰ˆ Â· å¤šç”¨æˆ· Â· æƒé™ç®¡ç† Â· äº‘ç«¯æ•°æ®</p>
                
                <div id="errorMsg" class="error-msg" style="display: none;"></div>
                
                <button id="loginBtn" class="btn btn-primary" onclick="signIn()" style="padding: 12px 30px; font-size: 16px; margin-bottom: 16px;">
                    ğŸ” ä½¿ç”¨Googleè´¦æˆ·ç™»å½•
                </button>
                <p style="font-size: 13px; color: #9ca3af;">ç³»ç»Ÿå·²å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®ç™»å½•</p>
            </div>
        </div>

        <div id="mainPage" style="display: none;">
            <div class="header">
                <div>
                    <h2 style="margin: 0; font-size: 18px;">å‘¨æŠ¥æ¦‚è§ˆ</h2>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div class="user-pill">
                        <span id="userEmail">---</span>
                        <span id="roleLabel" class="role-badge">å·¥ç¨‹å¸ˆ</span>
                    </div>
                    <button class="btn btn-outline" style="font-size: 12px;" onclick="signOut()">ç™»å‡º</button>
                </div>
            </div>

            <div class="main-content">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn btn-primary" onclick="toggleModal(true)">+ æ–°å¢é¡¹ç›®</button>
                    <div id="statsInfo" style="font-size: 14px; color: #6b7280;"></div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>å®¢æˆ·åç§°</th>
                            <th>é¡¹ç›®åç§°</th>
                            <th>è§„æ¨¡ (Â£K)</th>
                            <th>å·¥ç¨‹å¸ˆ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr><td colspan="5" style="text-align: center; color: #9ca3af; padding: 40px;">æš‚æ— é¡¹ç›®ï¼Œè¯·ç‚¹å‡»æ–°å¢</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top: 0;">æ–°å¢å‘¨æŠ¥é¡¹ç›®</h3>
            <form id="projectForm">
                <div class="form-group">
                    <label>å®¢æˆ·åç§° *</label>
                    <input type="text" id="clientName" required placeholder="ä¾‹å¦‚ï¼šæŸå¤§å‹é“¶è¡Œ">
                </div>
                <div class="form-group">
                    <label>é¡¹ç›®åç§° *</label>
                    <input type="text" id="projectName" required placeholder="ä¾‹å¦‚ï¼šæ ¸å¿ƒç½‘ç»œå‡çº§">
                </div>
                <div class="form-group">
                    <label>é¡¹ç›®è§„æ¨¡ (Â£K) *</label>
                    <input type="number" id="projectScale" step="0.1" required>
                </div>
                <div class="form-group">
                    <label>ä¸“ä¸šæ–¹å‘</label>
                    <select id="specialty">
                        <option value="ç½‘ç»œ">ç½‘ç»œ</option>
                        <option value="ç³»ç»Ÿ">ç³»ç»Ÿ</option>
                        <option value="åŸºç¡€è®¾æ–½">åŸºç¡€è®¾æ–½</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-outline" style="flex: 1;" onclick="toggleModal(false)">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">ä¿å­˜é¡¹ç›®</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBzcAr_OJFdIMnaYXRCE7TJs2qLK_TAy9U",
            authDomain: "weekly-report-d55e9.firebaseapp.com",
            projectId: "weekly-report-d55e9",
            storageBucket: "weekly-report-d55e9.firebasestorage.app",
            messagingSenderId: "315332641675",
            appId: "1:315332641675:web:1f8ab523df0b86a47c258e"
        };

        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let isAdmin = false;

        // ç›‘å¬è®¤è¯çŠ¶æ€
        auth.onAuthStateChanged(async (user) => {
            document.getElementById('authCheck').style.display = 'none';
            
            if (user) {
                currentUser = user;
                isAdmin = (user.email === "liuxinyu0914@gmail.com");
                
                showUI('mainPage');
                document.getElementById('userEmail').innerText = user.email;
                document.getElementById('roleLabel').innerText = isAdmin ? "ç®¡ç†å‘˜" : "å·¥ç¨‹å¸ˆ";
                loadData();
            } else {
                showUI('loginPage');
            }
        });

        // Google ç™»å½•
        async function signIn() {
            try {
                document.getElementById('errorMsg').style.display = 'none';
                document.getElementById('loginBtn').disabled = true;
                document.getElementById('loginBtn').textContent = 'æ­£åœ¨è¿æ¥Google...';

                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                
            } catch (e) {
                console.error('ç™»å½•å¤±è´¥:', e);
                showError('ç™»å½•å¤±è´¥: ' + e.message);
                document.getElementById('loginBtn').disabled = false;
                document.getElementById('loginBtn').textContent = 'ğŸ” ä½¿ç”¨Googleè´¦æˆ·ç™»å½•';
            }
        }

        // ç™»å‡º
        function signOut() {
            auth.signOut();
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            const tbody = document.getElementById('dataTableBody');
            try {
                let query = db.collection('projects');
                
                if (!isAdmin) {
                    query = query.where('uid', '==', currentUser.uid);
                }

                const snapshot = await query.orderBy('createdAt', 'desc').get();
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #9ca3af; padding: 40px;">æš‚æ— é¡¹ç›®</td></tr>';
                    document.getElementById('statsInfo').innerText = '0 ä¸ªé¡¹ç›®';
                    return;
                }

                let html = '';
                let totalAmount = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    totalAmount += parseFloat(data.projectScale || 0);
                    html += `
                        <tr>
                            <td>${data.clientName}</td>
                            <td>${data.projectName}</td>
                            <td>Â£${data.projectScale}K</td>
                            <td>${data.userName || 'æœªçŸ¥'}</td>
                            <td>
                                <button class="btn btn-danger" style="font-size: 12px;" onclick="deleteItem('${doc.id}')">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;
                document.getElementById('statsInfo').innerText = `${snapshot.size} ä¸ªé¡¹ç›® | æ€»é‡‘é¢: Â£${totalAmount.toFixed(1)}K`;
            } catch (e) {
                console.error(e);
                showError('æ•°æ®åŠ è½½å¤±è´¥: ' + e.message);
            }
        }

        // æäº¤è¡¨å•
        document.getElementById('projectForm').onsubmit = async (e) => {
            e.preventDefault();
            try {
                const newItem = {
                    clientName: document.getElementById('clientName').value,
                    projectName: document.getElementById('projectName').value,
                    projectScale: parseFloat(document.getElementById('projectScale').value),
                    specialty: document.getElementById('specialty').value,
                    uid: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('projects').add(newItem);
                toggleModal(false);
                document.getElementById('projectForm').reset();
                loadData();
            } catch (e) {
                showError('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        };

        // åˆ é™¤é¡¹ç›®
        async function deleteItem(id) {
            if (confirm("ç¡®å®šåˆ é™¤è¯¥é¡¹ç›®å—ï¼Ÿ")) {
                try {
                    await db.collection('projects').doc(id).delete();
                    loadData();
                } catch(e) {
                    showError('åˆ é™¤å¤±è´¥: ' + e.message);
                }
            }
        }

        // å·¥å…·å‡½æ•°
        function showUI(id) {
            document.getElementById('loginPage').style.display = (id === 'loginPage' ? 'flex' : 'none');
            document.getElementById('mainPage').style.display = (id === 'mainPage' ? 'block' : 'none');
        }

        function toggleModal(show) {
            document.getElementById('addModal').classList.toggle('active', show);
        }

        function showError(msg) {
            const errorEl = document.getElementById('errorMsg');
            errorEl.textContent = msg;
            errorEl.style.display = 'block';
        }
    </script>
</body>
</html>
