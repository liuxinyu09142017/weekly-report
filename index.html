<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ V11 - å®Œæ•´åŠŸèƒ½ç‰ˆ</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans CJK SC', sans-serif; background: #f9fafb; }
        .container { max-width: 1600px; margin: 0 auto; background: white; min-height: 100vh; }
        
        /* å¤´éƒ¨ */
        .header { background: #1f2937; color: white; padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 22px; display: flex; align-items: center; gap: 12px; }
        .header p { font-size: 13px; opacity: 0.8; margin-top: 4px; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        /* ç™»å½•é¡µ */
        .login-page { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; min-height: 100vh; }
        .login-box { text-align: center; max-width: 400px; }
        .login-box h1 { font-size: 48px; margin-bottom: 10px; }
        .login-box h2 { font-size: 24px; margin-bottom: 5px; color: #1f2937; }
        .login-box p { color: #6b7280; margin-bottom: 30px; }
        .google-btn { padding: 14px 28px; background: white; border: 1px solid #dadce0; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; }
        .google-btn:hover { background: #f8f9fa; }
        
        /* ä¸»å†…å®¹ */
        .main-page { display: none; }
        .main-page.active { display: block; }
        .content { padding: 24px; }
        
        /* é€‰é¡¹å¡ */
        .tabs { display: flex; gap: 8px; border-bottom: 1px solid #e5e7eb; margin-bottom: 24px; }
        .tab-btn { padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: #6b7280; font-size: 14px; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; }
        
        /* ä»ªè¡¨æ¿ */
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        
        /* ç­›é€‰æ¡ä»¶è¡Œ */
        .filter-row { background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; border: 1px solid #e5e7eb; }
        .filter-group { display: flex; flex-direction: column; gap: 4px; }
        .filter-group label { font-size: 12px; font-weight: 600; color: #374151; }
        .filter-group input, .filter-group select { padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px; }
        
        .action-buttons { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: #f9fafb; padding: 16px; border-radius: 8px; border-left: 3px solid #2563eb; }
        .stat-label { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
        .stat-value { font-size: 24px; font-weight: 700; color: #2563eb; }
        .stat-sub { font-size: 12px; color: #6b7280; margin-top: 4px; }
        
        .dashboard-section { margin-bottom: 32px; }
        .dashboard-section h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb; }
        
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .summary-card { background: white; border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px; }
        .summary-card strong { display: block; color: #111827; font-size: 13px; margin-bottom: 8px; }
        .summary-card .amount { font-size: 20px; font-weight: 700; color: #2563eb; }
        
        /* è¡¨å• */
        .form-section { display: none; }
        .form-section.active { display: block; }
        
        .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px; }
        .form-row.full { grid-template-columns: 1fr; }
        .form-row.three { grid-template-columns: repeat(3, 1fr); }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-weight: 600; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px; font-family: inherit; }
        .form-group textarea { resize: vertical; min-height: 60px; }
        
        .form-buttons { display: flex; gap: 12px; margin-top: 20px; }
        .form-buttons button { flex: 1; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background: #d1d5db; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-logout { background: #6b7280; color: white; }
        .btn-edit { background: #10b981; color: white; font-size: 12px; }
        .btn-edit:hover { background: #059669; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        /* è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 13px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #e5e7eb; background: #f9fafb; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
        tr:hover { background: #f9fafb; }
        
        .badge { display: inline-block; padding: 3px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .badge-presales { background: #dbeafe; color: #1e40af; }
        .badge-aftersales { background: #dcfce7; color: #166534; }
        .badge-signed { background: #dbeafe; color: #1e40af; }
        .badge-pipeline { background: #fef3c7; color: #92400e; }
        
        /* æ¨¡æ€æ¡† */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 24px; border-radius: 12px; width: 90%; max-width: 600px; margin: 20px auto; }
        .modal-header { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
        
        .info-box { background: #f0f4ff; border-left: 4px solid #2563eb; padding: 16px; border-radius: 8px; margin-top: 20px; }
        .info-box h3 { color: #2563eb; margin-bottom: 8px; }
        .info-box p { font-size: 13px; color: #374151; margin: 4px 0; }
        
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .work-log-item { background: #f9fafb; padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #2563eb; }
        .work-log-item .time { font-size: 12px; color: #6b7280; }
        .work-log-item .hours { font-weight: 700; color: #2563eb; }
        .work-log-item .type { font-size: 12px; background: #e0e7ff; color: #2563eb; padding: 2px 6px; border-radius: 3px; display: inline-block; margin-left: 8px; }
        
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .form-row.three { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: 1fr; }
            .filter-row { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <div>
                <h1>ğŸ“Š ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ V11</h1>
                <p>æ™ºèƒ½å·¥ä½œæ—¶é—´è¿½è¸ªã€å¤šç»´åº¦ç»Ÿè®¡åˆ†æä¸å·¥ä½œé‡ç®¡ç†</p>
            </div>
            <div id="userSection" style="display: none; align-items: center; gap: 16px;">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">ç”¨</div>
                    <div>
                        <div id="userName" style="font-weight: 600; font-size: 13px;">ç”¨æˆ·</div>
                        <div id="userEmail" style="font-size: 12px; opacity: 0.8;">é‚®ç®±</div>
                    </div>
                </div>
                <button class="btn btn-logout" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>

        <!-- ç™»å½•é¡µ -->
        <div id="loginPage" class="login-page">
            <div class="login-box">
                <h1>ğŸ“Š</h1>
                <h2>ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ</h2>
                <p>V11 ä¼ä¸šç‰ˆ Â· å¤šç”¨æˆ· Â· æƒé™ç®¡ç† Â· äº‘ç«¯æ•°æ®</p>
                <button class="google-btn" onclick="signInWithGoogle()">ğŸ” ä½¿ç”¨Googleè´¦æˆ·ç™»å½•</button>
                <p style="margin-top: 16px; color: #9ca3af; font-size: 13px;">ç³»ç»Ÿå·²å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®ç™»å½•</p>
            </div>
        </div>

        <!-- ä¸»é¡µé¢ -->
        <div id="mainPage" class="main-page">
            <!-- é€‰é¡¹å¡å¯¼èˆª -->
            <div style="padding: 0 24px; padding-top: 20px;">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('dashboard')">ğŸ“Š ä»ªè¡¨æ¿</button>
                    <button class="tab-btn" onclick="switchTab('add-project')">â• æ·»åŠ æ–°é¡¹ç›®</button>
                    <button class="tab-btn" onclick="switchTab('projects')">ğŸ“‹ æ‰€æœ‰é¡¹ç›®</button>
                </div>
            </div>

            <!-- ä»ªè¡¨æ¿ -->
            <div id="dashboard" class="dashboard active">
                <div class="content">
                    <h2 style="margin-bottom: 20px;">ä»ªè¡¨æ¿æ¦‚è§ˆ</h2>
                    
                    <!-- ç­›é€‰æ¡ä»¶è¡Œ -->
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="filterStartDate">
                        </div>
                        <div class="filter-group">
                            <label>ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="filterEndDate">
                        </div>
                        <div class="filter-group">
                            <label>é¡¹ç›®ç±»å‹</label>
                            <select id="filterProjectType">
                                <option value="">å…¨éƒ¨</option>
                                <option value="presales">å”®å‰</option>
                                <option value="aftersales">å”®å</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>ç­¾å•çŠ¶æ€</label>
                            <select id="filterSignedStatus">
                                <option value="">å…¨éƒ¨</option>
                                <option value="signed">å·²ç­¾å•</option>
                                <option value="pipeline">Pipeline</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>è¡Œä¸š</label>
                            <input type="text" id="filterIndustry" placeholder="æœç´¢è¡Œä¸š">
                        </div>
                        <div class="filter-group">
                            <label>å®¢æˆ·</label>
                            <input type="text" id="filterCustomer" placeholder="æœç´¢å®¢æˆ·">
                        </div>
                        <div class="filter-group">
                            <label>é”€å”®äººå‘˜</label>
                            <input type="text" id="filterSalesperson" placeholder="æœç´¢é”€å”®">
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰é’®ç»„ -->
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="applyFilters()">ğŸ” åº”ç”¨ç­›é€‰</button>
                        <button class="btn btn-secondary btn-sm" onclick="resetFilters()">â†º é‡ç½®ç­›é€‰</button>
                        <button class="btn btn-primary btn-sm" onclick="exportToExcel()">ğŸ“Š å¯¼å‡ºExcel</button>
                        <button class="btn btn-primary btn-sm" onclick="generateReport()">ğŸ“‹ ç”Ÿæˆå‘¨æŠ¥</button>
                        <button class="btn btn-primary btn-sm" onclick="importData()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
                    </div>
                    
                    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
                    <input type="file" id="importFile" style="display: none;" accept=".xlsx,.xls" onchange="handleFileImport(event)">

                    <!-- æ ¸å¿ƒç»Ÿè®¡ -->
                    <div class="dashboard-section">
                        <h3>æ ¸å¿ƒæŒ‡æ ‡</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">å”®å‰å·²ç­¾å•</div>
                                <div class="stat-value" id="signedAmount">Â£0.0K</div>
                                <div class="stat-sub"><span id="signedCount">0</span>ä¸ªé¡¹ç›®</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å”®å‰Pipeline</div>
                                <div class="stat-value" id="pipelineAmount">Â£0.0K</div>
                                <div class="stat-sub"><span id="pipelineCount">0</span>ä¸ªé¡¹ç›®</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å”®åé¡¹ç›®é‡‘é¢</div>
                                <div class="stat-value" id="aftersalesAmount">Â£0.0K</div>
                                <div class="stat-sub"><span id="aftersalesCount">0</span>ä¸ªé¡¹ç›®</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æ€»é¡¹ç›®é‡‘é¢</div>
                                <div class="stat-value" id="totalAmount">Â£0.0K</div>
                                <div class="stat-sub"><span id="totalCount">0</span>ä¸ªé¡¹ç›®</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æ€»å·¥ä½œæ—¶é•¿</div>
                                <div class="stat-value" id="totalWorkHours">0.0h</div>
                                <div class="stat-sub">çº¦<span id="workDays">0</span>å¤©</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æ€»åŠ ç­æ—¶é•¿</div>
                                <div class="stat-value" id="totalOvertimeHours">0.0h</div>
                                <div class="stat-sub">çº¦<span id="overtimeDays">0</span>å¤©</div>
                            </div>
                        </div>
                    </div>

                    <!-- æœ¬å‘¨ç»Ÿè®¡ -->
                    <div class="dashboard-section">
                        <h3>æœ¬å‘¨ç»Ÿè®¡</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">æœ¬å‘¨åŠ ç­æ—¶é•¿</div>
                                <div class="stat-value" id="weekOvertimeHours">0.0h</div>
                                <div class="stat-sub" id="weekRange">å‘¨æœŸï¼šæš‚æ— </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æœ¬å‘¨æ”¯æŒé¡¹ç›®æ•°</div>
                                <div class="stat-value" id="weekProjectCount">0</div>
                                <div class="stat-sub">æœ¬å‘¨æ”¯æŒ<span id="weekProjectCountDetail">0</span>ä¸ªé¡¹ç›®</div>
                            </div>
                        </div>
                    </div>

                    <!-- æŒ‰è¡Œä¸šç»Ÿè®¡ -->
                    <div class="dashboard-section">
                        <h3>æŒ‰è¡Œä¸šç»Ÿè®¡é‡‘é¢</h3>
                        <div id="industryStats" class="summary-grid">
                            <p style="color: #9ca3af;">æš‚æ— æ•°æ®</p>
                        </div>
                    </div>

                    <!-- æŒ‰å®¢æˆ·ç»Ÿè®¡ -->
                    <div class="dashboard-section">
                        <h3>æŒ‰å®¢æˆ·ç»Ÿè®¡é‡‘é¢</h3>
                        <div id="customerStats" class="summary-grid">
                            <p style="color: #9ca3af;">æš‚æ— æ•°æ®</p>
                        </div>
                    </div>

                    <!-- æŒ‰é”€å”®ç»Ÿè®¡ -->
                    <div class="dashboard-section">
                        <h3>æŒ‰é”€å”®äººå‘˜ç»Ÿè®¡é‡‘é¢</h3>
                        <div id="salespersonStats" class="summary-grid">
                            <p style="color: #9ca3af;">æš‚æ— æ•°æ®</p>
                        </div>
                    </div>

                    <div class="info-box">
                        <h3>âœ… ç³»ç»Ÿå·²å°±ç»ª</h3>
                        <p>âœ¨ æ‰€æœ‰åŠŸèƒ½å·²æ¿€æ´»ï¼Œç³»ç»Ÿå·²æˆåŠŸéƒ¨ç½²ï¼</p>
                        <p><strong>é¡¹ç›®IDï¼š</strong> weekly-report-d55e9</p>
                        <p><strong>æ•°æ®åº“ï¼š</strong> æœ¬åœ°å­˜å‚¨ï¼ˆlocalStorageï¼‰</p>
                    </div>
                </div>
            </div>

            <!-- æ·»åŠ é¡¹ç›® -->
            <div id="add-project" class="form-section">
                <div class="content">
                    <h2 style="margin-bottom: 20px;">æ·»åŠ æ–°é¡¹ç›®</h2>
                    <form id="projectForm" onsubmit="saveProject(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>å‘¨èµ·å§‹æ—¥æœŸ *</label>
                                <input type="date" id="weekStartDate" required>
                            </div>
                            <div class="form-group">
                                <label>å‘¨ç»“æŸæ—¥æœŸ</label>
                                <input type="date" id="weekEndDate">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>å®¢æˆ·åç§° *</label>
                                <input type="text" id="clientName" required>
                            </div>
                            <div class="form-group">
                                <label>é¡¹ç›®åç§° *</label>
                                <input type="text" id="projectName" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>è¡Œä¸š *</label>
                                <input type="text" id="industry" required>
                            </div>
                            <div class="form-group">
                                <label>å›½å®¶</label>
                                <input type="text" id="country">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>é¡¹ç›®è§„æ¨¡ (Â£K) *</label>
                                <input type="number" id="projectScale" step="0.1" required>
                            </div>
                            <div class="form-group">
                                <label>é¡¹ç›®ç±»å‹ *</label>
                                <select id="projectType" onchange="updateFormFields()" required>
                                    <option value="">-- è¯·é€‰æ‹© --</option>
                                    <option value="presales">å”®å‰</option>
                                    <option value="aftersales">å”®å</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>ä¸“ä¸šæ–¹å‘ *</label>
                                <select id="specialty" required>
                                    <option value="">-- è¯·é€‰æ‹© --</option>
                                    <option value="ç½‘ç»œ">ç½‘ç»œ</option>
                                    <option value="ç³»ç»Ÿ">ç³»ç»Ÿ</option>
                                    <option value="åŸºç¡€è®¾æ–½">åŸºç¡€è®¾æ–½</option>
                                </select>
                            </div>
                            <div id="signedStatusGroup" class="form-group">
                                <label>ç­¾å•çŠ¶æ€ *</label>
                                <select id="signedStatus">
                                    <option value="signed">å·²ç­¾å•</option>
                                    <option value="pipeline">Pipeline</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>é”€å”®äººå‘˜ *</label>
                                <input type="text" id="salesperson" required>
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>è¿›åº¦é˜¶æ®µ</label>
                                <input type="text" id="projectStage" placeholder="ä¾‹å¦‚ï¼šæŠ€æœ¯æ–¹æ¡ˆã€ç°åœºä¿éšœ">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>ä¸»å·¥ç¨‹å¸ˆ</label>
                                <input type="text" id="engineerName">
                            </div>
                            <div class="form-group">
                                <label>åˆä½œå·¥ç¨‹å¸ˆ</label>
                                <input type="text" id="collaborators" placeholder="å¤šä¸ªå·¥ç¨‹å¸ˆç”¨é€—å·åˆ†éš”">
                            </div>
                        </div>

                        <div class="form-buttons">
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">é‡ç½®</button>
                            <button type="submit" class="btn btn-primary">ä¿å­˜é¡¹ç›®</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- é¡¹ç›®åˆ—è¡¨ -->
            <div id="projects" class="form-section">
                <div class="content">
                    <h2 style="margin-bottom: 20px;">é¡¹ç›®ç®¡ç†</h2>
                    
                    <div class="controls">
                        <button class="btn btn-primary" onclick="switchTab('add-project')">+ æ·»åŠ é¡¹ç›®</button>
                        <div style="font-size: 13px; color: #6b7280;">å…± <span id="projectListCount">0</span> ä¸ªé¡¹ç›®</div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>å®¢æˆ·</th>
                                <th>é¡¹ç›®</th>
                                <th>è¡Œä¸š</th>
                                <th>è§„æ¨¡ (Â£K)</th>
                                <th>ç±»å‹</th>
                                <th>ç­¾å•çŠ¶æ€</th>
                                <th>ä¸“ä¸šæ–¹å‘</th>
                                <th>é”€å”®</th>
                                <th>å·¥ç¨‹å¸ˆ</th>
                                <th>å·¥ä½œæ—¶é•¿</th>
                                <th>åŠ ç­æ—¶é•¿</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <tr><td colspan="12" style="text-align: center; padding: 40px; color: #9ca3af;">æš‚æ— é¡¹ç›®</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘é¡¹ç›®æ¨¡æ€æ¡† -->
    <div id="editProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ç¼–è¾‘é¡¹ç›®ä¿¡æ¯</div>
            <form id="editProjectForm" onsubmit="updateProject(event)">
                <input type="hidden" id="editProjectIndex">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>å®¢æˆ·åç§° *</label>
                        <input type="text" id="editClientName" required>
                    </div>
                    <div class="form-group">
                        <label>é¡¹ç›®åç§° *</label>
                        <input type="text" id="editProjectName" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é¡¹ç›®è§„æ¨¡ (Â£K) *</label>
                        <input type="number" id="editProjectScale" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label>è¡Œä¸š *</label>
                        <input type="text" id="editIndustry" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é”€å”®äººå‘˜ *</label>
                        <input type="text" id="editSalesperson" required>
                    </div>
                    <div class="form-group">
                        <label>ä¸»å·¥ç¨‹å¸ˆ</label>
                        <input type="text" id="editEngineerName">
                    </div>
                </div>

                <div class="form-row full">
                    <div class="form-group">
                        <label>è¿›åº¦é˜¶æ®µ</label>
                        <input type="text" id="editProjectStage">
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeEditProjectModal()">å…³é—­</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å·¥ä½œè®°å½•æ¨¡æ€æ¡† -->
    <div id="workLogModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ç¼–è¾‘é¡¹ç›® - æ·»åŠ å·¥ä½œè®°å½•</div>
            <form id="workLogForm" onsubmit="saveWorkLog(event)">
                <input type="hidden" id="workLogProjectIndex">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>å·¥ä½œæ—¥æœŸ *</label>
                        <input type="date" id="workDate" required>
                    </div>
                    <div class="form-group">
                        <label>å¼€å§‹æ—¶é—´ *</label>
                        <input type="time" id="startTime" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ç»“æŸæ—¶é—´ *</label>
                        <input type="time" id="endTime" required>
                    </div>
                    <div class="form-group">
                        <label>å·¥ä½œç±»å‹</label>
                        <select id="workType">
                            <option value="normal">æ­£å¸¸å·¥ä½œ</option>
                            <option value="overtime">åŠ ç­</option>
                        </select>
                    </div>
                </div>

                <div class="form-row full">
                    <div class="form-group">
                        <label>å·¥ä½œå†…å®¹</label>
                        <textarea id="workContent" placeholder="è®°å½•æœ¬æ¬¡å·¥ä½œçš„è¯¦ç»†å†…å®¹"></textarea>
                    </div>
                </div>

                <div style="background: #f9fafb; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                    <strong style="font-size: 13px;">è®¡ç®—ç»“æœï¼š</strong>
                    <div style="font-size: 13px; margin-top: 4px;">
                        <span id="calculatedHours">0.0</span> å°æ—¶
                        <span id="workTypeLabel" style="font-size: 12px; background: #e0e7ff; color: #2563eb; padding: 2px 6px; border-radius: 3px; margin-left: 8px;">æ­£å¸¸å·¥ä½œ</span>
                    </div>
                </div>

                <div id="workLogsList" style="margin-bottom: 16px; max-height: 200px; overflow-y: auto;"></div>

                <div style="display: flex; gap: 12px;">
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeWorkLogModal()">å…³é—­</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">æ·»åŠ å·¥ä½œè®°å½•</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let projects = [];
        let filteredProjects = [];

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            const today = new Date();
            document.getElementById('weekStartDate').valueAsDate = today;
            document.getElementById('workDate').valueAsDate = today;
            
            // è®¾ç½®ç­›é€‰æ¡ä»¶çš„é»˜è®¤æ—¥æœŸ
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            document.getElementById('filterStartDate').valueAsDate = startOfWeek;
            document.getElementById('filterEndDate').valueAsDate = endOfWeek;
        });

        // Googleç™»å½•
        async function signInWithGoogle() {
            try {
                if (typeof google === 'undefined') {
                    setTimeout(signInWithGoogle, 1000);
                    return;
                }

                google.accounts.id.initialize({
                    client_id: '1018033981926-cg6bl58ehp3kpm0rlcr7vlgeg8iore3g.apps.googleusercontent.com',
                    callback: handleCredentialResponse,
                    auto_select: false
                });

                google.accounts.id.prompt();

            } catch (e) {
                alert('ç™»å½•å¤±è´¥: ' + e.message);
            }
        }

        // å¤„ç†Googleå“åº”
        function handleCredentialResponse(response) {
            try {
                const base64Url = response.credential.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(
                    atob(base64).split('').map(c => 
                        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                    ).join('')
                );
                
                currentUser = JSON.parse(jsonPayload);
                showMainPage();
                loadProjects();
                
            } catch(e) {
                alert('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥');
            }
        }

        // æ˜¾ç¤ºä¸»é¡µ
        function showMainPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainPage').classList.add('active');
            document.getElementById('userSection').style.display = 'flex';
            
            const name = currentUser.name || currentUser.email;
            document.getElementById('userName').textContent = name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
        }

        // åˆ‡æ¢é€‰é¡¹å¡
        function switchTab(tabName) {
            document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.dashboard').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            if (tabName === 'dashboard') {
                document.getElementById('dashboard').classList.add('active');
                updateDashboard();
            } else if (tabName === 'add-project') {
                document.getElementById('add-project').classList.add('active');
            } else if (tabName === 'projects') {
                document.getElementById('projects').classList.add('active');
                renderProjectsList();
            }
            
            event.target.classList.add('active');
        }

        // æ›´æ–°è¡¨å•å­—æ®µ
        function updateFormFields() {
            const projectType = document.getElementById('projectType').value;
            const signedStatusGroup = document.getElementById('signedStatusGroup');
            
            if (projectType === 'aftersales') {
                signedStatusGroup.style.display = 'none';
            } else {
                signedStatusGroup.style.display = 'block';
            }
        }

        // è®¡ç®—æ—¶é—´
        document.addEventListener('change', function(e) {
            if (e.target.id === 'startTime' || e.target.id === 'endTime') {
                calculateHours();
            }
            if (e.target.id === 'workType') {
                updateWorkTypeLabel();
            }
        });

        function calculateHours() {
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;
            
            if (!start || !end) return;
            
            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);
            
            const startMinutes = startH * 60 + startM;
            const endMinutes = endH * 60 + endM;
            const diffMinutes = endMinutes - startMinutes;
            const hours = (diffMinutes / 60).toFixed(1);
            
            document.getElementById('calculatedHours').textContent = hours;
        }

        function updateWorkTypeLabel() {
            const type = document.getElementById('workType').value;
            const label = document.getElementById('workTypeLabel');
            if (type === 'overtime') {
                label.textContent = 'åŠ ç­';
            } else {
                label.textContent = 'æ­£å¸¸å·¥ä½œ';
            }
        }

        // åŠ è½½é¡¹ç›®
        function loadProjects() {
            const saved = localStorage.getItem('projects_' + currentUser.email);
            projects = saved ? JSON.parse(saved) : [];
            filteredProjects = projects;
            updateDashboard();
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            const startDate = document.getElementById('filterStartDate').value ? new Date(document.getElementById('filterStartDate').value) : null;
            const endDate = document.getElementById('filterEndDate').value ? new Date(document.getElementById('filterEndDate').value) : null;
            const projectType = document.getElementById('filterProjectType').value;
            const signedStatus = document.getElementById('filterSignedStatus').value;
            const industry = document.getElementById('filterIndustry').value.toLowerCase();
            const customer = document.getElementById('filterCustomer').value.toLowerCase();
            const salesperson = document.getElementById('filterSalesperson').value.toLowerCase();
            
            filteredProjects = projects.filter(p => {
                const pDate = new Date(p.weekStartDate);
                
                if (startDate && pDate < startDate) return false;
                if (endDate && pDate > endDate) return false;
                if (projectType && p.projectType !== projectType) return false;
                if (signedStatus && p.signedStatus !== signedStatus) return false;
                if (industry && !p.industry.toLowerCase().includes(industry)) return false;
                if (customer && !p.clientName.toLowerCase().includes(customer)) return false;
                if (salesperson && !p.salesperson.toLowerCase().includes(salesperson)) return false;
                
                return true;
            });
            
            updateDashboard();
            alert('ç­›é€‰å®Œæˆï¼å…± ' + filteredProjects.length + ' ä¸ªé¡¹ç›®');
        }

        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.getElementById('filterProjectType').value = '';
            document.getElementById('filterSignedStatus').value = '';
            document.getElementById('filterIndustry').value = '';
            document.getElementById('filterCustomer').value = '';
            document.getElementById('filterSalesperson').value = '';
            
            filteredProjects = projects;
            updateDashboard();
            alert('ç­›é€‰å·²é‡ç½®ï¼');
        }

        // å¯¼å‡ºExcel
        function exportToExcel() {
            if (filteredProjects.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }
            
            const data = filteredProjects.map(p => ({
                'å®¢æˆ·': p.clientName,
                'é¡¹ç›®': p.projectName,
                'è¡Œä¸š': p.industry,
                'è§„æ¨¡(Â£K)': p.projectScale,
                'ç±»å‹': p.projectType === 'presales' ? 'å”®å‰' : 'å”®å',
                'ç­¾å•çŠ¶æ€': p.signedStatus === 'signed' ? 'å·²ç­¾å•' : 'Pipeline',
                'ä¸“ä¸šæ–¹å‘': p.specialty,
                'é”€å”®': p.salesperson,
                'å·¥ç¨‹å¸ˆ': p.engineerName || '',
                'å‘¨èµ·å§‹æ—¥æœŸ': p.weekStartDate,
                'å·¥ä½œæ—¶é•¿(h)': p.workLogs ? p.workLogs.reduce((sum, log) => sum + (log.type === 'normal' ? parseFloat(log.hours) : 0), 0).toFixed(1) : '0',
                'åŠ ç­æ—¶é•¿(h)': p.workLogs ? p.workLogs.reduce((sum, log) => sum + (log.type === 'overtime' ? parseFloat(log.hours) : 0), 0).toFixed(1) : '0'
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "é¡¹ç›®æ•°æ®");
            XLSX.writeFile(wb, 'ä¼ä¸šå·¥ä½œå‘¨æŠ¥_' + new Date().getTime() + '.xlsx');
            
            alert('å¯¼å‡ºæˆåŠŸï¼');
        }

        // ç”Ÿæˆå‘¨æŠ¥
        function generateReport() {
            if (filteredProjects.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯ç”Ÿæˆå‘¨æŠ¥ï¼');
                return;
            }
            
            let reportHTML = '<h2>ä¼ä¸šå·¥ä½œå‘¨æŠ¥</h2>';
            reportHTML += '<p>ç”Ÿæˆæ—¶é—´ï¼š' + new Date().toLocaleString('zh-CN') + '</p>';
            reportHTML += '<table border="1" cellpadding="5"><tr><th>å®¢æˆ·</th><th>é¡¹ç›®</th><th>è§„æ¨¡</th><th>å·¥ä½œæ—¶é•¿</th><th>åŠ ç­æ—¶é•¿</th></tr>';
            
            filteredProjects.forEach(p => {
                const workHours = p.workLogs ? p.workLogs.reduce((sum, log) => sum + (log.type === 'normal' ? parseFloat(log.hours) : 0), 0).toFixed(1) : '0';
                const overtimeHours = p.workLogs ? p.workLogs.reduce((sum, log) => sum + (log.type === 'overtime' ? parseFloat(log.hours) : 0), 0).toFixed(1) : '0';
                
                reportHTML += '<tr><td>' + p.clientName + '</td><td>' + p.projectName + '</td><td>Â£' + p.projectScale + 'K</td><td>' + workHours + 'h</td><td>' + overtimeHours + 'h</td></tr>';
            });
            
            reportHTML += '</table>';
            
            const printWindow = window.open('', 'å‘¨æŠ¥', 'width=800,height=600');
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            printWindow.print();
        }

        // å¯¼å…¥æ•°æ®
        function importData() {
            document.getElementById('importFile').click();
        }

        // å¤„ç†æ–‡ä»¶å¯¼å…¥
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    
                    json.forEach(item => {
                        const project = {
                            weekStartDate: item['å‘¨èµ·å§‹æ—¥æœŸ'] || new Date().toISOString().split('T')[0],
                            clientName: item['å®¢æˆ·'] || '',
                            projectName: item['é¡¹ç›®'] || '',
                            industry: item['è¡Œä¸š'] || '',
                            projectScale: item['è§„æ¨¡(Â£K)'] || 0,
                            projectType: item['ç±»å‹'] === 'å”®å' ? 'aftersales' : 'presales',
                            signedStatus: item['ç­¾å•çŠ¶æ€'] === 'å·²ç­¾å•' ? 'signed' : 'pipeline',
                            specialty: item['ä¸“ä¸šæ–¹å‘'] || '',
                            salesperson: item['é”€å”®'] || '',
                            engineerName: item['å·¥ç¨‹å¸ˆ'] || '',
                            workLogs: [],
                            createdAt: new Date().toISOString()
                        };
                        
                        projects.push(project);
                    });
                    
                    localStorage.setItem('projects_' + currentUser.email, JSON.stringify(projects));
                    filteredProjects = projects;
                    updateDashboard();
                    renderProjectsList();
                    alert('å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ' + json.length + ' ä¸ªé¡¹ç›®');
                    
                } catch(error) {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                }
                
                document.getElementById('importFile').value = '';
            };
            
            reader.readAsArrayBuffer(file);
        }

        // æ›´æ–°ä»ªè¡¨æ¿
        function updateDashboard() {
            const presalesSigned = filteredProjects.filter(p => p.projectType === 'presales' && p.signedStatus === 'signed');
            const presalesPipeline = filteredProjects.filter(p => p.projectType === 'presales' && p.signedStatus === 'pipeline');
            const aftersales = filteredProjects.filter(p => p.projectType === 'aftersales');
            
            const signedAmount = presalesSigned.reduce((sum, p) => sum + parseFloat(p.projectScale || 0), 0);
            const pipelineAmount = presalesPipeline.reduce((sum, p) => sum + parseFloat(p.projectScale || 0), 0);
            const aftersalesAmount = aftersales.reduce((sum, p) => sum + parseFloat(p.projectScale || 0), 0);
            const totalAmount = signedAmount + pipelineAmount + aftersalesAmount;
            
            let totalWorkHours = 0, totalOvertimeHours = 0;
            filteredProjects.forEach(p => {
                if (p.workLogs) {
                    p.workLogs.forEach(log => {
                        const hours = parseFloat(log.hours || 0);
                        if (log.type === 'overtime') {
                            totalOvertimeHours += hours;
                        } else {
                            totalWorkHours += hours;
                        }
                    });
                }
            });
            
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            let weekOvertimeHours = 0;
            let weekProjectSet = new Set();
            
            filteredProjects.forEach(p => {
                if (p.workLogs) {
                    p.workLogs.forEach(log => {
                        const logDate = new Date(log.date);
                        if (logDate >= startOfWeek && logDate <= endOfWeek) {
                            if (log.type === 'overtime') {
                                weekOvertimeHours += parseFloat(log.hours || 0);
                            }
                            weekProjectSet.add(p.clientName + '-' + p.projectName);
                        }
                    });
                }
            });
            
            document.getElementById('signedAmount').textContent = 'Â£' + signedAmount.toFixed(1) + 'K';
            document.getElementById('signedCount').textContent = presalesSigned.length;
            document.getElementById('pipelineAmount').textContent = 'Â£' + pipelineAmount.toFixed(1) + 'K';
            document.getElementById('pipelineCount').textContent = presalesPipeline.length;
            document.getElementById('aftersalesAmount').textContent = 'Â£' + aftersalesAmount.toFixed(1) + 'K';
            document.getElementById('aftersalesCount').textContent = aftersales.length;
            document.getElementById('totalAmount').textContent = 'Â£' + totalAmount.toFixed(1) + 'K';
            document.getElementById('totalCount').textContent = filteredProjects.length;
            document.getElementById('totalWorkHours').textContent = totalWorkHours.toFixed(1) + 'h';
            document.getElementById('workDays').textContent = Math.round(totalWorkHours / 8);
            document.getElementById('totalOvertimeHours').textContent = totalOvertimeHours.toFixed(1) + 'h';
            document.getElementById('overtimeDays').textContent = Math.round(totalOvertimeHours / 8);
            document.getElementById('weekOvertimeHours').textContent = weekOvertimeHours.toFixed(1) + 'h';
            document.getElementById('weekRange').textContent = 'å‘¨æœŸï¼š' + startOfWeek.toLocaleDateString('zh-CN') + ' åˆ° ' + endOfWeek.toLocaleDateString('zh-CN');
            document.getElementById('weekProjectCount').textContent = weekProjectSet.size;
            document.getElementById('weekProjectCountDetail').textContent = weekProjectSet.size;
            
            const industryMap = {};
            filteredProjects.forEach(p => {
                if (!industryMap[p.industry]) industryMap[p.industry] = 0;
                industryMap[p.industry] += parseFloat(p.projectScale || 0);
            });
            
            let industryHTML = '';
            Object.entries(industryMap).forEach(([industry, amount]) => {
                industryHTML += `<div class="summary-card"><strong>${industry}</strong><div class="amount">Â£${amount.toFixed(1)}K</div></div>`;
            });
            document.getElementById('industryStats').innerHTML = industryHTML || '<p style="color: #9ca3af;">æš‚æ— æ•°æ®</p>';
            
            const customerMap = {};
            filteredProjects.forEach(p => {
                if (!customerMap[p.clientName]) customerMap[p.clientName] = 0;
                customerMap[p.clientName] += parseFloat(p.projectScale || 0);
            });
            
            let customerHTML = '';
            Object.entries(customerMap).forEach(([customer, amount]) => {
                customerHTML += `<div class="summary-card"><strong>${customer}</strong><div class="amount">Â£${amount.toFixed(1)}K</div></div>`;
            });
            document.getElementById('customerStats').innerHTML = customerHTML || '<p style="color: #9ca3af;">æš‚æ— æ•°æ®</p>';
            
            const salespersonMap = {};
            filteredProjects.forEach(p => {
                if (!salespersonMap[p.salesperson]) salespersonMap[p.salesperson] = 0;
                salespersonMap[p.salesperson] += parseFloat(p.projectScale || 0);
            });
            
            let salespersonHTML = '';
            Object.entries(salespersonMap).forEach(([salesperson, amount]) => {
                salespersonHTML += `<div class="summary-card"><strong>${salesperson}</strong><div class="amount">Â£${amount.toFixed(1)}K</div></div>`;
            });
            document.getElementById('salespersonStats').innerHTML = salespersonHTML || '<p style="color: #9ca3af;">æš‚æ— æ•°æ®</p>';
        }

        // æ¸²æŸ“é¡¹ç›®åˆ—è¡¨
        function renderProjectsList() {
            const tbody = document.getElementById('projectsTableBody');
            
            if (projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 40px; color: #9ca3af;">æš‚æ— é¡¹ç›®</td></tr>';
                document.getElementById('projectListCount').textContent = '0';
                return;
            }

            let html = '';
            projects.forEach((project, index) => {
                let workHours = 0, overtimeHours = 0;
                if (project.workLogs) {
                    project.workLogs.forEach(log => {
                        const hours = parseFloat(log.hours || 0);
                        if (log.type === 'overtime') {
                            overtimeHours += hours;
                        } else {
                            workHours += hours;
                        }
                    });
                }
                
                const typeBadge = `<span class="badge ${project.projectType === 'presales' ? 'badge-presales' : 'badge-aftersales'}">${project.projectType === 'presales' ? 'å”®å‰' : 'å”®å'}</span>`;
                const statusBadge = project.projectType === 'aftersales' ? '-' : `<span class="badge ${project.signedStatus === 'signed' ? 'badge-signed' : 'badge-pipeline'}">${project.signedStatus === 'signed' ? 'å·²ç­¾å•' : 'Pipeline'}</span>`;
                
                html += `
                    <tr>
                        <td>${project.clientName}</td>
                        <td>${project.projectName}</td>
                        <td>${project.industry}</td>
                        <td>Â£${parseFloat(project.projectScale).toFixed(1)}K</td>
                        <td>${typeBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${project.specialty}</td>
                        <td>${project.salesperson}</td>
                        <td>${project.engineerName || '-'}</td>
                        <td>${workHours.toFixed(1)}h</td>
                        <td><span style="color: #ef4444; font-weight: 700;">${overtimeHours.toFixed(1)}h</span></td>
                        <td style="display: flex; gap: 4px;">
                            <button class="btn btn-primary btn-sm" onclick="openEditProjectModal(${index})">ç¼–è¾‘</button>
                            <button class="btn btn-edit btn-sm" onclick="openWorkLogModal(${index})">å·¥ä½œ</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProject(${index})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            document.getElementById('projectListCount').textContent = projects.length;
        }

        // æ‰“å¼€ç¼–è¾‘é¡¹ç›®æ¨¡æ€æ¡†
        function openEditProjectModal(index) {
            document.getElementById('editProjectIndex').value = index;
            const project = projects[index];
            
            document.getElementById('editClientName').value = project.clientName;
            document.getElementById('editProjectName').value = project.projectName;
            document.getElementById('editProjectScale').value = project.projectScale;
            document.getElementById('editIndustry').value = project.industry;
            document.getElementById('editSalesperson').value = project.salesperson;
            document.getElementById('editEngineerName').value = project.engineerName || '';
            document.getElementById('editProjectStage').value = project.projectStage || '';
            
            document.getElementById('editProjectModal').classList.add('active');
        }

        // å…³é—­ç¼–è¾‘é¡¹ç›®æ¨¡æ€æ¡†
        function closeEditProjectModal() {
            document.getElementById('editProjectModal').classList.remove('active');
        }

        // æ›´æ–°é¡¹ç›®
        function updateProject(e) {
            e.preventDefault();
            
            const index = parseInt(document.getElementById('editProjectIndex').value);
            projects[index].clientName = document.getElementById('editClientName').value;
            projects[index].projectName = document.getElementById('editProjectName').value;
            projects[index].projectScale = document.getElementById('editProjectScale').value;
            projects[index].industry = document.getElementById('editIndustry').value;
            projects[index].salesperson = document.getElementById('editSalesperson').value;
            projects[index].engineerName = document.getElementById('editEngineerName').value;
            projects[index].projectStage = document.getElementById('editProjectStage').value;
            
            localStorage.setItem('projects_' + currentUser.email, JSON.stringify(projects));
            alert('é¡¹ç›®å·²æ›´æ–°ï¼');
            
            closeEditProjectModal();
            filteredProjects = projects;
            renderProjectsList();
            updateDashboard();
        }

        // æ‰“å¼€å·¥ä½œè®°å½•æ¨¡æ€æ¡†
        function openWorkLogModal(index) {
            document.getElementById('workLogProjectIndex').value = index;
            const project = projects[index];
            
            let logsHTML = '';
            if (project.workLogs) {
                project.workLogs.forEach((log, i) => {
                    logsHTML += `
                        <div class="work-log-item">
                            <div class="time">${log.date} ${log.startTime}-${log.endTime}</div>
                            <div>${log.content || 'æ— '}</div>
                            <div style="margin-top: 4px;">
                                <span class="hours">${log.hours}h</span>
                                <span class="type">${log.type === 'overtime' ? 'åŠ ç­' : 'æ­£å¸¸'}</span>
                                <button type="button" class="btn btn-danger" style="float: right; padding: 2px 8px; font-size: 11px;" onclick="deleteWorkLog(${index}, ${i})">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('workLogsList').innerHTML = logsHTML;
            
            document.getElementById('workLogModal').classList.add('active');
        }

        // å…³é—­å·¥ä½œè®°å½•æ¨¡æ€æ¡†
        function closeWorkLogModal() {
            document.getElementById('workLogModal').classList.remove('active');
            document.getElementById('workLogForm').reset();
        }

        // ä¿å­˜å·¥ä½œè®°å½•
        function saveWorkLog(e) {
            e.preventDefault();
            
            const projectIndex = parseInt(document.getElementById('workLogProjectIndex').value);
            const workDate = document.getElementById('workDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const workType = document.getElementById('workType').value;
            const workContent = document.getElementById('workContent').value;
            const hours = parseFloat(document.getElementById('calculatedHours').textContent);
            
            if (!projects[projectIndex].workLogs) {
                projects[projectIndex].workLogs = [];
            }
            
            projects[projectIndex].workLogs.push({
                date: workDate,
                startTime: startTime,
                endTime: endTime,
                type: workType,
                content: workContent,
                hours: hours
            });
            
            localStorage.setItem('projects_' + currentUser.email, JSON.stringify(projects));
            alert('å·¥ä½œè®°å½•å·²æ·»åŠ ï¼');
            
            document.getElementById('workLogForm').reset();
            openWorkLogModal(projectIndex);
            filteredProjects = projects;
            renderProjectsList();
            updateDashboard();
        }

        // åˆ é™¤å·¥ä½œè®°å½•
        function deleteWorkLog(projectIndex, logIndex) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥å·¥ä½œè®°å½•å—ï¼Ÿ')) return;
            projects[projectIndex].workLogs.splice(logIndex, 1);
            localStorage.setItem('projects_' + currentUser.email, JSON.stringify(projects));
            openWorkLogModal(projectIndex);
            filteredProjects = projects;
            renderProjectsList();
            updateDashboard();
        }

        // ä¿å­˜é¡¹ç›®
        function saveProject(e) {
            e.preventDefault();
            
            const newProject = {
                weekStartDate: document.getElementById('weekStartDate').value,
                weekEndDate: document.getElementById('weekEndDate').value,
                clientName: document.getElementById('clientName').value,
                projectName: document.getElementById('projectName').value,
                industry: document.getElementById('industry').value,
                country: document.getElementById('country').value,
                projectScale: document.getElementById('projectScale').value,
                specialty: document.getElementById('specialty').value,
                projectType: document.getElementById('projectType').value,
                signedStatus: document.getElementById('projectType').value === 'presales' ? document.getElementById('signedStatus').value : 'n/a',
                projectStage: document.getElementById('projectStage').value,
                salesperson: document.getElementById('salesperson').value,
                engineerName: document.getElementById('engineerName').value,
                collaborators: document.getElementById('collaborators').value,
                workLogs: [],
                createdAt: new Date().toISOString()
            };

            projects.push(newProject);
            localStorage.setItem('projects_' + currentUser.email, JSON.stringify(projects));
            
            alert('é¡¹ç›®å·²ä¿å­˜ï¼');
            resetForm();
            filteredProjects = projects;
            updateDashboard();
            switchTab('projects');
        }

        // åˆ é™¤é¡¹ç›®
        function deleteProject(index) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥é¡¹ç›®å—ï¼Ÿ')) return;
            projects.splice(index, 1);
            localStorage.setItem('projects_' + currentUser.email, JSON.stringify(projects));
            filteredProjects = projects;
            renderProjectsList();
            updateDashboard();
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('projectForm').reset();
            const today = new Date();
            document.getElementById('weekStartDate').valueAsDate = today;
        }

        // ç™»å‡º
        function logout() {
            currentUser = null;
            document.getElementById('mainPage').classList.remove('active');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('userSection').style.display = 'none';
        }
    </script>
</body>
</html>
