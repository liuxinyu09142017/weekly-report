<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ V11 - ç¨³å®šç‰ˆ</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #1f2937;
            --secondary: #374151;
            --accent: #2563eb;
            --border: #e5e7eb;
            --bg-light: #f9fafb;
            --text-dark: #111827;
            --success: #10b981;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            margin: 0;
            padding: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            min-height: 80vh;
        }

        /* ç™»å½•é¡µæ ·å¼ */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 80vh;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            background: var(--primary);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px 12px 0 0;
        }

        .user-pill {
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .role-badge {
            background: var(--accent);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .main-content { padding: 24px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border); color: #6b7280; font-size: 13px; }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-outline { border: 1px solid var(--border); background: white; }
        .btn-danger { color: var(--danger); background: none; }

        /* æ¨¡æ€æ¡† */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; }
        .modal.active { display: flex; }
        .modal-content { background:white; padding:24px; border-radius:12px; width:400px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display:block; margin-bottom:5px; font-size:12px; font-weight:600; }
        .form-group input, .form-group select { width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="container">
        <div id="authCheck" style="text-align: center; padding: 50px;">æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</div>

        <div id="loginPage" class="login-container" style="display: none;">
            <h1 style="font-size: 40px; margin-bottom: 10px;">ğŸ“Š</h1>
            <h2>ä¼ä¸šå‘¨æŠ¥ç®¡ç†ç³»ç»Ÿ</h2>
            <p style="color: #6b7280; margin-bottom: 30px;">è¯·ä½¿ç”¨ Google è´¦å·ç™»å½•ä»¥åŒæ­¥äº‘ç«¯æ•°æ®</p>
            <button class="btn btn-primary" onclick="signIn()" style="padding: 12px 30px; font-size: 16px;">
                Google è´¦å·ä¸€é”®ç™»å½•
            </button>
        </div>

        <div id="mainPage" style="display: none;">
            <div class="header">
                <div>
                    <h2 style="margin: 0; font-size: 18px;">å‘¨æŠ¥æ¦‚è§ˆ</h2>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div class="user-pill">
                        <span id="userEmail">---</span>
                        <span id="roleLabel" class="role-badge">å·¥ç¨‹å¸ˆ</span>
                    </div>
                    <button class="btn btn-outline" style="font-size: 12px;" onclick="signOut()">ç™»å‡º</button>
                </div>
            </div>

            <div class="main-content">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn btn-primary" onclick="toggleModal(true)">+ æ–°å¢é¡¹ç›®æ¡ç›®</button>
                    <div id="statsInfo" style="font-size: 14px; color: #6b7280;"></div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>å®¢æˆ·åç§°</th>
                            <th>é¡¹ç›®åç§°</th>
                            <th>è§„æ¨¡ (KÂ£)</th>
                            <th>å·¥ç¨‹å¸ˆ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr><td colspan="5" style="text-align: center; color: #9ca3af; padding: 40px;">æš‚æ— å‘¨æŠ¥æ¡ç›®ï¼Œè¯·ç‚¹å‡»æ–°å¢</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top: 0;">æ–°å¢å‘¨æŠ¥é¡¹</h3>
            <form id="projectForm">
                <div class="form-group">
                    <label>å®¢æˆ·åç§° *</label>
                    <input type="text" id="clientName" required placeholder="ä¾‹å¦‚ï¼šæŸå¤§å‹é“¶è¡Œ">
                </div>
                <div class="form-group">
                    <label>é¡¹ç›®åç§° *</label>
                    <input type="text" id="projectName" required placeholder="ä¾‹å¦‚ï¼šæ ¸å¿ƒç½‘ç»œå‡çº§">
                </div>
                <div class="form-group">
                    <label>é¡¹ç›®è§„æ¨¡ (KÂ£) *</label>
                    <input type="number" id="projectScale" step="0.1" required>
                </div>
                <div class="form-group">
                    <label>ä¸“ä¸šæ–¹å‘</label>
                    <select id="specialty">
                        <option value="ç½‘ç»œ">ç½‘ç»œ</option>
                        <option value="ç³»ç»Ÿ">ç³»ç»Ÿ</option>
                        <option value="åŸºç¡€è®¾æ–½">åŸºç¡€è®¾æ–½</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-outline" style="flex: 1;" onclick="toggleModal(false)">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">ä¿å­˜æ¡ç›®</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- 1. åˆå§‹åŒ– Firebase (é…ç½®æ¥è‡ªä½ æä¾›çš„å›¾ç‰‡) ---
const firebaseConfig = {
    apiKey: "AIzaSyBzcAr_OJFdIMnaYXRCE7TJs2qLK_TAy9U",
    authDomain: "weekly-report-d55e9.firebaseapp.com",
    projectId: "weekly-report-d55e9",
    storageBucket: "weekly-report-d55e9.firebasestorage.app",
    messagingSenderId: "315332641675",
    appId: "1:315332641675:web:1f8ab523df0b86a47c258e",
    measurementId: "G-ZBYL1WTJNK"

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let isAdmin = false;

        // --- 2. èº«ä»½éªŒè¯é€»è¾‘ ---
        auth.onAuthStateChanged(async (user) => {
            document.getElementById('authCheck').style.display = 'none';
            if (user) {
                currentUser = user;
                // åˆ¤æ–­æ˜¯å¦ä¸ºç®¡ç†å‘˜ (åœ¨æ­¤å¤„ç¡¬ç¼–ç ä½ çš„é‚®ç®±ï¼Œæˆ–ä¹‹ååœ¨ Firestore å»ºç«‹ admin é›†åˆ)
                isAdmin = (user.email === "liuxinyu0914@gmail.com"); 
                
                showUI('mainPage');
                document.getElementById('userEmail').innerText = user.email;
                document.getElementById('roleLabel').innerText = isAdmin ? "ç®¡ç†å‘˜" : "å·¥ç¨‹å¸ˆ";
                loadData();
            } else {
                showUI('loginPage');
            }
        });

        async function signIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try { await auth.signInWithPopup(provider); } 
            catch (e) { alert("ç™»å½•å¤±è´¥: " + e.message); }
        }

        function signOut() { auth.signOut(); }

        // --- 3. æ•°æ®è¯»å†™é€»è¾‘ ---
        async function loadData() {
            const tbody = document.getElementById('dataTableBody');
            try {
                let query = db.collection('projects');
                
                // é€»è¾‘é™åˆ¶ï¼šéç®¡ç†å‘˜åªèƒ½çœ‹åˆ°è‡ªå·±æäº¤çš„å‘¨æŠ¥
                if (!isAdmin) {
                    query = query.where('uid', '==', currentUser.uid);
                }

                const snapshot = await query.orderBy('createdAt', 'desc').get();
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #9ca3af; padding: 40px;">æš‚æ— æ¡ç›®</td></tr>';
                    return;
                }

                let html = '';
                let totalAmount = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    totalAmount += parseFloat(data.projectScale || 0);
                    html += `
                        <tr>
                            <td>${data.clientName}</td>
                            <td>${data.projectName}</td>
                            <td>Â£${data.projectScale}K</td>
                            <td>${data.userName || 'æœªçŸ¥'}</td>
                            <td>
                                <button class="btn btn-danger" style="font-size: 12px;" onclick="deleteItem('${doc.id}')">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;
                document.getElementById('statsInfo').innerText = `å½“å‰ç»Ÿè®¡ï¼š${snapshot.size} ä¸ªé¡¹ç›® | æ€»é‡‘é¢ï¼šÂ£${totalAmount.toFixed(1)}K`;
            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Firestore å®‰å…¨è§„åˆ™ã€‚</td></tr>`;
            }
        }

        document.getElementById('projectForm').onsubmit = async (e) => {
            e.preventDefault();
            const newItem = {
                clientName: document.getElementById('clientName').value,
                projectName: document.getElementById('projectName').value,
                projectScale: parseFloat(document.getElementById('projectScale').value),
                specialty: document.getElementById('specialty').value,
                uid: currentUser.uid,
                userName: currentUser.displayName || currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('projects').add(newItem);
                toggleModal(false);
                document.getElementById('projectForm').reset();
                loadData();
            } catch (e) {
                alert("ä¿å­˜å¤±è´¥ï¼Œè¯·ç¡®è®¤ Firestore å†™å…¥æƒé™å·²å¼€å¯ã€‚");
            }
        };

        async function deleteItem(id) {
            if (confirm("ç¡®å®šåˆ é™¤è¯¥æ¡ç›®å—ï¼Ÿ")) {
                await db.collection('projects').doc(id).delete();
                loadData();
            }
        }

        // --- 4. è¾…åŠ©å‡½æ•° ---
        function showUI(id) {
            document.getElementById('loginPage').style.display = (id === 'loginPage' ? 'flex' : 'none');
            document.getElementById('mainPage').style.display = (id === 'mainPage' ? 'block' : 'none');
        }

        function toggleModal(show) {
            document.getElementById('addModal').classList.toggle('active', show);
        }
    </script>
</body>
</html>
