<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ä¸šçº§å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ V11 - ç¨³å®šç‰ˆ</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* ä¿ç•™ä½ åŸæœ‰çš„ CSS æ ·å¼ï¼Œæ­¤å¤„çœç•¥ä»¥èŠ‚çœç©ºé—´ï¼Œå»ºè®®ç›´æ¥ç²˜è´´åŸä»£ç æ ·å¼ */
        :root { --primary: #1f2937; --accent: #2563eb; --bg-light: #f9fafb; --text-dark: #111827; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg-light); margin: 0; padding: 16px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: var(--primary); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--accent); color: white; }
        .main { padding: 20px; }
        /* ... å…¶ä»–æ ·å¼ä¿æŒä¸å˜ ... */
    </style>
</head>
<body>
    <div class="container">
        <div id="loginPage" class="login-page" style="padding: 100px 20px; text-align: center;">
            <h1 style="margin-bottom: 20px;">ğŸ“Š å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ</h1>
            <button class="btn btn-primary" onclick="signInWithGoogle()" style="font-size: 16px; padding: 12px 24px;">
                ä½¿ç”¨ Google è´¦å·ç™»å½•
            </button>
            <p id="loginStatus" style="margin-top: 20px; color: #666;"></p>
        </div>

        <div id="mainPage" style="display: none;">
            <div class="header">
                <div>
                    <h2 id="headerTitle">å·¥ä½œå‘¨æŠ¥ç³»ç»Ÿ</h2>
                    <p id="userEmailDisplay" style="font-size: 12px; opacity: 0.8;"></p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="roleBadge" style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; font-size: 12px;">å·¥ç¨‹å¸ˆ</span>
                    <button class="btn" style="background: #4b5563; color: white;" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>

            <div class="main">
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="openModal()">+ æ–°å¢å‘¨æŠ¥æ¡ç›®</button>
                </div>
                
                <div id="contentSection">
                    <table style="width: 100%; border-collapse: collapse;" id="projectTable">
                        <thead>
                            <tr style="background: #f3f4f6; text-align: left;">
                                <th style="padding: 12px;">å®¢æˆ·</th>
                                <th>é¡¹ç›®</th>
                                <th>é‡‘é¢</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- è¯·å°†æ­¤å¤„æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "ä½ çš„API_KEY",
            authDomain: "ä½ çš„é¡¹ç›®ID.firebaseapp.com",
            projectId: "ä½ çš„é¡¹ç›®ID",
            storageBucket: "ä½ çš„é¡¹ç›®ID.appspot.com",
            messagingSenderId: "ä½ çš„å‘é€è€…ID",
            appId: "ä½ çš„APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let userRole = 'engineer';

        // ç™»å½•é€»è¾‘
        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                console.log("ç™»å½•æˆåŠŸ");
            } catch (error) {
                alert("ç™»å½•å¤±è´¥: " + error.message);
            }
        }

        // è·å–è§’è‰²é€»è¾‘ (ä¼˜åŒ–ç‰ˆ)
        async function checkUserRole(email) {
            try {
                // é¢„è®¾ç®¡ç†å‘˜é‚®ç®± (ä½ å¯ä»¥ç›´æ¥åœ¨è¿™é‡Œç¡¬ç¼–ç ï¼Œä¹Ÿå¯ä»¥è¯»æ•°æ®åº“)
                const adminList = ['liuxinyu0914@gmail.com']; 
                if (adminList.includes(email)) {
                    return 'admin';
                }
                
                // å°è¯•ä» Firestore è·å–æ›´å¤šé…ç½®
                const doc = await db.collection('config').doc('settings').get();
                if (doc.exists) {
                    const data = doc.data();
                    if (data.adminEmails && data.adminEmails.includes(email)) return 'admin';
                    if (data.leaderEmails && data.leaderEmails.includes(email)) return 'leader';
                }
                return 'engineer';
            } catch (e) {
                console.warn("è§’è‰²æ£€æŸ¥å—é™ï¼Œé»˜è®¤ä¸ºå·¥ç¨‹å¸ˆ");
                return 'engineer';
            }
        }

        // ç›‘å¬ç™»å½•çŠ¶æ€
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                userRole = await checkUserRole(user.email);
                
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainPage').style.display = 'block';
                document.getElementById('userEmailDisplay').textContent = user.email;
                document.getElementById('roleBadge').textContent = userRole === 'admin' ? 'ç®¡ç†å‘˜' : 'å·¥ç¨‹å¸ˆ';
                
                loadData();
            } else {
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('mainPage').style.display = 'none';
            }
        });

        async function loadData() {
            const tbody = document.getElementById('projectsTableBody');
            tbody.innerHTML = '<tr><td colspan="4">åŠ è½½ä¸­...</td></tr>';
            
            try {
                let query = db.collection('projects');
                // å¦‚æœä¸æ˜¯ç®¡ç†å‘˜ï¼Œåªçœ‹è‡ªå·±çš„æ•°æ®
                if (userRole !== 'admin') {
                    query = query.where('userId', '==', currentUser.uid);
                }
                
                const snapshot = await query.orderBy('createdAt', 'desc').get();
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px;">${data.clientName}</td>
                            <td>${data.projectName}</td>
                            <td>Â£${data.projectScale}K</td>
                            <td><button onclick="deleteDoc('${doc.id}')" style="color:red; background:none; border:none; cursor:pointer;">åˆ é™¤</button></td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html || '<tr><td colspan="4">æš‚æ— æ•°æ®</td></tr>';
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="4">åŠ è½½å¤±è´¥: ${e.message}</td></tr>`;
            }
        }

        async function deleteDoc(id) {
            if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
                await db.collection('projects').doc(id).delete();
                loadData();
            }
        }

        function logout() {
            auth.signOut();
        }
    </script>
</body>
</html>