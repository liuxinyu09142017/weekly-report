<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºå·¥ä½œè®°å½• - å·¥ç¨‹å¸ˆå·¥æ—¶ç³»ç»Ÿ</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            padding-bottom: 50px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .form-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .form-card h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .form-subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .form-section {
            margin-bottom: 35px;
            border-left: 4px solid #667eea;
            padding-left: 20px;
        }
        
        .form-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row.three-col {
            grid-template-columns: 1fr 1fr 1fr;
        }
        
        .form-row.full {
            grid-template-columns: 1fr;
        }
        
        .form-group {
            margin-bottom: 0;
        }
        
        .form-label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .required {
            color: #f48771;
        }
        
        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .time-inputs {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
        }
        
        .time-separator {
            color: #666;
            font-weight: bold;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }
        
        .hours-display {
            background: #e7f3ff;
            border: 2px solid #569cd6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .hours-display h4 {
            color: #569cd6;
            margin-bottom: 15px;
        }
        
        .hours-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .hours-item {
            text-align: center;
        }
        
        .hours-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }
        
        .hours-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .cancel-btn {
            background: #f5f7fa;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .cancel-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 100px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }
        
        .message.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="header">
        <div class="header-content">
            <h2>ğŸ“ åˆ›å»ºå·¥ä½œè®°å½•</h2>
            <a href="dashboard.html" class="back-btn">â† è¿”å›ä¸»é¡µ</a>
        </div>
    </div>
    
    <!-- åŠ è½½ä¸­ -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>æ­£åœ¨åŠ è½½...</div>
    </div>
    
    <!-- ä¸»å†…å®¹ -->
    <div id="main-content" class="container" style="display: none;">
        <div class="form-card">
            <h1>æ–°å»ºå·¥ä½œè®°å½•</h1>
            <p class="form-subtitle">è®°å½•æœ¬æ¬¡å·¥ä½œçš„è¯¦ç»†ä¿¡æ¯</p>
            
            <div id="message" class="message"></div>
            
            <form id="work-record-form">
                <!-- å®¢æˆ·ä¿¡æ¯ -->
                <div class="form-section">
                    <h3>ğŸ¢ å®¢æˆ·ä¿¡æ¯</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">å®¢æˆ·åç§° <span class="required">*</span></label>
                            <input type="text" id="customer-name" class="form-input" 
                                   placeholder="ä¾‹å¦‚: æ‹›å•†é“¶è¡Œä¼¦æ•¦åˆ†è¡Œ" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å®¢æˆ·æ‰€å±è¡Œä¸š <span class="required">*</span></label>
                            <select id="customer-industry" class="form-select" required>
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="é‡‘è">é‡‘è</option>
                                <option value="åˆ¶é€ ">åˆ¶é€ </option>
                                <option value="é›¶å”®">é›¶å”®</option>
                                <option value="æ”¿åºœ">æ”¿åºœ</option>
                                <option value="æ•™è‚²">æ•™è‚²</option>
                                <option value="åŒ»ç–—">åŒ»ç–—</option>
                                <option value="èƒ½æº">èƒ½æº</option>
                                <option value="è¿è¾“">è¿è¾“</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- é¡¹ç›®ä¿¡æ¯ -->
                <div class="form-section">
                    <h3>ğŸ“‹ é¡¹ç›®ä¿¡æ¯</h3>
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®åç§° <span class="required">*</span></label>
                            <input type="text" id="project-name" class="form-input" 
                                   placeholder="ä¾‹å¦‚: IPç”µè¯ç³»ç»Ÿå‡çº§é¡¹ç›®" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®ç±»å‹ <span class="required">*</span></label>
                            <select id="project-type" class="form-select" required onchange="updateProjectStages()">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="å”®å‰é¡¹ç›®">å”®å‰é¡¹ç›®</option>
                                <option value="å”®åé¡¹ç›®">å”®åé¡¹ç›®</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®é˜¶æ®µ <span class="required">*</span></label>
                            <select id="project-stage" class="form-select" required disabled>
                                <option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®ç±»å‹</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row three-col">
                        <div class="form-group">
                            <label class="form-label">æ”¯æŒç±»å‹ <span class="required">*</span></label>
                            <select id="support-type" class="form-select" required>
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="ç°åœºæ”¯æŒ">ç°åœºæ”¯æŒ</option>
                                <option value="è¿œç¨‹æ”¯æŒ">è¿œç¨‹æ”¯æŒ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®é‡‘é¢ (K)</label>
                            <input type="number" id="project-amount" class="form-input" 
                                   placeholder="140" step="0.1" min="0">
                            <div class="help-text">ç•™ç©ºè¡¨ç¤º NAA (Not Applicable)</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">è´§å¸</label>
                            <select id="project-currency" class="form-select">
                                <option value="GBP">GBP</option>
                                <option value="EUR">EUR</option>
                                <option value="USD">USD</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é”€å”®äººå‘˜</label>
                            <input type="text" id="sales-person" class="form-input" 
                                   placeholder="ä¾‹å¦‚: å¼ ä¸‰">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®çŠ¶æ€</label>
                            <select id="project-status" class="form-select">
                                <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                                <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                                <option value="å·²ä¸­æ ‡">å·²ä¸­æ ‡</option>
                                <option value="å·²ä¸¢æ ‡">å·²ä¸¢æ ‡</option>
                                <option value="å¾…å…¬å¸ƒ">å¾…å…¬å¸ƒä¸­æ ‡ç»“æœ</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- å·¥ä½œæ—¶é—´ -->
                <div class="form-section">
                    <h3>â° å·¥ä½œæ—¶é—´</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">å¼€å§‹æ—¶é—´ <span class="required">*</span></label>
                            <div class="time-inputs">
                                <input type="date" id="start-date" class="form-input" required onchange="calculateHours()">
                                <span class="time-separator">-</span>
                                <input type="time" id="start-time" class="form-input" required onchange="calculateHours()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç»“æŸæ—¶é—´ <span class="required">*</span></label>
                            <div class="time-inputs">
                                <input type="date" id="end-date" class="form-input" required onchange="calculateHours()">
                                <span class="time-separator">-</span>
                                <input type="time" id="end-time" class="form-input" required onchange="calculateHours()">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="is-holiday" onchange="calculateHours()">
                                <label for="is-holiday">è¿™æ˜¯èŠ‚å‡æ—¥åŠ ç­</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <select id="holiday-type" class="form-select" disabled>
                                <option value="">èŠ‚å‡æ—¥ç±»å‹ï¼ˆå¯é€‰ï¼‰</option>
                                <option value="bank_holiday">Bank Holiday</option>
                                <option value="christmas">Christmas</option>
                                <option value="easter">Easter</option>
                                <option value="new_year">New Year</option>
                                <option value="other">å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- å·¥æ—¶æ˜¾ç¤º -->
                    <div class="hours-display" id="hours-display" style="display: none;">
                        <h4>ğŸ“Š å·¥æ—¶ç»Ÿè®¡</h4>
                        <div class="hours-grid">
                            <div class="hours-item">
                                <div class="hours-value" id="normal-hours">0.0</div>
                                <div class="hours-label">æ­£å¸¸å·¥æ—¶ (å°æ—¶)</div>
                            </div>
                            <div class="hours-item">
                                <div class="hours-value" id="overtime-hours">0.0</div>
                                <div class="hours-label">åŠ ç­å·¥æ—¶ (å°æ—¶)</div>
                            </div>
                            <div class="hours-item">
                                <div class="hours-value" id="total-hours">0.0</div>
                                <div class="hours-label">æ€»å·¥æ—¶ (å°æ—¶)</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å·¥ä½œå†…å®¹ -->
                <div class="form-section">
                    <h3>ğŸ“ å·¥ä½œå†…å®¹</h3>
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">å·¥ä½œæè¿° <span class="required">*</span></label>
                            <textarea id="work-description" class="form-textarea" 
                                      placeholder="è¯¦ç»†æè¿°æœ¬æ¬¡å·¥ä½œçš„å…·ä½“å†…å®¹..." required></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">ä¸»è¦æˆæœ</label>
                            <textarea id="achievements" class="form-textarea" 
                                      placeholder="æœ¬æ¬¡å·¥ä½œå®Œæˆçš„ä¸»è¦æˆæœ..."></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">é‡åˆ°çš„é—®é¢˜</label>
                            <textarea id="challenges" class="form-textarea" 
                                      placeholder="é‡åˆ°çš„å›°éš¾å’ŒæŒ‘æˆ˜..."></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">ä¸‹ä¸€æ­¥å·¥ä½œè®¡åˆ’</label>
                            <textarea id="next-plan" class="form-textarea" 
                                      placeholder="åç»­çš„å·¥ä½œå®‰æ’..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- æäº¤æŒ‰é’® -->
                <div class="button-group">
                    <button type="submit" class="submit-btn" id="submit-btn">ğŸ’¾ ä¿å­˜å·¥ä½œè®°å½•</button>
                    <button type="button" class="cancel-btn" onclick="window.location.href='dashboard.html'">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBzcAr_OJFdIMnaYXRCE7TJs2qlK_TAy9U",
            authDomain: "weekly-report-d55e9.firebaseapp.com",
            projectId: "weekly-report-d55e9",
            storageBucket: "weekly-report-d55e9.appspot.com",
            messagingSenderId: "315332641675",
            appId: "1:315332641675:web:e1b52c3d4c5fcc7b8c0de7"
        };

        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUser = null;

        // é¡¹ç›®é˜¶æ®µå®šä¹‰
        const PRESALES_STAGES = [
            "éœ€æ±‚è°ƒç ”", "é¡¹ç›®ç«‹é¡¹", "å”®å‰æ–¹æ¡ˆ", "å”®å‰è¯¢ä»·", "å”®å‰äº¤æµ",
            "æ‹›æ ‡ææ–™å‡†å¤‡", "æŠ•æ ‡ææ–™å‡†å¤‡", "ç­”æ ‡", 
            "å¾…å…¬å¸ƒä¸­æ ‡ç»“æœ", "å·²ä¸­æ ‡", "å·²ä¸¢æ ‡"
        ];
        
        const POSTSALES_STAGES = [
            "ç¡®è®¤åˆåŒæ¸…å•å’Œé‡‡è´­æ¸…å•", "ç¡®è®¤åˆ°è´§æ—¶é—´", "ç¡®è®¤é€è´§æ—¶é—´", 
            "ç¡®è®¤å®æ–½æ—¶é—´", "ç°åœºéªŒè´§", "å®æ–½å¯åŠ¨ä¼š", "ç°åœºå®æ–½",
            "å®æ–½æ–¹æ¡ˆå‡†å¤‡", "åŠŸèƒ½æµ‹è¯•", "ç³»ç»Ÿä¸Šçº¿", "å‰²æ¥", "ç°åœºä¿éšœ",
            "ç”¨æˆ·åŸ¹è®­", "é¡¹ç›®äº¤æ¥", "éªŒæ”¶"
        ];

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                console.log('ç”¨æˆ·å·²ç™»å½•:', user.email);
                initializeForm();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            } else {
                console.log('ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ');
                window.location.href = 'index.html';
            }
        });

        // åˆå§‹åŒ–è¡¨å•
        function initializeForm() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸå’Œæ—¶é—´ä¸ºä»Šå¤©
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            document.getElementById('start-date').value = today;
            document.getElementById('end-date').value = today;
            
            // è®¾ç½®é»˜è®¤æ—¶é—´ä¸ºå·¥ä½œæ—¶é—´
            document.getElementById('start-time').value = '09:00';
            document.getElementById('end-time').value = '17:30';
            
            // èŠ‚å‡æ—¥å¤é€‰æ¡†ç›‘å¬
            document.getElementById('is-holiday').addEventListener('change', function() {
                document.getElementById('holiday-type').disabled = !this.checked;
                if (!this.checked) {
                    document.getElementById('holiday-type').value = '';
                }
            });
            
            // åˆå§‹è®¡ç®—å·¥æ—¶
            calculateHours();
        }

        // æ›´æ–°é¡¹ç›®é˜¶æ®µé€‰é¡¹
        function updateProjectStages() {
            const projectType = document.getElementById('project-type').value;
            const stageSelect = document.getElementById('project-stage');
            
            stageSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            stageSelect.disabled = false;
            
            let stages = [];
            if (projectType === 'å”®å‰é¡¹ç›®') {
                stages = PRESALES_STAGES;
            } else if (projectType === 'å”®åé¡¹ç›®') {
                stages = POSTSALES_STAGES;
            }
            
            stages.forEach(stage => {
                const option = document.createElement('option');
                option.value = stage;
                option.textContent = stage;
                stageSelect.appendChild(option);
            });
        }

        // è®¡ç®—å·¥æ—¶
        function calculateHours() {
            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;
            const isHoliday = document.getElementById('is-holiday').checked;
            
            if (!startDate || !startTime || !endDate || !endTime) {
                return;
            }
            
            const start = new Date(`${startDate}T${startTime}`);
            const end = new Date(`${endDate}T${endTime}`);
            
            if (end <= start) {
                showMessage('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´', 'error');
                return;
            }
            
            // è®¡ç®—æ€»å·¥æ—¶ï¼ˆå°æ—¶ï¼‰
            const totalMinutes = (end - start) / 1000 / 60;
            const totalHours = totalMinutes / 60;
            
            let normalHours = 0;
            let overtimeHours = 0;
            
            // è·å–æ˜ŸæœŸå‡  (0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­)
            const dayOfWeek = start.getDay();
            const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
            
            if (isHoliday) {
                // èŠ‚å‡æ—¥ï¼šå…¨éƒ¨ç®—åŠ ç­
                overtimeHours = totalHours;
            } else if (isWeekend) {
                // å‘¨æœ«ï¼šå…¨éƒ¨ç®—åŠ ç­
                overtimeHours = totalHours;
            } else {
                // å·¥ä½œæ—¥ï¼šè®¡ç®—æ­£å¸¸å·¥æ—¶å’ŒåŠ ç­
                const workStart = new Date(`${startDate}T09:00`);
                const workEnd = new Date(`${startDate}T17:30`);
                
                // å¼€å§‹æ—¶é—´åœ¨09:00ä¹‹å‰
                if (start < workStart) {
                    overtimeHours += (workStart - start) / 1000 / 60 / 60;
                }
                
                // ç»“æŸæ—¶é—´åœ¨17:30ä¹‹å
                if (end > workEnd) {
                    overtimeHours += (end - workEnd) / 1000 / 60 / 60;
                }
                
                // æ­£å¸¸å·¥æ—¶
                const actualStart = start < workStart ? workStart : start;
                const actualEnd = end > workEnd ? workEnd : end;
                
                if (actualEnd > actualStart) {
                    normalHours = (actualEnd - actualStart) / 1000 / 60 / 60;
                }
            }
            
            // æ˜¾ç¤ºå·¥æ—¶
            document.getElementById('normal-hours').textContent = normalHours.toFixed(1);
            document.getElementById('overtime-hours').textContent = overtimeHours.toFixed(1);
            document.getElementById('total-hours').textContent = totalHours.toFixed(1);
            document.getElementById('hours-display').style.display = 'block';
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }

        // è·å–æœ¬å‘¨çš„å‘¨ä¸€å’Œå‘¨æ—¥
        function getWeekRange(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // è°ƒæ•´åˆ°å‘¨ä¸€
            
            const monday = new Date(d.setDate(diff));
            monday.setHours(0, 0, 0, 0);
            
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            sunday.setHours(23, 59, 59, 999);
            
            return { weekStart: monday, weekEnd: sunday };
        }

        // æäº¤è¡¨å•
        document.getElementById('work-record-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                showMessage('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ä¿å­˜ä¸­...';
            
            try {
                // æ”¶é›†è¡¨å•æ•°æ®
                const startDate = document.getElementById('start-date').value;
                const startTime = document.getElementById('start-time').value;
                const endDate = document.getElementById('end-date').value;
                const endTime = document.getElementById('end-time').value;
                
                const start = new Date(`${startDate}T${startTime}`);
                const end = new Date(`${endDate}T${endTime}`);
                
                // è·å–å·¥æ—¶
                const normalHours = parseFloat(document.getElementById('normal-hours').textContent);
                const overtimeHours = parseFloat(document.getElementById('overtime-hours').textContent);
                const totalHours = parseFloat(document.getElementById('total-hours').textContent);
                
                // è·å–æœ¬å‘¨èŒƒå›´
                const weekRange = getWeekRange(start);
                
                // è·å–é¡¹ç›®é‡‘é¢
                const projectAmount = document.getElementById('project-amount').value;
                
                const recordData = {
                    // ç”¨æˆ·ä¿¡æ¯
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email,
                    userEmail: currentUser.email,
                    technicalDirection: "", // åç»­ä»ç”¨æˆ·é…ç½®è¯»å–
                    
                    // å®¢æˆ·ä¿¡æ¯
                    customerName: document.getElementById('customer-name').value.trim(),
                    customerIndustry: document.getElementById('customer-industry').value,
                    
                    // é¡¹ç›®ä¿¡æ¯
                    projectName: document.getElementById('project-name').value.trim(),
                    projectType: document.getElementById('project-type').value,
                    projectStage: document.getElementById('project-stage').value,
                    supportType: document.getElementById('support-type').value,
                    salesPerson: document.getElementById('sales-person').value.trim(),
                    projectAmount: projectAmount ? parseFloat(projectAmount) : null,
                    projectCurrency: document.getElementById('project-currency').value,
                    projectStatus: document.getElementById('project-status').value,
                    
                    // æ—¶é—´ä¿¡æ¯
                    startDate: startDate,
                    startTime: startTime,
                    endDate: endDate,
                    endTime: endTime,
                    startDateTime: firebase.firestore.Timestamp.fromDate(start),
                    endDateTime: firebase.firestore.Timestamp.fromDate(end),
                    
                    // å·¥æ—¶ç»Ÿè®¡
                    normalWorkingHours: normalHours,
                    overtimeHours: overtimeHours,
                    totalWorkingHours: totalHours,
                    
                    // èŠ‚å‡æ—¥
                    isHolidayWork: document.getElementById('is-holiday').checked,
                    holidayType: document.getElementById('holiday-type').value,
                    
                    // å·¥ä½œå†…å®¹
                    workDescription: document.getElementById('work-description').value.trim(),
                    achievements: document.getElementById('achievements').value.trim(),
                    challenges: document.getElementById('challenges').value.trim(),
                    nextWeekPlan: document.getElementById('next-plan').value.trim(),
                    
                    // å‘¨æŠ¥å½’å±
                    weekStart: firebase.firestore.Timestamp.fromDate(weekRange.weekStart),
                    weekEnd: firebase.firestore.Timestamp.fromDate(weekRange.weekEnd),
                    
                    // å…ƒæ•°æ®
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                };
                
                // ä¿å­˜åˆ°Firestore
                const docRef = await db.collection('workRecords').add(recordData);
                
                console.log('å·¥ä½œè®°å½•å·²ä¿å­˜ï¼Œæ–‡æ¡£ID:', docRef.id);
                showMessage('âœ… å·¥ä½œè®°å½•ä¿å­˜æˆåŠŸï¼2ç§’åè¿”å›ä¸»é¡µ...', 'success');
                
                // 2ç§’åè·³è½¬
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
                
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                showMessage('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸ’¾ ä¿å­˜å·¥ä½œè®°å½•';
            }
        });
    </script>
</body>
</html>
