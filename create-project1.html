<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å»ºé¡¹ç›® - å·¥ç¨‹å¸ˆå·¥æ—¶ç³»ç»Ÿ</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="js/countries-list.js"></script>
    <script src="js/project-stages.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-back {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .btn-back:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .form-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .form-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #444;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #e1e8ed;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .form-group {
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }
        
        .required {
            color: #e53e3e;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e1e8ed;
        }
        
        .btn-submit {
            flex: 1;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-cancel {
            padding: 15px 30px;
            background: #f5f7fa;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-cancel:hover {
            background: #e7eaf0;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-size: 13px;
            color: #1565c0;
        }
    
        /* é¡¹ç›®é˜¶æ®µåˆ†ç±»é€‰æ‹©å™¨ */
        .stage-category-selector {
            display: none;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .category-btn {
            padding: 10px 18px;
            border: 2px solid #E5E7EB;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
        }
        
        .category-btn:hover {
            border-color: #667eea;
            background: #F9FAFB;
            transform: translateY(-1px);
        }
        
        .category-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* ========== å·²æœ‰é¡¹ç›®æç¤ºæ¡† ========== */
        .existing-projects-box {
            display: none;
            background: #fff8e1;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            animation: slideIn 0.3s ease;
        }

        .existing-projects-box.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .existing-projects-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ffe082;
        }

        .existing-projects-header .icon {
            font-size: 24px;
        }

        .existing-projects-header .title {
            font-weight: 600;
            color: #e65100;
            font-size: 15px;
        }

        .existing-projects-header .subtitle {
            font-size: 12px;
            color: #ff8f00;
        }

        .existing-project-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .existing-project-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e0e0e0;
        }

        .existing-project-item:hover {
            background: #fff3e0;
            border-color: #ffc107;
            transform: translateX(5px);
        }

        .existing-project-item:last-child {
            margin-bottom: 0;
        }

        .existing-project-info {
            flex: 1;
        }

        .existing-project-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .existing-project-name mark {
            background: #fff59d;
            padding: 1px 3px;
            border-radius: 3px;
        }

        .existing-project-details {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .existing-project-details span {
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }

        .existing-project-action {
            color: #667eea;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
        }

        .no-existing-projects {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .no-existing-projects .icon {
            font-size: 40px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* è¾“å…¥æ¡†åŒ…è£…å™¨ï¼ˆç”¨äºä¸‹æ‹‰æç¤ºï¼‰ */
        .input-wrapper {
            position: relative;
        }

        /* é¡¹ç›®åç§°è”æƒ³æç¤º */
        .project-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .project-suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .suggestion-item:hover {
            background: #f8f9ff;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-name {
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .suggestion-name mark {
            background: #fff59d;
            padding: 1px 3px;
            border-radius: 3px;
        }

        .suggestion-meta {
            font-size: 12px;
            color: #888;
            margin-top: 3px;
        }

        /* å®¢æˆ·åç§°è”æƒ³ */
        .customer-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .customer-suggestions.show {
            display: block;
        }

    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="header">
        <div class="header-content">
            <h2>â• æ–°å»ºé¡¹ç›®</h2>
            <a href="project-management.html" class="btn-back">â† è¿”å›é¡¹ç›®åˆ—è¡¨</a>
        </div>
    </div>
    
    <!-- ä¸»å†…å®¹ -->
    <div class="container">
        <div class="form-card">
            <h2 class="form-title">ğŸ“ åˆ›å»ºæ–°é¡¹ç›®</h2>
            
            <div class="info-box">
                ğŸ’¡ è¾“å…¥å®¢æˆ·åç§°åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ˜¾ç¤ºè¯¥å®¢æˆ·çš„å·²æœ‰é¡¹ç›®ï¼Œå¸®åŠ©æ‚¨é¿å…åˆ›å»ºé‡å¤é¡¹ç›®ã€‚
            </div>
            
            <form id="create-project-form">
                <!-- å®¢æˆ·ä¿¡æ¯ -->
                <div class="form-section">
                    <div class="section-title">ğŸ‘¤ å®¢æˆ·ä¿¡æ¯</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">å®¢æˆ·åç§° <span class="required">*</span></label>
                            <div class="input-wrapper">
                                <input type="text" id="customer-name" class="form-input" required
                                       placeholder="ä¾‹å¦‚: ä¸­å›½é“¶è¡Œã€ä¸­è¡Œ"
                                       oninput="onCustomerNameInput()"
                                       onfocus="onCustomerNameFocus()"
                                       autocomplete="off">
                                <div class="customer-suggestions" id="customer-suggestions">
                                    <!-- åŠ¨æ€å¡«å…… -->
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å®¢æˆ·è¡Œä¸š</label>
                            <select id="customer-industry" class="form-select">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="é“¶è¡Œ">é“¶è¡Œ</option>
                                <option value="ä¿é™©">ä¿é™©</option>
                                <option value="è¯åˆ¸">è¯åˆ¸</option>
                                <option value="åŸºé‡‘">åŸºé‡‘</option>
                                <option value="ä¿¡æ‰˜">ä¿¡æ‰˜</option>
                                <option value="åˆ¶é€ ä¸š">åˆ¶é€ ä¸š</option>
                                <option value="èƒ½æº">èƒ½æº</option>
                                <option value="é›¶å”®">é›¶å”®</option>
                                <option value="ç‰©æµ">ç‰©æµ</option>
                                <option value="ç”µä¿¡">ç”µä¿¡</option>
                                <option value="äº’è”ç½‘">äº’è”ç½‘</option>
                                <option value="æ•™è‚²">æ•™è‚²</option>
                                <option value="åŒ»ç–—">åŒ»ç–—</option>
                                <option value="æ”¿åºœ">æ”¿åºœ</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">å›½å®¶/åœ°åŒº</label>
                            <select id="customer-country" class="form-select" onchange="onCountryChange()">
<!-- é€šè¿‡ countries-list.js è‡ªåŠ¨å¡«å…… -->
                            </select>
                        </div>
                    </div>
                    
                    <!-- å·²æœ‰é¡¹ç›®æç¤ºæ¡† -->
                    <div class="existing-projects-box" id="existing-projects-box">
                        <div class="existing-projects-header">
                            <span class="icon">âš ï¸</span>
                            <div>
                                <div class="title">è¯¥å®¢æˆ·å·²æœ‰ä»¥ä¸‹é¡¹ç›®</div>
                                <div class="subtitle">ç‚¹å‡»å¯ç›´æ¥è·³è½¬åˆ°é¡¹ç›®è¯¦æƒ…ï¼Œé¿å…é‡å¤åˆ›å»º</div>
                            </div>
                        </div>
                        <div class="existing-project-list" id="existing-project-list">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </div>
                    </div>
                </div>
                
                <!-- é¡¹ç›®ä¿¡æ¯ -->
                <div class="form-section">
                    <div class="section-title">ğŸ“Š é¡¹ç›®ä¿¡æ¯</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®åç§° <span class="required">*</span></label>
                            <div class="input-wrapper">
                                <input type="text" id="project-name" class="form-input" required
                                       placeholder="ä¾‹å¦‚: IPç”µè¯ç³»ç»Ÿå‡çº§é¡¹ç›®"
                                       oninput="onProjectNameInput()"
                                       onfocus="onProjectNameFocus()"
                                       autocomplete="off">
                                <div class="project-suggestions" id="project-suggestions">
                                    <!-- åŠ¨æ€å¡«å…… -->
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®ç±»å‹ <span class="required">*</span></label>
                            <select id="project-type" class="form-select" required onchange="updateProjectStages()">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="å”®å‰é¡¹ç›®">å”®å‰é¡¹ç›®</option>
                                <option value="å”®åé¡¹ç›®">å”®åé¡¹ç›®</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®é˜¶æ®µ <span class="required">*</span></label>
                            
                            <!-- é˜¶æ®µåˆ†ç±»é€‰æ‹©å™¨ï¼ˆå”®åé¡¹ç›®æ˜¾ç¤ºï¼‰ -->
                            <div class="stage-category-selector" id="stage-category-selector">
                                <button type="button" class="category-btn active" data-category="general" onclick="selectCategory('general')">
                                    ğŸ“¦ é€šç”¨é˜¶æ®µ
                                </button>
                                <button type="button" class="category-btn" data-category="network" onclick="selectCategory('network')">
                                    ğŸŒ ç½‘ç»œé¡¹ç›®
                                </button>
                                <button type="button" class="category-btn" data-category="system" onclick="selectCategory('system')">
                                    ğŸ–¥ï¸ ç³»ç»Ÿé¡¹ç›®
                                </button>
                                <button type="button" class="category-btn" data-category="infrastructure" onclick="selectCategory('infrastructure')">
                                    ğŸ¢ èƒ½åŸºé¡¹ç›®
                                </button>
                                <button type="button" class="category-btn" data-category="emergency" onclick="selectCategory('emergency')">
                                    ğŸš¨ åº”æ€¥é¡¹ç›®
                                </button>
                                <button type="button" class="category-btn" data-category="expansion" onclick="selectCategory('expansion')">
                                    ğŸ“ˆ æ‰©å®¹é¡¹ç›®
                                </button>
                                <button type="button" class="category-btn" data-category="optimization" onclick="selectCategory('optimization')">
                                    âš¡ ä¼˜åŒ–é¡¹ç›®
                                </button>
                            </div>
                            
                            <select id="project-stage" class="form-select" required>
                                <option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®ç±»å‹</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®çŠ¶æ€ <span class="required">*</span></label>
                            <select id="project-status" class="form-select" required>
                                <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                                <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                                <option value="æš‚åœ">æš‚åœ</option>
                                <option value="å–æ¶ˆ">å–æ¶ˆ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">æŠ€æœ¯æ–¹å‘</label>
                            <select id="tech-direction" class="form-select">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="ç½‘ç»œ">ğŸŒ ç½‘ç»œ</option>
                                <option value="ç³»ç»Ÿ">ğŸ–¥ï¸ ç³»ç»Ÿ</option>
                                <option value="èƒ½åŸº">ğŸ¢ èƒ½åŸº</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é”€å”®äººå‘˜</label>
                            <input type="text" id="sales-person" class="form-input"
                                   placeholder="ä¾‹å¦‚: å¼ ä¸‰">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®é‡‘é¢</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="project-amount" class="form-input" 
                                       style="flex: 1;" placeholder="ä¾‹å¦‚: 100000" min="0" step="0.01">
                                <select id="project-currency" class="form-select" style="width: 100px;">
                                    <option value="GBP">GBP</option>
                                    <option value="EUR">EUR</option>
                                    <option value="USD">USD</option>
                                    <option value="CNY">CNY</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <!-- å ä½ -->
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="start-date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¢„è®¡ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="end-date" class="form-input">
                        </div>
                    </div>
                </div>
                
                <!-- é¡¹ç›®æè¿° -->
                <div class="form-section">
                    <div class="section-title">ğŸ“ é¡¹ç›®æè¿°</div>
                    <div class="form-group">
                        <label class="form-label">é¡¹ç›®è¯´æ˜</label>
                        <textarea id="project-description" class="form-textarea"
                                  placeholder="è¯·è¾“å…¥é¡¹ç›®çš„è¯¦ç»†æè¿°ã€ç›®æ ‡ã€èŒƒå›´ç­‰ä¿¡æ¯..."></textarea>
                    </div>
                </div>
                
                <!-- æŒ‰é’® -->
                <div class="btn-actions">
                    <button type="submit" class="btn-submit" id="submit-btn">âœ… åˆ›å»ºé¡¹ç›®</button>
                    <button type="button" class="btn-cancel" onclick="window.history.back()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

		// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å›½å®¶åˆ—è¡¨
document.addEventListener('DOMContentLoaded', () => {
    populateCountrySelect('customer-country');
});


    <script>
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBzcAr_OJFdIMnaYXRCE7TJs2qlK_TAy9U",
            authDomain: "weekly-report-d55e9.firebaseapp.com",
            projectId: "weekly-report-d55e9",
            storageBucket: "weekly-report-d55e9.appspot.com",
            messagingSenderId: "315332641675",
            appId: "1:315332641675:web:e1b52c3d4c5fcc7b8c0de7"
        };

        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUser = null;
        let allUserProjects = [];  // æ‰€æœ‰é¡¹ç›®
        let allCustomers = [];      // æ‰€æœ‰å®¢æˆ·ï¼ˆå»é‡ï¼‰
        let searchTimeout = null;

        // ========== å®¢æˆ·åç§°åˆ«åæ˜ å°„ ==========
        // åŒ…å«ä¸­å›½ä¸»è¦é“¶è¡Œçš„å…¨ç§°ã€ç®€ç§°ã€è‹±æ–‡ç¼©å†™
        const customerAliases = {
            // ===== ä¸­å›½é“¶è¡Œ (Bank of China) =====
            'ä¸­è¡Œ': 'ä¸­å›½é“¶è¡Œ',
            'ä¸­é“¶': 'ä¸­å›½é“¶è¡Œ',
            'boc': 'ä¸­å›½é“¶è¡Œ',
            'bankofchina': 'ä¸­å›½é“¶è¡Œ',
            'bank of china': 'ä¸­å›½é“¶è¡Œ',
            
            // ===== ä¸­å›½å·¥å•†é“¶è¡Œ (ICBC) =====
            'å·¥è¡Œ': 'ä¸­å›½å·¥å•†é“¶è¡Œ',
            'å·¥å•†é“¶è¡Œ': 'ä¸­å›½å·¥å•†é“¶è¡Œ',
            'icbc': 'ä¸­å›½å·¥å•†é“¶è¡Œ',
            'industrial and commercial bank of china': 'ä¸­å›½å·¥å•†é“¶è¡Œ',
            
            // ===== ä¸­å›½å†œä¸šé“¶è¡Œ (ABC) =====
            'å†œè¡Œ': 'ä¸­å›½å†œä¸šé“¶è¡Œ',
            'å†œä¸šé“¶è¡Œ': 'ä¸­å›½å†œä¸šé“¶è¡Œ',
            'abc': 'ä¸­å›½å†œä¸šé“¶è¡Œ',
            'agricultural bank of china': 'ä¸­å›½å†œä¸šé“¶è¡Œ',
            
            // ===== ä¸­å›½å»ºè®¾é“¶è¡Œ (CCB) =====
            'å»ºè¡Œ': 'ä¸­å›½å»ºè®¾é“¶è¡Œ',
            'å»ºè®¾é“¶è¡Œ': 'ä¸­å›½å»ºè®¾é“¶è¡Œ',
            'ccb': 'ä¸­å›½å»ºè®¾é“¶è¡Œ',
            'china construction bank': 'ä¸­å›½å»ºè®¾é“¶è¡Œ',
            
            // ===== äº¤é€šé“¶è¡Œ (BOCOM) =====
            'äº¤è¡Œ': 'äº¤é€šé“¶è¡Œ',
            'äº¤é“¶': 'äº¤é€šé“¶è¡Œ',
            'bocom': 'äº¤é€šé“¶è¡Œ',
            'bankofcommunications': 'äº¤é€šé“¶è¡Œ',
            'bank of communications': 'äº¤é€šé“¶è¡Œ',
            
            // ===== æ‹›å•†é“¶è¡Œ (CMB) =====
            'æ‹›è¡Œ': 'æ‹›å•†é“¶è¡Œ',
            'cmb': 'æ‹›å•†é“¶è¡Œ',
            'cmbchina': 'æ‹›å•†é“¶è¡Œ',
            'china merchants bank': 'æ‹›å•†é“¶è¡Œ',
            
            // ===== ä¸­ä¿¡é“¶è¡Œ (CITIC) =====
            'ä¸­ä¿¡': 'ä¸­ä¿¡é“¶è¡Œ',
            'citic': 'ä¸­ä¿¡é“¶è¡Œ',
            'citicbank': 'ä¸­ä¿¡é“¶è¡Œ',
            'citic bank': 'ä¸­ä¿¡é“¶è¡Œ',
            'china citic bank': 'ä¸­ä¿¡é“¶è¡Œ',
            
            // ===== å…‰å¤§é“¶è¡Œ (CEB) =====
            'å…‰å¤§': 'å…‰å¤§é“¶è¡Œ',
            'ä¸­å›½å…‰å¤§é“¶è¡Œ': 'å…‰å¤§é“¶è¡Œ',
            'ceb': 'å…‰å¤§é“¶è¡Œ',
            'cebank': 'å…‰å¤§é“¶è¡Œ',
            'china everbright bank': 'å…‰å¤§é“¶è¡Œ',
            'everbright': 'å…‰å¤§é“¶è¡Œ',
            
            // ===== æµ¦å‘é“¶è¡Œ (SPDB) =====
            'æµ¦å‘': 'æµ¦å‘é“¶è¡Œ',
            'ä¸Šæµ·æµ¦ä¸œå‘å±•é“¶è¡Œ': 'æµ¦å‘é“¶è¡Œ',
            'spdb': 'æµ¦å‘é“¶è¡Œ',
            'shanghai pudong development bank': 'æµ¦å‘é“¶è¡Œ',
            
            // ===== å…´ä¸šé“¶è¡Œ (CIB) =====
            'å…´ä¸š': 'å…´ä¸šé“¶è¡Œ',
            'cib': 'å…´ä¸šé“¶è¡Œ',
            'industrial bank': 'å…´ä¸šé“¶è¡Œ',
            'industrial bank co': 'å…´ä¸šé“¶è¡Œ',
            
            // ===== æ°‘ç”Ÿé“¶è¡Œ (CMBC) =====
            'æ°‘ç”Ÿ': 'æ°‘ç”Ÿé“¶è¡Œ',
            'ä¸­å›½æ°‘ç”Ÿé“¶è¡Œ': 'æ°‘ç”Ÿé“¶è¡Œ',
            'cmbc': 'æ°‘ç”Ÿé“¶è¡Œ',
            'china minsheng bank': 'æ°‘ç”Ÿé“¶è¡Œ',
            'minsheng': 'æ°‘ç”Ÿé“¶è¡Œ',
            
            // ===== åå¤é“¶è¡Œ (HXB) =====
            'åå¤': 'åå¤é“¶è¡Œ',
            'hxb': 'åå¤é“¶è¡Œ',
            'huaxia bank': 'åå¤é“¶è¡Œ',
            
            // ===== å¹³å®‰é“¶è¡Œ (PAB) =====
            'å¹³å®‰': 'å¹³å®‰é“¶è¡Œ',
            'pab': 'å¹³å®‰é“¶è¡Œ',
            'pabank': 'å¹³å®‰é“¶è¡Œ',
            'ping an bank': 'å¹³å®‰é“¶è¡Œ',
            
            // ===== é‚®å‚¨é“¶è¡Œ (PSBC) =====
            'é‚®å‚¨': 'é‚®å‚¨é“¶è¡Œ',
            'é‚®æ”¿å‚¨è“„': 'é‚®å‚¨é“¶è¡Œ',
            'ä¸­å›½é‚®æ”¿å‚¨è“„é“¶è¡Œ': 'é‚®å‚¨é“¶è¡Œ',
            'psbc': 'é‚®å‚¨é“¶è¡Œ',
            'postal savings bank': 'é‚®å‚¨é“¶è¡Œ',
            
            // ===== æ¸£æ‰“é“¶è¡Œ (SCB) =====
            'æ¸£æ‰“': 'æ¸£æ‰“é“¶è¡Œ',
            'scb': 'æ¸£æ‰“é“¶è¡Œ',
            'standard chartered': 'æ¸£æ‰“é“¶è¡Œ',
            
            // ===== æ±‡ä¸°é“¶è¡Œ (HSBC) =====
            'æ±‡ä¸°': 'æ±‡ä¸°é“¶è¡Œ',
            'hsbc': 'æ±‡ä¸°é“¶è¡Œ',
            
            // ===== èŠ±æ——é“¶è¡Œ (Citi) =====
            'èŠ±æ——': 'èŠ±æ——é“¶è¡Œ',
            'citi': 'èŠ±æ——é“¶è¡Œ',
            'citibank': 'èŠ±æ——é“¶è¡Œ',
            
            // ===== è¿è¥å•† =====
            'ç§»åŠ¨': 'ä¸­å›½ç§»åŠ¨',
            'chinamobile': 'ä¸­å›½ç§»åŠ¨',
            'china mobile': 'ä¸­å›½ç§»åŠ¨',
            
            'è”é€š': 'ä¸­å›½è”é€š',
            'chinaunicom': 'ä¸­å›½è”é€š',
            'china unicom': 'ä¸­å›½è”é€š',
            
            'ç”µä¿¡': 'ä¸­å›½ç”µä¿¡',
            'chinatelecom': 'ä¸­å›½ç”µä¿¡',
            'china telecom': 'ä¸­å›½ç”µä¿¡',
        };

        // é¡¹ç›®åç§°å…³é”®è¯æ˜ å°„ï¼ˆç”¨äºç›¸ä¼¼é¡¹ç›®æ£€æµ‹ï¼‰
        const projectKeywords = {
            'ç”µè¯': ['ipç”µè¯', 'ç”µè¯ç³»ç»Ÿ', 'voip', 'è¯­éŸ³', 'è¯æœº', 'cucm', 'avaya', 'ipc', 'äº¤æ˜“ç”µè¯', 'turret'],
            'ç½‘ç»œ': ['ç½‘ç»œå‡çº§', 'ç½‘ç»œæ”¹é€ ', 'äº¤æ¢æœº', 'è·¯ç”±å™¨', 'lan', 'wan', 'switch', 'router', 'æ ¸å¿ƒç½‘', 'æ¥å…¥å±‚'],
            'è§†é¢‘': ['è§†é¢‘ä¼šè®®', 'vc', 'ä¼šè®®ç³»ç»Ÿ', 'webex', 'zoom', 'teams', 'polycom', 'cisco meeting'],
            'å®‰å…¨': ['é˜²ç«å¢™', 'å®‰å…¨', 'firewall', 'ips', 'ids', 'waf', 'vpn', 'å ¡å’æœº', 'ise'],
            'æ•°æ®ä¸­å¿ƒ': ['æœºæˆ¿', 'æ•°æ®ä¸­å¿ƒ', 'dc', 'idc', 'æœºæŸœ', 'ups', 'ç©ºè°ƒ', 'åˆ¶å†·'],
            'æ— çº¿': ['wifi', 'wlan', 'æ— çº¿', 'ap', 'æ— çº¿ç½‘ç»œ', 'wireless'],
            'ç›‘æ§': ['ç›‘æ§', 'æ‘„åƒå¤´', 'cctv', 'è§†é¢‘ç›‘æ§', 'nvr', 'dvr'],
            'æœåŠ¡å™¨': ['æœåŠ¡å™¨', 'server', 'è™šæ‹ŸåŒ–', 'vmware', 'esxi', 'vcenter', 'è¶…èåˆ', 'hci'],
        };

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                console.log('ç”¨æˆ·å·²ç™»å½•:', user.email);
                await loadAllUserProjects();
            } else {
                console.log('ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ');
                window.location.href = 'index.html';
            }
        });

        // åŠ è½½ç”¨æˆ·æ‰€æœ‰é¡¹ç›®ï¼ˆåŒ…æ‹¬åˆ›å»ºçš„å’Œè¢«åˆ†é…çš„ï¼‰
        async function loadAllUserProjects() {
            try {
                console.log('å¼€å§‹åŠ è½½é¡¹ç›®åˆ—è¡¨...');
                console.log('å½“å‰ç”¨æˆ·UID:', currentUser.uid);
                allUserProjects = [];
                const customerSet = new Set();
                
                // é¦–å…ˆå°è¯•ç›´æ¥åŠ è½½æ‰€æœ‰é¡¹ç›®ï¼ˆä¸å¸¦æ¡ä»¶ï¼‰
                try {
                    console.log('å°è¯•åŠ è½½æ‰€æœ‰é¡¹ç›®...');
                    const allSnapshot = await db.collection('projects')
                        .orderBy('updatedAt', 'desc')
                        .limit(200)
                        .get();
                    
                    allSnapshot.forEach(doc => {
                        const project = { id: doc.id, ...doc.data() };
                        allUserProjects.push(project);
                        if (project.customerName) {
                            customerSet.add(project.customerName);
                        }
                    });
                    console.log('âœ… æˆåŠŸåŠ è½½æ‰€æœ‰é¡¹ç›®:', allSnapshot.size, 'ä¸ª');
                } catch (e) {
                    console.error('åŠ è½½æ‰€æœ‰é¡¹ç›®å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•:', e.message);
                    
                    // æ–¹æ³•2ï¼šåŠ è½½ç”¨æˆ·åˆ›å»ºçš„é¡¹ç›®
                    try {
                        const createdSnapshot = await db.collection('projects')
                            .where('createdBy', '==', currentUser.uid)
                            .get();
                        
                        createdSnapshot.forEach(doc => {
                            const project = { id: doc.id, ...doc.data() };
                            allUserProjects.push(project);
                            if (project.customerName) {
                                customerSet.add(project.customerName);
                            }
                        });
                        console.log('ç”¨æˆ·åˆ›å»ºçš„é¡¹ç›®:', createdSnapshot.size, 'ä¸ª');
                    } catch (e2) {
                        console.error('åŠ è½½åˆ›å»ºçš„é¡¹ç›®ä¹Ÿå¤±è´¥:', e2.message);
                    }
                    
                    // æ–¹æ³•3ï¼šåŠ è½½ç”¨æˆ·è¢«åˆ†é…çš„é¡¹ç›®
                    try {
                        const assignedSnapshot = await db.collection('projects')
                            .where('assignedEngineers', 'array-contains', currentUser.uid)
                            .get();
                        
                        assignedSnapshot.forEach(doc => {
                            if (!allUserProjects.find(p => p.id === doc.id)) {
                                const project = { id: doc.id, ...doc.data() };
                                allUserProjects.push(project);
                                if (project.customerName) {
                                    customerSet.add(project.customerName);
                                }
                            }
                        });
                        console.log('ç”¨æˆ·è¢«åˆ†é…çš„é¡¹ç›®:', assignedSnapshot.size, 'ä¸ª');
                    } catch (e3) {
                        console.error('åŠ è½½åˆ†é…çš„é¡¹ç›®ä¹Ÿå¤±è´¥:', e3.message);
                    }
                }
                
                allCustomers = Array.from(customerSet).sort();
                console.log('ğŸ“Š æ€»å…±åŠ è½½', allUserProjects.length, 'ä¸ªé¡¹ç›®ï¼Œ', allCustomers.length, 'ä¸ªå®¢æˆ·');
                
                // æ‰“å°å‰3ä¸ªé¡¹ç›®ç”¨äºè°ƒè¯•
                if (allUserProjects.length > 0) {
                    console.log('ç¤ºä¾‹é¡¹ç›®:', allUserProjects.slice(0, 3).map(p => ({
                        name: p.projectName,
                        customer: p.customerName
                    })));
                }
            } catch (error) {
                console.error('âŒ åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // ========== æ–‡æœ¬æ ‡å‡†åŒ– ==========
        function normalizeText(text) {
            if (!text) return '';
            return text
                .toLowerCase()
                .replace(/[,ï¼Œ.ã€‚;ï¼›:ï¼š!ï¼?ï¼Ÿã€\s\-_ï¼ˆï¼‰()ã€ã€‘\[\]]/g, '')
                .trim();
        }

        // è·å–å®¢æˆ·çš„æ ‡å‡†åç§°
        function getCanonicalCustomerName(name) {
            if (!name) return '';
            const normalized = normalizeText(name);
            
            // æ£€æŸ¥åˆ«å
            for (const [alias, canonical] of Object.entries(customerAliases)) {
                if (normalized === normalizeText(alias) || normalized.includes(normalizeText(alias))) {
                    return canonical;
                }
            }
            
            return name;
        }

        // æ£€æŸ¥ä¸¤ä¸ªå®¢æˆ·åæ˜¯å¦åŒ¹é…
        function isCustomerMatch(name1, name2) {
            if (!name1 || !name2) return false;
            
            const canonical1 = getCanonicalCustomerName(name1);
            const canonical2 = getCanonicalCustomerName(name2);
            
            const norm1 = normalizeText(canonical1);
            const norm2 = normalizeText(canonical2);
            
            // å®Œå…¨åŒ¹é…
            if (norm1 === norm2) return true;
            
            // åŒ…å«åŒ¹é…ï¼ˆå¤„ç†"ä¸­å›½é“¶è¡Œå¢æ£®å ¡åˆ†è¡Œ"åŒ…å«"ä¸­å›½é“¶è¡Œ"çš„æƒ…å†µï¼‰
            if (norm1.includes(norm2) || norm2.includes(norm1)) return true;
            
            // æå–æ ¸å¿ƒåç§°åŒ¹é…ï¼ˆå»é™¤åˆ†è¡Œã€æ”¯è¡Œç­‰åç¼€ï¼‰
            const core1 = norm1.replace(/(åˆ†è¡Œ|æ”¯è¡Œ|æ€»è¡Œ|åˆ†å…¬å¸|å­å…¬å¸|åŠäº‹å¤„|ä»£è¡¨å¤„).*$/, '');
            const core2 = norm2.replace(/(åˆ†è¡Œ|æ”¯è¡Œ|æ€»è¡Œ|åˆ†å…¬å¸|å­å…¬å¸|åŠäº‹å¤„|ä»£è¡¨å¤„).*$/, '');
            
            if (core1 && core2 && (core1 === core2 || core1.includes(core2) || core2.includes(core1))) {
                return true;
            }
            
            return false;
        }

        // æ£€æŸ¥ä¸¤ä¸ªé¡¹ç›®åæ˜¯å¦ç›¸ä¼¼
        function isProjectSimilar(name1, name2) {
            if (!name1 || !name2) return false;
            
            const norm1 = normalizeText(name1);
            const norm2 = normalizeText(name2);
            
            // å®Œå…¨åŒ¹é…
            if (norm1 === norm2) return true;
            
            // åŒ…å«åŒ¹é…
            if (norm1.includes(norm2) || norm2.includes(norm1)) return true;
            
            // å…³é”®è¯åŒ¹é…
            for (const [category, keywords] of Object.entries(projectKeywords)) {
                const match1 = keywords.some(kw => norm1.includes(normalizeText(kw)));
                const match2 = keywords.some(kw => norm2.includes(normalizeText(kw)));
                if (match1 && match2) return true;
            }
            
            return false;
        }

        // ========== å®¢æˆ·åç§°è¾“å…¥äº‹ä»¶ ==========
        function onCustomerNameInput() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                showCustomerSuggestions();
                searchExistingProjects();
            }, 300);
        }

        function onCustomerNameFocus() {
            const input = document.getElementById('customer-name').value.trim();
            if (input.length > 0) {
                showCustomerSuggestions();
            }
        }

        // æ˜¾ç¤ºå®¢æˆ·åç§°å»ºè®®
        function showCustomerSuggestions() {
            const input = document.getElementById('customer-name').value.trim();
            const suggestionsDiv = document.getElementById('customer-suggestions');
            
            if (input.length < 1) {
                suggestionsDiv.classList.remove('show');
                return;
            }
            
            const canonical = getCanonicalCustomerName(input);
            const normalizedInput = normalizeText(input);
            
            // æœç´¢åŒ¹é…çš„å®¢æˆ·
            const matches = allCustomers.filter(customer => {
                const normalizedCustomer = normalizeText(customer);
                return normalizedCustomer.includes(normalizedInput) || 
                       isCustomerMatch(customer, input);
            });
            
            if (matches.length === 0) {
                suggestionsDiv.classList.remove('show');
                return;
            }
            
            let html = '';
            matches.slice(0, 5).forEach(customer => {
                const projectCount = allUserProjects.filter(p => 
                    isCustomerMatch(p.customerName, customer)
                ).length;
                
                html += `
                    <div class="suggestion-item" onclick="selectCustomer('${customer.replace(/'/g, "\\'")}')">
                        <div class="suggestion-name">${highlightMatch(customer, input)}</div>
                        <div class="suggestion-meta">${projectCount} ä¸ªé¡¹ç›®</div>
                    </div>
                `;
            });
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.classList.add('show');
        }

        // é€‰æ‹©å®¢æˆ·
        function selectCustomer(customer) {
            document.getElementById('customer-name').value = customer;
            document.getElementById('customer-suggestions').classList.remove('show');
            searchExistingProjects();
        }

        // ========== å›½å®¶å˜æ›´äº‹ä»¶ ==========
        function onCountryChange() {
            searchExistingProjects();
        }

        // ========== æœç´¢å·²æœ‰é¡¹ç›® ==========
        function searchExistingProjects() {
            const customerName = document.getElementById('customer-name').value.trim();
            const country = document.getElementById('customer-country').value;
            const box = document.getElementById('existing-projects-box');
            const list = document.getElementById('existing-project-list');
            
            if (!customerName) {
                box.classList.remove('show');
                return;
            }
            
            // æŸ¥æ‰¾åŒ¹é…çš„é¡¹ç›®
            const matchedProjects = allUserProjects.filter(project => {
                // å®¢æˆ·åç§°åŒ¹é…
                if (!isCustomerMatch(project.customerName, customerName)) {
                    return false;
                }
                
                // å¦‚æœé€‰æ‹©äº†å›½å®¶ï¼Œä¹Ÿè¦åŒ¹é…
                if (country && project.customerCountry && project.customerCountry !== country) {
                    return false;
                }
                
                return true;
            });
            
            if (matchedProjects.length === 0) {
                box.classList.remove('show');
                return;
            }
            
            // æŒ‰æ›´æ–°æ—¶é—´æ’åº
            matchedProjects.sort((a, b) => {
                const timeA = a.updatedAt?.toDate?.() || new Date(0);
                const timeB = b.updatedAt?.toDate?.() || new Date(0);
                return timeB - timeA;
            });
            
            // æ˜¾ç¤ºé¡¹ç›®åˆ—è¡¨
            let html = '';
            matchedProjects.forEach(project => {
                const amount = project.projectAmount ? 
                    `${(project.projectAmount/1000).toFixed(0)}K ${project.projectCurrency || 'GBP'}` : '';
                const records = project.totalSessions ? `${project.totalSessions}æ¡è®°å½•` : 'æ— è®°å½•';
                
                html += `
                    <div class="existing-project-item" onclick="goToProject('${project.id}')">
                        <div class="existing-project-info">
                            <div class="existing-project-name">${project.projectName}</div>
                            <div class="existing-project-details">
                                <span>ğŸ“ ${project.projectType || 'æœªåˆ†ç±»'}</span>
                                <span>ğŸ“Š ${project.projectStage || 'æœªè®¾ç½®'}</span>
                                ${amount ? `<span>ğŸ’° ${amount}</span>` : ''}
                                <span>ğŸ“ ${records}</span>
                            </div>
                        </div>
                        <div class="existing-project-action">æŸ¥çœ‹è¯¦æƒ… â†’</div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
            box.classList.add('show');
        }

        // è·³è½¬åˆ°é¡¹ç›®è¯¦æƒ…
        function goToProject(projectId) {
            window.location.href = `project-detail.html?id=${projectId}`;
        }

        // ========== é¡¹ç›®åç§°è¾“å…¥äº‹ä»¶ ==========
        function onProjectNameInput() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                showProjectSuggestions();
            }, 300);
        }

        function onProjectNameFocus() {
            const input = document.getElementById('project-name').value.trim();
            if (input.length > 0) {
                showProjectSuggestions();
            } else {
                // å¦‚æœæ²¡è¾“å…¥ï¼Œæ˜¾ç¤ºå½“å‰å®¢æˆ·çš„æ‰€æœ‰é¡¹ç›®
                showCustomerProjects();
            }
        }

        // æ˜¾ç¤ºå½“å‰å®¢æˆ·çš„æ‰€æœ‰é¡¹ç›®
        function showCustomerProjects() {
            const customerName = document.getElementById('customer-name').value.trim();
            const suggestionsDiv = document.getElementById('project-suggestions');
            
            if (!customerName) {
                suggestionsDiv.classList.remove('show');
                return;
            }
            
            const customerProjects = allUserProjects.filter(p => 
                isCustomerMatch(p.customerName, customerName)
            );
            
            if (customerProjects.length === 0) {
                suggestionsDiv.classList.remove('show');
                return;
            }
            
            let html = '<div style="padding: 8px 15px; background: #f8f9ff; color: #667eea; font-size: 12px; font-weight: 600;">è¯¥å®¢æˆ·å·²æœ‰é¡¹ç›®ï¼š</div>';
            customerProjects.slice(0, 5).forEach(project => {
                html += `
                    <div class="suggestion-item" onclick="goToProject('${project.id}')" style="background: #fffbeb;">
                        <div class="suggestion-name">âš ï¸ ${project.projectName}</div>
                        <div class="suggestion-meta">${project.projectType || ''} | ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                    </div>
                `;
            });
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.classList.add('show');
        }

        // æ˜¾ç¤ºé¡¹ç›®åç§°å»ºè®®
        function showProjectSuggestions() {
            const customerName = document.getElementById('customer-name').value.trim();
            const projectName = document.getElementById('project-name').value.trim();
            const suggestionsDiv = document.getElementById('project-suggestions');
            
            if (projectName.length < 1) {
                suggestionsDiv.classList.remove('show');
                return;
            }
            
            // æœç´¢ç›¸ä¼¼é¡¹ç›®ï¼ˆåŒä¸€å®¢æˆ·ä¸‹çš„ï¼‰
            const similarProjects = allUserProjects.filter(project => {
                // é¦–å…ˆæ£€æŸ¥å®¢æˆ·æ˜¯å¦åŒ¹é…
                if (customerName && !isCustomerMatch(project.customerName, customerName)) {
                    return false;
                }
                
                // æ£€æŸ¥é¡¹ç›®åç§°ç›¸ä¼¼åº¦
                return isProjectSimilar(project.projectName, projectName);
            });
            
            if (similarProjects.length === 0) {
                suggestionsDiv.classList.remove('show');
                return;
            }
            
            let html = '<div style="padding: 8px 15px; background: #fff3e0; color: #e65100; font-size: 12px; font-weight: 600;">âš ï¸ å‘ç°ç›¸ä¼¼é¡¹ç›®ï¼š</div>';
            similarProjects.slice(0, 5).forEach(project => {
                html += `
                    <div class="suggestion-item" onclick="goToProject('${project.id}')" style="background: #fffbeb;">
                        <div class="suggestion-name">${highlightMatch(project.projectName, projectName)}</div>
                        <div class="suggestion-meta">${project.customerName} | ${project.projectType || ''} | ç‚¹å‡»æŸ¥çœ‹</div>
                    </div>
                `;
            });
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.classList.add('show');
        }

        // é«˜äº®åŒ¹é…æ–‡æœ¬
        function highlightMatch(text, query) {
            if (!text || !query) return text || '';
            const regex = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        // ========== é¡¹ç›®é˜¶æ®µç›¸å…³ ==========
        function updateProjectStages() {
            const projectType = document.getElementById('project-type').value;
            const stageSelect = document.getElementById('project-stage');
            const categorySelector = document.getElementById('stage-category-selector');
            
            if (!projectType) {
                stageSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®ç±»å‹</option>';
                categorySelector.style.display = 'none';
                return;
            }
            
            if (projectType === 'å”®å‰é¡¹ç›®') {
                categorySelector.style.display = 'none';
                stageSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>' + 
                    presalesStages.map(stage => `<option value="${stage}">${stage}</option>`).join('');
            } else {
                categorySelector.style.display = 'flex';
                selectCategory('general');
            }
        }
        
        function selectCategory(category) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.category-btn[data-category="${category}"]`).classList.add('active');
            
            const categoryData = postsalesCategories[category];
            if (!categoryData) {
                console.error('åˆ†ç±»ä¸å­˜åœ¨:', category);
                return;
            }
            
            const stageSelect = document.getElementById('project-stage');
            stageSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>' + 
                categoryData.stages.map(stage => `<option value="${stage}">${stage}</option>`).join('');
        }

        // ========== æäº¤è¡¨å• ==========
        document.getElementById('create-project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'æ£€æµ‹ä¸­...';
            
            try {
                const projectName = document.getElementById('project-name').value.trim();
                const customerName = document.getElementById('customer-name').value.trim();
                
                // æ£€æµ‹é‡å¤é¡¹ç›®
                const duplicateProject = allUserProjects.find(project => {
                    return isCustomerMatch(project.customerName, customerName) && 
                           isProjectSimilar(project.projectName, projectName);
                });
                
                if (duplicateProject) {
                    submitBtn.textContent = 'åˆ›å»ºä¸­...';
                    
                    const userChoice = confirm(
                        'âš ï¸ å‘ç°å¯èƒ½é‡å¤çš„é¡¹ç›®ï¼\n\n' +
                        'å·²æœ‰é¡¹ç›®ï¼š' + duplicateProject.projectName + '\n' +
                        'å®¢æˆ·åç§°ï¼š' + duplicateProject.customerName + '\n' +
                        'é¡¹ç›®ç±»å‹ï¼š' + (duplicateProject.projectType || 'æœªè®¾ç½®') + '\n' +
                        'é¡¹ç›®é‡‘é¢ï¼š' + (duplicateProject.projectAmount ? 
                            (duplicateProject.projectAmount/1000).toFixed(0) + 'K ' + (duplicateProject.projectCurrency || 'GBP') 
                            : 'æœªè®¾ç½®') + '\n' +
                        'å·²æœ‰è®°å½•ï¼š' + (duplicateProject.totalSessions || 0) + ' æ¡\n\n' +
                        'æ˜¯å¦ç»§ç»­åˆ›å»ºæ–°é¡¹ç›®ï¼Ÿ\n\n' +
                        'ç‚¹å‡»ã€ç¡®å®šã€‘â†’ ç»§ç»­åˆ›å»ºæ–°é¡¹ç›®\n' +
                        'ç‚¹å‡»ã€å–æ¶ˆã€‘â†’ è·³è½¬åˆ°å·²æœ‰é¡¹ç›®'
                    );
                    
                    if (!userChoice) {
                        window.location.href = `project-detail.html?id=${duplicateProject.id}`;
                        return;
                    }
                }
                
                submitBtn.textContent = 'åˆ›å»ºä¸­...';
                
                const projectData = {
                    customerName: customerName,
                    customerIndustry: document.getElementById('customer-industry').value,
                    customerCountry: document.getElementById('customer-country').value,
                    projectName: projectName,
                    projectType: document.getElementById('project-type').value,
                    projectStage: document.getElementById('project-stage').value,
                    status: document.getElementById('project-status').value,
                    techDirection: document.getElementById('tech-direction').value,
                    salesPerson: document.getElementById('sales-person').value.trim(),
                    projectAmount: document.getElementById('project-amount').value ? 
                        parseFloat(document.getElementById('project-amount').value) : null,
                    projectCurrency: document.getElementById('project-currency').value,
                    startDate: document.getElementById('start-date').value || null,
                    endDate: document.getElementById('end-date').value || null,
                    description: document.getElementById('project-description').value.trim(),
                    totalWorkHours: 0,
                    totalSessions: 0,
                    assignedEngineers: [currentUser.uid],
                    createdBy: currentUser.uid,
                    createdByName: currentUser.displayName || currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('projects').add(projectData);
                
                console.log('é¡¹ç›®åˆ›å»ºæˆåŠŸï¼ŒID:', docRef.id);
                alert('âœ… é¡¹ç›®åˆ›å»ºæˆåŠŸï¼');
                
                window.location.href = `project-detail.html?id=${docRef.id}`;
                
            } catch (error) {
                console.error('åˆ›å»ºé¡¹ç›®å¤±è´¥:', error);
                alert('âŒ åˆ›å»ºå¤±è´¥: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'âœ… åˆ›å»ºé¡¹ç›®';
            }
        });

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰æ¡†
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.input-wrapper')) {
                document.getElementById('customer-suggestions').classList.remove('show');
                document.getElementById('project-suggestions').classList.remove('show');
            }
        });
    </script>
</body>
</html>
